<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Docente - ProfeAle v6.7 (N√≥mina 2026)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }

        /* --- ESTILOS INTERFAZ --- */
        .grade-chip { cursor: pointer; transition: all 0.2s; }
        .grade-chip:hover { transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-action { transition: all 0.2s; }
        .btn-action:hover { transform: translateY(-1px); }

        /* --- ESTILOS IMPRESI√ìN --- */
        .print-only { display: none; }
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 9pt; }
            .no-print { display: none !important; }
            .print-only { display: flex; }
            .printable-container { width: 100% !important; max-width: 100% !important; box-shadow: none !important; padding: 0 !important; margin: 0 !important; }
            table { width: 100% !important; border-collapse: collapse; }
            th, td { border: 1px solid #94a3b8 !important; padding: 2px 4px !important; }
            
            #printHeader { 
                flex-direction: row; align-items: center; justify-content: center; gap: 20px; 
                margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #0f172a; 
            }
            #printFooter { 
                position: fixed; bottom: 0; width: 100%; text-align: center; 
                font-size: 8pt; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 5px; 
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6">

    <div id="printHeader" class="print-only">
        <img src="logo.jpg" alt="Logo" style="height: 50px; width: auto;">
        <div style="text-align: left;">
            <h1 style="font-size: 16pt; font-weight: bold; margin: 0; color: #0f172a;">Escuela Agr√≠cola Sagrados Corazones</h1>
            <p style="margin: 0; color: #475569; font-size: 10pt;">Gesti√≥n Acad√©mica ‚Ä¢ ProfeAle</p>
        </div>
    </div>

    <div class="printable-container w-full max-w-7xl bg-white rounded-xl shadow-lg p-6">
        
        <div class="no-print text-center mb-6">
            <img src="logo.jpg" alt="Logo Escuela" class="h-20 mx-auto mb-3 object-contain hover:scale-105 transition-transform">
            <h1 class="text-2xl font-bold text-slate-800">Control de Asistencia y Calificaciones</h1>
            
            <div class="mt-3 flex flex-col items-center justify-center gap-1">
                <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold shadow-sm">
                    Versi√≥n Profesores 2026
                </span>
                <span id="userIdDisplay" class="text-[10px] text-slate-400 font-mono mt-1">Conectando...</span>
                <span id="statusDisplay" class="text-xs font-semibold text-emerald-600">‚óè En l√≠nea</span>
            </div>
            
            <p id="currentDate" class="text-slate-500 text-xs mt-3 font-medium capitalize"></p>
        </div>

        <div id="controlsContainer" class="no-print bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6">
             <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                 
                 <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">A√±o Acad√©mico</label>
                    <select id="yearSelector" class="w-full p-2 bg-white border-2 border-indigo-100 rounded shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-bold text-indigo-700 cursor-pointer">
                        <option value="2026" selected>2026</option>
                        <option value="2025">2025</option>
                    </select>
                 </div>

                 <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Clase</label>
                    <select id="classSelector" class="w-full p-2 bg-white border border-slate-300 rounded shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-medium text-slate-800 cursor-pointer"></select>
                 </div>
                 
                 <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label>
                    <input type="date" id="dateSelector" class="w-full p-2 bg-white border border-slate-300 rounded shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 font-medium cursor-pointer">
                 </div>

                 <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nuevo Estudiante</label>
                    <div class="flex shadow-sm">
                        <input type="text" id="studentNameInput" placeholder="Nombre" class="w-full p-2 border border-slate-300 rounded-l focus:ring-2 focus:ring-emerald-500 outline-none text-sm" />
                        <button id="addStudentBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold px-3 rounded-r transition">+</button>
                    </div>
                 </div>
                 
                 <div class="md:col-span-1">
                     <button id="saveDataBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded shadow-md btn-action flex items-center justify-center gap-2 text-sm">
                        <span>üíæ</span> Guardar Todo
                     </button>
                 </div>
             </div>
        </div>

        <div id="backToTableContainer" class="no-print hidden mb-4">
             <button id="backToTableBtn" class="text-indigo-600 font-bold hover:underline flex items-center gap-1">‚Üê Volver al Panel Principal</button>
        </div>

        <div id="studentsTableContainer" class="printable-container">
            <div id="loadingIndicator" class="text-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
                <p class="text-slate-400 font-medium">Cargando tus cursos...</p>
            </div>
            
            <div id="tableHeader" class="hidden grid-cols-12 gap-2 py-2 border-b-2 border-slate-200 font-bold text-slate-500 uppercase text-xs tracking-wider text-center">
                <div class="col-span-4 text-left pl-2">Nombre del Estudiante</div>
                <div class="col-span-3">Calificaciones</div>
                <div class="col-span-1">Prom.</div>
                <div class="col-span-2">Asistencia</div>
                <div class="col-span-2">Acciones</div>
            </div>
             
             <div id="tableBody" class="bg-white"></div>
        </div>

        <div id="classReportContainer" class="hidden mt-4 printable-container overflow-x-auto"></div>
        <div id="classDetailsContainer" class="hidden mt-4 printable-container overflow-x-auto"></div>
        
        <div id="reportButtons" class="no-print mt-8 pt-6 border-t border-slate-100 flex flex-wrap justify-center gap-4">
            <button id="showReportBtn" class="px-5 py-2 bg-white border border-slate-300 rounded-full text-slate-700 font-bold shadow-sm hover:bg-slate-50 transition text-sm">üìä Resumen</button>
            <button id="showDetailedReportBtn" class="px-5 py-2 bg-white border border-slate-300 rounded-full text-slate-700 font-bold shadow-sm hover:bg-slate-50 transition text-sm">üìã Detallado</button>
            <button id="printReportBtn" class="px-5 py-2 bg-slate-800 text-white rounded-full font-bold shadow-md hover:bg-slate-900 transition text-sm flex items-center gap-2">üñ®Ô∏è Imprimir</button>
        </div>
    </div>

    <div id="observationModal" class="no-print fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-indigo-600 p-3 flex justify-between items-center">
                <h3 class="text-md font-bold text-white flex items-center gap-2"><span>üí¨</span> <span id="modalTitle">Observaciones</span></h3>
                <button id="closeObservationModalBtn" class="text-white hover:text-gray-200 font-bold text-lg leading-none">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto bg-slate-50 flex-1">
                <div id="observationHistory" class="space-y-2 mb-4"></div>
                <div class="bg-white p-2 rounded border border-slate-200 shadow-sm">
                    <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nueva Entrada (<span id="obsDateDisplay"></span>)</label>
                    <textarea id="newObservationText" class="w-full text-sm text-slate-700 border-0 focus:ring-0 resize-none h-20 placeholder:text-slate-300" placeholder="Escribe aqu√≠..."></textarea>
                </div>
            </div>
            <div class="p-3 bg-white border-t border-slate-100 flex justify-end">
                <button id="saveObservationBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-4 rounded shadow transition text-sm">Guardar</button>
            </div>
        </div>
    </div>
    
    <div id="printFooter" class="print-only">Plataforma desarrollada por ProfeAle ‚Ä¢ Escuela Agr√≠cola Sagrados Corazones</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACI√ìN
        const CLAVE_DOCENTE = "ProfeAle"; 
        
        // --- N√ìMINA OFICIAL 2026 ---
        const BACKUP_DATA = {
            "1A": [
                '√ÅLVAREZ FA√öNDEZ MATEO VICENTE', 'AYALA V√ÅSQUEZ LISANDRA MILLARAY', 'CASTILLO ARAVENA MAITE PASCAL', 'COLLADO PUENTES SANTINO ALEXANDER',
                'CONCHA TORREALBA JOAQU√çN IGNACIO', 'D√çAZ MALUENDA ESTEFAN√çA ANTONIA', 'DONAIRE ROJAS MAITE EMILIA ESTER', 'ESPINOZA CACHA√ëA LISBET ALEXANDRA',
                'FERRADA ALBORNOZ AGUST√çN ALEXIS', 'FUENTEMAVIDA BARROS OSCAR ANTONIO', 'JAQUE PACHECO DAMI√ÅN IGNACIO', 'JARAMILLO VILLAR MATT HOST',
                'L√ìPEZ ACU√ëA MARCO EMILIO', 'L√ìPEZ VILLAR FRANCO IGNACIO', 'MESA D√çAZ GONZALO IGNACIO', 'MEZA CARRASCO CRISTIAN ALFONSO',
                'MORALES GARRIDO NICOL√ÅS ANTONIO', 'MOREIRA RIVAS VICENTE IGNACIO', 'MOYA COFRE KEVIN ALONSO', 'ORTEGA DA SILVA EMILIA CATALINA SOPHIA',
                'ORTEGA DA SILVA NICOL√ÅS IGNACIO', 'OYARZ√öN ROJAS MAR√çA FERNANDA', 'PEREIRA TAPIA KEVIN RUB√âN', 'RAM√çREZ SEP√öLVEDA LUIS JUSTIN JES√öS',
                'RAM√çREZ VALD√âS MARTINA POLETTE', 'RECABAL Y√Å√ëEZ TOM√ÅS IGNACIO', 'RODR√çGUEZ SEP√öLVEDA SIMONEY ISAMAR', 'ROJAS √ìRDENES TRACY MAIDEN',
                'S√ÅNCHEZ MUNIZAGA ALONDRA ANA√çS', 'SANDOVAL ARAVENA BENJAM√çN IGNACIO', 'SOLIZ OLGUIN BRAYAN', 'VALENZUELA MU√ëOZ MAGDALENA BEL√âN',
                'V√ÅSQUEZ RODR√çGUEZ ISMAEL ANDR√âS'
            ],
            "2A": [
                'ALARC√ìN FUENTES RICARDO FRANCISCO', 'ALBURQUENQUE DEL GRECCO EMILYA ANTONIA', 'ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS', 'ARAYA DOM√çNGUEZ ALEX FABI√ÅN',
                'ASTUDILLO CAMPOS CRIST√ìBAL ANTONIO', 'BAEZ DONOSO LUKAS ALFONSO', 'CARO BUSTOS KRISCHNA ESTEFANIA', 'CONTRERAS SALGADO HADEEY ALEJANDRA',
                'CUMINAO VIDAL CATALINA ANDREA', 'D√çAZ MALUENDA MIGUEL ALBERTO', 'DONOSO OLMOS EMILIA', 'IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA',
                'LAGOS LASTRA ALEXANDRA DANAE', 'L√ìPEZ L√ìPEZ LUCIANO ANTONIO', 'L√ìPEZ NOVOA EYDAN DAMI√ÅN', 'MALDONADO FLORES ANTONELLA BEL√âN',
                'MONTECINO D√çAZ VALESKA BEL√âN', 'MU√ëOZ CONTRERAS LUIS GABRIEL', 'MU√ëOZ LUNA ROGER JOEL', 'NAVARRO VILLANUEVA KARLA PAZ',
                'ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS', 'OSES CAMPOS VALENTINA ABIGAIL', 'PALMA ORELLANA ANTONELLA FRANCISCA', 'PEREIRA ORELLANA MONSERRAT ALAMIRA',
                'P√âREZ ORMAZ√ÅBAL ZADKA ALEJANDRA', 'P√âREZ QUEVEDO CONSTANZA TRINIDAD', 'QUEZADA NARANJO FELIPE ALONSO', 'RAM√çREZ VILLALOBOS DUVAN EMILIO',
                'RIQUELME SANTOS BENJAM√çN ALONSO', 'ROJAS GONZ√ÅLEZ FLORENCIA TRINIDAD', 'ROJAS LEIVA EDUARDO JAVIER', 'SALAZAR SALAS PEDRO JOS√â',
                'SANTANDER L√ìPEZ MAR√çA JOS√â', 'URBINA C√ÅCERES FRANCHESCA POULETTE', 'VARGAS MORAGA MARTINA SAYEN', 'V√ÅSQUEZ AGUILERA SCARLET NICOLE',
                'Y√Å√ëEZ GONZ√ÅLEZ BRAYAN DAMI√ÅN'
            ],
            "3A": [
                'AHUMADA ROJAS TRINIDAD BEL√âN', 'CORNEJO CASTILLO OSCAR GABRIEL', 'ESPINOZA PE√ëALILLO BRAYAN JES√öS', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO',
                'JARAMILLO VILLAR EMILIO SCOTT', 'L√ìPEZ VILLAR MART√çN ALONSO', 'MEZA COLIM√ÅN ANGEL BLAS', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA',
                'MORAGA PACHECO RENATO IGNACIO', 'MORALES REIM√ÅN ALFONSO TOM√ÅS', 'ORELLANA GARRIDO MAT√çAS LEANDRO', 'PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO',
                'PINTO TOBAR JORD√ÅN AMARO', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO', 'RECABAL Y√Å√ëEZ KEVIN ANDR√âS', 'SANDOVAL CERPA VICENTE ESTEBAN',
                'SOTO NARANJO CHRISTOPHER', 'TOLEDO ALBORNOZ ANTONELLA INES', 'VEKARIC VERDEJO MART√çN', 'VIELMA ZABALAGA JOAN MANUEL'
            ],
            "3C": [
                'BRAVO MENARES ALEX JOHAN', 'CARRASCO LEIVA BENJAM√çN IGNACIO', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER', 'ESPINOSA TORRES FERNANDA ELENA',
                'GONZ√ÅLEZ SALAZAR EMILIA CATALINA', 'MEDEL OJEDA LE√ìN IGNACIO', 'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA',
                'PUNOY MEDEL MILLARAY ANG√âLICA', 'RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO', 'RIQUELME COLOMA DALIA CONSTANZA', 'RIVERA ABARZA CONSTANZA VICTORIA',
                'SAAVEDRA BRAVO FLORENCIA ALEJANDRA', 'SALGADO ROJAS VICENTE MOIS√âS', 'SANTIS CASSEUS TEIVA SCARLETT', 'SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN',
                'VENEGAS ARRIAGADA ANTONIA EDITH'
            ],
            "4A": [
                'ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA', 'BAHAMONDE MU√ëOZ ARIEL LEON', 'CAMPOS MU√ëOZ CRISTOPHER JES√öS', 'CANCINO OR√ìSTICA VICENTE GASPAR',
                'CARO URRUTIA CONSUELO ANTONIA', 'CARRASCO GONZ√ÅLEZ CAMILA ANDREA', 'COFR√â CASTILLO ANTONIO ANDR√âS', 'GALDAMES VERGARA FELIPE ESTEBAN',
                'GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO', 'GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA', 'GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO', 'GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN',
                'HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO', 'LOBOS C√ÅCERES ANTONIA PAZ', 'MEZA CARRASCO BENJAM√çN INTI', 'MI√ëO GONZALEZ CATALINA ANDREA',
                'P√âREZ COR√ìN MANUEL IGNACIO', 'SAMANIEGO CORTEZ JAKSON FERGIE', 'SEP√öLVEDA SALAZAR SOF√çA ANTONIA', 'TAPIA ACU√ëA GABRIEL ANTONIO',
                'TORREALBA MOYA FLORVELIS DE LOS ANGELES', 'VEGA VIVANCO CRIST√ìBAL ANTONIO', 'VERA NAVARRETE DANIELA ELIZABETH', 'VILLALOBOS ARAVENA KARINA ANGELINA',
                'VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS'
            ],
            "4C": [
                'ARELLANO ACU√ëA MART√çN ANTONIO', 'AROS √ÅVILA DAYANA IGNACIA', 'CABRERA COLOMBINO MAR√çA GRACIA', 'COLLAO MEDINA ANA√çS VALENTINA',
                'DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN', 'FUENTES CARRASCO YARIXA ALEJANDRA', 'G√ìMEZ CANCINO DANIELA ALEJANDRA', 'GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA',
                'HONORATO TAPIA GLORIA JAVIERA', 'LARA RIVERA BENJAM√çN ESTEBAN', 'PAIVA OROZCO DUVAN MAURICIO ALBERTO', 'PALACIOS SOTO JOS√â TOM√ÅS',
                'PEZO SANTANDER JOS√â CRIST√ìBAL', 'ROCHA ROJAS JOS√â PABLO WILLIAMS', 'ROJAS Y√âVENES FABIANA ISIDORA', 'S√ÅNCHEZ PAREJA ANDY ANTONIO',
                'SANTANDER L√ìPEZ SIM√ìN ESTEBAN', 'TRONCOSO LIZAMA SIOMARA IGNACIA', 'WARNKEN ROJAS LUCIANA BERNABELA'
            ]
        };

        const firebaseConfig = {
            apiKey: "AIzaSyAFp6biz1UTr9Ehaudkpe7QyTFVbdQz5Sc",
            authDomain: "asistencia-mi-clase.firebaseapp.com",
            projectId: "asistencia-mi-clase",
            storageBucket: "asistencia-mi-clase.appspot.com",
            messagingSenderId: "552398254230",
            appId: "1:552398254230:web:c58dd07e5ceeb67e0912b7", 
            measurementId: "G-MYR01HM1YE"
        };
        const appId = firebaseConfig.appId;

        let app, db, auth;
        let currentDateString = new Date().toISOString().slice(0, 10);
        let masterData = {}; 
        let currentYear = "2026"; 
        let allClassesData = {}; 
        let currentClass = null;
        let students = [];
        let currentStudentIndex = -1;
        let userId = null;

        const getEl = (id) => document.getElementById(id);
        const elements = {
            status: getEl('statusDisplay'), userId: getEl('userIdDisplay'), dateText: getEl('currentDate'),
            tableContainer: getEl('studentsTableContainer'), loading: getEl('loadingIndicator'),
            yearSel: getEl('yearSelector'), classSel: getEl('classSelector'), dateSel: getEl('dateSelector'),
            nameInput: getEl('studentNameInput'), saveBtn: getEl('saveDataBtn'),
            reportBtns: { summary: getEl('showReportBtn'), detail: getEl('showDetailedReportBtn'), print: getEl('printReportBtn'), back: getEl('backToTableBtn') },
            containers: { controls: getEl('controlsContainer'), reportNav: getEl('reportButtons'), backNav: getEl('backToTableContainer'), reportSummary: getEl('classReportContainer'), reportDetail: getEl('classDetailsContainer'), tableBody: getEl('tableBody'), tableHeader: getEl('tableHeader') },
            modal: { el: getEl('observationModal'), title: getEl('modalTitle'), history: getEl('observationHistory'), input: getEl('newObservationText'), date: getEl('obsDateDisplay'), save: getEl('saveObservationBtn'), close: getEl('closeObservationModalBtn') }
        };

        function getTeacherDocRef() {
            return doc(db, `registros_publicos/${userId}/coleccion_datos/datos_maestros`);
        }

        async function initApp() {
             try {
                app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
                
                const today = new Date();
                const offset = today.getTimezoneOffset() * 60000;
                currentDateString = new Date(today.getTime() - offset).toISOString().slice(0, 10);
                elements.dateSel.value = currentDateString;
                updateDateDisplay();
                currentYear = "2026"; elements.yearSel.value = "2026";

                onAuthStateChanged(auth, user => {
                    if (user) { 
                        userId = user.uid;
                        elements.userId.textContent = `ID: ${userId.substring(0,6)}...`;
                        elements.status.textContent = '‚óè CONECTADO'; 
                        loadData(); 
                    } else { 
                        signInAnonymously(auth).catch(e => console.error(e)); 
                    }
                });
                setupListeners();
             } catch (e) { alert('Error de conexi√≥n: ' + e.message); }
        }

        function loadData() {
            const docRef = getTeacherDocRef();
            onSnapshot(docRef, (docSnap) => {
                elements.loading.style.display = 'none';
                let rawData = docSnap.exists() ? docSnap.data() : null;

                if (!rawData || !rawData["2026"]) {
                    masterData = { "2025": { classes: {} }, "2026": { classes: {} } };
                    if(rawData && rawData.classes) masterData["2025"].classes = rawData.classes; // Migraci√≥n simple
                } else {
                    masterData = rawData;
                }

                // --- AUTO-REPARACI√ìN Y POBLADO DE 2026 ---
                let modified = false;
                if(!masterData["2025"]) masterData["2025"] = { classes: {} };
                if(!masterData["2026"]) masterData["2026"] = { classes: {} };

                // Asegurar que las clases 2026 existan con la n√≥mina nueva
                for (const [clsName, studentList] of Object.entries(BACKUP_DATA)) {
                    const currentClassData = masterData["2026"].classes[clsName];
                    if (!currentClassData || currentClassData.length === 0) {
                        console.log(`Inicializando ${clsName} para 2026`);
                        masterData["2026"].classes[clsName] = studentList.map(name => ({
                            name: name, grades: [], attendance: {}, observations: []
                        }));
                        modified = true;
                    }
                }

                if (modified) saveToCloud(true);
                
                loadYearData(currentYear);
            });
        }

        function loadYearData(year) {
            currentYear = year;
            allClassesData = masterData[currentYear].classes || {};
            const classList = Object.keys(allClassesData).sort();

            let targetClass = currentClass;
            if (!targetClass || !classList.includes(targetClass)) {
                targetClass = classList.length > 0 ? classList[0] : null;
            }
            currentClass = targetClass;
            updateClassSelectorUI(classList, currentClass);
            refreshTable();
        }

        function updateClassSelectorUI(classList, selectedClass) {
            const currentOptionsStr = Array.from(elements.classSel.options).map(o => o.value).join(',');
            const newOptionsStr = classList.join(',');

            if (currentOptionsStr !== newOptionsStr) {
                elements.classSel.innerHTML = classList.map(k => `<option value="${k}">${k}</option>`).join('');
            }
            if (elements.classSel.value !== selectedClass && selectedClass) {
                elements.classSel.value = selectedClass;
            }
        }

        function refreshTable() {
            if(!currentClass) {
                elements.containers.tableBody.innerHTML = '<div class="p-8 text-center text-slate-400 italic">Cargando base de datos del docente...</div>';
                elements.containers.tableHeader.classList.add('hidden');
                return;
            }
            students = allClassesData[currentClass] || [];
            if(students.length > 0) elements.containers.tableHeader.classList.remove('hidden');
            else elements.containers.tableHeader.classList.add('hidden');
            elements.containers.tableHeader.style.display = students.length > 0 ? 'grid' : 'none';

            elements.containers.tableBody.innerHTML = students.map((s, idx) => {
                if(!s.grades) s.grades = []; if(!s.attendance) s.attendance = {}; if(!s.observations) s.observations = [];
                const avg = calculateAverage(s.grades);
                const att = s.attendance[currentDateString];
                const gradesHtml = s.grades.map((g, gIdx) => `<span onclick="window.editGrade(${idx}, ${gIdx})" title="${g.date}" class="inline-block bg-indigo-50 text-indigo-700 text-xs font-bold px-2 py-0.5 rounded border border-indigo-100 mr-1 mb-1 cursor-pointer hover:bg-indigo-100">${g.value.toFixed(1)}</span>`).join('');
                const hasObs = s.observations.length > 0;
                return `
                <div class="grid grid-cols-12 gap-2 py-2 border-b border-slate-100 items-center text-sm hover:bg-slate-50 transition-colors">
                    <div class="col-span-4 pl-2 font-semibold text-slate-700 truncate" title="${s.name}">${s.name}</div>
                    <div class="col-span-3 flex flex-wrap items-center">${gradesHtml || '<span class="text-slate-300 italic text-xs">--</span>'}</div>
                    <div class="col-span-1 text-center font-bold ${parseFloat(avg)<4 ? 'text-red-500':'text-slate-700'}">${avg}</div>
                    <div class="col-span-2 flex justify-center gap-1">${renderAttBtn(idx,'P','bg-emerald-500',att)}${renderAttBtn(idx,'A','bg-rose-500',att)}${renderAttBtn(idx,'J','bg-amber-400',att)}</div>
                    <div class="col-span-2 flex justify-end items-center gap-1 pr-2">
                        <div class="flex items-center border border-slate-200 rounded overflow-hidden bg-white"><input type="number" id="grade-${idx}" step="0.1" placeholder="-" class="w-8 text-center text-xs outline-none p-1 bg-transparent"><button onclick="window.addGrade(${idx})" class="bg-slate-50 hover:bg-slate-100 text-slate-600 px-1.5 font-bold border-l border-slate-200 text-xs">+</button></div>
                        <button onclick="window.openModal(${idx})" class="w-7 h-7 rounded-full flex items-center justify-center transition ${hasObs?'bg-indigo-100 text-indigo-600':'bg-slate-100 text-slate-400 hover:bg-slate-200'}">${hasObs?'üìù':'üí¨'}</button>
                        <button onclick="window.deleteStudent(${idx})" class="text-slate-300 hover:text-rose-500 transition w-6 text-center">üóëÔ∏è</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderAttBtn(idx, t, c, cur) { return `<button onclick="window.setAtt(${idx}, '${t}')" class="w-6 h-6 rounded-full text-[10px] font-bold transition-transform ${cur===t?`${c} text-white scale-110 shadow-md`:'bg-slate-100 text-slate-400 hover:bg-slate-200'}">${t}</button>`; }

        window.setAtt = (idx, status) => { students[idx].attendance[currentDateString] = status; saveLocal(); };
        window.addGrade = (idx) => { const v = parseFloat(getEl(`grade-${idx}`).value); if(isNaN(v)||v<1||v>7) return alert('Nota inv√°lida'); students[idx].grades.push({ value: v, date: currentDateString, id: Date.now() }); getEl(`grade-${idx}`).value=''; saveLocal(); };
        window.editGrade = (sIdx, gIdx) => { const g = students[sIdx].grades[gIdx]; const pwd = prompt(`üîí SEGURIDAD\nNota: ${g.value}\nIngrese Clave Docente:`); if(pwd!==CLAVE_DOCENTE) return pwd!==null&&alert('Clave incorrecta'); const act = prompt(`Editar Nota ${g.value}:\n- Nuevo valor\n- 'borrar'`); if(act==='borrar') students[sIdx].grades.splice(gIdx, 1); else if(act&&!isNaN(parseFloat(act))) students[sIdx].grades[gIdx].value = parseFloat(act); saveLocal(); };
        window.deleteStudent = (idx) => { if(confirm('¬øEliminar estudiante?')) { students.splice(idx, 1); saveLocal(); } };
        window.openModal = (idx) => { currentStudentIndex = idx; elements.modal.el.classList.remove('hidden','flex'); elements.modal.el.classList.add('flex'); elements.modal.title.textContent=students[idx].name; elements.modal.date.textContent=currentDateString; renderHistory(students[idx].observations||[]); };

        function saveLocal() { masterData[currentYear].classes[currentClass] = students; refreshTable(); }
        async function saveToCloud(silent = false) { if(!auth.currentUser) return; try { await setDoc(getTeacherDocRef(), masterData); if(!silent) { const btn = elements.saveBtn; const orig = btn.innerHTML; btn.innerHTML = "‚úÖ Guardado"; btn.classList.add('bg-emerald-600'); setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('bg-emerald-600'); }, 2000); } } catch(e) { alert('Error: ' + e.message); } }

        function calculateAverage(g) { if(!g.length) return '0.0'; return (g.reduce((a,b)=>a+b.value,0)/g.length).toFixed(1); }
        function updateDateDisplay() { const d = new Date(currentDateString + 'T12:00:00'); elements.dateText.textContent = d.toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); }
        function renderHistory(l) { const s = [...l].sort((a,b)=>b.id-a.id); elements.modal.history.innerHTML = s.length?s.map(o=>`<div class="bg-white border-l-4 border-indigo-400 p-2 rounded shadow-sm text-xs"><div class="flex justify-between text-[10px] text-slate-400 mb-1"><span class="font-bold text-indigo-600 bg-indigo-50 px-1 rounded">${o.date}</span></div><p class="text-slate-700">${o.text}</p></div>`).join(''):'<p class="text-center text-slate-400 italic text-xs">Sin registros.</p>'; }

        function setupListeners() {
            elements.saveBtn.onclick = () => saveToCloud(false);
            elements.yearSel.onchange = (e) => loadYearData(e.target.value);
            elements.classSel.onchange = (e) => { currentClass = e.target.value; refreshTable(); };
            elements.dateSel.onchange = (e) => { currentDateString = e.target.value; updateDateDisplay(); refreshTable(); };
            getEl('addStudentBtn').onclick = () => { const n = elements.nameInput.value.trim().toUpperCase(); if(n&&currentClass&&!students.find(s=>s.name===n)) { students.push({ name: n, grades: [], attendance: {}, observations: [] }); elements.nameInput.value=''; saveLocal(); } };
            elements.modal.close.onclick = () => elements.modal.el.classList.add('hidden');
            elements.modal.save.onclick = () => { const t = elements.modal.input.value.trim(); if(t) { students[currentStudentIndex].observations.push({ text: t, date: currentDateString, id: Date.now() }); elements.modal.el.classList.add('hidden'); elements.modal.input.value=''; saveLocal(); } };
            elements.reportBtns.back.onclick = () => { elements.containers.tableContainer.classList.remove('hidden'); elements.containers.controls.classList.remove('hidden'); elements.containers.reportNav.classList.remove('hidden'); elements.containers.backNav.classList.add('hidden'); elements.containers.reportSummary.classList.add('hidden'); elements.containers.reportDetail.classList.add('hidden'); refreshTable(); };
            elements.reportBtns.print.onclick = () => window.print();
            elements.reportBtns.summary.onclick = generateSummary;
            elements.reportBtns.detail.onclick = generateDetail;
        }

        function generateSummary() {
            elements.containers.tableContainer.classList.add('hidden'); elements.containers.controls.classList.add('hidden'); elements.containers.reportNav.classList.add('hidden'); elements.containers.backNav.classList.remove('hidden'); elements.containers.reportSummary.classList.remove('hidden');
            const data = Object.keys(allClassesData).map(cls => { const list = allClassesData[cls]; let p=0, a=0, j=0, total=0; list.forEach(s => Object.values(s.attendance||{}).forEach(v => { if(v==='P')p++; if(v==='A')a++; if(v==='J')j++; total++; })); return { cls, count: list.length, p, a, j, rate: total ? ((p+j)/total*100).toFixed(1)+'%' : 'N/A' }; });
            elements.containers.reportSummary.innerHTML = `<h2 class="text-xl font-bold text-slate-800 mb-4 text-center border-b pb-2">Resumen ${currentYear}</h2><table class="w-full text-sm text-left text-slate-600"><thead class="bg-slate-100 text-xs uppercase"><tr><th class="px-4 py-2">Clase</th><th class="px-4 py-2 text-center">Matr√≠cula</th><th class="text-center px-4 py-2 text-emerald-600">Presentes</th><th class="text-center px-4 py-2 text-rose-600">Ausentes</th><th class="text-center px-4 py-2 text-amber-600">Justif.</th><th class="text-center px-4 py-2">% Asist.</th></tr></thead><tbody>${data.map(d=>`<tr class="border-b"><td class="px-4 py-3 font-medium">${d.cls}</td><td class="text-center">${d.count}</td><td class="text-center font-bold text-emerald-600">${d.p}</td><td class="text-center font-bold text-rose-600">${d.a}</td><td class="text-center font-bold text-amber-600">${d.j}</td><td class="text-center font-bold">${d.rate}</td></tr>`).join('')}</tbody></table>`;
        }
        function generateDetail() {
            if(!currentClass) return; elements.containers.tableContainer.classList.add('hidden'); elements.containers.controls.classList.add('hidden'); elements.containers.reportNav.classList.add('hidden'); elements.containers.backNav.classList.remove('hidden'); elements.containers.reportDetail.classList.remove('hidden');
            const list = allClassesData[currentClass]; const datesSet = new Set(); list.forEach(s => Object.keys(s.attendance||{}).forEach(d => datesSet.add(d))); const sortedDates = Array.from(datesSet).sort();
            elements.containers.reportDetail.innerHTML = `<h2 class="text-xl font-bold text-slate-800 mb-4 text-center border-b pb-2">Detalle: ${currentClass} (${currentYear})</h2><table class="w-full text-xs text-slate-600 border border-slate-200"><thead class="bg-slate-100 uppercase"><tr><th class="px-2 py-2 text-left border w-48">Estudiante</th><th class="px-1 py-2 text-center border w-12">Prom</th>${sortedDates.map(d=>`<th class="px-1 py-2 text-center border w-10">${d.slice(5)}</th>`).join('')}<th class="px-2 py-2 text-left border">Observaciones</th></tr></thead><tbody>${list.map((s,i)=>{ const attCells = sortedDates.map(d=>{ const v=s.attendance[d]||'-'; let c='text-slate-300'; if(v==='P')c='bg-emerald-100 text-emerald-700 font-bold'; if(v==='A')c='bg-rose-100 text-rose-700 font-bold'; if(v==='J')c='bg-amber-100 text-amber-700 font-bold'; return `<td class="text-center border ${c}">${v}</td>`; }).join(''); const obsHtml = s.observations.map(o=>`<div class="mb-1"><strong class="text-slate-800">${o.date}:</strong> ${o.text}</div>`).join(''); return `<tr class="${i%2===0?'bg-white':'bg-slate-50'}"><td class="px-2 py-2 border font-medium truncate max-w-[150px]">${s.name}</td><td class="px-1 py-2 border text-center font-bold text-indigo-600">${calculateAverage(s.grades)}</td>${attCells}<td class="px-2 py-2 border leading-tight">${obsHtml}</td></tr>`; }).join('')}</tbody></table>`;
        }

        window.onload = initApp;
    </script>
</body>
</html>