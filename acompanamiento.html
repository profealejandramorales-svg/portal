<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompañamiento 360° - UTP (Ordenado)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; }
        .header-band { background: linear-gradient(135deg, #157347 0%, #0b4129 100%); color: white; padding: 20px 0; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .container-app { max-width: 1100px; margin: 0 auto; background: white; padding: 35px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .selector-box { background-color: #e8f5e9; border: 2px solid #198754; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        
        /* TARJETAS */
        .digital-plan-card { border-left: 5px solid #6f42c1; background: #f3f0ff; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .digital-plan-title { color: #563d7c; font-weight: bold; font-size: 1.1em; border-bottom: 1px solid #dcd6f7; padding-bottom: 5px; margin-bottom: 10px; }
        .secuencia-badge { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; color: white; margin-right: 5px; }
        .bg-inicio { background-color: #198754; } .bg-desarrollo { background-color: #0d6efd; } .bg-cierre { background-color: #dc3545; }
        .oa-card { background: white; border-left: 5px solid #ccc; padding: 10px; margin-bottom: 8px; border-radius: 6px; font-size: 0.9rem; }
        .oa-card.planificado { border-left-color: #0d6efd; } .oa-card.realizado { border-left-color: #198754; background-color: #f1fff5; }
        .criteria-box { border-left: 5px solid #198754; background: #fff; margin-bottom: 20px; padding: 15px; border-radius: 6px; border: 1px solid #e0e0e0; }
        .criteria-title { font-weight: 700; color: #157347; }
        
        @media print { 
            .no-print, .header-band { display: none !important; } 
            .container-app { box-shadow: none; padding: 0; max-width: 100%; } 
            .selector-box { border: none; background: none; padding: 0; }
            .digital-plan-card { background: #fff; border: 1px solid #ccc; }
            textarea { border: none; resize: none; font-family: inherit; } 
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body>

<div class="header-band no-print">
    <div class="container d-flex align-items-center gap-3">
        <div class="bg-white text-success rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 55px; height: 55px; font-size: 26px;">
            <i class="fas fa-clipboard-user"></i>
        </div>
        <div>
            <h3 class="m-0 fw-bold">Acompañamiento al Aula 360°</h3>
            <p class="mb-0 opacity-75 small">Gestión Técnica Pedagógica Integrada</p>
        </div>
    </div>
</div>

<div class="container-app">
    <div class="selector-box no-print">
        <div class="row g-3 align-items-end">
            <div class="col-md-5">
                <label class="form-label fw-bold text-success">1. Curso/Asignatura (Base Bitácora):</label>
                <select id="select-curso" class="form-select" onchange="cargarDatosCombinados()">
                    <option value="">Cargando...</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold text-success">2. Fecha Visita:</label>
                <input type="date" id="fecha" class="form-control" onchange="cargarDatosCombinados()">
            </div>
            <div class="col-md-4 text-end">
                <small class="text-muted d-block mb-1">Estado de Conexión:</small>
                <span class="badge bg-success"><i class="fas fa-link"></i> Bitácora</span>
                <span class="badge bg-primary"><i class="fas fa-wifi"></i> Digital</span>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4 p-3 bg-light rounded border">
        <div class="col-md-4"><label class="fw-bold small text-muted">DOCENTE:</label><input type="text" id="docente-nombre" class="form-control fw-bold border-0 bg-transparent" readonly></div>
        <div class="col-md-4"><label class="fw-bold small text-muted">ASIGNATURA/CURSO:</label><input type="text" id="asignatura-nombre" class="form-control fw-bold border-0 bg-transparent" readonly></div>
        <div class="col-md-4"><label class="fw-bold small text-muted">N° VISITA / FOCO:</label><input type="text" id="foco-visita" class="form-control" placeholder="Ej: Visita N°1 - Clima de Aula"></div>
    </div>

    <div class="row mb-4">
        <div class="col-md-7">
            <h6 class="fw-bold text-primary mb-3"><i class="fas fa-laptop-code"></i> Planificación Digital (Detalle de Clase)</h6>
            <div id="digital-content" class="small">
                <div class="alert alert-light border text-center text-muted">Seleccione curso y fecha para buscar planificación digital.</div>
            </div>
        </div>
        <div class="col-md-5">
            <h6 class="fw-bold text-success mb-3"><i class="fas fa-book"></i> Contexto Curricular (Bitácora)</h6>
            <div id="bitacora-content" class="small">
                <div class="alert alert-light border text-center text-muted">Esperando selección...</div>
            </div>
        </div>
    </div>

    <hr class="my-4">
    <h5 class="fw-bold text-dark mb-4"><i class="fas fa-check-double"></i> Pauta de Observación</h5>
    <div id="container-criterios"></div>

    <div class="criteria-box mt-4 page-break">
        <div class="criteria-title mb-2"><i class="fas fa-handshake"></i> Acuerdos y Compromisos de Mejora</div>
        <textarea id="acuerdos" class="form-control" rows="4" placeholder="Redacte aquí los acuerdos tomados con el docente..."></textarea>
    </div>

    <div class="row mt-5 pt-5 text-center" style="page-break-inside: avoid;">
        <div class="col-6"><div class="border-top border-dark pt-2 w-75 mx-auto"><strong>Firma Docente</strong><br><small class="text-muted">Tomado de conocimiento</small></div></div>
        <div class="col-6"><div class="border-top border-dark pt-2 w-75 mx-auto"><strong>Alejandra Morales G.</strong><br><small class="text-muted">Jefa Unidad Técnico Pedagógica</small></div></div>
    </div>

    <div class="text-end mt-5 no-print">
        <button class="btn btn-primary btn-lg shadow rounded-pill fw-bold" onclick="window.print()"><i class="fas fa-file-pdf"></i> Generar PDF / Imprimir</button>
    </div>
</div>

<script>
    const configBitacora = { apiKey: "AIzaSyDUArOBUzzvulHYQGA7IvnEwo2jQbEa3Xs", authDomain: "attendance-ai-s81lt.firebaseapp.com", projectId: "attendance-ai-s81lt", storageBucket: "attendance-ai-s81lt.firebasestorage.app", messagingSenderId: "935781953186", appId: "1:935781953186:web:6c8a7a93ffad180d33b1fb" };
    const appBitacora = firebase.initializeApp(configBitacora, "appBitacora");
    const dbBitacora = appBitacora.firestore();

    const configPlanif = { apiKey: "AIzaSyDJnJlpsqR76z_lBnTNEULYcGoQGIi23VU", authDomain: "planificaciones-18b94.firebaseapp.com", projectId: "planificaciones-18b94", storageBucket: "planificaciones-18b94.appspot.com", messagingSenderId: "268119843295", appId: "1:268119843295:web:bb2bdbcb0affe4ecf3646a" };
    const appPlanif = firebase.initializeApp(configPlanif, "appPlanif");
    const dbPlanif = appPlanif.firestore();

    let cursosCache = [];
    let mapaDocentes = {}; // Diccionario ID -> Nombre

    const criterios = [
        { t: "1. Estructura de la Clase", d: "Se visualiza inicio, desarrollo y cierre. Objetivo claro.", s: { "L": "Clase bien estructurada.", "ML": "Cierre débil o ausente.", "PM": "Sin estructura clara." } },
        { t: "2. Gestión de Aula", d: "Clima propicio, manejo conductual y normas.", s: { "L": "Ambiente de respeto.", "ML": "Interrupciones frecuentes.", "PM": "Desorden generalizado." } },
        { t: "3. Estrategias Didácticas", d: "Coherencia con el OA, rol activo del estudiante.", s: { "L": "Estudiantes protagonistas.", "ML": "Clase muy expositiva.", "PM": "Dictado/Copia excesiva." } },
        { t: "4. Evaluación Formativa", d: "Monitoreo del aprendizaje durante la clase.", s: { "L": "Monitoreo constante.", "ML": "Solo pregunta a algunos.", "PM": "No verifica aprendizaje." } },
        { t: "5. Uso de Recursos/DUA", d: "Materiales adecuados y atención a la diversidad.", s: { "L": "Recursos variados.", "ML": "Solo texto/pizarrón.", "PM": "Sin recursos de apoyo." } }
    ];

    document.addEventListener("DOMContentLoaded", async () => {
        document.getElementById('fecha').valueAsDate = new Date();
        renderCriterios();
        await cargarDatosMaestros();
    });

    async function cargarDatosMaestros() {
        const sel = document.getElementById('select-curso');
        sel.innerHTML = '<option>Cargando Sistema...</option>';
        
        try {
            // 1. Cargar Docentes
            const docentesSnap = await dbBitacora.collection('docentes').get();
            mapaDocentes = {};
            docentesSnap.forEach(d => {
                mapaDocentes[d.id] = d.data().nombre;
            });

            // 2. Cargar Cursos
            const cursosSnap = await dbBitacora.collection('cursos').get();
            cursosCache = [];
            
            cursosSnap.forEach(doc => {
                const d = doc.data();
                // 3. Resolver Nombre Docente
                let nombreDocente = d.docenteNombre;
                if (!nombreDocente && d.docenteId && mapaDocentes[d.docenteId]) {
                    nombreDocente = mapaDocentes[d.docenteId];
                }
                
                cursosCache.push({ id: doc.id, ...d, nombreDocenteResuelto: nombreDocente });
            });

            // 4. ORDENAR ALFABÉTICAMENTE
            cursosCache.sort((a, b) => {
                const nombreA = a.nombre.toUpperCase();
                const nombreB = b.nombre.toUpperCase();
                
                if (nombreA < nombreB) return -1;
                if (nombreA > nombreB) return 1;
                
                // Si el nombre es igual (ej: Biología), ordenar por Nivel
                return a.nivel.localeCompare(b.nivel, undefined, { numeric: true, sensitivity: 'base' });
            });

            // 5. Renderizar Opciones
            sel.innerHTML = '<option value="">-- Seleccione --</option>';
            cursosCache.forEach(c => {
                const textoDocente = c.nombreDocenteResuelto ? c.nombreDocenteResuelto : "⚠ Sin Asignar";
                sel.innerHTML += `<option value="${c.id}">${c.nombre} (${c.nivel}) - ${textoDocente}</option>`;
            });

        } catch(e) { 
            console.error(e);
            sel.innerHTML = '<option>Error de Conexión con Bitácora</option>';
        }
    }

    window.cargarDatosCombinados = async () => {
        const cursoId = document.getElementById('select-curso').value;
        const fechaTxt = document.getElementById('fecha').value;
        const divDigital = document.getElementById('digital-content');
        
        if(!cursoId || !fechaTxt) return;

        const cursoData = cursosCache.find(c => c.id === cursoId);
        const docenteReal = cursoData.nombreDocenteResuelto;

        if(cursoData) {
            document.getElementById('docente-nombre').value = docenteReal || "NO ASIGNADO";
            document.getElementById('asignatura-nombre').value = `${cursoData.nombre} - ${cursoData.nivel}`;
        }

        if (!docenteReal) {
            divDigital.innerHTML = `<div class="alert alert-warning text-center fw-bold"><i class="fas fa-exclamation-triangle"></i> ATENCIÓN: Curso sin docente asignado en BD.</div>`;
            return;
        }

        const dateObj = new Date(fechaTxt + "T00:00:00");
        const mesesShort = ["MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"];
        const mesIndex = dateObj.getMonth(); 
        let mesBusqueda = (mesIndex >= 2 && mesIndex <= 11) ? mesesShort[mesIndex - 2] : "";

        divDigital.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Buscando planificación digital...</div>';

        try {
            const q = dbPlanif.collection('planificaciones_digitales')
                .where("docente", "==", docenteReal)
                .where("nivel", "==", cursoData.nivel)
                .where("asignatura", "==", cursoData.nombre) 
                .limit(5);

            const snapDigital = await q.get();
            let planEncontrado = null;

            snapDigital.forEach(doc => {
                const data = doc.data();
                if(data.mes_planificado === mesBusqueda) planEncontrado = data;
                else if (data.monthly_distribution && Object.values(data.monthly_distribution).includes(mesBusqueda)) planEncontrado = data;
            });

            if(planEncontrado && planEncontrado.detailed_planning && planEncontrado.detailed_planning[mesBusqueda]) {
                const clases = planEncontrado.detailed_planning[mesBusqueda];
                let htmlClases = "";
                if(clases.length > 0) {
                    clases.forEach((clase) => {
                        htmlClases += `
                        <div class="digital-plan-card">
                            <div class="digital-plan-title">Clase N°${clase.number} <span class="float-end text-muted small fw-normal">OA: ${clase.oa_ref}</span></div>
                            <div class="mb-2"><strong>Obj/Contenido:</strong> ${clase.contenido || "No especificado"}</div>
                            <div class="d-flex gap-1 mb-1"><span class="secuencia-badge bg-inicio">Inicio</span><span class="text-muted fst-italic">${clase.actividad_inicio || "..."}</span></div>
                            <div class="d-flex gap-1 mb-1"><span class="secuencia-badge bg-desarrollo">Desarrollo</span><span>${clase.actividad_desarrollo || "..."}</span></div>
                            <div class="d-flex gap-1"><span class="secuencia-badge bg-cierre">Cierre</span><span class="text-muted fst-italic">${clase.actividad_cierre || "..."}</span></div>
                        </div>`;
                    });
                    divDigital.innerHTML = htmlClases;
                } else divDigital.innerHTML = `<div class="alert alert-warning">Carpeta de ${mesBusqueda} creada pero sin clases detalladas.</div>`;
            } else divDigital.innerHTML = `<div class="alert alert-secondary"><i class="fas fa-info-circle"></i> No se encontró planificación digital para <strong>${mesBusqueda}</strong> de ${docenteReal}.</div>`;

        } catch(e) {
            console.error(e);
            divDigital.innerHTML = `<div class="alert alert-danger">Error técnico: ${e.message}</div>`;
        }

        const divBitacora = document.getElementById('bitacora-content');
        divBitacora.innerHTML = "";
        const planAnual = cursoData.plan || [];
        const realData = cursoData.real || [];
        let oasDelMes = planAnual.filter(p => p.mes === mesBusqueda || p.mes === "Anual");
        
        if(oasDelMes.length > 0) {
            oasDelMes.forEach(oa => {
                const isReal = realData.find(r => r.codigo === oa.codigo && r.meses && r.meses.includes(mesBusqueda));
                const icono = isReal ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="far fa-circle text-primary"></i>';
                divBitacora.innerHTML += `<div class="oa-card ${isReal ? "realizado" : "planificado"}"><div class="fw-bold d-flex justify-content-between"><span>${icono} ${oa.codigo}</span><span class="badge bg-light text-dark border">${oa.mes}</span></div><div class="text-muted fst-italic">${oa.desc.substring(0, 80)}...</div></div>`;
            });
        } else divBitacora.innerHTML = `<div class="alert alert-light border">No hay OAs asignados a ${mesBusqueda}.</div>`;
    };

    function renderCriterios() {
        const c = document.getElementById('container-criterios');
        c.innerHTML = "";
        criterios.forEach((cr, i) => {
            c.innerHTML += `
            <div class="criteria-box page-break">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="criteria-title">${cr.t}</div>
                    <select id="sel-${i}" class="form-select form-select-sm w-auto fw-bold border-success text-success" onchange="setSug(${i})">
                        <option value="">- Evaluar -</option><option value="L">Logrado</option><option value="ML">Medianamente L.</option><option value="PM">Por Mejorar</option>
                    </select>
                </div>
                <p class="text-muted fst-italic mb-2 small">${cr.d}</p>
                <textarea id="obs-${i}" class="form-control bg-light" rows="2" placeholder="Evidencia observada..."></textarea>
            </div>`;
        });
    }

    window.setSug = (i) => {
        const val = document.getElementById(`sel-${i}`).value;
        if(val && criterios[i].s[val]) {
            const box = document.getElementById(`obs-${i}`);
            if(!box.value) box.value = criterios[i].s[val];
        }
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>