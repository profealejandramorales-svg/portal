<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control de Inventario - QR Completo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
    h1 { text-align: center; margin-top: 0; color: #333; }
    
    .card {
      max-width: 1100px; margin: 0 auto 20px; background: #fff; padding: 20px;
      border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Estilos Generales */
    label { font-size: 13px; font-weight: bold; display: block; margin-top: 10px; color: #555; }
    input[type="text"], input[type="number"], select {
      width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 5px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    
    /* Botones */
    .btn {
      padding: 10px 15px; border-radius: 5px; border: none; font-size: 14px;
      cursor: pointer; color: #fff; margin-right: 5px; margin-bottom: 5px; font-weight: bold;
    }
    .btn-blue { background: #007bff; }
    .btn-success { background: #28a745; }
    .btn-danger { background: #dc3545; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-dark { background: #343a40; }

    /* PANEL DE IMPRESI√ìN QR */
    .qr-panel {
        background-color: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 0; overflow: hidden;
    }
    .qr-header {
        background: #2196f3; color: white; padding: 10px 20px; font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 10px;
    }
    .qr-body { padding: 20px; }
    .qr-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    
    .filter-group { background: white; padding: 15px; border-radius: 6px; border: 1px solid #bbdefb; }
    .filter-title { font-size: 12px; text-transform: uppercase; color: #1976d2; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }

    .radio-card {
        display: flex; align-items: flex-start; gap: 10px; padding: 10px;
        border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: 0.2s;
    }
    .radio-card:hover { background: #f5f5f5; }
    .radio-card input { margin-top: 4px; }
    .radio-card div { font-size: 13px; }
    .radio-card strong { display: block; color: #333; margin-bottom: 2px; }
    .radio-card small { color: #666; }

    /* Tablas */
    .table-wrapper { overflow-x: auto; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f8f9fa; font-weight: bold; }
    
    .totales { padding: 15px; background: #343a40; color: white; border-radius: 5px; margin-top: 15px; font-weight: bold; text-align: right; }
  </style>
</head>
<body>

  <h1>üì¶ Control de Inventario</h1>

  <div class="card">
    <details open>
        <summary style="cursor:pointer; font-weight:bold; color:#007bff;">üìÇ Importar CSV (Clic para cerrar)</summary>
        <div style="margin-top:10px; padding:10px; background:#f9f9f9; border:1px solid #eee;">
            <p style="margin:0 0 5px;">Sube el archivo <b>tal cual lo tienes</b>.</p>
            <input type="file" id="fileInput" accept=".csv" />
            <div id="importStatus" style="font-size:12px; color:green; margin-top:5px;"></div>
        </div>
    </details>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">‚ûï Agregar Nuevo √çtem Manual</h3>
    <form id="itemForm" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px; align-items:end;">
      <div><label>Descripci√≥n</label><input type="text" id="descripcion" required /></div>
      <div><label>Ubicaci√≥n</label><input type="text" id="ubicacion" required /></div>
      <div><label>Cantidad</label><input type="number" id="cantidadForm" min="1" value="1" /></div>
      <div>
          <label>Estado</label>
          <select id="estado">
            <option>Usado</option><option>Nuevo</option><option>En reparaci√≥n</option>
          </select>
      </div>
      <div><label>Procedencia</label><input type="text" id="subvencion" placeholder="Ej: SEP, Donaci√≥n" /></div>
      <div><label>Categor√≠a</label><input type="text" id="categoria" /></div>
      <div style="padding-bottom:8px;">
          <label style="display:inline-flex; align-items:center; gap:5px;">
            <input type="checkbox" id="darDeBaja" style="width:auto; margin:0;"> Marcar Baja
          </label>
      </div>
      <div><button type="submit" class="btn btn-blue" style="width:100%">Guardar</button></div>
    </form>
  </div>

  <div class="card" style="padding:0; overflow:hidden;">
    <div class="qr-panel">
        <div class="qr-header">
            <span style="font-size:20px;">üñ®Ô∏è</span> Generador de Etiquetas (Con Procedencia)
        </div>
        <div class="qr-body">
            <div class="qr-grid">
                <div class="filter-group">
                    <div class="filter-title">1. Selecciona qu√© imprimir</div>
                    <label>Filtrar por Ubicaci√≥n:</label>
                    <select id="qrFilterUbicacion"><option value="all">-- Todas --</option></select>
                    <label>Filtrar por Procedencia:</label>
                    <select id="qrFilterProcedencia"><option value="all">-- Todas --</option></select>
                    <label>Filtrar por Estado:</label>
                    <select id="qrFilterEstado">
                        <option value="all">-- Todos --</option>
                        <option value="Nuevo">Solo Nuevos</option>
                        <option value="Usado">Solo Usados</option>
                        <option value="En reparaci√≥n">En reparaci√≥n</option>
                    </select>
                </div>

                <div class="filter-group">
                    <div class="filter-title">2. Elige el formato</div>
                    <label class="radio-card">
                        <input type="radio" name="qrMode" value="individual" checked>
                        <div><strong>Modo Individual</strong><small>Una etiqueta por cada objeto f√≠sico.</small></div>
                    </label>
                    <label class="radio-card">
                        <input type="radio" name="qrMode" value="summary">
                        <div><strong>Modo Resumen</strong><small>Una sola etiqueta con el total.</small></div>
                    </label>
                </div>

                <div style="display:flex; flex-direction:column; justify-content:center;">
                    <button id="btnGenerateQR" class="btn btn-success" style="width:100%; padding:20px; font-size:18px;">GENERAR ETIQUETAS</button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div class="card">
    <div style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
        <label>Herramientas:</label>
        <button id="btnListByUnit" class="btn btn-dark">üìã Por Unidad</button>
        <button id="btnListByState" class="btn btn-dark">üìã Por Estado</button>
        <button id="btnListByCategory" class="btn btn-dark">üìã Por Categor√≠a</button>
        <button id="btnPurgeEmpty" class="btn btn-danger" style="margin-left:10px;">üóëÔ∏è Limpiar Vac√≠os</button>
    </div>

    <h3 style="margin-bottom:5px;">Inventario Actual</h3>
    <div style="display:flex; gap:10px; background:#eee; padding:10px; border-radius:5px;">
        <select id="viewFilterProcedencia"><option value="all">Ver toda Procedencia</option><option value="SEP">SEP</option></select>
        <select id="viewFilterEstado"><option value="all">Ver todo Estado</option><option value="Nuevo">Nuevo</option><option value="Usado">Usado</option></select>
    </div>

    <div class="table-wrapper">
      <table id="itemsTable">
        <thead>
          <tr>
            <th>Descripci√≥n</th>
            <th>Ubicaci√≥n</th>
            <th>Estado</th>
            <th>Procedencia</th>
            <th>Categor√≠a</th>
            <th style="width:80px; text-align:center;">Total</th>
            <th style="width:80px; text-align:center;">Baja</th>
            <th style="width:80px; text-align:center; background:#e8f5e9;">Real</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="itemsTbody"></tbody>
      </table>
    </div>
    <div class="totales" id="totalesBox">Cargando totales...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDUArOBUzzvulHYQGA7IvnEwo2jQbEa3Xs",
      authDomain: "attendance-ai-s81lt.firebaseapp.com",
      projectId: "attendance-ai-s81lt",
      storageBucket: "attendance-ai-s81lt.firebasestorage.app",
      messagingSenderId: "935781953186",
      appId: "1:935781953186:web:6c8a7a93ffad180d33b1fb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COL = "inventarioItems";
    const KEY = "inv_local_v2";

    let items = [];

    const parseNum = (v) => { const n = parseFloat(v); return isNaN(n) || n < 0 ? 0 : n; };
    const cleanStr = (s) => (s || "").toString().trim();
    
    // --- L√ìGICA DE DATOS ---
    const loadData = async () => {
        try {
            const snap = await getDocs(collection(db, COL));
            let data = [];
            snap.forEach(d => data.push({ ...d.data(), id: parseFloat(d.id) }));
            if(data.length > 0) items = data;
            else items = JSON.parse(localStorage.getItem(KEY) || "[]");
        } catch (e) { items = JSON.parse(localStorage.getItem(KEY) || "[]"); }
        updateFilters();
        renderTable();
    };

    const saveData = async (item, isNew = false) => {
        if (isNew) items.push(item);
        else {
            const idx = items.findIndex(i => i.id === item.id);
            if(idx > -1) items[idx] = item;
        }
        localStorage.setItem(KEY, JSON.stringify(items));
        updateFilters();
        try {
            if (isNew) await setDoc(doc(db, COL, String(item.id)), item);
            else await updateDoc(doc(db, COL, String(item.id)), item);
        } catch (e) {}
    };

    const deleteData = async (id) => {
        items = items.filter(i => i.id !== id);
        localStorage.setItem(KEY, JSON.stringify(items));
        renderTable();
        try { await deleteDoc(doc(db, COL, String(id))); } catch(e){}
    };

    // --- IMPORTADOR CSV ---
    const importCSV = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const lines = evt.target.result.split('\n');
                let count = 0;
                lines.forEach((line, idx) => {
                    if(idx === 0) return;
                    const delim = line.includes(';') ? ';' : ',';
                    const c = line.split(delim);
                    
                    if(c.length >= 6) {
                        const desc = cleanStr(c[1]);
                        if(desc.length > 0) {
                            const cant = parseNum(c[2]); 
                            saveData({
                                id: Date.now() + Math.random(),
                                descripcion: desc,
                                ubicacion: cleanStr(c[5]),
                                cantidadTotal: cant,
                                cantidadBaja: 0,
                                cantidadReal: cant,
                                estado: cleanStr(c[3] || "Usado"),
                                subvencion: cleanStr(c[4] || ""),
                                categoria: cleanStr(c[6] || ""),
                                darDeBaja: false
                            }, true);
                            count++;
                        }
                    }
                });
                resolve(count);
            };
            reader.readAsText(file);
        });
    };

    document.getElementById("fileInput").addEventListener("change", (e) => {
        const f = e.target.files[0];
        if(!f) return;
        document.getElementById("importStatus").textContent = "Cargando...";
        importCSV(f).then(count => {
            alert(`Importados ${count} √≠tems.`);
            renderTable();
            document.getElementById("importStatus").textContent = "Listo";
            e.target.value = '';
        });
    });

    const updateFilters = () => {
        const fillSelect = (id, key) => {
            const sel = document.getElementById(id);
            const current = sel.value;
            const vals = [...new Set(items.map(i => cleanStr(i[key])).filter(x => x))].sort();
            const firstOpt = sel.options[0];
            sel.innerHTML = ''; sel.appendChild(firstOpt);
            vals.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v; opt.textContent = v;
                sel.appendChild(opt);
            });
            if ([...sel.options].some(o => o.value === current)) sel.value = current;
        };
        fillSelect("qrFilterUbicacion", "ubicacion");
        fillSelect("qrFilterProcedencia", "subvencion");
    };

    const renderTable = () => {
        const tbody = document.getElementById("itemsTbody");
        const fProc = document.getElementById("viewFilterProcedencia").value.toLowerCase();
        const fEst = document.getElementById("viewFilterEstado").value.toLowerCase();
        const filtered = items.filter(i => {
            if(!i.descripcion || i.descripcion.trim() === "") return false;
            const p = cleanStr(i.subvencion).toLowerCase();
            const e = cleanStr(i.estado).toLowerCase();
            return (fProc === 'all' || p.includes(fProc)) && (fEst === 'all' || e.includes(fEst));
        });

        tbody.innerHTML = filtered.map(i => {
            const real = (i.cantidadTotal||0) - (i.cantidadBaja||0);
            return `
            <tr data-id="${i.id}">
                <td>${i.descripcion}</td>
                <td>${i.ubicacion}</td>
                <td>${i.estado}</td>
                <td>${i.subvencion}</td>
                <td>${i.categoria}</td>
                <td style="text-align:center"><input type="number" class="qty-input total" value="${i.cantidadTotal}" min="0" style="width:50px"></td>
                <td style="text-align:center"><input type="number" class="qty-input baja" value="${i.cantidadBaja}" min="0" style="width:50px"></td>
                <td style="text-align:center; font-weight:bold; color:${real<1?'red':'green'}">${real}</td>
                <td style="text-align:center"><button class="btn btn-danger btn-sm" onclick="window.delItem(${i.id})">X</button></td>
            </tr>`;
        }).join("");

        const validItems = items.filter(i => i.descripcion && i.descripcion.trim() !== "");
        const real = validItems.reduce((acc, i) => acc + ((i.cantidadTotal||0) - (i.cantidadBaja||0)), 0);
        document.getElementById("totalesBox").textContent = `TOTAL ACTIVOS: ${real}`;
    };

    window.delItem = (id) => { if(confirm("¬øEliminar?")) deleteData(id); };
    
    document.getElementById("itemsTbody").addEventListener("change", (e) => {
        if(e.target.classList.contains("qty-input")) {
            const tr = e.target.closest("tr");
            const item = items.find(i => i.id === parseFloat(tr.dataset.id));
            if(!item) return;
            const val = parseNum(e.target.value);
            if(e.target.classList.contains("total")) item.cantidadTotal = val;
            if(e.target.classList.contains("baja")) item.cantidadBaja = val;
            if(item.cantidadBaja > item.cantidadTotal) item.cantidadBaja = item.cantidadTotal;
            item.cantidadReal = item.cantidadTotal - item.cantidadBaja;
            saveData(item);
            renderTable();
        }
    });

    document.getElementById("itemForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const desc = document.getElementById("descripcion").value;
        if(!desc.trim()) return alert("Falta descripci√≥n");
        saveData({
            id: Date.now(),
            descripcion: desc,
            ubicacion: document.getElementById("ubicacion").value,
            cantidadTotal: parseNum(document.getElementById("cantidadForm").value),
            cantidadBaja: 0,
            cantidadReal: parseNum(document.getElementById("cantidadForm").value),
            estado: document.getElementById("estado").value,
            subvencion: document.getElementById("subvencion").value,
            categoria: document.getElementById("categoria").value,
            darDeBaja: document.getElementById("darDeBaja").checked
        }, true);
        renderTable();
        e.target.reset();
        alert("Guardado!");
    });

    document.getElementById("btnPurgeEmpty").addEventListener("click", async () => {
        const garbage = items.filter(i => !i.descripcion || i.descripcion.trim() === "");
        if(garbage.length === 0) return alert("Todo limpio.");
        if(confirm(`Borrar ${garbage.length} registros vac√≠os?`)) {
            for(const g of garbage) await deleteDoc(doc(db, COL, String(g.id)));
            items = items.filter(i => i.descripcion && i.descripcion.trim() !== "");
            localStorage.setItem(KEY, JSON.stringify(items));
            renderTable();
            alert("Limpieza completada.");
        }
    });

    // --- GENERADOR QR (Versi√≥n Definitiva con UBIC + PROC + CANT) ---
    document.getElementById("btnGenerateQR").addEventListener("click", () => {
        const loc = document.getElementById("qrFilterUbicacion").value;
        const est = document.getElementById("qrFilterEstado").value;
        const pro = document.getElementById("qrFilterProcedencia").value;
        const mode = document.querySelector('input[name="qrMode"]:checked').value; 

        const itemsToPrint = items.filter(i => {
            if(!i.descripcion || (i.cantidadTotal - i.cantidadBaja) <= 0) return false;
            return (loc === 'all' || i.ubicacion === loc) && 
                   (est === 'all' || i.estado === est) && 
                   (pro === 'all' || i.subvencion === pro);
        });

        if (itemsToPrint.length === 0) return alert("Nada para imprimir con estos filtros.");
        
        let labelsHtml = "";
        itemsToPrint.forEach(item => {
            const stock = item.cantidadTotal - item.cantidadBaja;
            const loops = (mode === 'individual') ? stock : 1;
            
            const shortDesc = item.descripcion.substring(0, 25) + (item.descripcion.length>25?"...":"");
            const cleanUbic = item.ubicacion.substring(0, 20);
            const cleanProc = item.subvencion ? item.subvencion.substring(0,15) : "S/I";
            
            // AQUI AGREGAMOS "PROC" AL CODIGO QR
            const qrText = `ITEM: ${shortDesc}\nUBIC: ${cleanUbic}\nPROC: ${cleanProc}\nCANT: ${stock}`;

            for(let i=0; i<loops; i++) {
                const counter = (mode === 'individual') ? `(${i+1}/${stock})` : `(Total: ${stock})`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrText)}`;
                
                labelsHtml += `
                <div class="label">
                    <div class="qr-code"><img src="${qrUrl}"></div>
                    <div class="meta">
                        <div class="title">${escapeHtml(item.descripcion).substring(0,40)}</div>
                        <div class="info">
                            <b>UBIC: ${escapeHtml(item.ubicacion)}</b><br>
                            PROC: ${cleanProc} | CANT: ${stock}
                        </div>
                        <div class="id">ID: ${item.id} ${counter}</div>
                    </div>
                </div>`;
            }
        });

        const w = window.open("", "_blank");
        w.document.write(`<html><head><style>
            body{margin:0} .sheet{display:grid;grid-template-columns:repeat(3,64mm);grid-auto-rows:50mm;gap:2mm;padding-top:5mm;justify-content:center}
            .label{border:1px dashed #ccc;width:64mm;height:50mm;padding:3mm;display:flex;gap:5px;overflow:hidden;align-items:center}
            .qr-code img{width:22mm;height:22mm} .meta{flex:1;overflow:hidden; display:flex; flex-direction:column; justify-content:center;}
            .title{font-size:11px;font-weight:bold;margin-bottom:4px;max-height:26px;overflow:hidden;line-height:1.1}
            .info{font-size:10px; color:#333; margin-bottom:3px; line-height:1.3} 
            .id{font-size:8px;color:#666;font-family:monospace}
            @media print{.label{border:none}}
        </style><script>window.onload=()=>{setTimeout(()=>window.print(),2000)}<\/script></head><body><div class="sheet">${labelsHtml}</div></body></html>`);
        w.document.close();
    });

    const printList = (key) => {
        let html = `<h1>Listado por ${key.toUpperCase()}</h1>`;
        const groups = {};
        items.forEach(i => { if((i.cantidadTotal-i.cantidadBaja)>0) { const k=i[key]||"Otros"; if(!groups[k]) groups[k]=[]; groups[k].push(i); }});
        Object.keys(groups).sort().forEach(k => {
            html += `<h3>${k}</h3><table border="1" style="width:100%;border-collapse:collapse;font-size:12px">
            <tr><th>Item</th><th>Ubic</th><th>Cant</th></tr>
            ${groups[k].map(x=>`<tr><td>${escapeHtml(x.descripcion)}</td><td>${escapeHtml(x.ubicacion)}</td><td>${x.cantidadReal}</td></tr>`).join('')}</table>`;
        });
        const w=window.open("","_blank"); w.document.write(html); w.document.close();
    };

    function escapeHtml(text) {
        if (!text) return "";
        return text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
    
    document.getElementById("btnListByUnit").onclick = () => printList("ubicacion");
    document.getElementById("btnListByState").onclick = () => printList("estado");
    document.getElementById("btnListByCategory").onclick = () => printList("categoria");
    document.getElementById("viewFilterProcedencia").onchange = renderTable;
    document.getElementById("viewFilterEstado").onchange = renderTable;

    loadData();
  </script>
</body>
</html>