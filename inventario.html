<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario Pro - Escuela Agr√≠cola Sagrados Corazones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; background: #f4f6f8; }
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .qty-input { width: 55px; padding: 4px; text-align: center; border: 1px solid #e5e7eb; border-radius: 4px; font-weight: bold; }
    .totales-footer { background: #1f2937; color: white; padding: 15px; border-radius: 0 0 8px 8px; display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; }
    
    /* ESTILOS DE IMPRESI√ìN */
    @media print {
        @page { size: Letter portrait; margin: 5mm; }
        body > *:not(#printable-area) { display: none !important; }
        #printable-area { display: block !important; width: 100%; }
        
        /* DISE√ëO DE ETIQUETAS (QR) */
        .sheet { display: grid; grid-template-columns: repeat(3, 64mm); grid-auto-rows: 50mm; gap: 2mm; justify-content: center; page-break-after: always; }
        .label { border: 2px solid #000; width: 64mm; height: 50mm; padding: 3mm; display: flex; gap: 5px; align-items: center; page-break-inside: avoid; color: black; box-sizing: border-box; }
        .qr-code img { width: 22mm; height: 22mm; display: block; }
        .meta { flex: 1; display: flex; flex-direction: column; justify-content: space-between; height: 100%; overflow: hidden; }
        .title { font-size: 11px; font-weight: 900; line-height: 1.1; margin-bottom: 2px; text-transform: uppercase; border-bottom: 1px solid #000; padding-bottom: 2px;}
        .info { font-size: 10px; line-height: 1.2; font-weight: 600; }
        .sku { font-size: 8px; text-align: right; margin-top: auto; font-family: monospace; }

        /* DISE√ëO DE LISTADOS (REPORTES) */
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .report-table th { background: #ddd; border: 1px solid #000; padding: 5px; text-align: left; }
        .report-table td { border: 1px solid #000; padding: 4px; }
        .report-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
    }
  </style>
</head>
<body class="p-4 md:p-8">

  <div id="message-box" class="fixed top-5 right-5 bg-green-600 text-white px-6 py-3 rounded shadow-lg hidden z-[70]"></div>

  <div id="camera-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex flex-col items-center justify-center p-4">
      <h3 class="text-white font-bold mb-4 text-lg">üì∑ Apunta al C√≥digo QR</h3>
      <div id="reader" class="w-full max-w-sm bg-white rounded-lg overflow-hidden border-4 border-white"></div>
      <button onclick="window.stopScanner()" class="mt-6 bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-full font-bold shadow-lg text-lg">‚ùå CERRAR</button>
  </div>

  <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">üì¶ Gesti√≥n de Inventario</h1>

  <div class="max-w-7xl mx-auto space-y-6">
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card border-t-4 border-gray-500 py-2">
            <details>
                <summary class="cursor-pointer font-bold text-gray-700 text-xs uppercase">üìÇ Importar Excel (CSV)</summary>
                <div class="mt-2"><input type="file" id="fileInput" accept=".csv" class="text-xs w-full" /></div>
            </details>
        </div>
        <div class="card border-t-4 border-blue-600 py-2">
             <details>
                <summary class="cursor-pointer font-bold text-blue-800 text-xs uppercase">‚ûï Nuevo Item Manual</summary>
                <form id="itemForm" class="mt-4 grid grid-cols-2 gap-2">
                    <input type="text" id="descripcion" class="col-span-2 p-2 border rounded text-xs" required placeholder="Descripci√≥n (Ej: Monitor Samsung)">
                    <input type="text" id="ubicacion" class="p-2 border rounded text-xs" placeholder="Ubicaci√≥n (Ej: Bodega)">
                    <input type="text" id="categoria" class="p-2 border rounded text-xs" placeholder="Categor√≠a (Ej: Computaci√≥n)">
                    <input type="number" id="cantidadForm" class="p-2 border rounded text-xs" value="1" min="1">
                    <select id="estado" class="p-2 border rounded text-xs">
                        <option value="NUEVO">NUEVO</option><option value="USADO">USADO</option>
                        <option value="REPARACI√ìN">REPARACI√ìN</option><option value="MALO">MALO</option>
                    </select>
                    <input type="text" id="subvencion" class="col-span-2 p-2 border rounded text-xs" placeholder="Procedencia (Ej: SEP)">
                    <button type="submit" class="col-span-2 bg-blue-600 text-white font-bold p-2 rounded text-xs hover:bg-blue-700">GUARDAR</button>
                </form>
            </details>
        </div>
    </div>

    <div class="card p-0 overflow-hidden">
        <div class="p-4 bg-gray-100 border-b flex flex-col md:flex-row gap-3 items-center justify-between">
            
            <div class="flex gap-2 items-center w-full md:w-auto">
                <button onclick="window.startScanner()" class="bg-indigo-600 text-white text-xs font-bold px-3 py-2 rounded flex items-center gap-1 shadow hover:bg-indigo-800">
                    üì∑ ESCANEAR
                </button>
                <button id="btnResetFilter" class="hidden bg-orange-500 text-white text-xs font-bold px-3 py-2 rounded shadow animate-pulse">
                    üîÑ VER TODO
                </button>
            </div>

            <div class="flex flex-1 gap-2 w-full md:justify-center">
                <select id="filterLocation" class="bg-white border border-gray-300 text-gray-700 text-xs font-bold py-2 px-3 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="ALL">üìç TODAS LAS UBICACIONES</option>
                </select>
                <select id="filterState" class="bg-white border border-gray-300 text-gray-700 text-xs font-bold py-2 px-3 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="ALL">‚ö° TODOS LOS ESTADOS</option>
                    <option value="NUEVO">NUEVO</option><option value="USADO">USADO</option>
                    <option value="REPARACI√ìN">REPARACI√ìN</option><option value="MALO">MALO</option>
                </select>
            </div>

            <div class="flex gap-2 w-full md:w-auto justify-end">
                <button id="btnPrintList" class="bg-gray-700 hover:bg-gray-900 text-white text-xs font-bold px-3 py-2 rounded flex items-center gap-1 shadow">
                    üìÑ LISTADO
                </button>
                <button id="btnPrintLabels" class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold px-3 py-2 rounded flex items-center gap-1 shadow">
                    üñ®Ô∏è ETIQUETAS
                </button>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm border-collapse">
                <thead class="bg-white font-bold text-gray-600 uppercase text-[11px] border-b-2 border-gray-200">
                    <tr>
                        <th class="p-3">Descripci√≥n</th>
                        <th class="p-3">Ubicaci√≥n</th>
                        <th class="p-3">Estado</th>
                        <th class="p-3">Proc.</th>
                        <th class="p-3 text-center">Total</th>
                        <th class="p-3 text-center">Baja</th>
                        <th class="p-3 text-center bg-green-50">Real</th>
                        <th class="p-3 text-center">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="itemsTbody" class="divide-y divide-gray-100"></tbody>
            </table>
        </div>
        <div class="totales-footer" id="totalesBox">
            <span>MOSTRANDO: <span id="totalRegistros">0</span> ITEMS</span>
            <span>STOCK REAL VISIBLE: <span id="totalStockReal">0</span></span>
        </div>
    </div>
  </div>

  <div id="printable-area" class="hidden"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, setDoc, doc, deleteDoc, updateDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyDUArOBUzzvulHYQGA7IvnEwo2jQbEa3Xs", 
        authDomain: "attendance-ai-s81lt.firebaseapp.com", 
        projectId: "attendance-ai-s81lt", 
        storageBucket: "attendance-ai-s81lt.firebasestorage.app", 
        messagingSenderId: "935781953186", 
        appId: "1:935781953186:web:6c8a7a93ffad180d33b1fb" 
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COL = "inventarioItems";
    
    let allItems = [];
    let filteredItems = [];
    let html5QrcodeScanner = null;

    // --- CARGA DE DATOS EN TIEMPO REAL ---
    onSnapshot(query(collection(db, COL), orderBy("timestamp", "desc")), (snap) => {
        allItems = [];
        snap.forEach(d => { 
            const data = d.data();
            if(data.descripcion) {
                allItems.push({ 
                    ...data, 
                    id: d.id,
                    estado: data.estado || "S/I",
                    subvencion: data.subvencion || "S/I",
                    categoria: data.categoria || "-",
                    ubicacion: data.ubicacion || "S/U",
                    cantidadTotal: data.cantidadTotal || 0,
                    cantidadBaja: data.cantidadBaja || 0
                }); 
            }
        });
        updateLocationDropdown(); // Actualizar lista de lugares
        applyFilters();           // Refrescar tabla
    });

    // --- SISTEMA DE FILTROS ---
    const updateLocationDropdown = () => {
        const select = document.getElementById("filterLocation");
        const currentVal = select.value;
        const locations = [...new Set(allItems.map(i => i.ubicacion))].sort();
        select.innerHTML = `<option value="ALL">üìç TODAS LAS UBICACIONES</option>` + 
                           locations.map(l => `<option value="${l}">${l}</option>`).join("");
        select.value = currentVal;
    };

    const applyFilters = () => {
        const locFilter = document.getElementById("filterLocation").value;
        const stateFilter = document.getElementById("filterState").value;
        filteredItems = allItems.filter(item => {
            return (locFilter === "ALL" || item.ubicacion === locFilter) && 
                   (stateFilter === "ALL" || item.estado === stateFilter);
        });
        renderTable();
    };

    document.getElementById("filterLocation").addEventListener("change", applyFilters);
    document.getElementById("filterState").addEventListener("change", applyFilters);
    document.getElementById("btnResetFilter").onclick = () => {
        document.getElementById("filterLocation").value = "ALL";
        document.getElementById("filterState").value = "ALL";
        applyFilters();
        document.getElementById("btnResetFilter").classList.add("hidden");
    };

    // --- RENDERIZADO DE TABLA ---
    const renderTable = () => {
        const tbody = document.getElementById("itemsTbody");
        let stockAcumulado = 0;
        
        if(filteredItems.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-gray-400 italic">No hay resultados.</td></tr>`;
            document.getElementById("totalRegistros").textContent = 0;
            document.getElementById("totalStockReal").textContent = 0;
            return;
        }

        tbody.innerHTML = filteredItems.map(i => {
            const total = parseInt(i.cantidadTotal) || 0;
            const baja = parseInt(i.cantidadBaja) || 0;
            const real = total - baja;
            stockAcumulado += real;
            return `
            <tr data-id="${i.id}" class="hover:bg-gray-50 transition-colors">
                <td class="p-3 font-bold text-gray-700">${i.descripcion}</td>
                <td class="p-3 text-gray-500 uppercase text-[10px]">${i.ubicacion}</td>
                <td class="p-3 text-[10px] font-bold uppercase"><span class="bg-gray-100 px-1 rounded">${i.estado}</span></td>
                <td class="p-3 text-gray-500 text-[10px] uppercase">${i.subvencion}</td>
                <td class="p-3 text-center"><input type="number" class="qty-input total" value="${total}" min="0"></td>
                <td class="p-3 text-center"><input type="number" class="qty-input baja" value="${baja}" min="0"></td>
                <td class="p-3 text-center font-bold ${real < 1 ? 'text-red-500' : 'text-green-600'} bg-green-50/50">${real}</td>
                <td class="p-3 text-center flex justify-center gap-1">
                    <button onclick="window.printOne('${i.id}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">üñ®Ô∏è</button>
                    <button onclick="window.delItem('${i.id}')" class="bg-red-500 text-white px-2 py-1 rounded font-bold hover:bg-red-700">‚úï</button>
                </td>
            </tr>`;
        }).join("");
        document.getElementById("totalRegistros").textContent = filteredItems.length;
        document.getElementById("totalStockReal").textContent = stockAcumulado;
    };

    // --- L√ìGICA DE IMPRESI√ìN (CON ESPERA DE CARGA) ---
    
    // Funci√≥n clave: Espera a que las im√°genes QR se descarguen antes de imprimir
    const waitForImages = (container) => {
        const images = container.querySelectorAll('img');
        const promises = Array.from(images).map(img => {
            if (img.complete) return Promise.resolve();
            return new Promise(resolve => {
                img.onload = resolve;
                img.onerror = resolve; 
            });
        });
        return Promise.all(promises);
    };

    const createLabelHTML = (item) => {
        // Datos completos en el QR
        const qrText = `ITEM: ${item.descripcion}\nUBIC: ${item.ubicacion}\nCANT: ${item.cantidadTotal}\nPROC: ${item.subvencion}\nEST: ${item.estado}\nID: ${item.id}`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrText)}`;
        
        return `
        <div class="label">
            <div class="qr-code"><img src="${qrUrl}" alt="QR" loading="eager"></div>
            <div class="meta">
                <div><div class="title">${item.descripcion.substring(0, 50)}</div>
                <div class="info">Ubic: ${item.ubicacion}</div>
                <div class="info">Est: ${item.estado} | Cant: ${item.cantidadTotal}</div>
                <div class="info">Proc: ${item.subvencion}</div></div>
                <div class="sku">ID: ${item.id}</div>
            </div>
        </div>`;
    };

    // Imprimir Etiquetas (Masivo/Filtrado)
    document.getElementById("btnPrintLabels").onclick = async () => {
        if(filteredItems.length === 0) return alert("No hay items para imprimir");
        
        const btn = document.getElementById("btnPrintLabels");
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚è≥ CARGANDO..."; // Feedback visual
        
        const area = document.getElementById("printable-area");
        const labelsHTML = filteredItems.map(item => createLabelHTML(item)).join("");
        area.innerHTML = `<div class="sheet">${labelsHTML}</div>`;
        
        await waitForImages(area); // Esperamos la carga
        
        btn.innerHTML = originalText;
        window.print();
    };

    // Imprimir Etiqueta (Individual)
    window.printOne = async (id) => {
        const item = allItems.find(i => i.id === id);
        const area = document.getElementById("printable-area");
        area.innerHTML = `<div class="sheet">${createLabelHTML(item)}</div>`;
        
        await waitForImages(area); // Esperamos la carga
        
        window.print();
    };

    // Imprimir Listado (Reporte PDF)
    document.getElementById("btnPrintList").onclick = () => {
        if(filteredItems.length === 0) return alert("No hay datos para el reporte");
        
        const locName = document.getElementById("filterLocation").value === "ALL" ? "General" : document.getElementById("filterLocation").value;
        const area = document.getElementById("printable-area");
        
        let rows = filteredItems.map(i => `
            <tr>
                <td>${i.descripcion}</td>
                <td>${i.ubicacion}</td>
                <td>${i.estado}</td>
                <td>${i.subvencion}</td>
                <td style="text-align:center">${i.cantidadTotal - i.cantidadBaja}</td>
                <td></td>
            </tr>`).join("");
            
        area.innerHTML = `
            <div class="p-8">
                <div class="report-header">
                    <h2 class="text-xl font-bold uppercase">Reporte: ${locName}</h2>
                    <p class="text-sm">Fecha: ${new Date().toLocaleDateString()} | Total: ${filteredItems.length}</p>
                </div>
                <table class="report-table">
                    <thead><tr><th>Descripci√≥n</th><th>Ubicaci√≥n</th><th>Estado</th><th>Procedencia</th><th>Stock Real</th><th>Check</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>`;
        window.print();
    };

    // --- ESC√ÅNER INTELIGENTE ---
    window.startScanner = () => {
        document.getElementById("camera-modal").classList.remove("hidden");
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (decodedText) => {
            window.stopScanner();
            // Busca si el texto escaneado contiene un ID conocido
            const found = allItems.find(i => decodedText.includes(i.id));
            if (found) {
                filteredItems = [found];
                renderTable();
                document.getElementById("btnResetFilter").classList.remove("hidden");
                alert("‚úÖ Item encontrado: " + found.descripcion);
            } else { 
                alert("‚ö†Ô∏è QR no registrado en base de datos.\nContenido:\n" + decodedText); 
            }
        });
    };
    window.stopScanner = () => { if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => { html5QrcodeScanner.clear(); document.getElementById("camera-modal").classList.add("hidden"); }); };

    // --- GUARDADO Y EDICI√ìN ---
    document.getElementById("itemsTbody").addEventListener("change", async (e) => {
        if(e.target.classList.contains("qty-input")) {
            const id = e.target.closest("tr").dataset.id;
            const val = parseInt(e.target.value) || 0;
            let update = {};
            if(e.target.classList.contains("total")) update.cantidadTotal = val;
            if(e.target.classList.contains("baja")) update.cantidadBaja = val;
            await updateDoc(doc(db, COL, id), update);
        }
    });

    document.getElementById("itemForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = "INV-" + Date.now();
        await setDoc(doc(db, COL, id), {
            descripcion: document.getElementById("descripcion").value.toUpperCase(),
            ubicacion: (document.getElementById("ubicacion").value || "S/U").toUpperCase(),
            categoria: (document.getElementById("categoria").value || "-").toUpperCase(),
            cantidadTotal: parseInt(document.getElementById("cantidadForm").value) || 1,
            cantidadBaja: 0,
            estado: document.getElementById("estado").value,
            subvencion: (document.getElementById("subvencion").value || "S/I").toUpperCase(),
            timestamp: Date.now()
        });
        e.target.reset(); document.getElementById("cantidadForm").value = 1; alert("‚úÖ Registrado");
    });
    
    window.delItem = async (id) => { if(confirm("¬øEliminar?")) await deleteDoc(doc(db, COL, id)); };
    
    // --- IMPORTACI√ìN CSV ---
    document.getElementById("fileInput").addEventListener("change", (e) => {
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = async (evt) => {
            const lines = evt.target.result.split('\n');
            for(let i=1; i<lines.length; i++) {
                const c = lines[i].split(';');
                if(c.length >= 6) {
                    await setDoc(doc(db, COL, "INV-" + (Date.now()+i)), {
                        descripcion: c[1]?.trim().toUpperCase(),
                        cantidadTotal: parseInt(c[2]) || 1, cantidadBaja: 0,
                        estado: (c[3]||"USADO").trim().toUpperCase(), subvencion: (c[4]||"").trim().toUpperCase(),
                        ubicacion: (c[5]||"S/U").trim().toUpperCase(), categoria: (c[6]||"-").trim().toUpperCase(),
                        timestamp: Date.now()
                    });
                }
            }
            alert("Importaci√≥n finalizada");
        };
        reader.readAsText(f);
    });
  </script>
</body>
</html>