<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario Pro - Escuela Agr√≠cola Sagrados Corazones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f4f6f8; }
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .qty-input { width: 55px; padding: 4px; text-align: center; border: 1px solid #e5e7eb; border-radius: 4px; font-weight: bold; }
    .totales-footer { background: #1f2937; color: white; padding: 15px; border-radius: 0 0 8px 8px; display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; }
    @media print {
        @page { size: Letter portrait; margin: 0; }
        body > *:not(#printable-area) { display: none !important; }
        #printable-area { display: block !important; }
        .sheet { display: grid; grid-template-columns: repeat(3, 64mm); grid-auto-rows: 50mm; gap: 2mm; padding: 5mm; justify-content: center; }
        .label { border: 1px dashed #ccc; width: 64mm; height: 50mm; padding: 3mm; display: flex; gap: 5px; align-items: center; page-break-inside: avoid; color: black; }
        .qr-code img { width: 24mm; height: 24mm; }
        .meta { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .title { font-size: 10px; font-weight: bold; line-height: 1.1; margin-bottom: 4px; }
        .info { font-size: 9px; line-height: 1.2; }
    }
  </style>
</head>
<body class="p-4 md:p-8">

  <div id="message-box" class="fixed top-5 right-5 bg-green-600 text-white px-6 py-3 rounded shadow-lg hidden z-50"></div>

  <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">üì¶ Gesti√≥n de Inventario Institucional</h1>

  <div class="max-w-7xl mx-auto space-y-6">
    
    <div class="card border-t-4 border-gray-500">
        <details>
            <summary class="cursor-pointer font-bold text-gray-700 text-sm uppercase">üìÇ Cargar Datos desde Excel (CSV)</summary>
            <div class="mt-4 p-4 bg-gray-50 border rounded border-dashed border-gray-300">
                <input type="file" id="fileInput" accept=".csv" class="text-sm" />
                <p class="text-[10px] text-gray-500 mt-2 italic">Format: ID; descripcion; Cantidad; Estado; procedencia; ubicacion; Categoria...</p>
            </div>
        </details>
    </div>

    <div class="card border-t-4 border-blue-600">
        <h3 class="font-bold text-sm uppercase text-blue-800 mb-4 tracking-wider">‚ûï Registro Manual</h3>
        <form id="itemForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-2">
                <label class="block text-[10px] font-bold uppercase text-gray-500">Descripci√≥n</label>
                <input type="text" id="descripcion" class="w-full p-2 border rounded text-sm" required>
            </div>
            <div>
                <label class="block text-[10px] font-bold uppercase text-gray-500">Ubicaci√≥n</label>
                <input type="text" id="ubicacion" class="w-full p-2 border rounded text-sm">
            </div>
            <div>
                <label class="block text-[10px] font-bold uppercase text-gray-500">Categor√≠a</label>
                <input type="text" id="categoria" class="w-full p-2 border rounded text-sm">
            </div>
            <div>
                <label class="block text-[10px] font-bold uppercase text-gray-500">Estado</label>
                <select id="estado" class="w-full p-2 border rounded text-sm">
                    <option value="NUEVO">NUEVO</option>
                    <option value="USADO">USADO</option>
                    <option value="REPARACI√ìN">REPARACI√ìN</option>
                    <option value="MALO">MALO</option>
                </select>
            </div>
            <div>
                <label class="block text-[10px] font-bold uppercase text-gray-500">Procedencia</label>
                <input type="text" id="subvencion" class="w-full p-2 border rounded text-sm">
            </div>
            <div class="flex items-end gap-2 md:col-span-2">
                <button type="submit" class="flex-1 bg-blue-600 text-white font-bold p-2 rounded text-sm hover:bg-blue-700 shadow transition">GUARDAR EN NUBE</button>
                <button type="button" id="clear-btn" class="px-4 bg-gray-200 text-gray-700 font-bold p-2 rounded text-sm hover:bg-gray-300">LIMPIAR</button>
            </div>
        </form>
    </div>

    <div class="card p-0 overflow-hidden">
        <div class="p-4 flex flex-wrap gap-2">
            <button id="btnListByUnit" class="bg-gray-800 text-white text-xs font-bold px-3 py-2 rounded">üìã POR UNIDAD</button>
            <button id="btnListByState" class="bg-gray-800 text-white text-xs font-bold px-3 py-2 rounded">üìã POR ESTADO</button>
            <button id="btnPurgeEmpty" class="bg-red-600 text-white text-xs font-bold px-3 py-2 rounded ml-auto">üóëÔ∏è LIMPIAR VAC√çOS</button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm border-collapse">
                <thead class="bg-gray-100 font-bold text-gray-600 uppercase text-[11px]">
                    <tr>
                        <th class="p-3">Descripci√≥n</th>
                        <th class="p-3">Ubicaci√≥n</th>
                        <th class="p-3">Estado</th>
                        <th class="p-3">Procedencia</th>
                        <th class="p-3">Categor√≠a</th>
                        <th class="p-3 text-center">Total</th>
                        <th class="p-3 text-center">Baja</th>
                        <th class="p-3 text-center bg-green-50">Real</th>
                        <th class="p-3 text-center">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="itemsTbody" class="divide-y divide-gray-100"></tbody>
            </table>
        </div>
        <div class="totales-footer" id="totalesBox">
            <span>REGISTROS EN TOTAL: <span id="totalRegistros">0</span></span>
            <span>STOCK REAL ACUMULADO: <span id="totalStockReal">0</span></span>
        </div>
    </div>
  </div>

  <div id="printable-area" class="hidden"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, setDoc, doc, deleteDoc, updateDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyDUArOBUzzvulHYQGA7IvnEwo2jQbEa3Xs", 
        authDomain: "attendance-ai-s81lt.firebaseapp.com", 
        projectId: "attendance-ai-s81lt", 
        storageBucket: "attendance-ai-s81lt.firebasestorage.app", 
        messagingSenderId: "935781953186", 
        appId: "1:935781953186:web:6c8a7a93ffad180d33b1fb" 
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COL = "inventarioItems";
    let items = [];

    onSnapshot(query(collection(db, COL), orderBy("timestamp", "desc")), (snap) => {
        items = [];
        snap.forEach(d => { 
            const data = d.data();
            if(data.descripcion) {
                items.push({ 
                    ...data, 
                    id: d.id,
                    estado: data.estado || "S/I",
                    subvencion: data.subvencion || "S/I",
                    categoria: data.categoria || "-",
                    ubicacion: data.ubicacion || "S/U",
                    cantidadTotal: data.cantidadTotal || 0,
                    cantidadBaja: data.cantidadBaja || 0
                }); 
            }
        });
        renderTable();
    });

    const renderTable = () => {
        const tbody = document.getElementById("itemsTbody");
        let stockAcumulado = 0;

        tbody.innerHTML = items.map(i => {
            const total = parseInt(i.cantidadTotal) || 0;
            const baja = parseInt(i.cantidadBaja) || 0;
            const real = total - baja;
            stockAcumulado += real;

            return `
            <tr data-id="${i.id}" class="hover:bg-gray-50 transition-colors">
                <td class="p-3 font-bold text-gray-700">${i.descripcion}</td>
                <td class="p-3 text-gray-500 uppercase text-[10px]">${i.ubicacion}</td>
                <td class="p-3 text-[10px] font-bold uppercase">${i.estado}</td>
                <td class="p-3 text-gray-500 text-[10px] uppercase">${i.subvencion}</td>
                <td class="p-3 text-gray-500 text-[10px] uppercase">${i.categoria}</td>
                <td class="p-3 text-center"><input type="number" class="qty-input total" value="${total}" min="0"></td>
                <td class="p-3 text-center"><input type="number" class="qty-input baja" value="${baja}" min="0"></td>
                <td class="p-3 text-center font-bold ${real < 1 ? 'text-red-500' : 'text-green-600'} bg-green-50/50">${real}</td>
                <td class="p-3 text-center"><button onclick="window.delItem('${i.id}')" class="bg-red-500 text-white px-2 py-1 rounded font-bold text-xs hover:bg-red-700">X</button></td>
            </tr>`;
        }).join("");

        // Actualizar totales en el footer
        document.getElementById("totalRegistros").textContent = items.length;
        document.getElementById("totalStockReal").textContent = stockAcumulado;
    };

    // EDICI√ìN DIRECTA EN TABLA
    document.getElementById("itemsTbody").addEventListener("change", async (e) => {
        if(e.target.classList.contains("qty-input")) {
            const tr = e.target.closest("tr");
            const id = tr.dataset.id;
            const val = parseInt(e.target.value) || 0;
            let update = {};
            if(e.target.classList.contains("total")) update.cantidadTotal = val;
            if(e.target.classList.contains("baja")) update.cantidadBaja = val;
            await updateDoc(doc(db, COL, id), update);
            showToast("‚úÖ Sincronizado");
        }
    });

    // IMPORTACI√ìN CSV AJUSTADA
    document.getElementById("fileInput").addEventListener("change", (e) => {
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = async (evt) => {
            const lines = evt.target.result.split('\n');
            for(let i=1; i<lines.length; i++) {
                const c = lines[i].split(';');
                if(c.length >= 7 && c[1]) {
                    const id = "INV-" + (Date.now() + i);
                    await setDoc(doc(db, COL, id), {
                        descripcion: c[1].trim().toUpperCase(),
                        cantidadTotal: parseInt(c[2]) || 1,
                        cantidadBaja: 0,
                        estado: (c[3] || "USADO").trim().toUpperCase(),
                        subvencion: (c[4] || "S/I").trim().toUpperCase(),
                        ubicacion: (c[5] || "S/U").trim().toUpperCase(),
                        categoria: (c[6] || "-").trim().toUpperCase(),
                        timestamp: Date.now()
                    });
                }
            }
            alert("‚úÖ Importaci√≥n completada");
        };
        reader.readAsText(f);
    });

    document.getElementById("itemForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = "INV-" + Date.now();
        await setDoc(doc(db, COL, id), {
            descripcion: document.getElementById("descripcion").value.toUpperCase(),
            ubicacion: (document.getElementById("ubicacion").value || "S/U").toUpperCase(),
            categoria: (document.getElementById("categoria").value || "-").toUpperCase(),
            cantidadTotal: parseInt(document.getElementById("cantidadForm").value) || 1,
            cantidadBaja: 0,
            estado: document.getElementById("estado").value,
            subvencion: (document.getElementById("subvencion").value || "S/I").toUpperCase(),
            timestamp: Date.now()
        });
        e.target.reset();
        showToast("‚úÖ Registrado");
    });

    window.delItem = async (id) => { if(confirm("¬øEliminar?")) await deleteDoc(doc(db, COL, id)); };
    document.getElementById("btnPurgeEmpty").onclick = async () => {
        const q = await getDocs(collection(db, COL));
        q.forEach(async (d) => { if(!d.data().descripcion) await deleteDoc(doc(db, COL, d.id)); });
    };
    document.getElementById("clear-btn").onclick = () => document.getElementById("itemForm").reset();
    function showToast(m) { const b = document.getElementById('message-box'); b.innerText = m; b.classList.remove('hidden'); setTimeout(() => b.classList.add('hidden'), 3000); }
  </script>
</body>
</html>