<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner ProfeAle v3 (Excel)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: white; }
        
        .overlay-grid {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }
        .guide-circle {
            position: absolute;
            border: 2px solid rgba(255, 0, 0, 0.7);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            width: 20px; height: 20px;
            box-shadow: 0 0 4px rgba(255,0,0,0.8);
        }
        
        @media print {
            body { background-color: white; color: black; }
            .no-print { display: none !important; }
            #hoja-impresa { display: block !important; }
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div class="bg-gray-800 p-3 flex flex-wrap justify-between items-center no-print gap-2 shadow-md z-20">
        <div class="flex items-center gap-3">
            <h1 class="text-lg font-bold text-green-400">ðŸ“Š Scanner v3</h1>
            
            <div class="flex items-center bg-gray-700 rounded px-2 py-1">
                <label class="text-xs text-gray-300 mr-2">Preguntas:</label>
                <input type="number" id="input-cantidad" value="10" min="5" max="30" class="w-12 text-black text-center text-sm rounded font-bold">
                <button onclick="aplicarConfig()" class="ml-2 text-xs bg-green-600 hover:bg-green-500 px-2 py-1 rounded font-bold">Set</button>
            </div>
        </div>

        <div class="space-x-1 flex">
            <button onclick="imprimirHoja()" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-xs font-bold">ðŸ“„ Hoja</button>
            <button onclick="configurarPauta()" class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-xs font-bold">ðŸ”‘ Pauta</button>
            <button onclick="descargarExcel()" class="bg-green-700 hover:bg-green-600 px-3 py-1 rounded text-xs font-bold flex items-center gap-1 border border-green-500">
                ðŸ“¥ Excel
            </button>
        </div>
    </div>

    <div class="flex-1 flex flex-col md:flex-row no-print overflow-hidden relative">
        
        <div class="relative w-full md:w-2/3 bg-black flex justify-center items-center overflow-hidden border-r border-gray-700">
            <video id="video" autoplay playsinline class="absolute w-full h-full object-cover opacity-70"></video>
            <div id="overlay" class="overlay-grid"></div>
            
            <div class="absolute bottom-6 z-20 flex flex-col items-center gap-2">
                <div class="bg-black bg-opacity-50 px-3 py-1 rounded text-xs text-gray-300">
                    Alinea los cÃ­rculos y captura
                </div>
                <button onclick="escanear()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full shadow-lg border-4 border-green-800 text-lg transform hover:scale-105 transition flex items-center gap-2">
                    ðŸ“¸ CAPTURAR
                </button>
            </div>
            <canvas id="canvas" class="hidden"></canvas>
        </div>

        <div class="w-full md:w-1/3 bg-gray-900 flex flex-col h-full">
            
            <div class="p-4 border-b border-gray-700 bg-gray-800">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Ãšltimo Resultado</h3>
                <div id="resultado-actual" class="text-center">
                    <p class="text-gray-500 text-sm">Esperando captura...</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-gray-400 uppercase">Historial del Curso (<span id="contador-lista">0</span>)</h3>
                    <button onclick="borrarHistorial()" class="text-xs text-red-400 hover:text-red-300">Borrar Todo</button>
                </div>
                
                <table class="w-full text-xs text-left text-gray-300">
                    <thead class="text-gray-500 border-b border-gray-700 bg-gray-800">
                        <tr>
                            <th class="p-2">#</th>
                            <th class="p-2">Hora</th>
                            <th class="p-2">Pts</th>
                            <th class="p-2">Nota</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-notas" class="divide-y divide-gray-800">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-pauta" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex justify-center items-center no-print">
        <div class="bg-gray-800 p-6 rounded-lg w-96 max-w-full h-3/4 flex flex-col">
            <h3 class="text-xl font-bold mb-4">ðŸ”‘ Pauta Correcta</h3>
            <div id="lista-pauta" class="flex-1 overflow-y-auto space-y-2 mb-4 pr-2"></div>
            <button onclick="cerrarModal()" class="bg-green-600 px-4 py-3 rounded font-bold w-full">Guardar Pauta</button>
        </div>
    </div>

    <div id="hoja-impresa" class="hidden bg-white text-black p-8 w-[210mm] min-h-[297mm] mx-auto">
        <div class="text-center border-b-2 border-black pb-2 mb-4">
            <h1 class="text-2xl font-bold uppercase">Hoja de Respuestas</h1>
            <p class="text-sm">Escuela AgrÃ­cola Sagrados Corazones</p>
        </div>
        <div class="flex justify-between mb-6 text-sm">
            <div class="border-b border-black w-2/3 mr-4">Nombre:</div>
            <div class="border-b border-black w-1/3">Curso:</div>
        </div>
        <div id="grid-impresion" class="flex flex-wrap gap-8 justify-center"></div>
        <div class="mt-8 text-center text-xs text-gray-400 border-t pt-2">
            Rellena completamente el cÃ­rculo con lÃ¡piz oscuro.
        </div>
    </div>

    <script>
        // --- VARIABLES ---
        let CANTIDAD = 10;
        const OPCIONES = ['A', 'B', 'C', 'D', 'E'];
        let pautaCorrecta = []; 
        let coordenadasGuias = [];
        let historialNotas = []; // AquÃ­ guardamos todos los alumnos

        document.addEventListener("DOMContentLoaded", () => {
            iniciarCamara();
            aplicarConfig(); 
        });

        // 1. CONFIG & CAMARA
        function aplicarConfig() {
            const val = parseInt(document.getElementById('input-cantidad').value);
            if(val < 1 || val > 30) { alert("Entre 5 y 30 preguntas."); return; }
            CANTIDAD = val;
            pautaCorrecta = Array(CANTIDAD).fill(0);
            historialNotas = []; // Resetear historial al cambiar config
            actualizarTablaHistorial();
            generarOverlayCamara();
            generarHojaPapel();
        }

        async function iniciarCamara() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById('video').srcObject = stream;
            } catch(e) { console.error(e); alert("CÃ¡mara no encontrada."); }
        }

        function generarOverlayCamara() {
            const overlay = document.getElementById('overlay');
            overlay.innerHTML = '';
            coordenadasGuias = [];
            const usarDosColumnas = CANTIDAD > 15;
            const preguntasPorColumna = usarDosColumnas ? Math.ceil(CANTIDAD / 2) : CANTIDAD;
            const startY = 15; 
            const gapY = 80 / (preguntasPorColumna + 1);
            let columnasX = usarDosColumnas ? [25, 75] : [50];
            
            for (let i = 0; i < CANTIDAD; i++) {
                let colIndex = (usarDosColumnas && i >= preguntasPorColumna) ? 1 : 0;
                let filaIndex = (colIndex === 1) ? i - preguntasPorColumna : i;
                const ejeXBase = columnasX[colIndex]; 
                const yPos = startY + (filaIndex * gapY);
                let filaCoords = [];
                const anchoOpciones = 25; 
                const pasoX = anchoOpciones / 4; 
                const inicioX = ejeXBase - (anchoOpciones / 2);

                for (let o = 0; o < OPCIONES.length; o++) {
                    const xPos = inicioX + (o * pasoX);
                    const circle = document.createElement('div');
                    circle.className = 'guide-circle';
                    circle.style.left = xPos + '%';
                    circle.style.top = yPos + '%';
                    overlay.appendChild(circle);
                    filaCoords.push({ x: xPos, y: yPos });
                }
                coordenadasGuias.push(filaCoords);
            }
        }

        // 2. ESCANEO
        function escanear() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            if (video.readyState !== video.HAVE_ENOUGH_DATA) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

            let puntaje = 0;
            
            for (let i = 0; i < CANTIDAD; i++) {
                let brillos = [];
                for (let o = 0; o < OPCIONES.length; o++) {
                    const cx = Math.floor((coordenadasGuias[i][o].x / 100) * canvas.width);
                    const cy = Math.floor((coordenadasGuias[i][o].y / 100) * canvas.height);
                    brillos.push(getBrightness(frame, canvas.width, cx, cy));
                }
                const minVal = Math.min(...brillos);
                const marcadoIdx = brillos.indexOf(minVal);
                if(marcadoIdx === pautaCorrecta[i]) puntaje++;
            }

            const nota = ((puntaje / CANTIDAD) * 6 + 1).toFixed(1);
            
            // MOSTRAR RESULTADO INMEDIATO
            mostrarResultadoActual(nota, puntaje);
            
            // GUARDAR EN HISTORIAL
            guardarEnHistorial(nota, puntaje);
        }

        function getBrightness(data, width, cx, cy) {
            let sum = 0, count = 0, r = 4;
            for(let y = cy-r; y <= cy+r; y++) {
                for(let x = cx-r; x <= cx+r; x++) {
                    const i = (y * width + x) * 4;
                    if(data[i]) { sum += (data[i] + data[i+1] + data[i+2]) / 3; count++; }
                }
            }
            return sum/count;
        }

        // 3. GESTIÃ“N DE NOTAS
        function mostrarResultadoActual(nota, puntaje) {
            const color = nota >= 4.0 ? 'text-blue-400' : 'text-red-500';
            document.getElementById('resultado-actual').innerHTML = `
                <div class="text-5xl font-bold ${color} mb-1">${nota}</div>
                <div class="text-xs text-gray-400">Puntaje: ${puntaje}/${CANTIDAD}</div>
                <div class="text-xs text-green-500 mt-2 font-bold animate-pulse">âœ… Guardado en lista</div>
            `;
        }

        function guardarEnHistorial(nota, puntaje) {
            const fecha = new Date();
            const hora = fecha.toLocaleTimeString('es-CL', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            
            historialNotas.push({
                id: historialNotas.length + 1,
                hora: hora,
                puntaje: puntaje,
                nota: nota
            });
            actualizarTablaHistorial();
        }

        function actualizarTablaHistorial() {
            const tbody = document.getElementById('tabla-notas');
            document.getElementById('contador-lista').innerText = historialNotas.length;
            tbody.innerHTML = '';
            
            // Mostrar Ãºltimos primero
            [...historialNotas].reverse().forEach(item => {
                const color = item.nota >= 4.0 ? 'text-blue-400' : 'text-red-400';
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-700 transition">
                        <td class="p-2 text-gray-500">#${item.id}</td>
                        <td class="p-2">${item.hora}</td>
                        <td class="p-2">${item.puntaje}/${CANTIDAD}</td>
                        <td class="p-2 font-bold ${color}">${item.nota}</td>
                    </tr>
                `;
            });
        }

        function borrarHistorial() {
            if(confirm("Â¿Borrar todas las notas escaneadas?")) {
                historialNotas = [];
                actualizarTablaHistorial();
                document.getElementById('resultado-actual').innerHTML = '<p class="text-gray-500 text-sm">Lista vacÃ­a</p>';
            }
        }

        function descargarExcel() {
            if(historialNotas.length === 0) { alert("No hay notas para descargar."); return; }
            
            // Crear contenido CSV
            let csv = "ID,Hora,Puntaje Total,Puntaje Obtenido,Nota\n";
            historialNotas.forEach(row => {
                csv += `${row.id},${row.hora},${CANTIDAD},${row.puntaje},${row.nota}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "notas_escaneadas.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 4. GENERADORES (Papel y Pauta)
        function generarHojaPapel() {
            const grid = document.getElementById('grid-impresion');
            grid.innerHTML = '';
            const usarDosColumnas = CANTIDAD > 15;
            const corte = usarDosColumnas ? Math.ceil(CANTIDAD/2) : CANTIDAD;
            const crearColHTML = (ini, fin) => {
                let html = '<div class="w-48">';
                for(let i=ini; i<fin; i++) {
                    let opts = '';
                    OPCIONES.forEach(op => opts += `<div class="inline-block text-center mr-2"><div class="w-4 h-4 border border-black rounded-full mx-auto mb-1"></div><span class="text-[10px] font-bold">${op}</span></div>`);
                    html += `<div class="flex items-center mb-4 border-b border-gray-100 pb-1"><span class="font-bold mr-2 w-6 text-right">${i+1}.</span><div class="flex">${opts}</div></div>`;
                }
                return html + '</div>';
            };
            grid.innerHTML += crearColHTML(0, corte);
            if(usarDosColumnas) { grid.innerHTML += '<div class="border-r-2 border-dashed border-gray-300 mx-4"></div>'; grid.innerHTML += crearColHTML(corte, CANTIDAD); }
        }

        function configurarPauta() {
            const lista = document.getElementById('lista-pauta');
            lista.innerHTML = '';
            for(let i=0; i<CANTIDAD; i++) {
                let opts = '';
                OPCIONES.forEach((op, idx) => {
                    const chk = pautaCorrecta[i] === idx ? 'checked' : '';
                    opts += `<label class="mr-3 cursor-pointer"><input type="radio" name="p-${i}" value="${idx}" ${chk} class="accent-green-500"> ${op}</label>`;
                });
                lista.innerHTML += `<div class="flex justify-between border-b border-gray-700 py-2 text-sm"><span>P${i+1}</span><div>${opts}</div></div>`;
            }
            document.getElementById('modal-pauta').classList.remove('hidden');
        }

        function cerrarModal() {
            for(let i=0; i<CANTIDAD; i++) {
                const els = document.getElementsByName(`p-${i}`);
                for(let el of els) if(el.checked) pautaCorrecta[i] = parseInt(el.value);
            }
            document.getElementById('modal-pauta').classList.add('hidden');
        }
        function imprimirHoja() { window.print(); }
    </script>
</body>
</html>