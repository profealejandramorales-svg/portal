<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Privado - ProfeAle Admin v9.0 (Import)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .grade-cell { min-width: 70px; text-align: center; }
        .empty-grade { color: #d1d5db; font-style: italic; font-size: 0.7rem; }
        .btn-action { transition: all 0.2s; } .btn-action:hover { transform: translateY(-1px); }
        .print-only { display: none; }
        @media print {
            .no-print { display: none !important; }
            .printable-container { margin: 0; padding: 0; box-shadow: none; width: 100% !important; max-width: 100% !important; }
            body { background-color: white; }
            .print-only { display: block; }
            #printHeader { position: fixed; top: 0; left: 0; width: 100%; background-color: white; border-bottom: 2px solid #3730a3; padding: 10px 40px; margin-bottom: 20px; z-index: 1000; }
            body > .printable-container { padding-top: 100px; }
            table { font-size: 10px; width: 100%; }
            th, td { padding: 4px !important; border: 1px solid #9ca3af !important; }
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center min-h-screen py-6">

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center border-t-4 border-indigo-600">
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">ProfeAle Admin</h1>
            <p class="text-slate-500 text-sm mt-1 mb-6">Acceso Privado + Importador</p>
            <form id="loginForm" class="space-y-4 text-left">
                <input type="email" id="emailInput" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="admin@profeale.cl" required>
                <input type="password" id="passwordInput" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                <div id="authErrorMsg" class="text-rose-500 text-xs text-center font-bold hidden"></div>
                <button type="submit" id="btnLogin" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition shadow-md">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="printHeader" class="print-only">
        <div class="flex items-center justify-between w-full">
            <div class="w-1/3"><h3 class="font-bold">ProfeAle</h3></div>
            <div class="w-1/3 text-center"><h3 class="text-xl font-bold uppercase">Informe AcadÃ©mico</h3></div>
            <div class="w-1/3 text-right text-xs"><p class="print-date-placeholder">--/--/----</p></div>
        </div>
    </div>

    <div class="printable-container bg-white p-6 rounded-2xl shadow-xl max-w-[95%] w-full">
        
        <div class="no-print flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
            <div class="flex items-center gap-4">
                <img src="logo.jpg" onerror="this.src='https://cdn-icons-png.flaticon.com/512/167/167707.png'" alt="Logo" class="h-16 object-contain hover:scale-105 transition-transform">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">Panel de Control</h1>
                    <div class="flex items-center gap-2 text-xs">
                        <span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-bold">Admin v9.0</span>
                        <span id="userIdDisplay" class="text-slate-400">...</span>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-end gap-2">
                <input type="file" id="csvInput" accept=".csv" class="hidden">
                <button id="importBtn" class="bg-blue-100 text-blue-700 hover:bg-blue-200 text-xs font-bold py-1 px-3 rounded border border-blue-200 transition flex items-center gap-1">ğŸ“‚ Importar NÃ³mina CSV</button>
                
                <button id="backupBtn" class="bg-rose-100 text-rose-700 hover:bg-rose-200 text-xs font-bold py-1 px-3 rounded border border-rose-200 transition">ğŸ’¾ Descargar Respaldo JSON</button>
                <button id="btnLogout" class="text-xs font-bold text-slate-400 hover:text-slate-600 underline">Cerrar SesiÃ³n</button>
            </div>
        </div>

        <p id="currentDate" class="text-slate-500 text-center mb-4 no-print text-sm font-medium capitalize"></p>

        <div id="controlsContainer" class="no-print bg-slate-50 border border-slate-200 rounded-xl p-5 mb-6 shadow-sm">
             <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                 <div class="md:col-span-1"><label class="block text-xs font-bold text-indigo-600 uppercase mb-1">AÃ±o</label><select id="yearSelector" class="w-full p-2 border-2 border-indigo-100 rounded text-sm font-bold text-indigo-700"><option value="2025">2025</option><option value="2026">2026</option></select></div>
                 <div class="md:col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Clase</label><div class="flex"><select id="classSelector" class="w-full p-2 border border-slate-300 rounded-l text-sm"></select><button id="addClassBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold px-2 rounded-r" title="Nueva Clase">+</button></div></div>
                 <div class="md:col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label><input type="date" id="dateSelector" class="w-full p-2 border border-slate-300 rounded text-sm"></div>
                 <div class="md:col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">EvaluaciÃ³n</label><input type="text" id="evalNameInput" placeholder="Ej: PRUEBA 1" class="w-full p-2 border border-slate-300 rounded text-sm uppercase font-semibold text-slate-700"></div>
                 <div class="md:col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Estudiante</label><div class="flex"><input type="text" id="studentNameInput" placeholder="Nombre" class="w-full p-2 border border-slate-300 rounded-l text-sm" /><button id="addStudentBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold px-3 rounded-r transition">+</button></div></div>
                 <div class="md:col-span-1"><button id="saveDataBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded shadow-md btn-action text-sm">ğŸ’¾ Guardar Todo</button></div>
             </div>
        </div>

        <div id="backToTableContainer" class="no-print hidden mb-4"><button id="backToTableBtn" class="text-indigo-600 font-bold hover:underline flex items-center gap-1">â† Volver al Panel Principal</button></div>

        <div id="studentsTableContainer" class="printable-container overflow-x-auto min-h-[300px]">
            <div id="loadingIndicator" class="text-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
                <p class="text-slate-400 font-medium">Cargando base de datos...</p>
                <p id="loadingError" class="text-red-500 text-xs mt-2 hidden">Error de conexiÃ³n.</p>
            </div>
            <table id="mainTable" class="w-full hidden border-collapse text-sm">
                <thead id="tableHeader" class="bg-slate-100 text-slate-500 uppercase text-xs font-bold border-b-2 border-slate-200"></thead>
                <tbody id="tableBody" class="bg-white"></tbody>
            </table>
        </div>

        <div id="classReportContainer" class="hidden mt-6 printable-container"></div>
        <div id="classDetailsContainer" class="hidden mt-6 printable-container"></div>
        
        <div id="reportButtons" class="no-print mt-8 pt-6 border-t border-slate-100 flex flex-wrap justify-center gap-4">
            <button id="showReportBtn" class="px-5 py-2 bg-white border border-slate-300 rounded-full text-slate-700 font-bold shadow-sm hover:bg-slate-50 transition text-sm">ğŸ“Š Resumen</button>
            <button id="showDetailedReportBtn" class="px-5 py-2 bg-white border border-slate-300 rounded-full text-slate-700 font-bold shadow-sm hover:bg-slate-50 transition text-sm">ğŸ“‹ Detallado</button>
            <button id="printReportBtn" class="px-5 py-2 bg-slate-800 text-white rounded-full font-bold shadow-md hover:bg-slate-900 transition text-sm flex items-center gap-2">ğŸ–¨ï¸ Imprimir</button>
        </div>

        <div id="observationModal" class="no-print fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[95vh]">
                <div class="bg-indigo-600 p-3 flex justify-between items-center">
                    <h3 class="text-md font-bold text-white flex items-center gap-2"><span>ğŸ’¬</span> <span id="modalTitle">Observaciones</span></h3>
                    <button id="closeObservationModalBtn" class="text-white hover:text-gray-200 font-bold text-lg leading-none">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto bg-slate-50 flex-1">
                    <div id="observationHistory" class="space-y-3 mb-4"></div>
                    <div class="bg-white p-3 rounded border border-slate-200 shadow-sm relative">
                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Fecha</label>
                        <input type="date" id="obsDateInput" class="w-full mb-2 p-1.5 border border-slate-300 rounded text-sm font-bold text-slate-700">
                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">ObservaciÃ³n</label>
                        <textarea id="newObservationText" class="w-full text-sm text-slate-700 border border-slate-200 rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none resize-none h-20 placeholder:text-slate-300 mb-2" placeholder="Escribe el detalle..."></textarea>
                        <div class="flex items-center gap-2 border-t border-slate-100 pt-2">
                            <label class="cursor-pointer bg-slate-100 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 border border-slate-200 rounded px-3 py-1.5 flex items-center gap-2 text-xs font-bold transition">
                                <span>ğŸ“·</span> Adjuntar Foto
                                <input type="file" id="photoInput" accept="image/*" class="hidden">
                            </label>
                            <span id="photoPreviewText" class="text-[10px] text-emerald-600 font-bold hidden">Â¡Foto lista para subir!</span>
                            <img id="photoPreviewImg" class="h-8 w-8 object-cover rounded hidden border border-slate-300">
                            <button id="clearPhotoBtn" class="hidden text-rose-500 text-xs hover:underline">Borrar</button>
                        </div>
                    </div>
                </div>
                <div class="p-3 bg-white border-t border-slate-100 flex justify-end">
                    <button id="saveObservationBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-6 rounded shadow transition text-sm">Guardar</button>
                </div>
            </div>
        </div>

        <div id="photoViewerModal" class="no-print fixed inset-0 bg-black/90 hidden items-center justify-center z-[60] backdrop-blur-sm p-4">
            <div class="relative max-w-4xl w-full">
                <button id="closePhotoViewer" class="absolute -top-10 right-0 text-white font-bold text-xl hover:text-gray-300">CERRAR âœ•</button>
                <img id="fullSizeImage" class="w-full max-h-[85vh] object-contain rounded shadow-2xl">
                <p id="photoCaption" class="text-white text-center mt-2 text-sm font-mono"></p>
            </div>
        </div>

    </div>
    
    <div id="printFooter" class="print-only text-center text-xs text-slate-400 mt-2">Sistema Privado ProfeAle</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAFp6biz1UTr9Ehaudkpe7QyTFVbdQz5Sc", authDomain: "asistencia-mi-clase.firebaseapp.com", projectId: "asistencia-mi-clase", storageBucket: "asistencia-mi-clase.appspot.com", messagingSenderId: "552398254230", appId: "1:552398254230:web:c58dd07e5ceeb67e0912b7", measurementId: "G-MYR01HM1YE" };
        const appId = firebaseConfig.appId;

        let app, db, auth, userId = null;
        let masterData = {}; 
        let currentYear = "2025";
        let allClassesData = {};
        let currentClass = null;
        let students = [];
        let currentStudentIndex = -1;
        let currentDateString = new Date().toISOString().slice(0, 10);
        let pendingPhotoBase64 = null;

        const getEl = (id) => document.getElementById(id);
        const els = {
            loginOverlay: getEl('loginOverlay'), loginForm: getEl('loginForm'), email: getEl('emailInput'), pass: getEl('passwordInput'), authError: getEl('authErrorMsg'),
            mainTable: getEl('mainTable'), tableHeader: getEl('tableHeader'), tableBody: getEl('tableBody'), tableContainer: getEl('studentsTableContainer'),
            yearSel: getEl('yearSelector'), classSel: getEl('classSelector'), dateSel: getEl('dateSelector'), evalName: getEl('evalNameInput'),
            saveBtn: getEl('saveDataBtn'), addStudentBtn: getEl('addStudentBtn'), addClassBtn: getEl('addClassBtn'), backupBtn: getEl('backupBtn'),
            importBtn: getEl('importBtn'), csvInput: getEl('csvInput'), // IMPORT ELEMENTS
            reportSummary: getEl('classReportContainer'), reportDetail: getEl('classDetailsContainer'), backNav: getEl('backToTableContainer'), controls: getEl('controlsContainer'), reportBtns: getEl('reportButtons'),
            modal: { el: getEl('observationModal'), title: getEl('modalTitle'), history: getEl('observationHistory'), input: getEl('newObservationText'), date: getEl('obsDateInput'), save: getEl('saveObservationBtn'), close: getEl('closeObservationModalBtn'), photoInput: getEl('photoInput'), photoPreview: getEl('photoPreviewImg'), photoText: getEl('photoPreviewText'), clearPhoto: getEl('clearPhotoBtn') },
            photoViewer: { el: getEl('photoViewerModal'), img: getEl('fullSizeImage'), caption: getEl('photoCaption'), close: getEl('closePhotoViewer') }
        };

        function getMyPrivateDocRef() { 
            return doc(db, `artifacts/${appId}/public/data/calificaciones/master_data`); 
        }

        async function initApp() {
            try {
                app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
                const today = new Date(); const offset = today.getTimezoneOffset() * 60000;
                currentDateString = new Date(today.getTime() - offset).toISOString().slice(0, 10);
                els.dateSel.value = currentDateString; updateDateDisplay();
                onAuthStateChanged(auth, user => {
                    if (user) { userId = user.uid; getEl('userIdDisplay').textContent = user.email; els.loginOverlay.classList.add('hidden'); loadData(); }
                    else { els.loginOverlay.classList.remove('hidden'); }
                });
                setupEvents();
            } catch (e) { alert("Error crÃ­tico: " + e.message); }
        }

        async function handleLogin(e) { e.preventDefault(); els.authError.classList.add('hidden'); try { await signInWithEmailAndPassword(auth, els.email.value, els.pass.value); } catch (error) { els.authError.textContent = "Error: " + error.message; els.authError.classList.remove('hidden'); } }

        function loadData() {
            onSnapshot(getMyPrivateDocRef(), (docSnap) => {
                getEl('loadingIndicator').style.display = 'none';
                let raw = docSnap.exists() ? docSnap.data() : null;
                if (!raw) { masterData = { "2025": { classes: {} }, "2026": { classes: {} } }; } 
                else if (raw.classes && !raw["2025"]) { masterData = { "2025": { classes: raw.classes }, "2026": { classes: {} } }; } 
                else { masterData = raw; }
                if(!masterData["2025"]) masterData["2025"] = { classes: {} };
                if(!masterData["2026"]) masterData["2026"] = { classes: {} };
                loadYearData(currentYear);
            }, (error) => {
                console.error("Error cargando datos:", error);
                getEl('loadingError').textContent = "Error de Permisos o ConexiÃ³n: " + error.message;
                getEl('loadingError').classList.remove('hidden');
            });
        }

        function loadYearData(year) {
            currentYear = year; allClassesData = masterData[currentYear].classes || {};
            const keys = Object.keys(allClassesData).sort();
            // Mantener selecciÃ³n si existe
            const prevSel = els.classSel.value;
            els.classSel.innerHTML = keys.map(k => `<option value="${k}">${k}</option>`).join('');
            
            if(keys.includes(prevSel)) els.classSel.value = prevSel;
            else if (!currentClass || !allClassesData[currentClass]) currentClass = keys[0] || null;
            
            if(els.classSel.value) currentClass = els.classSel.value;
            refreshTable();
        }

        function getUniqueEvaluations(list) { const evals = new Set(); list.forEach(s => s.grades.forEach(g => evals.add(g.type || "EVALUACIÃ“N"))); return Array.from(evals).sort(); }

        function refreshTable() {
            if(!currentClass) { els.mainTable.classList.add('hidden'); return; }
            students = allClassesData[currentClass] || []; els.mainTable.classList.remove('hidden');
            const evalCols = getUniqueEvaluations(students);

            let htmlHead = `<tr><th class="p-3 text-left border w-48 bg-slate-50">Estudiante</th><th class="p-3 text-center border w-16 bg-slate-50">Prom</th>`;
            evalCols.forEach(col => htmlHead += `<th class="p-3 text-center border min-w-[80px] bg-indigo-50 text-indigo-700 font-bold text-xs">${col}</th>`);
            htmlHead += `<th class="p-3 text-center border w-24 bg-slate-50">Asistencia</th><th class="p-3 text-center border w-32 bg-slate-50">Acciones</th></tr>`;
            els.tableHeader.innerHTML = htmlHead;

            els.tableBody.innerHTML = students.map((s, idx) => {
                if(!s.grades) s.grades=[]; if(!s.attendance) s.attendance={}; if(!s.observations) s.observations=[];
                const avg = calculateAverage(s.grades); const att = s.attendance[currentDateString]; const hasObs = s.observations.length > 0;
                const cells = evalCols.map(col => {
                    const g = s.grades.slice().reverse().find(gr => (gr.type || "EVALUACIÃ“N") === col);
                    if(g) return `<td class="border p-1 text-center bg-slate-50"><div class="flex items-center justify-center gap-1"><span class="font-bold text-slate-700">${g.value.toFixed(1)}</span><button onclick="window.editGrade(${idx},${s.grades.indexOf(g)})" class="text-[10px] text-indigo-400 hover:text-indigo-700">âœï¸</button></div></td>`;
                    return `<td class="border p-1 text-center empty-grade">-</td>`;
                }).join('');

                return `<tr class="hover:bg-slate-50 transition"><td class="border p-2 font-medium text-slate-700 truncate max-w-[200px]">${s.name}</td><td class="border p-2 text-center font-bold ${parseFloat(avg)<4?'text-rose-500':'text-slate-700'}">${avg}</td>${cells}<td class="border p-1 text-center"><div class="flex justify-center gap-1 scale-90">${renderAtt(idx,'P','bg-emerald-500',att)}${renderAtt(idx,'A','bg-rose-500',att)}${renderAtt(idx,'J','bg-amber-400',att)}</div></td><td class="border p-1"><div class="flex justify-end gap-2 pr-2"><div class="flex items-center border border-slate-300 rounded bg-white"><input type="number" id="g-${idx}" class="w-10 text-center text-xs outline-none font-bold" placeholder="-"><button onclick="window.addGrade(${idx})" class="px-2 bg-slate-100 hover:bg-slate-200 border-l border-slate-300 text-xs font-bold">+</button></div><button onclick="window.openModal(${idx})" class="w-7 h-7 rounded-full flex items-center justify-center ${hasObs?'bg-indigo-100 text-indigo-600':'bg-slate-100 text-slate-400'}">${hasObs?'ğŸ“':'ğŸ’¬'}</button><button onclick="window.delStudent(${idx})" class="text-slate-300 hover:text-rose-500">ğŸ—‘ï¸</button></div></td></tr>`;
            }).join('');
        }

        function renderAtt(idx,t,c,cur) { return `<button onclick="window.setAtt(${idx},'${t}')" class="w-6 h-6 rounded-full text-[10px] font-bold transition ${cur===t?`${c} text-white scale-110 shadow`:'bg-slate-100 text-slate-300 hover:bg-slate-200'}">${t}</button>`; }

        window.setAtt = (i,s) => { students[i].attendance[currentDateString]=s; saveLoc(); }
        window.addGrade = (i) => {
            const v = parseFloat(getEl(`g-${i}`).value); if(isNaN(v)||v<1||v>7) return alert("Nota invÃ¡lida");
            const type = els.evalName.value.trim().toUpperCase() || "EVALUACIÃ“N";
            const exists = students[i].grades.find(g => (g.type||"EVALUACIÃ“N")===type);
            if(exists && !confirm(`Ya existe nota para ${type}. Â¿Agregar igual?`)) return;
            students[i].grades.push({ value:v, date:currentDateString, type:type, id:Date.now() }); getEl(`g-${i}`).value=''; saveLoc();
        }
        window.editGrade = (si, gi) => {
            const g = students[si].grades[gi]; const n = prompt(`Editar ${g.type||"Nota"}:`, g.value);
            if(n==='borrar') students[si].grades.splice(gi,1); else if(n&&!isNaN(parseFloat(n))) students[si].grades[gi].value=parseFloat(n);
            saveLoc();
        }
        window.delStudent = (i) => { if(confirm("Â¿Eliminar?")) { students.splice(i,1); saveLoc(); } }
        
        // --- MODAL Y FOTOS ---
        window.openModal = (i) => { 
            currentStudentIndex=i; pendingPhotoBase64 = null;
            els.modal.el.classList.remove('hidden','flex'); els.modal.el.classList.add('flex');
            els.modal.title.textContent=students[i].name; els.modal.date.value=currentDateString;
            resetPhotoUI();
            renderObs(students[i].observations); 
        }

        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width; let height = img.height;
                        const MAX_WIDTH = 600; 
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function resetPhotoUI() {
            els.modal.photoInput.value = ''; els.modal.photoPreview.src = ''; els.modal.photoPreview.classList.add('hidden'); els.modal.clearPhoto.classList.add('hidden'); els.modal.photoText.classList.add('hidden');
        }

        window.viewPhoto = (base64, caption) => {
            els.photoViewer.img.src = base64; els.photoViewer.caption.textContent = caption;
            els.photoViewer.el.classList.remove('hidden'); els.photoViewer.el.classList.add('flex');
        }

        function renderObs(l) { 
            const s = [...l].sort((a,b)=>new Date(b.date)-new Date(a.date));
            els.modal.history.innerHTML = s.map(o=>`
                <div class="border-b pb-2 mb-2 border-slate-100 flex justify-between items-start">
                    <div>
                        <strong class="text-[10px] text-indigo-500 bg-indigo-50 px-1 rounded">${o.date}</strong>
                        <p class="text-xs text-slate-700 mt-1">${o.text}</p>
                    </div>
                    ${o.photo ? `<button onclick="window.viewPhoto('${o.photo}', '${o.date} - ${o.text.substring(0,20)}...')" class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded hover:bg-indigo-200 flex items-center gap-1">ğŸ“· Ver Foto</button>` : ''}
                </div>`).join('');
        }

        function saveLoc() { masterData[currentYear].classes[currentClass] = students; refreshTable(); }
        async function saveCloud() {
            if(!auth.currentUser) return;
            try { await setDoc(getMyPrivateDocRef(), masterData); els.saveBtn.innerHTML = "âœ… Listo"; els.saveBtn.classList.add("bg-emerald-600"); setTimeout(() => { els.saveBtn.innerHTML = "ğŸ’¾ Guardar Todo"; els.saveBtn.classList.remove("bg-emerald-600"); }, 2000); } catch(e) { alert("Error al guardar: "+e.message); }
        }

        function downloadBackup() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(masterData)); a.download=`Respaldo_${currentDateString}.json`; a.click(); }
        function calculateAverage(g) { if(!g.length) return '0.0'; return (g.reduce((a,b)=>a+b.value,0)/g.length).toFixed(1); }
        function updateDateDisplay() { const d=new Date(currentDateString+'T12:00:00'); getEl('currentDate').textContent = d.toLocaleDateString('es-CL',{weekday:'long',day:'numeric',month:'long',year:'numeric'}); }

        // --- LÃ“GICA IMPORTACIÃ“N CSV ---
        function parseCSV(text) {
            const lines = text.split('\n');
            let addedCount = 0;
            lines.forEach(line => {
                const parts = line.split(','); // Asume CSV simple separado por comas
                if(parts.length >= 2) {
                    const className = parts[0].trim();
                    const studentName = parts[1].trim().toUpperCase();
                    if(className && studentName) {
                        // Crear clase si no existe
                        if(!allClassesData[className]) allClassesData[className] = [];
                        // Agregar estudiante si no existe
                        const exists = allClassesData[className].find(s => s.name === studentName);
                        if(!exists) {
                            allClassesData[className].push({ name: studentName, grades: [], attendance: {}, observations: [] });
                            addedCount++;
                        }
                    }
                }
            });
            if(addedCount > 0) {
                saveLoc();
                saveCloud();
                loadYearData(currentYear);
                alert(`âœ… Se importaron ${addedCount} estudiantes nuevos.`);
            } else {
                alert("â„¹ï¸ No se encontraron estudiantes nuevos o el formato es incorrecto.");
            }
        }

        function setupEvents() {
            els.loginForm.onsubmit = handleLogin;
            getEl('btnLogout').onclick = () => { if(confirm("Salir?")) signOut(auth).then(()=>location.reload()); };
            els.saveBtn.onclick = saveCloud;
            els.addStudentBtn.onclick = () => { const n=getEl('studentNameInput').value.trim().toUpperCase(); if(n&&!students.find(s=>s.name===n)){ students.push({name:n,grades:[],attendance:{},observations:[]}); getEl('studentNameInput').value=''; saveLoc(); } };
            els.addClassBtn.onclick = () => { const n=prompt("Nombre curso:"); if(n&&!allClassesData[n]) { allClassesData[n]=[]; saveLoc(); saveCloud(); loadYearData(currentYear); } };
            
            // IMPORT CSV
            els.importBtn.onclick = () => els.csvInput.click();
            els.csvInput.onchange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => parseCSV(e.target.result);
                    reader.readAsText(file); // Importante para CSV
                }
                els.csvInput.value = ''; // Reset
            };

            els.backupBtn.onclick = downloadBackup;
            
            els.yearSel.onchange = (e) => loadYearData(e.target.value);
            els.classSel.onchange = (e) => { currentClass=e.target.value; refreshTable(); };
            els.dateSel.onchange = (e) => { currentDateString=e.target.value; updateDateDisplay(); refreshTable(); };

            els.modal.close.onclick = () => els.modal.el.classList.add('hidden');
            els.photoViewer.close.onclick = () => els.photoViewer.el.classList.add('hidden');
            
            els.modal.photoInput.onchange = async (e) => {
                if(e.target.files && e.target.files[0]) {
                    pendingPhotoBase64 = await compressImage(e.target.files[0]);
                    els.modal.photoPreview.src = pendingPhotoBase64;
                    els.modal.photoPreview.classList.remove('hidden');
                    els.modal.photoText.classList.remove('hidden');
                    els.modal.clearPhoto.classList.remove('hidden');
                }
            };
            els.modal.clearPhoto.onclick = () => { pendingPhotoBase64 = null; resetPhotoUI(); };

            els.modal.save.onclick = () => { 
                const t=els.modal.input.value.trim(); const d=els.modal.date.value; 
                if((t || pendingPhotoBase64) && d) { 
                    students[currentStudentIndex].observations.push({ text:t, date:d, photo: pendingPhotoBase64, id:Date.now() }); 
                    els.modal.el.classList.add('hidden'); els.modal.input.value=''; pendingPhotoBase64=null; 
                    saveLoc(); 
                } 
            };

            getEl('showReportBtn').onclick = () => generateReport('summary');
            getEl('showDetailedReportBtn').onclick = () => generateReport('detail');
            getEl('backToTableBtn').onclick = () => { els.tableContainer.classList.remove('hidden'); els.controls.classList.remove('hidden'); els.backNav.classList.add('hidden'); els.reportSummary.classList.add('hidden'); els.reportDetail.classList.add('hidden'); };
            getEl('printReportBtn').onclick = () => window.print();
        }

        function generateReport(type) {
            if(!currentClass) return;
            els.tableContainer.classList.add('hidden'); els.controls.classList.add('hidden'); els.backNav.classList.remove('hidden');
            if(type==='summary') {
                els.reportSummary.classList.remove('hidden'); els.reportDetail.classList.add('hidden');
                const data = Object.keys(allClassesData).map(c=>{ const l=allClassesData[c]; let p=0,a=0,j=0,t=0; l.forEach(s=>Object.values(s.attendance||{}).forEach(v=>{ if(v==='P')p++;if(v==='A')a++;if(v==='J')j++;t++; })); return {c, count:l.length, p,a,j, rate: t?((p+j)/t*100).toFixed(1)+'%':'N/A'}; });
                els.reportSummary.innerHTML = `<h2 class="text-xl font-bold mb-4 text-center">Resumen General ${currentYear}</h2><table class="w-full text-sm text-left"><thead class="bg-slate-100 uppercase"><tr><th class="px-4 py-2">Clase</th><th class="px-4 py-2 text-center">MatrÃ­cula</th><th class="text-center px-4 py-2 text-green-600">P</th><th class="text-center px-4 py-2 text-rose-600">A</th><th class="text-center px-4 py-2">%</th></tr></thead><tbody>${data.map(d=>`<tr class="border-b"><td class="px-4 py-2 font-medium">${d.c}</td><td class="text-center">${d.count}</td><td class="text-center text-green-600 font-bold">${d.p}</td><td class="text-center text-rose-600 font-bold">${d.a}</td><td class="text-center font-bold">${d.rate}</td></tr>`).join('')}</tbody></table>`;
            } else {
                els.reportDetail.classList.remove('hidden'); els.reportSummary.classList.add('hidden');
                const list = allClassesData[currentClass];
                const dates = new Set(); list.forEach(s=>Object.keys(s.attendance||{}).forEach(d=>dates.add(d)));
                const sortedDates = Array.from(dates).sort();
                const evalCols = getUniqueEvaluations(list);
                els.reportDetail.innerHTML = `<h2 class="text-xl font-bold mb-4 text-center">Detalle: ${currentClass}</h2><table class="w-full text-xs border border-slate-200"><thead class="bg-slate-100"><tr><th class="px-2 py-2 text-left border w-40">Estudiante</th><th class="px-1 py-2 border w-10">Prom</th>${evalCols.map(e=>`<th class="px-1 py-2 border bg-indigo-50 text-indigo-700 w-12">${e}</th>`).join('')}${sortedDates.map(d=>`<th class="px-1 py-2 border w-8">${d.slice(5)}</th>`).join('')}<th class="px-2 py-2 text-left border">Obs</th></tr></thead><tbody>${list.map((s,i)=>{
                    const grades = evalCols.map(c=>{ const g=s.grades.slice().reverse().find(gr=>(gr.type||"EVALUACIÃ“N")===c); return `<td class="text-center border font-bold ${g?'text-slate-700':'text-slate-200'}">${g?g.value.toFixed(1):'-'}</td>`; }).join('');
                    const atts = sortedDates.map(d=>{ const v=s.attendance[d]||'-'; let c='text-slate-300'; if(v==='P')c='bg-green-100 text-green-700 font-bold'; if(v==='A')c='bg-rose-100 text-rose-700 font-bold'; return `<td class="text-center border ${c}">${v}</td>`; }).join('');
                    const obs = s.observations.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(o=>`${o.date}: ${o.text} ${o.photo?'(ğŸ“·)':''}`).join(' | ');
                    return `<tr class="${i%2===0?'bg-white':'bg-slate-50'}"><td class="px-2 py-2 border font-medium truncate max-w-[150px]">${s.name}</td><td class="px-1 py-2 border text-center font-bold bg-slate-100">${calculateAverage(s.grades)}</td>${grades}${atts}<td class="px-2 py-2 border text-[10px] leading-tight">${obs}</td></tr>`;
                }).join('')}</tbody></table>`;
            }
        }

        window.onload = initApp;
    </script>
</body>
</html>