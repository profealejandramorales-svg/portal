<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Privado - ProfeAle Admin v9.7 (2026 Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .grade-cell { min-width: 70px; text-align: center; }
        .empty-grade { color: #d1d5db; font-style: italic; font-size: 0.7rem; }
        .btn-action { transition: all 0.2s; } .btn-action:hover { transform: translateY(-1px); }
        .print-only { display: none; }
        @media print {
            .no-print { display: none !important; }
            .printable-container { margin: 0; padding: 0; box-shadow: none; width: 100% !important; max-width: 100% !important; }
            body { background-color: white; }
            .print-only { display: block; }
            #printHeader { position: fixed; top: 0; left: 0; width: 100%; background-color: white; border-bottom: 2px solid #3730a3; padding: 10px 40px; margin-bottom: 20px; z-index: 1000; }
            body > .printable-container { padding-top: 100px; }
            table { font-size: 10px; width: 100%; }
            th, td { padding: 4px !important; border: 1px solid #9ca3af !important; }
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center min-h-screen py-6">

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center border-t-4 border-indigo-600">
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">ProfeAle Admin</h1>
            <p class="text-slate-500 text-sm mt-1 mb-6">Acceso Privado + Generador PDF</p>
            <form id="loginForm" class="space-y-4 text-left">
                <input type="email" id="emailInput" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="admin@profeale.cl" required>
                <input type="password" id="passwordInput" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                <div id="authErrorMsg" class="text-rose-500 text-xs text-center font-bold hidden"></div>
                <button type="submit" id="btnLogin" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition shadow-md">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="printHeader" class="print-only">
        <div class="flex items-center justify-between w-full">
            <div class="w-1/3"><h3 class="font-bold">ProfeAle</h3></div>
            <div class="w-1/3 text-center"><h3 class="text-xl font-bold uppercase">Informe Acad√©mico</h3></div>
            <div class="w-1/3 text-right text-xs"><p class="print-date-placeholder">--/--/----</p></div>
        </div>
    </div>

    <div class="printable-container bg-white p-6 rounded-2xl shadow-xl max-w-[95%] w-full">
        
        <div class="no-print flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
            <div class="flex items-center gap-4">
                <img src="logo.jpg" id="schoolLogo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/167/167707.png'" alt="Logo" class="h-16 object-contain hover:scale-105 transition-transform">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">Panel de Control</h1>
                    <div class="flex items-center gap-2 text-xs">
                        <span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-bold">Admin v9.7</span>
                        <span id="userIdDisplay" class="text-slate-400">...</span>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-end gap-2">
                <input type="file" id="csvInput" accept=".csv" class="hidden">
                <button id="importBtn" class="bg-blue-100 text-blue-700 hover:bg-blue-200 text-xs font-bold py-1 px-3 rounded border border-blue-200 transition flex items-center gap-1">üìÇ Importar N√≥mina CSV</button>
                <button id="backupBtn" class="bg-rose-100 text-rose-700 hover:bg-rose-200 text-xs font-bold py-1 px-3 rounded border border-rose-200 transition">üíæ Descargar Respaldo JSON</button>
                <button id="btnLogout" class="text-xs font-bold text-slate-400 hover:text-slate-600 underline">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <p id="currentDate" class="text-slate-500 text-center mb-4 no-print text-sm font-medium capitalize"></p>

        <div id="controlsContainer" class="no-print bg-slate-50 border border-slate-200 rounded-xl p-5 mb-6 shadow-sm">
             <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                 <div class="md:col-span-1"><label class="block text-xs font-bold text-indigo-600 uppercase mb-1">A√±o</label><select id="yearSelector" class="w-full p-2 border-2 border-indigo-100 rounded text-sm font-bold text-indigo-700"><option value="2025">2025</option><option value="2026" selected>2026</option></select></div>
                 <div class="md:col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Clase</label><div class="flex"><select id="classSelector" class="w-full p-2 border border-slate-300 rounded-l text-sm"></select><button id="addClassBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold px-2 rounded-r" title="Nueva Clase">+</button></div></div>
                 <div class="md:col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label><input type="date" id="dateSelector" class="w-full p-2 border border-slate-300 rounded text-sm"></div>
                 <div class="md:col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Evaluaci√≥n</label><input type="text" id="evalNameInput" placeholder="Ej: PRUEBA 1" class="w-full p-2 border border-slate-300 rounded text-sm uppercase font-semibold text-slate-700"></div>
                 <div class="md:col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Estudiante</label><div class="flex"><input type="text" id="studentNameInput" placeholder="Nombre" class="w-full p-2 border border-slate-300 rounded-l text-sm" /><button id="addStudentBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold px-3 rounded-r transition">+</button></div></div>
                 <div class="md:col-span-1"><button id="saveDataBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded shadow-md btn-action text-sm">üíæ Guardar Todo</button></div>
             </div>
        </div>

        <div id="backToTableContainer" class="no-print hidden mb-4"><button id="backToTableBtn" class="text-indigo-600 font-bold hover:underline flex items-center gap-1">‚Üê Volver al Panel Principal</button></div>

        <div id="studentsTableContainer" class="printable-container overflow-x-auto min-h-[300px]">
            <div id="loadingIndicator" class="text-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
                <p class="text-slate-400 font-medium">Cargando base de datos...</p>
                <p id="loadingError" class="text-red-500 text-xs mt-2 hidden">Error de conexi√≥n.</p>
            </div>
            <table id="mainTable" class="w-full hidden border-collapse text-sm">
                <thead id="tableHeader" class="bg-slate-100 text-slate-500 uppercase text-xs font-bold border-b-2 border-slate-200"></thead>
                <tbody id="tableBody" class="bg-white"></tbody>
            </table>
        </div>

        <div id="classReportContainer" class="hidden mt-6 printable-container"></div>
        <div id="classDetailsContainer" class="hidden mt-6 printable-container"></div>
        
        <div id="reportButtons" class="no-print mt-8 pt-6 border-t border-slate-100 flex flex-wrap justify-center gap-4">
            <button id="showReportBtn" class="px-5 py-2 bg-white border border-slate-300 rounded-full text-slate-700 font-bold shadow-sm hover:bg-slate-50 transition text-sm">üìä Resumen</button>
            <button id="showDetailedReportBtn" class="px-5 py-2 bg-white border border-slate-300 rounded-full text-slate-700 font-bold shadow-sm hover:bg-slate-50 transition text-sm">üìã Detallado</button>
            <button id="printReportBtn" class="px-5 py-2 bg-slate-800 text-white rounded-full font-bold shadow-md hover:bg-slate-900 transition text-sm flex items-center gap-2">üñ®Ô∏è Imprimir</button>
        </div>

        <div id="observationModal" class="no-print fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[95vh]">
                <div class="bg-indigo-600 p-3 flex justify-between items-center">
                    <h3 class="text-md font-bold text-white flex items-center gap-2"><span>üí¨</span> <span id="modalTitle">Observaciones</span></h3>
                    <button id="closeObservationModalBtn" class="text-white hover:text-gray-200 font-bold text-lg leading-none">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto bg-slate-50 flex-1">
                    <div id="observationHistory" class="space-y-3 mb-4"></div>
                    <div class="bg-white p-3 rounded border border-slate-200 shadow-sm relative">
                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Fecha</label>
                        <input type="date" id="obsDateInput" class="w-full mb-2 p-1.5 border border-slate-300 rounded text-sm font-bold text-slate-700">
                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Observaci√≥n</label>
                        <textarea id="newObservationText" class="w-full text-sm text-slate-700 border border-slate-200 rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none resize-none h-20 placeholder:text-slate-300 mb-2" placeholder="Escribe el detalle..."></textarea>
                    </div>
                </div>
                <div class="p-3 bg-white border-t border-slate-100 flex justify-end">
                    <button id="saveObservationBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-6 rounded shadow transition text-sm">Guardar</button>
                </div>
            </div>
        </div>

    </div>
    
    <div id="printFooter" class="print-only text-center text-xs text-slate-400 mt-2">Sistema Privado ProfeAle</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- N√ìMINA 2025 (HIST√ìRICA) ---
        const LISTA_2025 = {
            "Primero Medio A": ['ALBURQUENQUE DEL GRECCO EMILYA ANTONIA', 'ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS', 'CONTRERAS SALGADO HADEEY ALEJANDRA', 'FERRADA ALBORNOZ AGUST√çN ALEXIS', 'HERN√ÅNDEZ FERN√ÅNDEZ DHARIEN ALEXSANDER', 'IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA', 'LAGOS LASTRA ALEXANDRA DANAE', 'L√ìPEZ L√ìPEZ LUCIANO ANTONIO', 'MALDONADO FLORES ANTONELLA BEL√âN', 'MARIN MAR√çN IGNACIO ANTONIO', 'MONTECINO D√çAZ VALESKA BEL√âN', 'MU√ëOZ CONTRERAS LUIS GABRIEL', 'MU√ëOZ LUNA ROGER JOEL', 'NAVARRO VILLANUEVA KARLA PAZ', 'ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS', 'QUEZADA NARANJO FELIPE ALONSO', 'QUINTEROS VERGARA FERNANDA FLORENCIA', 'RAM√çREZ VILLALOBOS DUVAN EMILIO', 'SANTANDER L√ìPEZ MAR√çA JOS√â', 'TAPIA CASTILLA JEANFRANCO PATRICK', 'URBINA C√ÅCERES FRANCHESCA POULETTE', 'V√ÅSQUEZ ZALDUENDO AMANDA ISABEL', 'ZABALAGA COFR√â DAMI√ÅN ANDR√âS', 'BAEZ DONOSO LUKAS ALFONSO', 'MESA D√çAZ GONZALO IGNACIO', 'BAREA SALGADO SERGIO ALEXANDER'],
            "Primero Medio B": ['ARAVENA Z√ö√ëIGA NOEM√ç JES√öS DE LAS ESTRELLAS', 'ASTUDILLO CAMPOS CRIST√ìBAL ANTONIO', 'ASTUDILLO V√ÅSQUEZ BRUNO FERNANDO LE√ìN', 'CASTILLO MU√ëOZ REN√â ANTONIO', 'CID CERDA MAR√çA EVANGELINA', 'CUMINAO VIDAL CATALINA ANDREA', 'D√çAZ MALUENDA MIGUEL ALBERTO', 'KILTAN GONZ√ÅLEZ DIDIER EZEQUIEL', 'L√ìPEZ ACU√ëA MARCO EMILIO', 'L√ìPEZ NOVOA EYDAN DAMI√ÅN', 'M√âNDEZ SUAZO FABI√ÅN FELIPE', 'MOYA REYES MATEO ANTONIO BENJAM√çN', 'OSES CAMPOS VALENTINA ABIGAIL', 'PALMA ORELLANA ANTONELLA FRANCISCA', 'PEREIRA ORELLANA MONSERRAT ALAMIRA', 'P√âREZ ORMAZ√ÅBAL ZADKA ALEJANDRA', 'ROJAS GONZ√ÅLEZ FLORENCIA TRINIDAD', 'ROJAS LEIVA EDUARDO JAVIER', 'V√ÅSQUEZ AGUILERA SCARLET NICOLE', 'Y√Å√ëEZ GONZ√ÅLEZ BRAYAN DAMI√ÅN', 'VARGAS MORAGA MARTINA SAYEN', 'SALAZAR SALAS PEDRO JOS√â', 'VERA BRAVO FLORENCIA ANTONIA', 'P√âREZ QUEVEDO CONSTANZA TRINIDAD', 'SALGADO TOLEDO FRANCISCO JAVIER', 'RIQUELME SANTOS BENJAM√çN ALONSO'],
            "Segundo Medio A": ['AHUMADA ROJAS TRINIDAD BEL√âN', 'ESPINOSA TORRES FERNANDA ELENA', 'ESPINOZA PE√ëALILLO BRAYAN JES√öS', 'GONZ√ÅLEZ SALAZAR EMILIA CATALINA', 'MEDEL OJEDA LE√ìN IGNACIO', 'MORALES REIM√ÅN ALFONSO TOM√ÅS', 'PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO', 'PINTO TOBAR JORD√ÅN AMARO', 'RECABAL Y√Å√ëEZ KEVIN ANDR√âS', 'RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO', 'RIVERA ABARZA CONSTANZA VICTORIA', 'SANTIS CASSEUS TEIVA SCARLETT', 'SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN', 'TOLEDO ALBORNOZ ANTONELLA INES', 'VENEGAS ARRIAGADA ANTONIA EDITH', 'VIELMA ZABALAGA JOAN MANUEL', 'MEZA COLIM√ÅN ANGEL BLAS', 'PALMA ORELLANA ANTONELLA FRANCISCA'],
            "Segundo Medio B": ['ARAYA DOM√çNGUEZ ALEX FABI√ÅN', 'BRAVO MENARES ALEX JOHAN', 'CARRASCO LEIVA BENJAM√çN IGNACIO', 'CARVAJAL URRUTIA CONSTANZA PRISILA (DANIEL)', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO', 'JARAMILLO VILLAR EMILIO SCOTT', 'L√ìPEZ VILLAR MART√çN ALONSO', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA', 'MU√ëOZ TRONCOSO H√âCTOR ANTONIO', 'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA', 'ORELLANA GARRIDO MAT√çAS LEANDRO', 'PUNOY MEDEL MILLARAY ANG√âLICA', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO', 'RIQUELME COLOMA DALIA CONSTANZA', 'SALGADO ROJAS VICENTE MOIS√âS', 'SANDOVAL CERPA VICENTE ESTEBAN', 'SOTO NARANJO CHRISTOPHER', 'VEKARIC VERDEJO MART√çN'],
            "Tercero Medio A": ['ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA', 'BAHAMONDE MU√ëOZ ARIEL LEON', 'CAMPOS MU√ëOZ CRISTOPHER JES√öS', 'CANCINO OR√ìSTICA VICENTE GASPAR', 'CARRASCO GONZ√ÅLEZ CAMILA ANDREA', 'COFR√â CASTILLO ANTONIO ANDR√âS', 'CONTRERAS VENEGAS BEL√âN ALEJANDRA', 'GALDAMES VERGARA FELIPE ESTEBAN', 'GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO', 'GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA', 'GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO', 'GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN', 'JARA SEP√öLVEDA KATRINA DARINKA', 'MART√çNEZ LIZANA AARON ALEJANDRO', 'MEZA CARRASCO BENJAM√çN INTI', 'MI√ëO GONZALEZ CATALINA ANDREA', 'MORAGA PACHECO RENATO IGNACIO', 'P√âREZ COR√ìN MANUEL IGNACIO', 'SAMANIEGO CORTEZ JAKSON FERGIE', 'SEP√öLVEDA SALAZAR SOF√çA ANTONIA', 'TAPIA ACU√ëA GABRIEL ANTONIO', 'VEGA VIVANCO CRIST√ìBAL ANTONIO', 'VERA NAVARRETE DANIELA ELIZABETH', 'VILLALOBOS ARAVENA KARINA ANGELINA', 'VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS', 'HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO', 'TORREALBA MOYA FLORVELIS DE LOS ANGELES', 'CARO URRUTIA CONSUELO ANTONIA', 'LOBOS C√ÅCERES ANTONIA PAZ'],
            "Tercero Medio C": ['ARELLANO ACU√ëA MART√çN ANTONIO', 'AROS √ÅVILA DAYANA IGNACIA', 'CABRERA COLOMBINO MAR√çA GRACIA', 'FUENTES CARRASCO YARIXA ALEJANDRA', 'G√ìMEZ CANCINO DANIELA ALEJANDRA', 'GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA', 'HONORATO TAPIA GLORIA JAVIERA', 'LARA RIVERA BENJAM√çN ESTEBAN', 'PALACIOS SOTO JOS√â TOM√ÅS', 'PEZO SANTANDER JOS√â CRIST√ìBAL', 'ROCHA ROJAS JOS√â PABLO WILLIAMS', 'ROJAS Y√âVENES FABIANA ISIDORA', 'S√ÅNCHEZ PAREJA ANDY ANTONIO', 'SANTANDER L√ìPEZ SIM√ìN ESTEBAN', 'TRONCOSO LIZAMA SIOMARA IGNACIA', 'WARNKEN ROJAS LUCIANA BERNABELA', 'DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN', 'COLLAO MEDINA ANA√çS VALENTINA'],
            "Cuarto Medio A": ['AGURTO CRESPO HOMERO ALEXANDER', 'ANDIA DE LA HOZ CATALINA BELEN', 'FUENTES GONZ√ÅLEZ ESTEBAN ALEXANDER', 'GARC√çA ROJAS SOF√çA ELENA', 'GODOY HERRERA ANTONELLA CONSTANZA PAZ', 'GONZ√ÅLEZ CASTRO KEVIN ALEJANDRO', 'MARCHANT MOR√ÅN P√çA IGNACIA', 'QUINTANA SAN MART√çN ALAN VICENTE', 'RECABAL Y√Å√ëEZ CRISTOFER BASTI√ÅN', 'ROJAS GONZ√ÅLEZ GABRIEL ANTONIO', 'TOLEDO MU√ëOZ ESPERANZA BEL√âN', 'Y√Å√ëEZ GONZ√ÅLEZ FRANCISCA ALEJANDRA'],
            "Cuarto Medio C": ['Josefa Morales', 'Benjam√≠n P√©rez', 'Constanza Varela']
        };

        // --- N√ìMINA 2026 (OFICIAL NUEVA) ---
        const LISTA_2026 = {
            "1A": [
                '√ÅLVAREZ FA√öNDEZ MATEO VICENTE', 'CASTILLO ARAVENA MAITE PASCAL', 'COLLADO PUENTES SANTINO ALEXANDER', 'CONCHA TORREALBA JOAQU√çN IGNACIO', 'D√çAZ MALUENDA ESTEFAN√çA ANTONIA', 'DONAIRE ROJAS MAITE EMILIA ESTER', 'ESPINOZA CACHA√ëA LISBET ALEXANDRA', 'FERRADA ALBORNOZ AGUST√çN ALEXIS', 'FUENTEMAVIDA BARROS OSCAR ANTONIO', 'JAQUE PACHECO DAMI√ÅN IGNACIO', 'JARAMILLO VILLAR MATT HOST', 'L√ìPEZ ACU√ëA MARCO EMILIO', 'L√ìPEZ VILLAR FRANCO IGNACIO', 'MESA D√çAZ GONZALO IGNACIO', 'MEZA CARRASCO CRISTIAN ALFONSO', 'MORALES GARRIDO NICOL√ÅS ANTONIO', 'ORTEGA DA SILVA EMILIA CATALINA SOPHIA', 'PEREIRA TAPIA KEVIN RUB√âN', 'RAM√çREZ SEP√öLVEDA LUIS JUSTIN JES√öS', 'RAM√çREZ VALD√âS MARTINA POLETTE', 'RECABAL Y√Å√ëEZ TOM√ÅS IGNACIO', 'RODR√çGUEZ SEP√öLVEDA SIMONEY ISAMAR', 'ROJAS √ìRDENES TRACY MAIDEN', 'S√ÅNCHEZ MUNIZAGA ALONDRA ANA√çS', 'SOLIZ OLGUIN BRAYAN', 'VALENZUELA MU√ëOZ MAGDALENA BEL√âN'
            ],
            "2A": [
                'ALBURQUENQUE DEL GRECCO EMILYA ANTONIA', 'ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS', 'ARAVENA Z√ö√ëIGA NOEM√ç JES√öS DE LAS ESTRELLAS', 'ARAYA DOM√çNGUEZ ALEX FABI√ÅN', 'ASTUDILLO CAMPOS CRIST√ìBAL ANTONIO', 'ASTUDILLO V√ÅSQUEZ BRUNO FERNANDO LE√ìN', 'BAEZ DONOSO LUKAS ALFONSO', 'CARO BUSTOS KRISCHNA ESTEFANIA', 'CONTRERAS SALGADO HADEEY ALEJANDRA', 'CUMINAO VIDAL CATALINA ANDREA', 'D√çAZ MALUENDA MIGUEL ALBERTO', 'IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA', 'KILTAN GONZ√ÅLEZ DIDIER EZEQUIEL', 'LAGOS LASTRA ALEXANDRA DANAE', 'L√ìPEZ L√ìPEZ LUCIANO ANTONIO', 'L√ìPEZ NOVOA EYDAN DAMI√ÅN', 'MALDONADO FLORES ANTONELLA BEL√âN', 'MONTECINO D√çAZ VALESKA BEL√âN', 'MOYA REYES MATEO ANTONIO BENJAM√çN', 'MU√ëOZ CONTRERAS LUIS GABRIEL', 'MU√ëOZ LUNA ROGER JOEL', 'NAVARRO VILLANUEVA KARLA PAZ', 'ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS', 'OSES CAMPOS VALENTINA ABIGAIL', 'PALMA ORELLANA ANTONELLA FRANCISCA', 'PEREIRA ORELLANA MONSERRAT ALAMIRA', 'P√âREZ ORMAZ√ÅBAL ZADKA ALEJANDRA', 'P√âREZ QUEVEDO CONSTANZA TRINIDAD', 'QUEZADA NARANJO FELIPE ALONSO', 'RAM√çREZ VILLALOBOS DUVAN EMILIO', 'RIQUELME SANTOS BENJAM√çN ALONSO', 'ROJAS GONZ√ÅLEZ FLORENCIA TRINIDAD', 'ROJAS LEIVA EDUARDO JAVIER', 'SALAZAR SALAS PEDRO JOS√â', 'SANTANDER L√ìPEZ MAR√çA JOS√â', 'TAPIA CASTILLA JEANFRANCO PATRICK', 'URBINA C√ÅCERES FRANCHESCA POULETTE', 'VARGAS MORAGA MARTINA SAYEN', 'V√ÅSQUEZ AGUILERA SCARLET NICOLE', 'V√ÅSQUEZ ZALDUENDO AMANDA ISABEL', 'VERA BRAVO FLORENCIA ANTONIA', 'Y√Å√ëEZ GONZ√ÅLEZ BRAYAN DAMI√ÅN', 'ZABALAGA COFR√â DAMI√ÅN ANDR√âS'
            ],
            "3A": [
                'AHUMADA ROJAS TRINIDAD BEL√âN', 'CORNEJO CASTILLO OSCAR GABRIEL', 'ESPINOZA PE√ëALILLO BRAYAN JES√öS', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO', 'JARAMILLO VILLAR EMILIO SCOTT', 'L√ìPEZ VILLAR MART√çN ALONSO', 'MEZA COLIM√ÅN ANGEL BLAS', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA', 'MORAGA PACHECO RENATO IGNACIO', 'MORALES REIM√ÅN ALFONSO TOM√ÅS', 'ORELLANA GARRIDO MAT√çAS LEANDRO', 'PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO', 'PINTO TOBAR JORD√ÅN AMARO', 'RECABAL Y√Å√ëEZ KEVIN ANDR√âS', 'SANDOVAL CERPA VICENTE ESTEBAN', 'SOTO NARANJO CHRISTOPHER', 'VEKARIC VERDEJO MART√çN', 'VIELMA ZABALAGA JOAN MANUEL'
            ],
            "3C": [
                'BRAVO MENARES ALEX JOHAN', 'CARRASCO LEIVA BENJAM√çN IGNACIO', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER', 'ESPINOSA TORRES FERNANDA ELENA', 'GONZ√ÅLEZ SALAZAR EMILIA CATALINA', 'MEDEL OJEDA LE√ìN IGNACIO', 'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA', 'PUNOY MEDEL MILLARAY ANG√âLICA', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO', 'RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO', 'RIQUELME COLOMA DALIA CONSTANZA', 'RIVERA ABARZA CONSTANZA VICTORIA', 'SAAVEDRA BRAVO FLORENCIA ALEJANDRA', 'SALGADO ROJAS VICENTE MOIS√âS', 'SANTIS CASSEUS TEIVA SCARLETT', 'SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN', 'TOLEDO ALBORNOZ ANTONELLA INES', 'VENEGAS ARRIAGADA ANTONIA EDITH'
            ],
            "4A": [
                'ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA', 'BAHAMONDE MU√ëOZ ARIEL LEON', 'CAMPOS MU√ëOZ CRISTOPHER JES√öS', 'CANCINO OR√ìSTICA VICENTE GASPAR', 'CARO URRUTIA CONSUELO ANTONIA', 'CARRASCO GONZ√ÅLEZ CAMILA ANDREA', 'COFR√â CASTILLO ANTONIO ANDR√âS', 'GALDAMES VERGARA FELIPE ESTEBAN', 'GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO', 'GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA', 'GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO', 'GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN', 'HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO', 'LOBOS C√ÅCERES ANTONIA PAZ', 'MART√çNEZ LIZANA AARON ALEJANDRO', 'MEZA CARRASCO BENJAM√çN INTI', 'MI√ëO GONZALEZ CATALINA ANDREA', 'P√âREZ COR√ìN MANUEL IGNACIO', 'SAMANIEGO CORTEZ JAKSON FERGIE', 'SEP√öLVEDA SALAZAR SOF√çA ANTONIA', 'TAPIA ACU√ëA GABRIEL ANTONIO', 'TORREALBA MOYA FLORVELIS DE LOS ANGELES', 'VEGA VIVANCO CRIST√ìBAL ANTONIO', 'VERA NAVARRETE DANIELA ELIZABETH', 'VILLALOBOS ARAVENA KARINA ANGELINA', 'VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS'
            ],
            "4C": [
                'ARELLANO ACU√ëA MART√çN ANTONIO', 'AROS √ÅVILA DAYANA IGNACIA', 'CABRERA COLOMBINO MAR√çA GRACIA', 'COLLAO MEDINA ANA√çS VALENTINA', 'DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN', 'FUENTES CARRASCO YARIXA ALEJANDRA', 'G√ìMEZ CANCINO DANIELA ALEJANDRA', 'GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA', 'HONORATO TAPIA GLORIA JAVIERA', 'LARA RIVERA BENJAM√çN ESTEBAN', 'PALACIOS SOTO JOS√â TOM√ÅS', 'PEZO SANTANDER JOS√â CRIST√ìBAL', 'ROCHA ROJAS JOS√â PABLO WILLIAMS', 'ROJAS Y√âVENES FABIANA ISIDORA', 'S√ÅNCHEZ PAREJA ANDY ANTONIO', 'SANTANDER L√ìPEZ SIM√ìN ESTEBAN', 'TRONCOSO LIZAMA SIOMARA IGNACIA', 'WARNKEN ROJAS LUCIANA BERNABELA'
            ]
        };

        const firebaseConfig = { apiKey: "AIzaSyAFp6biz1UTr9Ehaudkpe7QyTFVbdQz5Sc", authDomain: "asistencia-mi-clase.firebaseapp.com", projectId: "asistencia-mi-clase", storageBucket: "asistencia-mi-clase.appspot.com", messagingSenderId: "552398254230", appId: "1:552398254230:web:c58dd07e5ceeb67e0912b7", measurementId: "G-MYR01HM1YE" };
        const appId = firebaseConfig.appId;

        let app, db, auth, userId = null;
        let masterData = {}; 
        let currentYear = "2026"; 
        let allClassesData = {};
        let currentClass = null;
        let students = [];
        let currentStudentIndex = -1;
        let currentDateString = new Date().toISOString().slice(0, 10);

        const getEl = (id) => document.getElementById(id);
        const els = {
            loginOverlay: getEl('loginOverlay'), loginForm: getEl('loginForm'), email: getEl('emailInput'), pass: getEl('passwordInput'), authError: getEl('authErrorMsg'),
            mainTable: getEl('mainTable'), tableHeader: getEl('tableHeader'), tableBody: getEl('tableBody'), tableContainer: getEl('studentsTableContainer'),
            yearSel: getEl('yearSelector'), classSel: getEl('classSelector'), dateSel: getEl('dateSelector'), evalName: getEl('evalNameInput'),
            saveBtn: getEl('saveDataBtn'), addStudentBtn: getEl('addStudentBtn'), addClassBtn: getEl('addClassBtn'), backupBtn: getEl('backupBtn'),
            importBtn: getEl('importBtn'), csvInput: getEl('csvInput'),
            reportSummary: getEl('classReportContainer'), reportDetail: getEl('classDetailsContainer'), backNav: getEl('backToTableContainer'), controls: getEl('controlsContainer'), reportBtns: getEl('reportButtons'),
            modal: { el: getEl('observationModal'), title: getEl('modalTitle'), history: getEl('observationHistory'), input: getEl('newObservationText'), date: getEl('obsDateInput'), save: getEl('saveObservationBtn'), close: getEl('closeObservationModalBtn') }
        };

        function getMyPrivateDocRef() { 
            return doc(db, `artifacts/${appId}/public/data/calificaciones/master_data`); 
        }

        async function initApp() {
            try {
                app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
                const today = new Date(); const offset = today.getTimezoneOffset() * 60000;
                currentDateString = new Date(today.getTime() - offset).toISOString().slice(0, 10);
                els.dateSel.value = currentDateString; updateDateDisplay();
                onAuthStateChanged(auth, user => {
                    if (user) { userId = user.uid; getEl('userIdDisplay').textContent = user.email; els.loginOverlay.classList.add('hidden'); loadData(); }
                    else { els.loginOverlay.classList.remove('hidden'); }
                });
                setupEvents();
            } catch (e) { alert("Error cr√≠tico: " + e.message); }
        }

        async function handleLogin(e) { e.preventDefault(); els.authError.classList.add('hidden'); try { await signInWithEmailAndPassword(auth, els.email.value, els.pass.value); } catch (error) { els.authError.textContent = "Error: " + error.message; els.authError.classList.remove('hidden'); } }

        function loadData() {
            onSnapshot(getMyPrivateDocRef(), (docSnap) => {
                getEl('loadingIndicator').style.display = 'none';
                let raw = docSnap.exists() ? docSnap.data() : null;
                if (!raw) { masterData = { "2025": { classes: {} }, "2026": { classes: {} } }; } 
                else if (raw.classes && !raw["2025"]) { masterData = { "2025": { classes: raw.classes }, "2026": { classes: {} } }; } 
                else { masterData = raw; }
                
                if(!masterData["2025"]) masterData["2025"] = { classes: {} };
                if(!masterData["2026"]) masterData["2026"] = { classes: {} };

                let modified = false;

                // --- AUTOCORRECCI√ìN 2026: Si est√° vac√≠a O incorrecta, forzar la nueva lista ---
                const classKeys2026 = Object.keys(masterData["2026"].classes);
                const shouldFix2026 = classKeys2026.length === 0 || 
                    (masterData["2026"].classes["1A"] && masterData["2026"].classes["1A"][0].name !== LISTA_2026["1A"][0]);

                if (shouldFix2026) {
                    console.log("Corrigiendo n√≥mina 2026...");
                    for (const [clsName, studentList] of Object.entries(LISTA_2026)) {
                        // Preservar datos existentes si coinciden los nombres, sino reiniciar
                        // Para simplificar: Si detectamos error masivo, reiniciamos la lista base preservando notas si es posible, 
                        // pero aqu√≠ forzaremos la estructura correcta.
                        masterData["2026"].classes[clsName] = studentList.map(name => ({ name: name, grades: [], attendance: {}, observations: [] }));
                    }
                    modified = true;
                }

                // --- AUTOCORRECCI√ìN 2025: Si por error tiene datos de 2026 (ej: 1A tiene a Alvarez en vez de Alburquenque) ---
                const classKeys2025 = Object.keys(masterData["2025"].classes);
                // Chequeo r√°pido: Si 2025 tiene "1A" (formato nuevo) en vez de "Primero Medio A" (formato antiguo) o nombres incorrectos
                if (masterData["2025"].classes["Primero Medio A"] && masterData["2025"].classes["Primero Medio A"][0].name !== LISTA_2025["Primero Medio A"][0]) {
                     console.log("Corrigiendo n√≥mina 2025 (estaba alterada)...");
                     for (const [clsName, studentList] of Object.entries(LISTA_2025)) {
                        masterData["2025"].classes[clsName] = studentList.map(name => ({ name: name, grades: [], attendance: {}, observations: [] }));
                     }
                     modified = true;
                }
                
                // Si faltan clases del 2025, agregarlas
                for (const [clsName, studentList] of Object.entries(LISTA_2025)) {
                    if(!masterData["2025"].classes[clsName]) {
                        masterData["2025"].classes[clsName] = studentList.map(name => ({ name: name, grades: [], attendance: {}, observations: [] }));
                        modified = true;
                    }
                }

                if (modified) saveToCloud(true);
                loadYearData(els.yearSelector.value);
            }, (error) => {
                getEl('loadingError').textContent = "Error: " + error.message;
                getEl('loadingError').classList.remove('hidden');
            });
        }

        function loadYearData(year) {
            currentYear = year;
            allClassesData = masterData[currentYear].classes || {};
            const keys = Object.keys(allClassesData).sort();
            
            // Actualizar selector de clases
            els.classSel.innerHTML = keys.map(k => `<option value="${k}">${k}</option>`).join('');
            
            // Seleccionar primera clase por defecto si no hay selecci√≥n v√°lida
            if (!keys.includes(currentClass)) currentClass = keys[0] || null;
            els.classSel.value = currentClass || "";
            
            refreshTable();
        }

        function getUniqueEvaluations(list) { const evals = new Set(); list.forEach(s => s.grades.forEach(g => evals.add(g.type || "EVALUACI√ìN"))); return Array.from(evals).sort(); }

        function refreshTable() {
            if(!currentClass) { els.mainTable.classList.add('hidden'); return; }
            students = allClassesData[currentClass] || []; els.mainTable.classList.remove('hidden');
            const evalCols = getUniqueEvaluations(students);

            let htmlHead = `<tr><th class="p-3 text-left border w-48 bg-slate-50">Estudiante</th><th class="p-3 text-center border w-16 bg-slate-50">Prom</th>`;
            evalCols.forEach(col => htmlHead += `<th class="p-3 text-center border min-w-[80px] bg-indigo-50 text-indigo-700 font-bold text-xs">${col}</th>`);
            htmlHead += `<th class="p-3 text-center border w-24 bg-slate-50">Asistencia</th><th class="p-3 text-center border w-32 bg-slate-50">Acciones</th></tr>`;
            els.tableHeader.innerHTML = htmlHead;

            els.tableBody.innerHTML = students.map((s, idx) => {
                if(!s.grades) s.grades=[]; if(!s.attendance) s.attendance={}; if(!s.observations) s.observations=[];
                const avg = calculateAverage(s.grades); const att = s.attendance[currentDateString]; const hasObs = s.observations.length > 0;
                const cells = evalCols.map(col => {
                    const g = s.grades.slice().reverse().find(gr => (gr.type || "EVALUACI√ìN") === col);
                    if(g) return `<td class="border p-1 text-center bg-slate-50"><div class="flex items-center justify-center gap-1"><span class="font-bold text-slate-700">${g.value.toFixed(1)}</span><button onclick="window.editGrade(${idx},${s.grades.indexOf(g)})" class="text-[10px] text-indigo-400 hover:text-indigo-700">‚úèÔ∏è</button></div></td>`;
                    return `<td class="border p-1 text-center empty-grade">-</td>`;
                }).join('');

                return `<tr class="hover:bg-slate-50 transition"><td class="border p-2 font-medium text-slate-700 truncate max-w-[200px]">${s.name}</td><td class="border p-2 text-center font-bold ${parseFloat(avg)<4?'text-rose-500':'text-slate-700'}">${avg}</td>${cells}<td class="border p-1 text-center"><div class="flex justify-center gap-1 scale-90">${renderAtt(idx,'P','bg-emerald-500',att)}${renderAtt(idx,'A','bg-rose-500',att)}${renderAtt(idx,'J','bg-amber-400',att)}</div></td><td class="border p-1"><div class="flex justify-end gap-2 pr-2"><div class="flex items-center border border-slate-300 rounded bg-white"><input type="number" id="g-${idx}" class="w-10 text-center text-xs outline-none font-bold" placeholder="-"><button onclick="window.addGrade(${idx})" class="px-2 bg-slate-100 hover:bg-slate-200 border-l border-slate-300 text-xs font-bold">+</button></div>
                
                <button onclick="window.generateStudentPDF(${idx})" class="text-slate-400 hover:text-blue-600 transition" title="Generar Hoja de Vida PDF">üñ®Ô∏è</button>
                
                <button onclick="window.openModal(${idx})" class="w-7 h-7 rounded-full flex items-center justify-center ${hasObs?'bg-indigo-100 text-indigo-600':'bg-slate-100 text-slate-400'}">${hasObs?'üìù':'üí¨'}</button><button onclick="window.delStudent(${idx})" class="text-slate-300 hover:text-rose-500">üóëÔ∏è</button></div></td></tr>`;
            }).join('');
        }

        function renderAtt(idx,t,c,cur) { return `<button onclick="window.setAtt(${idx},'${t}')" class="w-6 h-6 rounded-full text-[10px] font-bold transition ${cur===t?`${c} text-white scale-110 shadow`:'bg-slate-100 text-slate-300 hover:bg-slate-200'}">${t}</button>`; }

        window.setAtt = (i,s) => { students[i].attendance[currentDateString]=s; saveLoc(); }
        window.addGrade = (i) => {
            const v = parseFloat(getEl(`g-${i}`).value); if(isNaN(v)||v<1||v>7) return alert("Nota inv√°lida");
            const type = els.evalName.value.trim().toUpperCase() || "EVALUACI√ìN";
            const exists = students[i].grades.find(g => (g.type||"EVALUACI√ìN")===type);
            if(exists && !confirm(`Ya existe nota para ${type}. ¬øAgregar igual?`)) return;
            students[i].grades.push({ value:v, date:currentDateString, type:type, id:Date.now() }); getEl(`g-${i}`).value=''; saveLoc();
        }
        window.editGrade = (si, gi) => {
            const g = students[si].grades[gi]; const n = prompt(`Editar ${g.type||"Nota"}:`, g.value);
            if(n==='borrar') students[si].grades.splice(gi,1); else if(n&&!isNaN(parseFloat(n))) students[si].grades[gi].value=parseFloat(n);
            saveLoc();
        }
        window.delStudent = (i) => { if(confirm("¬øEliminar?")) { students.splice(i,1); saveLoc(); } }
        
        window.openModal = (i) => { 
            currentStudentIndex=i;
            els.modal.el.classList.remove('hidden','flex'); els.modal.el.classList.add('flex');
            els.modal.title.textContent=students[i].name; els.modal.date.value=currentDateString;
            renderObs(students[i].observations); 
        }

        function renderObs(l) { 
            const s = [...l].sort((a,b)=>new Date(b.date)-new Date(a.date));
            els.modal.history.innerHTML = s.map(o=>`<div class="border-b pb-2 mb-2 border-slate-100"><strong class="text-[10px] text-indigo-500 bg-indigo-50 px-1 rounded">${o.date}</strong><p class="text-xs text-slate-700 mt-1">${o.text}</p></div>`).join('');
        }

        function saveLoc() { masterData[currentYear].classes[currentClass] = students; refreshTable(); }
        async function saveCloud() {
            if(!auth.currentUser) return;
            try { await setDoc(getMyPrivateDocRef(), masterData); els.saveBtn.innerHTML = "‚úÖ Listo"; els.saveBtn.classList.add("bg-emerald-600"); setTimeout(() => { els.saveBtn.innerHTML = "üíæ Guardar Todo"; els.saveBtn.classList.remove("bg-emerald-600"); }, 2000); } catch(e) { alert("Error al guardar: "+e.message); }
        }

        function downloadBackup() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(masterData)); a.download=`Respaldo_${currentDateString}.json`; a.click(); }
        function calculateAverage(g) { if(!g.length) return '0.0'; return (g.reduce((a,b)=>a+b.value,0)/g.length).toFixed(1); }
        function updateDateDisplay() { const d=new Date(currentDateString+'T12:00:00'); getEl('currentDate').textContent = d.toLocaleDateString('es-CL',{weekday:'long',day:'numeric',month:'long',year:'numeric'}); }

        // --- L√ìGICA IMPORTACI√ìN CSV ---
        function parseCSV(text) {
            const lines = text.split('\n'); let addedCount = 0;
            lines.forEach(line => {
                const separator = line.includes(';') ? ';' : ',';
                const parts = line.split(separator);
                if(parts.length >= 2) {
                    const className = parts[0].trim();
                    let studentName = "";
                    if (separator === ';' && parts.length > 2) { studentName = parts[2].trim().toUpperCase(); } 
                    else if (parts[1]) { studentName = parts[1].trim().toUpperCase(); }

                    if(className && studentName) {
                        if(!allClassesData[className]) allClassesData[className] = [];
                        const exists = allClassesData[className].find(s => s.name === studentName);
                        if(!exists) { allClassesData[className].push({ name: studentName, grades: [], attendance: {}, observations: [] }); addedCount++; }
                    }
                }
            });
            if(addedCount > 0) { saveLoc(); saveCloud(); loadYearData(currentYear); alert(`‚úÖ ${addedCount} importados.`); } else { alert("‚ÑπÔ∏è Nada nuevo."); }
        }

        // --- GENERAR PDF INDIVIDUAL ---
        window.generateStudentPDF = async (index) => {
            const s = students[index];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16); doc.setTextColor(40, 40, 40);
            doc.text("Hoja de Vida del Estudiante", 105, 20, null, null, "center");
            
            doc.setFontSize(10);
            doc.text(`Escuela Agr√≠cola Sagrados Corazones - A√±o ${currentYear}`, 105, 26, null, null, "center");
            
            doc.setDrawColor(200); doc.line(14, 30, 196, 30);
            doc.setFontSize(12); doc.setTextColor(0, 0, 0);
            doc.text(`Nombre: ${s.name}`, 14, 40);
            doc.text(`Curso: ${currentClass}`, 14, 46);
            const avg = calculateAverage(s.grades);
            doc.text(`Promedio Actual: ${avg}`, 14, 52);
            if(parseFloat(avg)<4) { doc.setTextColor(200,0,0); doc.text("(Riesgo Acad√©mico)", 70, 52); doc.setTextColor(0,0,0); }

            const gradesData = s.grades.map(g => [g.type || "Evaluaci√≥n", g.date, g.value]);
            if(gradesData.length > 0) {
                doc.autoTable({ startY: 60, head: [['Evaluaci√≥n', 'Fecha', 'Nota']], body: gradesData, theme: 'grid', headStyles: { fillColor: [79, 70, 229] } });
            } else { doc.text("Sin calificaciones registradas.", 14, 65); }

            let finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 70;
            doc.setFontSize(14); doc.text("Observaciones / Anotaciones", 14, finalY);
            doc.setLineWidth(0.5); doc.line(14, finalY+2, 100, finalY+2);
            
            if(s.observations.length > 0) {
                const obsData = s.observations.map(o => [o.date, o.text]);
                doc.autoTable({ startY: finalY + 5, head: [['Fecha', 'Detalle']], body: obsData, theme: 'striped', styles: { fontSize: 9 }, columnStyles: { 0: { cellWidth: 30 } } });
            } else { doc.setFontSize(10); doc.text("Sin observaciones registradas.", 14, finalY + 10); }

            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(8); doc.setTextColor(150); doc.text(`Generado por ProfeAle Admin - ${new Date().toLocaleDateString()}`, 105, 290, null, null, "center"); }

            doc.save(`Hoja_Vida_${s.name.replace(/\s+/g, '_')}.pdf`);
        };

        function setupEvents() {
            els.loginForm.onsubmit = handleLogin;
            getEl('btnLogout').onclick = () => { if(confirm("Salir?")) signOut(auth).then(()=>location.reload()); };
            els.saveBtn.onclick = saveCloud;
            els.addStudentBtn.onclick = () => { const n=getEl('studentNameInput').value.trim().toUpperCase(); if(n&&!students.find(s=>s.name===n)){ students.push({name:n,grades:[],attendance:{},observations:[]}); getEl('studentNameInput').value=''; saveLoc(); } };
            els.addClassBtn.onclick = () => { const n=prompt("Nombre curso:"); if(n&&!allClassesData[n]) { allClassesData[n]=[]; saveLoc(); saveCloud(); loadYearData(currentYear); } };
            els.importBtn.onclick = () => els.csvInput.click();
            els.csvInput.onchange = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (e) => parseCSV(e.target.result); reader.readAsText(file); } els.csvInput.value = ''; };
            els.backupBtn.onclick = downloadBackup;
            els.yearSel.onchange = (e) => loadYearData(e.target.value);
            els.classSel.onchange = (e) => { currentClass=e.target.value; refreshTable(); };
            els.dateSel.onchange = (e) => { currentDateString=e.target.value; updateDateDisplay(); refreshTable(); };
            els.modal.close.onclick = () => els.modal.el.classList.add('hidden');
            els.modal.save.onclick = () => { const t=els.modal.input.value.trim(); const d=els.modal.date.value; if(t&&d) { students[currentStudentIndex].observations.push({text:t,date:d,id:Date.now()}); els.modal.el.classList.add('hidden'); els.modal.input.value=''; saveLoc(); } };
            getEl('showReportBtn').onclick = () => generateReport('summary');
            getEl('showDetailedReportBtn').onclick = () => generateReport('detail');
            getEl('backToTableBtn').onclick = () => { els.tableContainer.classList.remove('hidden'); els.controls.classList.remove('hidden'); els.backNav.classList.add('hidden'); els.reportSummary.classList.add('hidden'); els.reportDetail.classList.add('hidden'); refreshTable(); };
            getEl('printReportBtn').onclick = () => window.print();
        }

        function generateReport(type) {
            if(!currentClass) return;
            els.tableContainer.classList.add('hidden'); els.controls.classList.add('hidden'); els.backNav.classList.remove('hidden');
            if(type==='summary') {
                els.reportSummary.classList.remove('hidden'); els.reportDetail.classList.add('hidden');
                const data = Object.keys(allClassesData).map(c=>{ const l=allClassesData[c]; let p=0,a=0,j=0,t=0; l.forEach(s=>Object.values(s.attendance||{}).forEach(v=>{ if(v==='P')p++;if(v==='A')a++;if(v==='J')j++;t++; })); return {c, count:l.length, p,a,j, rate: t?((p+j)/t*100).toFixed(1)+'%':'N/A'}; });
                els.reportSummary.innerHTML = `<h2 class="text-xl font-bold mb-4 text-center">Resumen General ${currentYear}</h2><table class="w-full text-sm text-left"><thead class="bg-slate-100 uppercase"><tr><th class="px-4 py-2">Clase</th><th class="px-4 py-2 text-center">Matr√≠cula</th><th class="text-center px-4 py-2 text-green-600">P</th><th class="text-center px-4 py-2 text-rose-600">A</th><th class="text-center px-4 py-2">%</th></tr></thead><tbody>${data.map(d=>`<tr class="border-b"><td class="px-4 py-2 font-medium">${d.c}</td><td class="text-center">${d.count}</td><td class="text-center text-green-600 font-bold">${d.p}</td><td class="text-center text-rose-600 font-bold">${d.a}</td><td class="text-center font-bold">${d.rate}</td></tr>`).join('')}</tbody></table>`;
            } else {
                els.reportDetail.classList.remove('hidden'); els.reportSummary.classList.add('hidden');
                const list = allClassesData[currentClass];
                const dates = new Set(); list.forEach(s=>Object.keys(s.attendance||{}).forEach(d=>dates.add(d)));
                const sortedDates = Array.from(dates).sort();
                const evalCols = getUniqueEvaluations(list);
                els.reportDetail.innerHTML = `<h2 class="text-xl font-bold mb-4 text-center">Detalle: ${currentClass}</h2><table class="w-full text-xs border border-slate-200"><thead class="bg-slate-100"><tr><th class="px-2 py-2 text-left border w-40">Estudiante</th><th class="px-1 py-2 border w-10">Prom</th>${evalCols.map(e=>`<th class="px-1 py-2 border bg-indigo-50 text-indigo-700 w-12">${e}</th>`).join('')}${sortedDates.map(d=>`<th class="px-1 py-2 border w-8">${d.slice(5)}</th>`).join('')}<th class="px-2 py-2 text-left border">Obs</th></tr></thead><tbody>${list.map((s,i)=>{
                    const grades = evalCols.map(c=>{ const g=s.grades.slice().reverse().find(gr=>(gr.type||"EVALUACI√ìN")===c); return `<td class="text-center border font-bold ${g?'text-slate-700':'text-slate-200'}">${g?g.value.toFixed(1):'-'}</td>`; }).join('');
                    const atts = sortedDates.map(d=>{ const v=s.attendance[d]||'-'; let c='text-slate-300'; if(v==='P')c='bg-green-100 text-green-700 font-bold'; if(v==='A')c='bg-rose-100 text-rose-700 font-bold'; return `<td class="text-center border ${c}">${v}</td>`; }).join('');
                    const obs = s.observations.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(o=>`${o.date}: ${o.text}`).join(' | ');
                    return `<tr class="${i%2===0?'bg-white':'bg-slate-50'}"><td class="px-2 py-2 border font-medium truncate max-w-[150px]">${s.name}</td><td class="px-1 py-2 border text-center font-bold bg-slate-100">${calculateAverage(s.grades)}</td>${grades}${atts}<td class="px-2 py-2 border text-[10px] leading-tight">${obs}</td></tr>`;
                }).join('')}</tbody></table>`;
            }
        }

        window.onload = initApp;
    </script>
</body>
</html>