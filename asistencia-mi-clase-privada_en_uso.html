<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Acad√©mica - ProfeAle 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .printable-container { width: 100%; }
        
        /* Botones y Estilos */
        .btn-add { background-color: #22c55e; } .btn-add:hover { background-color: #16a34a; }
        .btn-grade { background-color: #f97316; } .btn-grade:hover { background-color: #ea580c; }
        .btn-delete { background-color: #9ca3af; } .btn-delete:hover { background-color: #6b7280; }
        .btn-volver { background-color: #a855f7; } .btn-volver:hover { background-color: #9333ea; }
        .btn-print { background-color: #0d9488; } .btn-print:hover { background-color: #0f766e; }
        .btn-reset { background-color: #f59e0b; } .btn-reset:hover { background-color: #d97706; }
        
        /* Chips de Notas */
        .grade-chip { cursor: pointer; transition: all 0.2s; }
        .grade-chip:hover { transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Reglas de IMPRESI√ìN */
        .print-only { display: none; }
        @media print {
            .no-print { display: none !important; }
            .printable-container { margin: 0; padding: 0; box-shadow: none; }
            body { background-color: white; }
            .print-only { display: block; }
            
            #printHeader { 
                position: fixed; top: 0; left: 0; width: 100%; 
                background-color: white; border-bottom: 2px solid #3730a3; 
                padding: 10px 40px; margin-bottom: 20px; z-index: 1000;
            }
            #printFooter { 
                position: fixed; bottom: 0; width: 100%; text-align: center; 
                border-top: 1px solid #ccc; padding-top: 5px; 
                background-color: white; font-size: 10px; 
            }
            body > .printable-container { padding-top: 100px; padding-bottom: 20px; }
            table { font-size: 11px; width: 100%; }
            th, td { padding: 4px !important; }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="printHeader" class="print-only">
        <div class="flex items-center justify-between w-full">
            <div class="w-1/3">
                <img src="logo.jpg" onerror="this.style.display='none'" alt="Logo" class="h-16 object-contain">
            </div>
            <div class="w-1/3 text-center">
                <h3 class="text-xl font-bold text-gray-800 uppercase tracking-wider">Gesti√≥n Acad√©mica</h3>
                <p class="text-sm text-gray-500 font-bold">ProfeAle</p>
            </div>
            <div class="w-1/3 text-right text-xs text-gray-400">
                <p>Reporte Generado</p>
                <p class="print-date-placeholder">--/--/----</p>
            </div>
        </div>
    </div>

    <div class="printable-container bg-white p-8 rounded-2xl shadow-xl max-w-6xl w-full">
        
        <div class="text-center mb-4 no-print relative group">
            <div class="w-full flex justify-center">
                <img src="logo.jpg" 
                     onerror="this.src='https://cdn-icons-png.flaticon.com/512/167/167707.png'" 
                     alt="Logo Escuela" 
                     class="h-24 mx-auto object-contain hover:scale-105 transition-transform duration-300 drop-shadow-sm">
            </div>
            <p class="text-xs text-gray-300 mt-1 opacity-0 group-hover:opacity-100 transition-opacity absolute w-full text-center bottom-[-20px]">
                (Guarda tu logo como 'logo.jpg')
            </p>
        </div>

        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center no-print">Control de Asistencia y Calificaciones</h1>
        
        <div class="no-print text-center mb-6 bg-indigo-50 py-2 rounded-lg mx-auto max-w-md border border-indigo-100">
             <p class="text-sm text-gray-600 flex flex-col items-center justify-center">
                <span class="font-bold text-indigo-700 text-base">‚ú® Desarrollado por ProfeAle ‚ú®</span>
                <span id="statusDisplay" class="text-xs font-medium mt-1 text-green-600">Conectando...</span>
             </p>
        </div>

        <p id="currentDate" class="text-gray-600 text-center mb-6 no-print font-bold"></p>

        <div id="controlsContainer" class="no-print mb-8 space-y-4 md:space-y-0 md:flex md:justify-between md:items-end bg-gray-50 p-4 rounded-xl border border-gray-200">
             
             <div class="flex flex-col space-y-1">
                <label for="classSelector" class="text-gray-700 font-bold text-sm">Seleccionar Clase</label>
                <div class="flex gap-2">
                    <select id="classSelector" class="p-2 border rounded-lg shadow-sm w-48 bg-white focus:ring-2 focus:ring-indigo-400"></select>
                    <button id="addClassBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold px-3 rounded-lg shadow" title="Crear nueva clase">‚ûï</button>
                </div>
             </div>
             
             <div class="flex flex-col space-y-1">
                <label for="dateSelector" class="text-gray-700 font-bold text-sm">Fecha de Trabajo</label>
                <input type="date" id="dateSelector" class="p-2 border rounded-lg shadow-sm w-40 bg-white focus:ring-2 focus:ring-indigo-400">
             </div>

             <div class="flex flex-col space-y-1">
                <label for="studentNameInput" class="text-gray-700 font-bold text-sm">Agregar Estudiante</label>
                <div class="flex">
                    <input type="text" id="studentNameInput" placeholder="Ej: Juan P√©rez" class="p-2 border rounded-l-lg shadow-sm w-48 focus:outline-none focus:ring-2 focus:ring-green-400" />
                    <button id="addStudentBtn" class="btn-add text-white font-bold py-2 px-3 rounded-r-lg transition duration-150 shadow-md">+</button>
                </div>
             </div>
             
             <button id="saveDataBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md w-full md:w-auto transform hover:-translate-y-1">
                üíæ Guardar Cambios
             </button>
        </div>

        <div id="backToTableContainer" class="no-print text-center mb-6 hidden">
             <button id="backToTableBtn" class="btn-volver text-white font-bold py-2 px-4 rounded-lg transition duration-150 mr-4">Volver a la Tabla</button>
             <button id="printReportBtn" class="btn-print text-white font-bold py-2 px-4 rounded-lg transition duration-150">üñ®Ô∏è Imprimir Reporte</button>
        </div>

        <div id="studentsTableContainer" class="min-h-[200px] flex flex-col justify-start printable-container">
            <div id="loadingIndicator" class="text-center p-10 font-bold text-gray-500 animate-pulse">Cargando datos de la nube...</div>
            
            <div id="tableHeader" class="grid grid-cols-12 gap-2 py-3 border-b-2 border-gray-300 font-bold text-gray-700 uppercase text-xs text-center bg-gray-100 rounded-t-lg">
                <div class="col-span-3 text-left pl-4">ESTUDIANTE</div>
                <div class="col-span-4">NOTAS (Click para editar)</div>
                <div class="col-span-1">PROM</div>
                <div class="col-span-2">ASISTENCIA</div>
                <div class="col-span-2">ACCIONES</div>
            </div>
             <div id="tableBody" class="bg-white"></div>
        </div>

        <div id="reportButtons" class="no-print mt-8 space-y-4">
            <div class="text-center md:flex md:justify-center md:space-x-4">
                <button id="showReportBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg border border-gray-300">üìä Resumen Asistencia</button>
                <button id="showDetailedReportBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg border border-gray-300">üìã Reporte Detallado</button>
            </div>
            
            <div class="text-center mt-6 border-t pt-4">
                <p class="text-xs text-gray-400 mb-2">¬øFaltan cursos? Pulsa aqu√≠ para cargar la n√≥mina importada (1¬∞ a 4¬∞ Medio)</p>
                <button id="resetCoursesBtn" class="btn-reset text-white text-xs font-bold py-2 px-4 rounded-lg shadow-sm">üîÑ Cargar N√≥mina 2025</button>
            </div>
        </div>

        <div id="classReportContainer" class="hidden mt-8 printable-container"></div>
        <div id="classDetailsContainer" class="hidden mt-8 printable-container"></div>
        
        <div id="observationModal" class="no-print fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="bg-indigo-600 p-4">
                    <h3 id="modalTitle" class="text-xl font-bold text-white">Observaciones</h3>
                </div>
                <div class="p-6 flex-1 overflow-y-auto">
                    <h4 class="text-sm font-bold text-gray-500 uppercase mb-3">Historial Cronol√≥gico</h4>
                    <div id="observationHistory" class="space-y-3 mb-6"></div>
                    <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">Nueva Observaci√≥n (<span id="obsDateDisplay"></span>)</h4>
                    <textarea id="newObservationText" class="w-full p-3 border border-gray-300 rounded-lg h-24 resize-none" placeholder="Escribe el detalle..."></textarea>
                </div>
                <div class="bg-gray-50 p-4 flex justify-end space-x-2 border-t">
                    <button id="closeObservationModalBtn" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button id="saveObservationBtn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg">Guardar</button>
                </div>
            </div>
        </div>

    </div>
    
    <div id="printFooter" class="print-only text-gray-500">Desarrollado por ProfeAle</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACI√ìN
        const CLAVE_DOCENTE = "ProfeAle"; 
        const firebaseConfig = { apiKey: "AIzaSyAFp6biz1UTr9Ehaudkpe7QyTFVbdQz5Sc", authDomain: "asistencia-mi-clase.firebaseapp.com", projectId: "asistencia-mi-clase", storageBucket: "asistencia-mi-clase.appspot.com", messagingSenderId: "552398254230", appId: "1:552398254230:web:c58dd07e5ceeb67e0912b7", measurementId: "G-MYR01HM1YE" };
        const appId = firebaseConfig.appId;

        let app, db, auth, isFirebaseConnected = false;
        let currentDateString = new Date().toISOString().slice(0, 10);
        let allClassesData = {};
        let currentClass = null;
        let students = [];
        let currentStudentIndex = -1;

        // DOM Elements
        const getEl = (id) => document.getElementById(id);
        const statusDisplay = getEl('statusDisplay');
        const currentDateElement = getEl('currentDate');
        const studentsTableContainer = getEl('studentsTableContainer');
        const loadingIndicator = getEl('loadingIndicator');
        const classSelector = getEl('classSelector');
        const dateSelector = getEl('dateSelector');
        const studentNameInput = getEl('studentNameInput');
        
        const saveDataBtn = getEl('saveDataBtn');
        const showReportBtn = getEl('showReportBtn');
        const showDetailedReportBtn = getEl('showDetailedReportBtn');
        const backToTableBtn = getEl('backToTableBtn');
        const printReportBtn = getEl('printReportBtn'); 
        const addStudentBtn = getEl('addStudentBtn');
        const addClassBtn = getEl('addClassBtn');
        const resetCoursesBtn = getEl('resetCoursesBtn');
        
        const classReportContainer = getEl('classReportContainer');
        const classDetailsContainer = getEl('classDetailsContainer');
        const tableBody = getEl('tableBody');
        const tableHeader = getEl('tableHeader');
        const controlsContainer = getEl('controlsContainer');
        const reportButtons = getEl('reportButtons');
        const backToTableContainer = getEl('backToTableContainer');

        const observationModal = getEl('observationModal');
        const observationHistory = getEl('observationHistory');
        const newObservationText = getEl('newObservationText');
        const obsDateDisplay = getEl('obsDateDisplay');
        
        // DATOS IMPORTADOS DE N√ìMINA 2025.CSV
        const fullDefaultClasses = {
            "1¬∞ Medio A": [
                "ALBURQUENQUE DEL GRECCO EMILYA ANTONIA", "ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS", "CONTRERAS SALGADO HADEEY ALEJANDRA",
                "FERRADA ALBORNOZ AGUST√çN ALEXIS", "HERN√ÅNDEZ FERN√ÅNDEZ DHARIEN ALEXSANDER", "IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA",
                "LAGOS LASTRA ALEXANDRA DANAE", "L√ìPEZ L√ìPEZ LUCIANO ANTONIO", "MALDONADO FLORES ANTONELLA BEL√âN",
                "MONTECINO D√çAZ VALESKA BEL√âN", "MU√ëOZ CONTRERAS LUIS GABRIEL", "MU√ëOZ LUNA ROGER JOEL",
                "NAVARRO VILLANUEVA KARLA PAZ", "ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS", "QUEZADA NARANJO FELIPE ALONSO",
                "QUINTEROS VERGARA FERNANDA FLORENCIA", "RAM√çREZ VILLALOBOS DUVAN EMILIO", "SANTANDER L√ìPEZ MAR√çA JOS√â",
                "TAPIA CASTILLA JEANFRANCO PATRICK", "URBINA C√ÅCERES FRANCHESCA POULETTE", "V√ÅSQUEZ ZALDUENDO AMANDA ISABEL",
                "ZABALAGA COFR√â DAMI√ÅN ANDR√âS", "BAEZ DONOSO LUKAS ALFONSO", "MESA D√çAZ GONZALO IGNACIO"
            ],
            "1¬∞ Medio B": [
                "ARAVENA Z√ö√ëIGA NOEM√ç JES√öS DE LAS ESTRELLAS", "ASTUDILLO CAMPOS CRIST√ìBAL ANTONIO", "ASTUDILLO V√ÅSQUEZ BRUNO FERNANDO LE√ìN",
                "CUMINAO VIDAL CATALINA ANDREA", "D√çAZ MALUENDA MIGUEL ALBERTO", "KILTAN GONZ√ÅLEZ DIDIER EZEQUIEL",
                "L√ìPEZ ACU√ëA MARCO EMILIO", "L√ìPEZ NOVOA EYDAN DAMI√ÅN", "M√âNDEZ SUAZO FABI√ÅN FELIPE",
                "MOYA REYES MATEO ANTONIO BENJAM√çN", "OSES CAMPOS VALENTINA ABIGAIL", "PALMA ORELLANA ANTONELLA FRANCISCA",
                "PEREIRA ORELLANA MONSERRAT ALAMIRA", "P√âREZ ORMAZ√ÅBAL ZADKA ALEJANDRA", "ROJAS GONZ√ÅLEZ FLORENCIA TRINIDAD",
                "ROJAS LEIVA EDUARDO JAVIER", "V√ÅSQUEZ AGUILERA SCARLET NICOLE", "Y√Å√ëEZ GONZ√ÅLEZ BRAYAN DAMI√ÅN",
                "VARGAS MORAGA MARTINA SAYEN", "SALAZAR SALAS PEDRO JOS√â", "VERA BRAVO FLORENCIA ANTONIA",
                "P√âREZ QUEVEDO CONSTANZA TRINIDAD", "RIQUELME SANTOS BENJAM√çN ALONSO"
            ],
            "1¬∞ Medio C": [],
            "2¬∞ Medio A": [
                "AHUMADA ROJAS TRINIDAD BEL√âN", "ESPINOSA TORRES FERNANDA ELENA", "ESPINOZA PE√ëALILLO BRAYAN JES√öS",
                "GONZ√ÅLEZ SALAZAR EMILIA CATALINA", "MEDEL OJEDA LE√ìN IGNACIO", "MORALES REIM√ÅN ALFONSO TOM√ÅS",
                "PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO", "PINTO TOBAR JORD√ÅN AMARO", "RECABAL Y√Å√ëEZ KEVIN ANDR√âS",
                "RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO", "RIVERA ABARZA CONSTANZA VICTORIA", "SANTIS CASSEUS TEIVA SCARLETT",
                "SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN", "TOLEDO ALBORNOZ ANTONELLA INES", "VENEGAS ARRIAGADA ANTONIA EDITH",
                "VIELMA ZABALAGA JOAN MANUEL", "MEZA COLIM√ÅN ANGEL BLAS", "SAAVEDRA BRAVO FLORENCIA ALEJANDRA"
            ],
            "2¬∞ Medio B": [
                "ARAYA DOM√çNGUEZ ALEX FABI√ÅN", "BRAVO MENARES ALEX JOHAN", "CARRASCO LEIVA BENJAM√çN IGNACIO",
                "CARVAJAL URRUTIA CONSTANZA PRISILA (DANIEL)", "ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER", "FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO",
                "JARAMILLO VILLAR EMILIO SCOTT", "L√ìPEZ VILLAR MART√çN ALONSO", "MIRANDA MU√ëOZ ALEXANDRA JAVIERA",
                "MU√ëOZ TRONCOSO H√âCTOR ANTONIO", "OLIVARES VALENZUELA ALONSO IGNACIO", "OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA",
                "ORELLANA GARRIDO MAT√çAS LEANDRO", "PUNOY MEDEL MILLARAY ANG√âLICA", "QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO",
                "RIQUELME COLOMA DALIA CONSTANZA", "SALGADO ROJAS VICENTE MOIS√âS", "SANDOVAL CERPA VICENTE ESTEBAN",
                "SOTO NARANJO CHRISTOPHER", "VEKARIC VERDEJO MART√çN"
            ],
            "2¬∞ Medio C": [],
            "3¬∞ Medio A": [
                "ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA", "BAHAMONDE MU√ëOZ ARIEL LEON", "CAMPOS MU√ëOZ CRISTOPHER JES√öS",
                "CANCINO OR√ìSTICA VICENTE GASPAR", "CARRASCO GONZ√ÅLEZ CAMILA ANDREA", "COFR√â CASTILLO ANTONIO ANDR√âS",
                "CONTRERAS VENEGAS BEL√âN ALEJANDRA", "GALDAMES VERGARA FELIPE ESTEBAN", "GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO",
                "GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA", "GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO", "GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN",
                "JARA SEP√öLVEDA KATRINA DARINKA", "MART√çNEZ LIZANA AARON ALEJANDRO", "MEZA CARRASCO BENJAM√çN INTI",
                "MI√ëO GONZALEZ CATALINA ANDREA", "MORAGA PACHECO RENATO IGNACIO", "P√âREZ COR√ìN MANUEL IGNACIO",
                "SAMANIEGO CORTEZ JAKSON FERGIE", "SEP√öLVEDA SALAZAR SOF√çA ANTONIA", "TAPIA ACU√ëA GABRIEL ANTONIO",
                "VEGA VIVANCO CRIST√ìBAL ANTONIO", "VERA NAVARRETE DANIELA ELIZABETH", "VILLALOBOS ARAVENA KARINA ANGELINA",
                "VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS", "HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO", "TORREALBA MOYA FLORVELIS DE LOS ANGELES",
                "CARO URRUTIA CONSUELO ANTONIA", "LOBOS C√ÅCERES ANTONIA PAZ"
            ],
            "3¬∞ Medio B": [],
            "3¬∞ Medio C": [
                "ARELLANO ACU√ëA MART√çN ANTONIO", "AROS √ÅVILA DAYANA IGNACIA", "CABRERA COLOMBINO MAR√çA GRACIA",
                "FUENTES CARRASCO YARIXA ALEJANDRA", "G√ìMEZ CANCINO DANIELA ALEJANDRA", "GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA",
                "HONORATO TAPIA GLORIA JAVIERA", "LARA RIVERA BENJAM√çN ESTEBAN", "PALACIOS SOTO JOS√â TOM√ÅS",
                "PEZO SANTANDER JOS√â CRIST√ìBAL", "ROCHA ROJAS JOS√â PABLO WILLIAMS", "ROJAS Y√âVENES FABIANA ISIDORA",
                "S√ÅNCHEZ PAREJA ANDY ANTONIO", "SANTANDER L√ìPEZ SIM√ìN ESTEBAN", "TRONCOSO LIZAMA SIOMARA IGNACIA",
                "WARNKEN ROJAS LUCIANA BERNABELA", "DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN", "COLLAO MEDINA ANA√çS VALENTINA"
            ],
            "4¬∞ Medio A": [], 
            "4¬∞ Medio B": [], 
            "4¬∞ Medio C": []
        };

        function getMyPrivateDocRef() { return doc(db, `artifacts/${appId}/public/data/calificaciones/master_data`); }

        async function initApp() {
             try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseConnected = true;
                dateSelector.value = currentDateString;

                onAuthStateChanged(auth, user => {
                    if (user) {
                        statusDisplay.textContent = '‚óè CONECTADO (ADMIN)';
                        loadDataFromFirestore();
                    } else {
                        signInAnonymously(auth).catch(e => console.error(e));
                    }
                });
             } catch (e) { alert('Error Fatal: No se pudo conectar a Firebase.'); }
             updateCurrentDateUI();
             setupEventHandlers();
        }

        function loadDataFromFirestore() {
            const docRef = getMyPrivateDocRef(); 
            onSnapshot(docRef, (docSnap) => {
                loadingIndicator.style.display = 'none';
                if (docSnap.exists() && docSnap.data().classes) {
                    allClassesData = docSnap.data().classes;
                    
                    // Normalizaci√≥n de datos antiguos
                    for (const className in allClassesData) {
                        allClassesData[className] = allClassesData[className].map(s => {
                            const normalizedGrades = (s.grades || []).map(g => (typeof g === 'object' && g.value) ? g : { value: g, date: '---', id: Date.now() + Math.random() });
                            let normalizedObs = [];
                            if (Array.isArray(s.observations)) normalizedObs = s.observations;
                            else if (s.observations && typeof s.observations === 'string') normalizedObs = [{ text: s.observations, date: '---', id: Date.now() }];
                            return { name: s.name, grades: normalizedGrades, attendance: s.attendance || {}, observations: normalizedObs };
                        });
                    }
                    if (!currentClass || !allClassesData[currentClass]) currentClass = Object.keys(allClassesData)[0];
                } else {
                    createInitialData(); 
                    return; 
                }
                students = allClassesData[currentClass] || [];
                initializeClassSelector();
                renderStudentsTable();
            });
        }

        async function createInitialData() {
             // Si no hay datos, iniciamos con la lista completa
             const initialClasses = {};
             for (const className in fullDefaultClasses) {
                 initialClasses[className] = fullDefaultClasses[className].map(name => ({ name, grades: [], attendance: {}, observations: [] }));
             }
             await setDoc(getMyPrivateDocRef(), { classes: initialClasses });
        }

        // FUNCIONES DE GESTI√ìN DE CLASES
        async function loadDefaultCourses() {
            if(!confirm("‚ö†Ô∏è ¬øEst√°s seguro? Esto agregar√° la N√ìMINA 2025 completa (1¬∞ a 4¬∞ Medio) a tu lista actual. No borrar√° los alumnos existentes.")) return;
            
            let updated = false;
            for (const className in fullDefaultClasses) {
                if (!allClassesData[className]) {
                    allClassesData[className] = fullDefaultClasses[className].map(name => ({ name, grades: [], attendance: {}, observations: [] }));
                    updated = true;
                }
            }
            
            if(updated) {
                await setDoc(getMyPrivateDocRef(), { classes: allClassesData });
                alert("‚úÖ Cursos 2025 cargados exitosamente.");
            } else {
                alert("‚ÑπÔ∏è Los cursos ya exist√≠an.");
            }
        }

        async function addNewClass() {
            const name = prompt("Nombre del nuevo curso (Ej: 5¬∞ B√°sico A):");
            if(name && name.trim() !== "") {
                if(allClassesData[name]) return alert("Ese curso ya existe.");
                allClassesData[name] = [];
                currentClass = name;
                await setDoc(getMyPrivateDocRef(), { classes: allClassesData });
                alert(`‚úÖ Curso "${name}" creado.`);
            }
        }

        async function saveData() {
             if (!isFirebaseConnected) return;
             try {
                 await setDoc(getMyPrivateDocRef(), { classes: allClassesData });
                 saveDataBtn.textContent = "‚úÖ Guardado";
                 setTimeout(() => saveDataBtn.textContent = "üíæ Guardar Cambios", 2000);
             } catch (e) { alert('Error: ' + e.message); }
        }
        
        function addStudent() {
            const name = studentNameInput.value.trim().toUpperCase();
            if (!name || !currentClass) return alert('Escribe un nombre v√°lido.');
            if (students.some(s => s.name === name)) return alert('Ya existe.');
            students.push({ name: name, grades: [], attendance: {}, observations: [] });
            studentNameInput.value = '';
            updateDataAndRender();
        }

        function showView(view) {
            studentsTableContainer.style.display = 'none';
            classReportContainer.style.display = 'none';
            classDetailsContainer.style.display = 'none';
            controlsContainer.classList.add('hidden');
            reportButtons.classList.add('hidden');
            backToTableContainer.classList.add('hidden');

            if (view === 'table') {
                studentsTableContainer.style.display = 'flex';
                controlsContainer.classList.remove('hidden');
                reportButtons.classList.remove('hidden');
            } else if (view === 'report') {
                classReportContainer.style.display = 'block';
                backToTableContainer.classList.remove('hidden');
            } else if (view === 'detailed') {
                classDetailsContainer.style.display = 'block';
                backToTableContainer.classList.remove('hidden');
            }
        }

        function renderStudentsTable() { 
            tableHeader.style.display = students.length > 0 ? 'grid' : 'none';
            tableBody.innerHTML = students.map((student, index) => {
                const gradesHtml = student.grades.map((g, gIndex) => `
                    <div onclick="editGrade(${index}, ${gIndex})" title="${g.date}"
                         class="grade-chip inline-flex items-center justify-center bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full mr-1 mb-1 border border-blue-200">
                        ${g.value.toFixed(1)}
                    </div>`).join('');
                const hasObs = student.observations && student.observations.length > 0;
                return `
                <div class="grid grid-cols-12 gap-2 py-3 border-b border-gray-100 hover:bg-gray-50 items-center text-sm px-2">
                    <div class="col-span-3 text-left font-semibold text-gray-800 truncate pl-2">${student.name}</div>
                    <div class="col-span-4 flex flex-wrap content-center">${gradesHtml.length > 0 ? gradesHtml : '<span class="text-gray-300 text-xs italic">Sin notas</span>'}</div>
                    <div class="col-span-1 text-center font-bold text-gray-700">${calculateAverage(student.grades)}</div>
                    <div class="col-span-2 flex justify-center space-x-1">
                         <button data-status="P" data-index="${index}" class="attendance-btn w-7 h-7 rounded-full text-xs font-bold transition-all ${getAttendanceStatus(student) === 'P' ? 'bg-green-500 text-white scale-110' : 'bg-gray-200 text-gray-400'}">P</button>
                         <button data-status="A" data-index="${index}" class="attendance-btn w-7 h-7 rounded-full text-xs font-bold transition-all ${getAttendanceStatus(student) === 'A' ? 'bg-red-500 text-white scale-110' : 'bg-gray-200 text-gray-400'}">A</button>
                         <button data-status="J" data-index="${index}" class="attendance-btn w-7 h-7 rounded-full text-xs font-bold transition-all ${getAttendanceStatus(student) === 'J' ? 'bg-yellow-400 text-white scale-110' : 'bg-gray-200 text-gray-400'}">J</button>
                    </div>
                    <div class="col-span-2 flex justify-end items-center space-x-2 pr-2">
                        <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200">
                            <input type="number" id="gradeInput-${index}" step="0.1" class="w-10 bg-transparent text-center text-xs focus:outline-none">
                            <button onclick="addGrade(${index})" class="text-orange-500 font-bold px-1 text-lg leading-none">+</button>
                        </div>
                        <button onclick="openObservationModal(${index})" class="w-8 h-8 rounded-full border flex items-center justify-center ${hasObs ? 'text-indigo-600 bg-indigo-100' : 'text-gray-400 bg-gray-100'}">${hasObs ? 'üìù' : 'üí¨'}</button>
                        <button data-index="${index}" class="btn-delete text-white w-7 h-7 rounded-full text-xs shadow hover:bg-gray-500 flex items-center justify-center">üóëÔ∏è</button>
                    </div>
                </div>`; }).join('');
            attachTableListeners();
        }

        // REPORTES
        function generateClassReport() {
            showView('report');
            const classNames = Object.keys(allClassesData);
            classReportContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Resumen de Asistencia General</h2>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 border"><thead class="bg-gray-50"><tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Clase</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Total</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-green-600 uppercase">P</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-red-600 uppercase">A</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-yellow-600 uppercase">J</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase">%</th>
                </tr></thead><tbody class="bg-white divide-y divide-gray-200">${classNames.map(c => {
                    const s = calculateClassSummary(c);
                    return `<tr><td class="px-6 py-4 font-medium text-gray-900">${c}</td><td class="px-6 py-4 text-center">${s.total_students}</td><td class="px-6 py-4 text-center text-green-600 font-bold">${s.P}</td><td class="px-6 py-4 text-center text-red-600 font-bold">${s.A}</td><td class="px-6 py-4 text-center text-yellow-600 font-bold">${s.J}</td><td class="px-6 py-4 text-center font-bold">${s.tasa_asistencia}</td></tr>`;
                }).join('')}</tbody></table></div>`;
        }

        function generateDetailedReport(className) {
            if (!className) return alert("Selecciona una clase.");
            showView('detailed');
            const data = allClassesData[className] || [];
            let dates = new Set();
            data.forEach(s => Object.values(s.attendance || {}).length > 0 && Object.keys(s.attendance).forEach(d => dates.add(d)));
            const sortedDates = Array.from(dates).sort();
            
            // Fix si no hay fechas
            const datesHeader = sortedDates.length > 0 
                ? sortedDates.map(d => `<th class="px-2 py-2 text-center w-8">${d.substring(5)}</th>`).join('') 
                : '<th class="px-2 py-2 text-center">Sin Fechas</th>';

            classDetailsContainer.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Reporte Detallado: ${className}</h2>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 border text-xs"><thead class="bg-gray-100"><tr>
                    <th class="px-2 py-2 text-left border-r sticky left-0 bg-gray-100">Estudiante</th><th class="px-2 py-2 text-center border-r">Prom</th>${datesHeader}<th class="px-4 py-2 text-left">Obs</th>
                </tr></thead><tbody class="bg-white divide-y divide-gray-200">${data.map(s => {
                    const datesCells = sortedDates.length > 0 
                        ? sortedDates.map(d => `<td class="px-1 py-2 text-center border-r ${s.attendance[d]==='P'?'bg-green-50 font-bold text-green-600':(s.attendance[d]==='A'?'bg-red-50 font-bold text-red-600':(s.attendance[d]==='J'?'bg-yellow-50 font-bold text-yellow-600':'text-gray-300'))}">${s.attendance[d]||'-'}</td>`).join('')
                        : '<td class="px-1 py-2 text-center text-gray-400">-</td>';
                    return `<tr><td class="px-2 py-3 font-medium border-r sticky left-0 bg-white">${s.name}</td><td class="px-2 py-3 text-center font-bold text-blue-600 border-r">${calculateAverage(s.grades)}</td>${datesCells}<td class="px-4 py-3 text-gray-600">${(s.observations||[]).map(o=>`${o.date}: ${o.text}`).join(' | ')}</td></tr>`;
                }).join('')}</tbody></table></div>`;
        }

        // UTILIDADES Y HANDLERS
        function calculateClassSummary(className) {
            const cls = allClassesData[className] || [];
            let sum = { P: 0, A: 0, J: 0, total_students: cls.length, total_records: 0 };
            cls.forEach(s => {
                if(s.attendance) Object.values(s.attendance).forEach(st => { if (st in sum) { sum[st]++; sum.total_records++; } });
            });
            sum.tasa_asistencia = sum.total_records > 0 ? ((sum.P + sum.J) / sum.total_records * 100).toFixed(1) + '%' : 'N/A';
            return sum;
        }

        window.addGrade = (index) => {
            const val = parseFloat(getEl(`gradeInput-${index}`).value);
            if (isNaN(val) || val < 1 || val > 7) return alert('Nota inv√°lida');
            students[index].grades.push({ value: val, date: currentDateString, id: Date.now() });
            getEl(`gradeInput-${index}`).value = '';
            updateDataAndRender();
        };

        window.editGrade = (sIdx, gIdx) => {
            if(prompt("üîí Clave Docente:") !== CLAVE_DOCENTE) return alert("Clave Incorrecta");
            const act = prompt(`Editar (nota) o 'borrar'`, students[sIdx].grades[gIdx].value);
            if(!act) return;
            if(act.toLowerCase()==='borrar') students[sIdx].grades.splice(gIdx, 1);
            else students[sIdx].grades[gIdx].value = parseFloat(act);
            updateDataAndRender();
        };

        window.openObservationModal = (index) => {
            currentStudentIndex = index;
            getEl('modalTitle').textContent = `Observaciones: ${students[index].name}`;
            obsDateDisplay.textContent = currentDateString;
            newObservationText.value = '';
            const hist = students[index].observations || [];
            observationHistory.innerHTML = hist.length ? hist.map(o => `<div class="bg-gray-50 border-l-4 border-indigo-400 p-2 mb-2"><span class="text-xs font-bold text-indigo-600">${o.date}</span><p class="text-sm">${o.text}</p></div>`).join('') : '<p class="text-gray-400 italic">Sin observaciones.</p>';
            observationModal.style.display = 'flex';
        };

        window.saveObservation = () => {
            const txt = newObservationText.value.trim();
            if(!txt) return;
            if(!students[currentStudentIndex].observations) students[currentStudentIndex].observations = [];
            students[currentStudentIndex].observations.push({ text: txt, date: currentDateString, id: Date.now() });
            observationModal.style.display = 'none';
            updateDataAndRender();
        };

        function updateDataAndRender() { allClassesData[currentClass] = students; renderStudentsTable(); }
        function calculateAverage(g) { return (!g || !g.length) ? '0.0' : (g.reduce((a, b) => a + (b.value||0), 0) / g.length).toFixed(1); }
        function getAttendanceStatus(s) { return (s.attendance && s.attendance[currentDateString]) ? s.attendance[currentDateString] : 'N/A'; }
        
        function initializeClassSelector() {
            classSelector.innerHTML = '';
            Object.keys(allClassesData).forEach(n => {
                const opt = document.createElement('option'); opt.value = n; opt.textContent = n;
                if(n === currentClass) opt.selected = true;
                classSelector.appendChild(opt);
            });
        }

        function updateCurrentDateUI() { 
             const parts = currentDateString.split('-');
             const d = new Date(parts[0], parts[1]-1, parts[2]);
             currentDateElement.textContent = d.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
             dateSelector.value = currentDateString;
             document.querySelectorAll('.print-date-placeholder').forEach(el => el.textContent = d.toLocaleDateString('es-ES'));
        }

        function attachTableListeners() {
            document.querySelectorAll('.attendance-btn').forEach(b => b.addEventListener('click', (e) => {
                if(!students[e.target.dataset.index].attendance) students[e.target.dataset.index].attendance = {};
                students[e.target.dataset.index].attendance[currentDateString] = e.target.dataset.status;
                updateDataAndRender();
            }));
            document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', (e) => {
                if(confirm("¬øEliminar?")) { students.splice(e.target.dataset.index, 1); updateDataAndRender(); }
            }));
        }
        
        function setupEventHandlers() { 
             saveDataBtn.addEventListener('click', saveData);
             getEl('closeObservationModalBtn').addEventListener('click', () => observationModal.style.display = 'none');
             getEl('saveObservationBtn').addEventListener('click', window.saveObservation); 
             classSelector.addEventListener('change', (e) => { currentClass = e.target.value; students = allClassesData[currentClass] || []; renderStudentsTable(); });
             dateSelector.addEventListener('change', (e) => { currentDateString = e.target.value; updateCurrentDateUI(); renderStudentsTable(); });
             showReportBtn.addEventListener('click', generateClassReport);
             showDetailedReportBtn.addEventListener('click', () => generateDetailedReport(currentClass));
             backToTableBtn.addEventListener('click', () => showView('table'));
             printReportBtn.addEventListener('click', () => window.print());
             addStudentBtn.addEventListener('click', addStudent);
             addClassBtn.addEventListener('click', addNewClass);
             resetCoursesBtn.addEventListener('click', loadDefaultCourses);
        }

        window.onload = initApp;
    </script>
</body>
</html>