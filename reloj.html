<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ProfeAle v7.7 - Gestión Completa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        .cell-input { width: 100%; text-align: center; background: transparent; border: 1px solid transparent; font-weight: bold; font-size: 0.85rem; color: #475569; }
        .cell-input:focus { background: white; border-color: #6366f1; outline: none; }
        .input-time { font-size: 0.8rem; padding: 2px; text-align: center; border-radius: 4px; border: 1px solid #cbd5e1; width: 100%; cursor: pointer; transition: border-color 0.2s; }
        .input-time:focus { border-color: #f97316; outline: none; background-color: #fff7ed; }
        
        #toast {
            visibility: hidden; min-width: 250px; background-color: #10b981; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 50; left: 50%; bottom: 30px;
            transform: translateX(-50%); font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0; transition: opacity 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; }
        
        /* ESTILOS DE ESTADO */
        .text-debt { color: #dc2626; font-weight: 800; } 
        .text-justified { color: #2563eb; font-weight: bold; } 
        .bg-justified { background-color: #eff6ff !important; }
        .text-work { text-decoration: line-through; color: #94a3b8; font-weight: normal; } 
        .bg-work { background-color: #f0fdf4 !important; }
        .bg-weekend { background-color: #f8fafc; color: #cbd5e1; }
        .text-extra { color: #3b82f6; font-size: 0.75rem; }

        .nav-btn { cursor: pointer; border-bottom: 2px solid transparent; padding-bottom: 4px; opacity: 0.7; transition: all 0.2s; }
        .nav-btn.active { border-color: #fb923c; opacity: 1; font-weight: bold; color: white; }
    </style>
</head>
<body class="p-4 text-slate-800 flex flex-col min-h-screen">

    <div id="toast"><i class="fa-solid fa-check-circle"></i> Guardado exitoso</div>
    <input type="file" id="logoInput" accept="image/*" class="hidden">

    <div class="max-w-[1600px] mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200 flex-grow w-full flex flex-col">
        
        <div class="bg-slate-900 p-4 text-white flex justify-between items-center shadow-md z-20">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold flex items-center gap-2">
                        <i class="fa-solid fa-graduation-cap text-orange-400"></i> ProfeAle Gestión v7.7
                    </h1>
                </div>
                <div class="flex gap-4 ml-6 text-sm">
                    <div onclick="switchTab('processor')" id="nav-processor" class="nav-btn active flex items-center gap-2"><i class="fa-solid fa-calculator"></i> Procesador</div>
                    <div onclick="switchTab('monitor')" id="nav-monitor" class="nav-btn flex items-center gap-2"><i class="fa-solid fa-chart-line"></i> Monitor</div>
                </div>
            </div>

            <div id="processor-controls" class="flex gap-2 items-center">
                <div class="bg-slate-800 p-1 px-2 rounded border border-slate-600 flex flex-col items-center">
                    <label class="text-[9px] text-slate-400 uppercase font-bold block mb-1">Periodo</label>
                    <div class="flex items-center gap-1">
                        <button onclick="changeYear(-1)" class="bg-slate-700 hover:bg-slate-600 text-white text-[10px] px-2 py-1 rounded">◀</button>
                        <input type="month" id="reportMonth" class="bg-transparent text-white font-bold text-sm outline-none cursor-pointer border-b border-slate-500 hover:border-orange-400 w-28 text-center" onchange="renderTable()">
                        <button onclick="changeYear(1)" class="bg-slate-700 hover:bg-slate-600 text-white text-[10px] px-2 py-1 rounded">▶</button>
                    </div>
                </div>
                <button onclick="document.getElementById('logoInput').click()" class="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded text-xs border border-indigo-400 text-white font-bold ml-2">Logo</button>
                <img id="logoPreview" class="h-8 w-8 object-contain bg-white rounded hidden border border-white">
                <label class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded cursor-pointer transition shadow border border-emerald-400 text-sm flex items-center gap-2 ml-2">
                    <i class="fa-solid fa-file-import"></i> Cargar Excel
                    <input type="file" id="fileUpload" class="hidden">
                </label>
            </div>
        </div>

        <div id="view-processor" class="p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow">
            <div class="lg:col-span-3 space-y-4 border-r border-slate-100 pr-4">
                <div class="bg-blue-50 p-3 rounded border border-blue-100 shadow-sm">
                    <label class="block text-xs font-bold text-blue-900 uppercase mb-1">1. Funcionario</label>
                    <select id="staffSelector" class="w-full p-2 border border-blue-300 rounded bg-white text-sm font-bold text-slate-700" disabled onchange="loadStaffConfig()">
                        <option value="">Esperando archivo...</option>
                    </select>
                </div>
                
                <div id="schedulePanel" class="bg-slate-50 p-3 rounded border border-slate-200 opacity-50 pointer-events-none transition-opacity shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-slate-700 uppercase">2. Horario Contrato</label>
                        <button onclick="saveScheduleToCloud()" class="bg-blue-600 text-white text-[10px] px-2 py-1 rounded hover:bg-blue-700 shadow transition"><i class="fa-solid fa-cloud"></i></button>
                    </div>
                    <div id="hours-container" class="space-y-1"></div>
                    <div class="mt-3 border-t border-slate-200 pt-2 flex items-center justify-between">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Horas Semanales:</label>
                        <input type="number" id="contractHours" class="w-16 p-1 text-center border border-slate-300 rounded text-sm font-bold text-slate-700" placeholder="44" onchange="renderTable()">
                    </div>
                </div>

                <div id="alignControls" class="bg-orange-50 p-3 rounded border border-orange-200 opacity-50 pointer-events-none text-center">
                    <label class="block text-xs font-bold text-orange-900 uppercase mb-1">3. Alinear Datos</label>
                    <div class="flex gap-2 justify-center items-center">
                        <button onclick="shiftData(1)" class="px-3 py-1 bg-white border border-orange-300 rounded font-bold text-orange-700">◀</button>
                        <span id="offsetDisplay" class="font-mono font-bold text-lg w-8 text-orange-800">0</span>
                        <button onclick="shiftData(-1)" class="px-3 py-1 bg-white border border-orange-300 rounded font-bold text-orange-700">▶</button>
                    </div>
                    <div id="debugInfo" class="mt-2 text-[10px] text-slate-500 font-mono break-all leading-tight">...</div>
                </div>

                <div class="mt-4 pt-4 border-t border-slate-200 space-y-3">
                    <button onclick="renderTable()" class="w-full bg-indigo-600 text-white font-bold py-2.5 rounded shadow hover:bg-indigo-700 text-sm flex justify-center gap-2 items-center"><i class="fa-solid fa-rotate"></i> Recalcular Tabla</button>
                    <button onclick="saveMonthToHistory()" id="btnSaveHistory" class="w-full bg-pink-600 text-white font-bold py-2.5 rounded shadow hover:bg-pink-700 text-sm flex justify-center gap-2 items-center opacity-50 cursor-not-allowed" disabled><i class="fa-solid fa-floppy-disk"></i> Registrar Cierre</button>
                    <button onclick="exportExcelWithLogo()" id="btnExport" class="w-full bg-green-600 text-white font-bold py-2.5 rounded shadow hover:bg-green-700 text-sm flex justify-center gap-2 items-center opacity-50 cursor-not-allowed" disabled><i class="fa-solid fa-file-excel"></i> Exportar Informe</button>
                </div>
            </div>

            <div class="lg:col-span-9 flex flex-col h-[650px]">
                <div class="flex-grow overflow-auto border rounded bg-white shadow-inner relative">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-slate-100 text-slate-600 uppercase text-xs sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-2 text-center border-b w-10">Día</th>
                                <th class="p-2 text-center border-b w-16 bg-slate-50 border-l">Ent P</th>
                                <th class="p-2 text-center border-b w-16 bg-blue-50 text-blue-900 font-bold border-l">Ent R</th>
                                <th class="p-2 text-center border-b w-16 bg-slate-50 border-l">Sal P</th>
                                <th class="p-2 text-center border-b w-16 bg-blue-50 text-blue-900 font-bold border-l">Sal R</th>
                                <th class="p-2 text-center border-b w-16 text-red-600 bg-red-50 border-l">Atraso</th>
                                <th class="p-2 text-center border-b w-16 text-orange-600 bg-orange-50 border-l">S.Ant</th>
                                <th class="p-2 border-b border-l w-64">Observación</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div class="mt-3 flex justify-between gap-4 text-sm items-center border-t pt-3 bg-slate-50 p-3 rounded border border-slate-200">
                    <div class="flex items-center gap-2 text-slate-500 text-xs w-1/4 leading-tight"><i class="fa-solid fa-info-circle"></i> <b>AUTORIZADO</b>: Error reloj. <b>LICENCIA</b>: Justificado.</div>
                    
                    <div class="flex gap-6 flex-grow justify-end">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div> 
                            <div class="flex flex-col items-end leading-tight">
                                <span class="text-[10px] uppercase font-bold text-slate-400">Tiempo No Trabajado:</span>
                                <div class="flex items-baseline gap-2">
                                    <span id="realDebt" class="font-bold text-2xl text-red-600">0</span>
                                    <span class="text-sm font-bold text-red-400">min</span>
                                </div>
                                <span id="realDebtHrs" class="text-[10px] text-slate-400 font-mono">(00:00 hrs)</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 border-l border-slate-300 pl-6">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div> 
                            <div class="flex flex-col items-end leading-tight">
                                <span class="text-[10px] uppercase font-bold text-slate-400">Ausencia Justificada:</span>
                                <div class="flex items-baseline gap-2">
                                    <span id="justifiedDebt" class="font-bold text-2xl text-blue-600">0</span>
                                    <span class="text-sm font-bold text-blue-400">min</span>
                                </div>
                                <span id="justifiedDebtHrs" class="text-[10px] text-slate-400 font-mono">(00:00 hrs)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-monitor" class="hidden p-6 flex-grow bg-slate-50">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div><h2 class="text-2xl font-bold text-slate-800"><i class="fa-solid fa-chart-column text-indigo-500"></i> Monitor de Gestión</h2><p class="text-sm text-slate-500 mt-1">Acumulado anual de Tiempo No Trabajado (Descontable).</p></div>
                    <button onclick="loadDashboard()" class="bg-indigo-600 text-white px-5 py-2 rounded shadow font-bold text-sm"><i class="fa-solid fa-sync"></i> Actualizar</button>
                </div>
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <table class="w-full text-left border-collapse"><thead class="bg-slate-800 text-white text-xs uppercase tracking-wider"><tr><th class="p-4">Funcionario</th><th class="p-4 text-center">Tiempo No Trabajado</th><th class="p-4 text-center">Hrs Equiv.</th><th class="p-4 text-center text-blue-200">Justificado (Días)</th><th class="p-4 text-center">Semáforo</th><th class="p-4 text-right">Cierre</th></tr></thead><tbody id="dashboardBody" class="text-sm text-slate-700 divide-y divide-slate-100"></tbody></table>
                </div>
            </div>
        </div>
        <div class="bg-slate-50 text-center py-3 text-xs text-slate-400 border-t border-slate-200 mt-auto">ProfeAle v7.7</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const WORK_KEYWORDS = ['REUNION', 'REUNIÓN', 'SUPERVISION', 'SUPERVISIÓN', 'PRACTICA', 'PRÁCTICA', 'TERRENO', 'CAPACITACION', 'CAPACITACIÓN', 'COMISION', 'COMISIÓN', 'AUTORIZADO', 'ERROR', 'ACCESO', 'CLAVE', 'HUELLA', 'MARCAJE'];
        const JUSTIFIED_KEYWORDS = ['LICENCIA', 'PERMISO', 'VACACIONES', 'FERIADO', 'DUELO', 'ADMINISTRATIVO'];
        
        const firebaseConfig = { apiKey: "AIzaSyAFp6biz1UTr9Ehaudkpe7QyTFVbdQz5Sc", authDomain: "asistencia-mi-clase.firebaseapp.com", projectId: "asistencia-mi-clase", storageBucket: "asistencia-mi-clase.appspot.com", messagingSenderId: "552398254230", appId: "1:552398254230:web:c58dd07e5ceeb67e0912b7" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let allSheetsData = {}, uniqueStaffList = [], currentStaff = null, globalOffset = 0, currentTableData = [];
        
        const today = new Date(); today.setMonth(today.getMonth() - 1); 
        const prevYear = today.getFullYear(); const prevMonth = String(today.getMonth() + 1).padStart(2, '0');
        document.getElementById('reportMonth').value = `${prevYear}-${prevMonth}`;

        window.changeYear = (delta) => {
            const currentVal = document.getElementById('reportMonth').value; if(!currentVal) return;
            const [y, m] = currentVal.split('-').map(Number); const newY = y + delta;
            document.getElementById('reportMonth').value = `${newY}-${String(m).padStart(2,'0')}`; renderTable();
        };

        const days = ['Lun','Mar','Mié','Jue','Vie'];
        document.getElementById('hours-container').innerHTML = days.map((d,i) => `<div class="grid grid-cols-3 gap-1 items-center"><span class="text-[10px] font-bold pl-1 text-slate-500 uppercase">${d}</span><input type="time" id="in${i+1}" class="input-time" onchange="renderTable()"><input type="time" id="out${i+1}" class="input-time" onchange="renderTable()"></div>`).join('');

        window.switchTab = (tab) => {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.getElementById('nav-' + tab).classList.add('active');
            document.getElementById('view-processor').classList.toggle('hidden', tab !== 'processor');
            document.getElementById('view-monitor').classList.toggle('hidden', tab !== 'monitor');
            document.getElementById('processor-controls').classList.toggle('hidden', tab !== 'processor');
            if(tab === 'monitor') loadDashboard();
        };

        const logoInput = document.getElementById('logoInput');
        logoInput.addEventListener('change', function(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(evt) { const img = new Image(); img.src = evt.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); let w = img.width; let h = img.height; if(w>h){if(w>150){h*=150/w;w=150;}}else{if(h>150){w*=150/h;h=150;}} canvas.width=w; canvas.height=h; ctx.drawImage(img,0,0,w,h); try{localStorage.setItem('school_logo',canvas.toDataURL('image/png',0.8));updateLogoPreview();}catch(e){} }; }; reader.readAsDataURL(file); } });
        function updateLogoPreview() { const d = localStorage.getItem('school_logo'); const i = document.getElementById('logoPreview'); if(d){i.src=d;i.classList.remove('hidden');}else{i.classList.add('hidden');} } updateLogoPreview();

        document.getElementById('fileUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return; 
            const data = await file.arrayBuffer(); const wb = XLSX.read(data, { type: 'array' });
            allSheetsData = {}; uniqueStaffList = []; const seenNames = new Set();
            let detectedYear = null; let detectedMonth = null;
            wb.SheetNames.forEach(name => {
                const ws = wb.Sheets[name]; const json = XLSX.utils.sheet_to_json(ws, { header: 1 }); allSheetsData[name] = json;
                const textDump = JSON.stringify(json.slice(0, 10)); 
                const m1 = textDump.match(/Periodo.*?(\d{4})[\/\-](\d{2})/i); if (m1) { detectedYear = m1[1]; detectedMonth = m1[2]; }
                if (!detectedYear) { const m2 = textDump.match(/(202[3-6])/); if(m2) detectedYear = m2[1]; }
                json.forEach((row, rIdx) => { if (!row) return; const nIdx = row.findIndex(c => typeof c === 'string' && c.toUpperCase().replace(/\s/g,'').includes('NOMBRE:')); if (nIdx !== -1) { let fName = null; for(let i=1; i<=5; i++) { if(row[nIdx+i] && typeof row[nIdx+i] === 'string') { fName = row[nIdx+i].trim(); break; } } if (fName && !seenNames.has(fName)) { seenNames.add(fName); uniqueStaffList.push({ name: fName, sheetName: name, rowIndex: rIdx }); } } });
            });
            if (detectedYear) { if(!detectedMonth) detectedMonth = String(new Date().getMonth()+1).padStart(2,'0'); document.getElementById('reportMonth').value = `${detectedYear}-${detectedMonth}`; }
            const sel = document.getElementById('staffSelector'); sel.innerHTML = '<option value="">-- Selecciona --</option>';
            uniqueStaffList.sort((a,b) => a.name.localeCompare(b.name));
            uniqueStaffList.forEach((p, i) => { const o = document.createElement('option'); o.value = i; o.text = p.name; sel.appendChild(o); });
            sel.disabled = false;
        });

        window.loadStaffConfig = async () => { const listIdx = document.getElementById('staffSelector').value; if(listIdx==="") return; currentStaff=uniqueStaffList[listIdx]; document.getElementById('schedulePanel').classList.remove('opacity-50','pointer-events-none'); document.getElementById('alignControls').classList.remove('opacity-50','pointer-events-none'); globalOffset=0; document.getElementById('offsetDisplay').innerText="0"; try{const snap=await getDoc(doc(db,"config_horarios",currentStaff.name.replace(/[^a-zA-Z0-9]/g,'_').toUpperCase()));if(snap.exists()){const d=snap.data();for(let i=1;i<=5;i++){document.getElementById(`in${i}`).value=d[`d${i}_in`]||'';document.getElementById(`out${i}`).value=d[`d${i}_out`]||'';}document.getElementById('contractHours').value=d.ch||'';}else{document.querySelectorAll('.input-time').forEach(i=>i.value='');}}catch(e){} renderTable(); };
        window.saveScheduleToCloud = async () => { if(!currentStaff) return; const d={ch:document.getElementById('contractHours').value}; for(let i=1;i<=5;i++){d[`d${i}_in`]=document.getElementById(`in${i}`).value;d[`d${i}_out`]=document.getElementById(`out${i}`).value;} await setDoc(doc(db,"config_horarios",currentStaff.name.replace(/[^a-zA-Z0-9]/g,'_').toUpperCase()),d,{merge:true}); showToast("Horario guardado"); };
        window.shiftData = (d) => { globalOffset+=d; document.getElementById('offsetDisplay').innerText=globalOffset>0?`+${globalOffset}`:globalOffset; renderTable(); };

        window.renderTable = () => {
            if (!currentStaff) return;
            const schedule = [null]; for(let i=1; i<=5; i++) schedule.push({ in: document.getElementById(`in${i}`).value, out: document.getElementById(`out${i}`).value }); schedule.push(null);
            const sheetJson = allSheetsData[currentStaff.sheetName]; const startRow = currentStaff.rowIndex;
            let rowData = null; for(let i=1; i<=4; i++) { const cand = sheetJson[startRow + i]; if(cand && cand.some(c => typeof c === 'string' && /\d{1,2}:\d{2}/.test(c))) { rowData = cand; break; } }
            if(!rowData) rowData = sheetJson[startRow + 1] || [];
            let dIdx = 0; const hRow = sheetJson[startRow - 1]; if(hRow) { const f = hRow.findIndex(c => c == 1 || c == "1.0" || c == "1"); if(f !== -1) dIdx = f; }
            const [y, m] = document.getElementById('reportMonth').value.split('-').map(Number); const daysInMonth = new Date(y, m, 0).getDate();
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = ''; currentTableData = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const raw = rowData[dIdx + (day - 1) + globalOffset]; let entry = '', exit = '';
                if (raw && typeof raw === 'string') { const t = raw.match(/\d{1,2}:\d{2}/g); if (t && t.length) { t.sort(); entry = t[0]; if (t.length > 1) exit = t[t.length - 1]; } }
                const date = new Date(y, m - 1, day); const wd = date.getDay(); const wdNames = ['Do','Lu','Ma','Mi','Ju','Vi','Sa']; const isW = (wd === 0 || wd === 6); const conf = schedule[wd];
                let late = 0, early = 0, isE = false, isL = false, pIn = '', pOut = '';
                if (!isW && conf) {
                    pIn = conf.in; pOut = conf.out;
                    const shiftDur = (toMins(pOut) - toMins(pIn));
                    if (shiftDur > 0) {
                        if(entry || exit) {
                            if (pIn && entry) { const d = toMins(entry) - toMins(pIn); if (d > 5) late = d; else if (d < 0) isE = true; }
                            if (pOut && exit) { const d = toMins(pOut) - toMins(exit); if (d > 5) early = d; else if (d < 0) isL = true; }
                        } else { late = shiftDur; }
                    }
                }
                const entDisp = isE ? `<span class="text-extra">${entry}</span>` : (late > 0 && entry ? `<span class="text-debt">${entry}</span>` : entry);
                const extDisp = isL ? `<span class="text-extra">${exit}</span>` : (early > 0 && exit ? `<span class="text-debt">${exit}</span>` : exit);
                tbody.innerHTML += `<tr id="row-${day-1}" class="${isW ? 'bg-weekend' : 'hover:bg-blue-50 border-b'}"><td class="p-1 border-r text-center font-bold text-xs">${day} <span class="text-[9px] text-gray-400 block">${wdNames[wd]}</span></td><td class="text-center text-xs text-gray-400 border-r">${pIn||'-'}</td><td class="text-center text-xs border-r">${entDisp}</td><td class="text-center text-xs text-gray-400 border-r">${pOut||'-'}</td><td class="text-center text-xs border-r">${extDisp}</td><td id="late-cell-${day-1}" class="text-center font-bold text-sm ${late>0?'text-debt bg-red-50':''} border-r">${late>0?late:'-'}</td><td id="early-cell-${day-1}" class="text-center font-bold text-sm ${early>0?'text-orange-600 bg-orange-50':''} border-r">${early>0?early:'-'}</td><td class="p-1"><input type="text" class="cell-input text-left" placeholder="..." oninput="updateObs(${day-1}, this.value)"></td></tr>`;
                currentTableData.push({ d:day, wd:wdNames[wd], late, early, obs:'', isW, pi: pIn, po: pOut, ri: entry, ro: exit });
            }
            recalcTotals();
            document.getElementById('btnExport').disabled = false; document.getElementById('btnExport').classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('btnSaveHistory').disabled = false; document.getElementById('btnSaveHistory').classList.remove('opacity-50', 'cursor-not-allowed');
        };

        window.recalcTotals = () => {
            let sumReal = 0, sumJustified = 0;
            currentTableData.forEach((row, idx) => {
                const obs = (row.obs || '').toUpperCase();
                const isWork = WORK_KEYWORDS.some(k => obs.includes(k));
                const isJustified = JUSTIFIED_KEYWORDS.some(k => obs.includes(k));
                const lC = document.getElementById(`late-cell-${idx}`); const eC = document.getElementById(`early-cell-${idx}`); const tr = document.getElementById(`row-${idx}`);
                if(lC) { lC.classList.remove('text-work', 'text-justified'); eC.classList.remove('text-work', 'text-justified'); tr.className = tr.className.replace(/bg-\w+/g, '').trim() + ' hover:bg-blue-50 border-b'; }
                if (isWork) { if(lC) lC.classList.add('text-work'); if(eC) eC.classList.add('text-work'); if(tr) tr.classList.add('bg-work'); }
                else if (isJustified) { if(lC) lC.classList.add('text-justified'); if(eC) eC.classList.add('text-justified'); if(tr) tr.classList.add('bg-justified'); sumJustified += (row.late||0) + (row.early||0); }
                else { sumReal += (row.late||0) + (row.early||0); }
            });
            document.getElementById('realDebt').innerText = sumReal; document.getElementById('justifiedDebt').innerText = sumJustified;
            document.getElementById('realDebtHrs').innerText = `(${toHrs(sumReal)} hrs)`; document.getElementById('justifiedDebtHrs').innerText = `(${toHrs(sumJustified)} hrs)`;
            currentStaff.stats = { real: sumReal, justified: sumJustified };
        };

        window.updateObs = (idx, val) => { if(currentTableData[idx]){currentTableData[idx].obs = val; recalcTotals();} };
        function toMins(t) { if (!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; }
        function toHrs(m) { const hrs = Math.floor(m / 60); const mins = m % 60; return `${hrs}:${String(mins).padStart(2,'0')}`; }
        function showToast(msg) { const t=document.getElementById("toast"); t.innerHTML=`<i class="fa-solid fa-check-circle"></i> ${msg}`; t.className="show"; setTimeout(()=>t.className="",3000); }

        window.saveMonthToHistory = async () => {
            if(!currentStaff || !currentStaff.stats) return;
            const docId = currentStaff.name.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase(); const period = document.getElementById('reportMonth').value;
            try { const staffRef = doc(db, "historial_deuda", docId); const snap = await getDoc(staffRef); let hData = snap.exists() ? snap.data() : { name: currentStaff.name, history: {} }; hData.history[period] = currentStaff.stats; hData.lastUpdate = new Date().toISOString(); hData.contractHours = document.getElementById('contractHours').value; hData.name = currentStaff.name; await setDoc(staffRef, hData); showToast(`Mes ${period} registrado OK`); } catch(e) { alert(e.message); }
        };

        window.loadDashboard = async () => {
            const tbody = document.getElementById('dashboardBody'); tbody.innerHTML = '<tr><td colspan="6" class="p-10 text-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-indigo-500"></i> Calculando...</td></tr>';
            try {
                const qs = await getDocs(collection(db, "historial_deuda")); const data = [];
                qs.forEach(docSnap => { const obj = docSnap.data(); let tr = 0, tj = 0; if(obj.history) { Object.values(obj.history).forEach(e => { if(typeof e === 'number') tr += e; else { tr += (e.real||0); tj += (e.justified||0); } }); } obj.totalReal = tr; obj.totalJustified = tj; data.push(obj); });
                data.sort((a, b) => b.totalReal - a.totalReal);
                tbody.innerHTML = ''; if(data.length===0){tbody.innerHTML='<tr><td colspan="6" class="p-8 text-center text-slate-400">Sin datos.</td></tr>';return;}
                data.forEach(s => {
                    const hrs = Math.floor(s.totalReal/60); const mins = s.totalReal%60; const daysJustified = (s.totalJustified/480).toFixed(1);
                    let badge = ''; if(s.totalReal<60) badge='<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold border border-green-200">AL DÍA</span>'; else if(s.totalReal<600) badge='<span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200">ALERTA</span>'; else badge='<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold border border-red-200 animate-pulse">CRÍTICO</span>';
                    tbody.innerHTML += `<tr class="hover:bg-slate-50 border-b border-slate-100"><td class="p-4 font-bold text-slate-700">${s.name}</td><td class="p-4 text-center"><span class="font-mono font-bold text-lg ${s.totalReal>0?'text-red-600':'text-slate-400'}">${s.totalReal}</span> <span class="text-xs text-slate-400">min</span></td><td class="p-4 text-center text-slate-600 font-medium">${hrs}:${String(mins).padStart(2,'0')}</td><td class="p-4 text-center"><span class="text-blue-600 font-bold">${daysJustified}</span> <span class="text-xs text-blue-400">días</span></td><td class="p-4 text-center">${badge}</td><td class="p-4 text-right text-xs text-slate-400 font-mono">${s.lastUpdate?new Date(s.lastUpdate).toLocaleDateString():'-'}</td></tr>`;
                });
            } catch(e) { tbody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 p-4">${e.message}</td></tr>`; }
        };

        window.exportExcelWithLogo = async () => { 
            // 1. FORZAR RECALCULO DE TABLA
            renderTable();
            await new Promise(r => setTimeout(r, 50)); // Micro-espera

            const workbook = new ExcelJS.Workbook(); const worksheet = workbook.addWorksheet('Asistencia');
            worksheet.columns = [{ header: 'Día', key: 'd', width: 6 }, { header: 'Sem', key: 'wd', width: 6 }, { header: 'Entrada\nProg', key: 'pi', width: 12 }, { header: 'Entrada\nReal', key: 'ri', width: 12 }, { header: 'Salida\nProg', key: 'po', width: 12 }, { header: 'Salida\nReal', key: 'ro', width: 12 }, { header: 'Atraso\n(min)', key: 'late', width: 10 }, { header: 'S. Antic\n(min)', key: 'early', width: 10 }, { header: 'Observación', key: 'obs', width: 45 }];
            const logoBase64 = localStorage.getItem('school_logo'); if(logoBase64) { const imageId = workbook.addImage({ base64: logoBase64, extension: 'png' }); worksheet.addImage(imageId, { tl: { col: 0, row: 0 }, ext: { width: 80, height: 80 } }); }
            
            // 2. LEER HORARIOS ACTUALES DEL DOM PARA ASEGURAR QUE NO ESTÉN VACÍOS
            const currentContractHrs = document.getElementById('contractHours').value || 'N/A';
            
            worksheet.mergeCells('C1:I1'); worksheet.getCell('C1').value = 'REPORTE OFICIAL DE ASISTENCIA'; worksheet.getCell('C1').font = { name: 'Arial', size: 14, bold: true, color: { argb: 'FF1E293B' } }; worksheet.getCell('C1').alignment = { vertical: 'middle', horizontal: 'center' };
            worksheet.mergeCells('C2:I2'); worksheet.getCell('C2').value = `Funcionario: ${currentStaff.name}`; worksheet.getCell('C2').font = { name: 'Arial', size: 16, bold: true }; worksheet.getCell('C2').alignment = { vertical: 'middle', horizontal: 'center' };
            worksheet.mergeCells('C3:I3'); worksheet.getCell('C3').value = `Periodo: ${document.getElementById('reportMonth').value} | Hrs Contrato: ${currentContractHrs}`; worksheet.getCell('C3').alignment = { vertical: 'middle', horizontal: 'center' };
            
            const headerRow = worksheet.getRow(5); headerRow.values = ['Día', 'Sem', 'Entrada Prog', 'Entrada Real', 'Salida Prog', 'Salida Real', 'Atraso', 'S. Antic', 'Observación']; headerRow.height = 30;
            headerRow.eachCell((cell) => { cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E293B' } }; cell.font = { color: { argb: 'FFFFFFFF' }, bold: true }; cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true }; cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} }; });
            
            let rIdx = 6; let sumReal = 0, sumJust = 0;
            
            // 3. ITERACIÓN DE DATOS (YA INCLUYEN HORARIOS RECALCULADOS)
            currentTableData.forEach(r => {
                const row = worksheet.getRow(rIdx); const obs = (r.obs || '').toUpperCase();
                const isWork = WORK_KEYWORDS.some(k => obs.includes(k)); const isJust = JUSTIFIED_KEYWORDS.some(k => obs.includes(k));
                if (isJust) sumJust += (r.late || 0) + (r.early || 0); else if (!isWork) sumReal += (r.late || 0) + (r.early || 0);
                
                // Aseguramos que los horarios programados (pi, po) se escriban aunque sean nulos en el origen
                row.values = [r.d, r.wd, r.pi || '', r.ri, r.po || '', r.ro, r.late||0, r.early||0, r.obs];
                
                row.eachCell((cell, col) => {
                    cell.alignment = { vertical: 'middle', horizontal: 'center' }; cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                    if ((col === 7 || col === 8) && cell.value > 0) { if (isWork) { cell.font = { strike: true, color: { argb: 'FF94A3B8' } }; } else if (isJust) { cell.font = { color: { argb: 'FF2563EB' }, bold: true }; cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEFF6FF' } }; } else { cell.font = { color: { argb: 'FFDC2626' }, bold: true }; cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEE2E2' } }; } }
                }); rIdx++;
            });

            // TOTALES
            rIdx++; const tRow = worksheet.getRow(rIdx); tRow.getCell(6).value = "TOTAL A DESCONTAR (TIEMPO NO TRABAJADO):"; tRow.getCell(6).font = { bold: true, color: { argb: 'FFDC2626' } }; tRow.getCell(6).alignment = { horizontal: 'right' }; tRow.getCell(7).value = sumReal + " min"; tRow.getCell(7).font = { bold: true, size: 12, color: { argb: 'FFDC2626' } }; tRow.getCell(7).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFEE2E2' } };
            // NUEVO: HORAS REALES
            rIdx++; const tHrsRow = worksheet.getRow(rIdx); tHrsRow.getCell(6).value = "EQUIVALENTE EN HORAS:"; tHrsRow.getCell(6).font = { bold: true, italic: true }; tHrsRow.getCell(6).alignment = { horizontal: 'right' }; tHrsRow.getCell(7).value = toHrs(sumReal) + " hrs";
            
            // TOTALES JUSTIFICADOS
            rIdx++; const jRow = worksheet.getRow(rIdx); jRow.getCell(6).value = "TOTAL AUSENCIA JUSTIFICADA (NO DESCONTAR):"; jRow.getCell(6).font = { bold: true, color: { argb: 'FF2563EB' } }; jRow.getCell(6).alignment = { horizontal: 'right' }; jRow.getCell(7).value = sumJust + " min"; jRow.getCell(7).font = { bold: true, color: { argb: 'FF2563EB' } };
            // NUEVO: HORAS JUSTIFICADAS
            rIdx++; const jHrsRow = worksheet.getRow(rIdx); jHrsRow.getCell(6).value = "EQUIVALENTE EN HORAS:"; jHrsRow.getCell(6).font = { bold: true, italic: true }; jHrsRow.getCell(6).alignment = { horizontal: 'right' }; jHrsRow.getCell(7).value = toHrs(sumJust) + " hrs";

            rIdx += 2; const legendLabel = worksheet.getRow(rIdx).getCell(2); legendLabel.value = "NOTA:"; legendLabel.font = { bold: true, size: 10 }; rIdx++; const legendText = worksheet.getRow(rIdx).getCell(2); legendText.value = "Minutos justificados (azul) = Licencias/Administrativos (No descontables). Minutos Tachados = Error de reloj/Trabajo terreno."; legendText.font = { italic: true, size: 9, color: { argb: 'FF64748B' } }; worksheet.mergeCells(`B${rIdx}:I${rIdx}`);
            const buffer = await workbook.xlsx.writeBuffer(); const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }); saveAs(blob, `Reporte_Oficial_${currentStaff.name.replace(/\s+/g, '_')}.xlsx`);
        };
    </script>
</body>
</html>