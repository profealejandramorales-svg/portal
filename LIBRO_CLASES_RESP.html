<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Libro de Clases Digital</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --primary: #004a99; 
            --primary-dark: #003366;
            --bg: #f4f6f8; 
            --text: #333; 
            --border: #ddd;
            --white: #ffffff;
            --danger: #d32f2f;
            --success: #388e3c;
            --warning: #fbc02d;
            --header-height: 60px;
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg); 
            margin: 0; padding: 0; color: var(--text); font-size: 13px; 
            padding-top: var(--header-height);
            position: relative; 
            min-height: 100vh;
            display: flex; flex-direction: column;
        }

        .app-header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: var(--primary); color: white; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .app-brand { display: flex; align-items: center; gap: 15px; font-weight: 700; font-size: 18px; }
        .app-brand img { height: 40px; width: 40px; border-radius: 50%; border: 2px solid white; object-fit: cover; }
        .app-controls { display: flex; gap: 10px; align-items: center; }

        .main-container { max-width: 98%; margin: 20px auto; padding: 0 15px; flex: 1; width: 100%; }
        .vista { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .vista.activa { display: block; opacity: 1; }

        .card { background: var(--white); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .card h2 { margin: 0; color: var(--primary); font-size: 1.5rem; }
        
        .grid-cursos { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .curso-item { background: white; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; border-top: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .curso-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 8px; text-align: center; border-bottom: 4px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-val { font-size: 28px; font-weight: bold; color: var(--primary); display: block; margin: 10px 0; }
        .kpi-lbl { color: #666; font-size: 12px; text-transform: uppercase; font-weight: 600; }
        .kpi-red { border-bottom-color: var(--danger); } .kpi-red .kpi-val { color: var(--danger); }
        .kpi-green { border-bottom-color: var(--success); } .kpi-green .kpi-val { color: var(--success); }

        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; transition: background 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-default { background: #e0e0e0; color: #333; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-sm { padding: 4px 8px; font-size: 14px; }
        .btn-back { background: transparent; border: 1px solid white; color: white; }
        .btn-icon { background: transparent; color: #666; padding: 5px; font-size: 16px; border:none; cursor: pointer; }
        .btn-icon:hover { color: var(--primary); background: #eee; border-radius: 50%; }
        
        .tabs-container { display: flex; gap: 5px; border-bottom: 2px solid var(--primary); margin-bottom: 15px; background: white; padding: 10px 10px 0 10px; border-radius: 8px 8px 0 0; }
        .tab-btn { padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 500; color: #666; transition: all 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; font-weight: 700; }

        .table-wrapper { overflow: auto; background: white; border: 1px solid var(--border); border-radius: 4px; max-height: 70vh; position: relative; }
        table.sge-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 12px; }
        .sge-table th, .sge-table td { border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; padding: 4px 6px; text-align: center; height: 30px; white-space: nowrap; }
        .sge-table thead th { position: sticky; top: 0; z-index: 10; background: #f8f9fa; color: #444; font-weight: 600; border-bottom: 2px solid #ccc; }
        .col-alumno { position: sticky; left: 0; z-index: 11; background: white; text-align: left !important; padding-left: 10px !important; border-right: 2px solid #999 !important; width: 250px; min-width: 250px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
        .sge-table thead th.col-alumno { z-index: 20; background: #f8f9fa; }
        
        .tr-click { cursor: pointer; transition: background 0.1s; }
        .tr-click:hover { background-color: #e3f2fd; }
        .tr-retiro { background-color: #eeeeee; color: #999; }
        .tr-retiro td { color: #999; }

        .th-eval { cursor: pointer; transition: background 0.2s; }
        .th-eval:hover { background-color: #e3f2fd !important; text-decoration: underline; }
        .th-configured { background-color: #1976d2 !important; color: white !important; border-bottom-color: #0d47a1 !important; }

        input.nota-in { width: 100%; height: 100%; border: 1px solid transparent; text-align: center; font-family: inherit; font-size: 12px; font-weight: 600; background: transparent; }
        input.nota-in:focus { background: #e3f2fd; border: 1px solid var(--primary); outline: none; }
        select.nota-in { width: 100%; height: 100%; border: none; text-align: center; background: transparent; font-size: 11px; font-weight: bold; cursor: pointer; appearance: none; -webkit-appearance: none; }
        select.nota-in:hover { background: #f0f0f0; }

        .cell-proc { background: #fff3e0 !important; font-weight: bold; border-left: 2px solid #ccc; }
        .cell-prom { background: #e8f5e9 !important; font-weight: bold; color: #2e7d32; }
        .cell-final { background: #e3f2fd !important; font-weight: bold; color: var(--primary); border-left: 2px solid #999; }
        .cell-auto { background: #e0f7fa !important; font-weight: bold; color: #006064; cursor: help; }
        
        select.form-control, input.form-control, textarea.form-control { 
            padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; width: 100%; 
        }
        .form-section { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; color: var(--primary); font-weight: bold; font-size: 11px; text-transform: uppercase; }

        /* ESTADISTICAS */
        .stats-container { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .stats-box { background: #fff; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stats-header { background: #eee; padding: 5px; text-align: center; font-weight: bold; border-bottom: 1px solid #ccc; font-size: 11px; }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .stats-table td { border: 1px solid #eee; padding: 3px 15px; text-align: center; }
        .stats-table tr:last-child td { font-weight: bold; background: #fafafa; }

        .sabana-table th { font-size: 10px; padding: 2px; }
        .sabana-table td { font-size: 11px; padding: 2px; border: 1px solid #e0e0e0; }
        .sabana-header-asig { background-color: #cfd8dc !important; font-weight: bold; text-transform: uppercase; border-left: 2px solid #666 !important; font-size: 9px !important; }
        .sabana-s1 { background-color: #e3f2fd; } .sabana-s2 { background-color: #f3e5f5; }
        .sabana-final { background-color: #fff3e0; font-weight: bold; border-right: 2px solid #ccc !important; }
        .nota-roja { color: red !important; font-weight: bold; } .nota-azul { color: #004a99; }
        .sabana-alert { background-color: #ffebee !important; color: red; font-weight: bold; }

        /* VISTA DETALLADA UTP */
        .utp-complex-table { width: 100%; border-collapse: collapse; font-size: 11px; font-family: 'Arial Narrow', sans-serif; }
        .utp-complex-table th, .utp-complex-table td { border: 1px solid #999; padding: 4px; text-align: center; }
        .utp-complex-table thead th { background-color: #cfd8dc; font-weight: bold; color: #333; }
        .header-main-blue { background-color: #0d47a1 !important; color: white !important; font-size: 14px; text-transform: uppercase; padding: 8px !important; }
        .header-sub-blue { background-color: #bbdefb !important; font-weight: bold; }
        .cell-yellow { background-color: #fff9c4 !important; font-weight: bold; }
        
        .footer-credits { margin-top: auto; padding: 15px; background: white; border-top: 1px solid #eee; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; color: #666; font-weight: bold; }
        .footer-credits img { height: 60px; margin-bottom: 5px; }
        
        .alu-thumb { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 1px solid #ccc; display: block; margin: 0 auto; }

        /* --- IMPRESI√ìN --- */
        @media print {
            @page { size: landscape; margin: 0; }
            
            html, body { 
                background: white !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                width: 100% !important; 
                height: 100% !important; 
                overflow: visible !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            
            /* ELEMENTOS OCULTOS AL IMPRIMIR */
            body::before { display: none !important; content: none !important; }
            .app-header, .tabs-container, .btn, #vMenu, #vCurso, #modalEval, #modalAsisStats, .no-print, #loader, .footer-credits, #modalAlumno, #modalAsigManager { display: none !important; }
            
            body > *:not(#printArea) { display: none !important; }
            
            #printArea { 
                display: block !important; 
                position: absolute !important; 
                top: 0 !important; 
                left: 0 !important; 
                width: 100% !important; 
                background: white !important; 
                z-index: 9999 !important; 
            }
            #printArea * { visibility: visible !important; }

            /* INFORME ALUMNO (Individual) - Estricto para duplex */
            .informe-page { 
                width: 100%; 
                height: 100vh; 
                position: relative; 
                page-break-after: always; 
                break-after: page; 
                display: flex; 
                flex-direction: column; 
                background: white !important;
                padding: 20px 40px; 
                box-sizing: border-box;
                overflow: hidden; /* Evita que contenido se pase a la siguiente */
            }

            /* PLANILLA CURSO (Masivo) - Permite flujo continuo */
            .print-flow-container {
                width: 100%;
                height: auto;
                overflow: visible !important;
                background: white;
                padding: 20px;
                display: block;
            }
            
            .print-flow-container .table-wrapper {
                overflow: visible !important;
                max-height: none !important;
                border: none !important;
                box-shadow: none !important;
            }
            
            .print-flow-container table {
                width: 100% !important;
                font-size: 10px !important; 
                border-collapse: collapse !important;
            }
            
            .print-flow-container th, .print-flow-container td {
                padding: 2px !important;
                border: 1px solid #999 !important;
            }
            
            .print-flow-container thead { display: table-header-group; }
            .print-flow-container tr { page-break-inside: avoid; }

            .inf-header-grid { display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #004a99; padding-bottom: 8px; margin-bottom: 8px; position: relative; z-index: 2; background: white; }
            .inf-logo { width: 60px !important; height: auto !important; }
            .inf-center { text-align: center; flex: 1; }
            .inf-school { font-size: 14px; font-weight: bold; text-transform: uppercase; color: #004a99; }
            .inf-doc-title { font-size: 16px; font-weight: bold; text-decoration: underline; margin-top: 5px; }

            .inf-data-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 5px; background: #f9f9f9; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; margin-bottom: 8px; position: relative; z-index: 2; }
            .inf-data-grid div { border-right: 1px solid #ddd; padding-right: 5px; } .inf-data-grid div:last-child { border-right: none; }

            .inf-table, .pers-table, .print-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; position: relative; z-index: 2; background: transparent !important; }
            .inf-table th, .inf-table td, .pers-table th, .pers-table td, .print-table th, .print-table td { border: 1px solid #000 !important; }

            .inf-table th { background-color: #e0e0e0 !important; color: #333; font-weight: bold; text-align: center; font-size: 10px; padding: 3px; }
            .inf-table td { font-size: 10px; padding: 2px; text-align: center; height: 16px; }
            .print-col-nombre { text-align: left !important; padding-left: 5px !important; width: 25%; font-weight: bold; font-size: 10px !important;}
            .print-col-prom { background-color: #f5f5f5 !important; font-weight: bold; }
            .final-closed { background-color: #e3f2fd !important; font-weight: bold; color: #004a99; }

            .pers-table th { background-color: #fff2cc !important; color: #000 !important; font-size: 10px; padding: 4px; text-align: center; }
            .pers-table td { font-size: 10px; padding: 2px 4px; }
            .pers-cat-row { background-color: #f0f0f0 !important; font-weight: bold !important; text-align: left !important; padding-left: 10px !important; }
            .pers-val-col { text-align: center !important; width: 60px; font-weight: bold; }

            .print-table th, .print-table td { font-size: 10px !important; padding: 2px; text-align: center; color: black !important; }

            .box-title { background: #eee; border: 1px solid #000; font-weight: bold; font-size: 10px; padding: 3px; text-align: center; }
            .box-content { border: 1px solid #000; height: 50px !important; font-size: 10px; padding: 5px; margin-bottom: 5px; }
            .chart-box { height: 90px !important; border: 1px solid #ccc; display: flex; justify-content: center; overflow: hidden; margin-bottom: 5px; }
            .inf-footer-dual { display: flex; justify-content: space-around; align-items: flex-end; margin-top: auto; padding-bottom: 20px; width: 100%; position: relative; z-index: 2; }
            .inf-firma-box { text-align: center; width: 35%; }
            .inf-firma-line { border-top: 1px solid #000; padding-top: 5px; font-size: 11px; font-weight: bold; }
            .inf-firma-sub { font-size: 10px; font-weight: normal; display: block; }
        }

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:2000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 8px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-wide { width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
        .modal-large { width: 90%; max-width: 1000px; height: 80vh; display: flex; flex-direction: column; }
        
        .modal-grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .span-2 { grid-column: span 2; }
        .span-3 { grid-column: span 3; }
        
        @media (max-width: 768px) {
            .modal-grid-container { grid-template-columns: 1fr; }
            .span-2, .span-3 { grid-column: span 1; }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="app-brand">
            <img src="logo.jpg" alt="Logo" onerror="this.src='https://via.placeholder.com/40?text=SGE'">
            <span>Libro de Clases Digital</span>
        </div>
        <div class="app-controls">
            <button class="btn btn-back" id="btnHeaderBack" style="display:none;" onclick="window.history.back()">‚¨Ö Volver</button>
            <select id="selAno" onchange="init()" style="padding: 5px; border-radius: 4px; border: none;">
                <option value="2026">2026</option>
                <option value="2025">2025</option>
            </select>
        </div>
    </header>

    <div id="loader"><div class="spinner"></div><h3 style="color:var(--primary); margin-top:20px;" id="loaderText">Cargando Sistema...</h3></div>
    <div id="printArea"></div>

    <div id="modalEval" class="modal-overlay">
        <div class="modal-box" style="width:400px;">
            <h3 style="color:var(--primary); margin-top:0;">Configurar Evaluaci√≥n</h3>
            <p id="lblEvalName" style="color:#666; margin-bottom:20px; font-weight:bold;"></p>
            <div style="margin: 15px 0;"><label>Fecha:</label><input type="date" id="inEvalFecha" class="form-control"></div>
            <div style="margin: 15px 0;"><label>Concepto:</label><input type="text" id="inEvalConcepto" class="form-control" placeholder="Ej: Prueba Unidad 1"></div>
            <div style="text-align:right;"><button class="btn btn-default" onclick="document.getElementById('modalEval').style.display='none'">Cancelar</button><button class="btn btn-blue" onclick="saveEvalData()">Guardar Configuraci√≥n</button></div>
        </div>
    </div>

    <div id="modalAlumno" class="modal-overlay">
        <div class="modal-box modal-wide">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="color:var(--primary); margin:0;" id="modalAluTitle">Ficha del Estudiante</h3>
                <button class="btn btn-icon" onclick="document.getElementById('modalAlumno').style.display='none'">‚úï</button>
            </div>
            
            <input type="hidden" id="inAluId">
            
            <div class="modal-grid-container">
                <div class="span-3 form-section">Identificaci√≥n Personal</div>
                <div><label>RUT (Sin puntos ni gui√≥n)*</label><input type="text" id="inAluRut" class="form-control" placeholder="123456789"></div>
                <div><label>N¬∞ Lista</label><input type="number" id="inAluNum" class="form-control"></div>
                <div><label>Sexo Registral</label><select id="inAluSexo" class="form-control"><option value="">Seleccione</option><option value="M">Masculino</option><option value="F">Femenino</option></select></div>
                
                <div><label>Nombre Legal Completo</label><input type="text" id="inAluNombreLegal" class="form-control" placeholder="Nombre Oficial"></div>
                <div><label>Nombre Social (Si aplica)</label><input type="text" id="inAluNombreSocial" class="form-control" placeholder="Nombre Social"></div>
                <div><label>URL Foto (Enlace)</label><input type="text" id="inAluFoto" class="form-control" placeholder="https://..."></div>

                <div class="span-3 form-section">Estado Acad√©mico</div>
                <div><label>Fecha Matr√≠cula</label><input type="date" id="inAluFechaMat" class="form-control"></div>
                <div><label>Fecha Retiro (Opcional)</label><input type="date" id="inAluFechaRet" class="form-control" style="background:#fff3e0"></div>
                <div style="font-size:11px; color:#666; display:flex; align-items:center;">‚ÑπÔ∏è Al marcar retiro, el alumno se excluye de estad√≠sticas.</div>

                <div class="span-3 form-section">Contacto y Apoderados</div>
                <div class="span-3"><label>Direcci√≥n</label><input type="text" id="inAluDir" class="form-control"></div>
                <div><label>Nombre Apoderado</label><input type="text" id="inAluApo" class="form-control"></div>
                <div><label>Tel√©fono Apoderado</label><input type="text" id="inAluTelApo" class="form-control" placeholder="+569..."></div>
                <div><label>Tel√©fono Alumno</label><input type="text" id="inAluTelAlu" class="form-control" placeholder="+569..."></div>

                <div class="span-3 form-section">Antecedentes Relevantes</div>
                <div class="span-3"><label>Necesidades Educativas (NEE) / Diagn√≥stico</label><textarea id="inAluNEE" class="form-control" rows="2" placeholder="Ej: TEA, TDAH, Dificultad Espec√≠fica..."></textarea></div>
                <div class="span-3"><label>Salud / Alergias / Medicamentos</label><textarea id="inAluSalud" class="form-control" rows="2"></textarea></div>
                <div class="span-3"><label>Intervenciones Judiciales / Medidas de Protecci√≥n</label><textarea id="inAluJudicial" class="form-control" rows="2"></textarea></div>
            </div>

            <div style="text-align:right; margin-top:20px; padding-top:15px; border-top:1px solid #eee;">
                <button class="btn btn-default" onclick="document.getElementById('modalAlumno').style.display='none'">Cancelar</button>
                <button class="btn btn-blue" onclick="saveStudent()">Guardar Ficha</button>
            </div>
        </div>
    </div>

    <div id="modalAsisStats" class="modal-overlay">
        <div class="modal-box modal-large" style="background: #f8f9fa;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #ddd;">
                <h3 style="margin:0; color:var(--primary);">Detalle de Asistencia por Curso</h3>
                <button class="btn btn-default" onclick="document.getElementById('modalAsisStats').style.display='none'">Cerrar</button>
            </div>
            <div style="flex:1; overflow-y:auto; padding:10px; display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="card" style="margin:0; height:fit-content;">
                    <h4 style="margin-top:0; color:var(--danger); border-bottom:2px solid var(--danger); padding-bottom:5px;">‚ö†Ô∏è Alumnos en Riesgo (M√°s Faltas)</h4>
                    <div style="max-height: 400px; overflow-y:auto;">
                        <table class="sge-table" style="width:100%"><thead><tr style="position:sticky; top:0; background:white; z-index:10;"><th>Alumno</th><th>Faltas</th><th>% Asis</th></tr></thead><tbody id="bodyRankingRisk"></tbody></table>
                    </div>
                </div>
                <div class="card" style="margin:0; display:flex; flex-direction:column;">
                    <h4 style="margin-top:0; color:var(--success); border-bottom:2px solid var(--success); padding-bottom:5px;">üèÜ Excelencia en Asistencia (Top 10)</h4>
                    <div style="flex:1; min-height:300px; position:relative;"><canvas id="chartBestAsis"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalAsigManager" class="modal-overlay">
        <div class="modal-box" style="width: 500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="color:var(--primary); margin:0;">Gestionar Asignaturas</h3>
                <button class="btn btn-icon" onclick="document.getElementById('modalAsigManager').style.display='none'">‚úï</button>
            </div>
            <div style="background:#fff3e0; padding:10px; font-size:11px; margin-bottom:10px; border-left:4px solid orange; color:#333;">
                ‚ö†Ô∏è <b>Cuidado:</b> Si eliminas una asignatura, el sistema dejar√° de mostrar sus notas, aunque no se borren permanentemente de los alumnos. Aseg√∫rate de borrar la duplicada.
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="sge-table" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="bodyAsigManager">
                        </tbody>
                </table>
            </div>
            <div style="text-align:right; margin-top:15px;">
                 <button class="btn btn-default" onclick="document.getElementById('modalAsigManager').style.display='none'">Cerrar</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div id="vMenu" class="vista activa">
            <div class="card">
                <div class="card-header">
                    <h2>Panel de Gesti√≥n Escolar</h2>
                    <div>
                        <button class="btn btn-warning" onclick="downloadBackup()">üíæ Copia Seguridad</button>
                        <input type="file" id="fileRestore" style="display:none" onchange="restoreBackup(this)">
                        <button class="btn btn-default" onclick="document.getElementById('fileRestore').click()">‚ôªÔ∏è Restaurar</button>
                        <button class="btn btn-blue" onclick="toggleMainView('libros')">Libros de Clases</button>
                        <button class="btn btn-default" onclick="toggleMainView('asistencia_gral')">Asistencia General</button>
                        <button class="btn btn-red" onclick="toggleMainView('utp')">üìä Gesti√≥n UTP</button>
                    </div>
                </div>
                <div id="sectionLibros"><div id="gridCursos" class="grid-cursos"></div></div>
                <div id="sectionAsistenciaGral" style="display:none;"><h3>Resumen Asistencia Colegio</h3><div id="wrapAsistenciaGral" class="table-wrapper"></div></div>
                <div id="sectionUTP" style="display:none;">
                    <div style="text-align: center; margin-bottom: 20px;"><button class="btn btn-blue" onclick="loadUTPData()">üîÑ Actualizar Datos UTP</button></div>
                    <div class="kpi-grid"><div class="kpi-card"><span class="kpi-lbl">Matr√≠cula (Activa)</span><span class="kpi-val" id="utpTotalMat">0</span></div><div class="kpi-card kpi-green"><span class="kpi-lbl">Promedio</span><span class="kpi-val" id="utpPromGral">-</span></div><div class="kpi-card kpi-red"><span class="kpi-lbl">Riesgo</span><span class="kpi-val" id="utpRiesgo">0</span></div><div class="kpi-card"><span class="kpi-lbl">Aprobaci√≥n</span><span class="kpi-val" id="utpAprob">0%</span></div></div>
                    <div class="card">
                        <div class="tabs-container">
                            <button class="tab-btn active" onclick="verUTP('sabana')">Planilla S√°bana</button>
                            <button class="tab-btn" onclick="verUTP('vista_utp')">Vista Detallada</button>
                            <button class="tab-btn" onclick="verUTP('alertas')">Alertas</button>
                            <button class="tab-btn" onclick="verUTP('ranking')">Ranking</button>
                            <button class="tab-btn" onclick="verUTP('correlacion')">Correlaci√≥n</button>
                            <button class="tab-btn" onclick="verUTP('general')">Consolidado</button>
                            <button class="tab-btn" onclick="verUTP('mantenedor')">‚öôÔ∏è Mantenedor</button>
                        </div>
                        <div id="utpSabana" class="utp-tab"><div style="margin-bottom:15px; display:flex; justify-content: space-between;"><div style="display:flex; gap:10px; align-items:center;"><label>Curso:</label><select id="selUtpCursoSabana" class="form-control" onchange="renderUTPPlanillaSabana()"></select></div><button class="btn btn-default" onclick="printSabana()">üñ®Ô∏è Imprimir</button></div><div class="table-wrapper" id="wrapUtpSabana" style="max-height: 75vh;"></div></div>
                        <div id="utpVista_utp" class="utp-tab" style="display:none;"><div style="margin-bottom:15px; display:flex; gap:15px; background:#e3f2fd; padding:10px; border-radius:4px; align-items:center;"><div><label style="font-weight:bold;">1. Seleccionar Curso:</label><br><select id="selUtpCursoDetalle" class="form-control" onchange="loadStudentsForDetail()"></select></div><div><label style="font-weight:bold;">2. Seleccionar Alumno:</label><br><select id="selUtpAlumnoDetalle" class="form-control" onchange="renderUTPDetalle()"><option value="">-- Primero elija curso --</option></select></div><div style="flex:1; text-align:right;"><span style="font-size:10px; color:#666;">An√°lisis Comparativo</span></div></div><div id="wrapUtpDetalle" style="overflow-x:auto;"></div></div>
                        <div id="utpAlertas" class="utp-tab" style="display:none;"><div class="table-wrapper"><table class="sge-table"><thead><tr><th>ALUMNO</th><th>CURSO</th><th>PROMEDIO</th><th>ROJOS</th></tr></thead><tbody id="bodyUTPAlertas"></tbody></table></div></div>
                        <div id="utpRanking" class="utp-tab" style="display:none;"><div class="table-wrapper"><table class="sge-table"><thead><tr><th>#</th><th>ALUMNO</th><th>CURSO</th><th>PROMEDIO</th></tr></thead><tbody id="bodyUTPRanking"></tbody></table></div></div>
                        <div id="utpCorrelacion" class="utp-tab" style="display:none;"><div style="padding:15px;"><h3 style="color:var(--primary);text-align:center;">Cruce Asistencia vs Calificaciones</h3><p style="text-align:center;font-size:12px;color:#666;">Este gr√°fico permite identificar si las inasistencias influyen en el rendimiento acad√©mico (Excluye Retirados).</p><div style="height:400px; width:100%;"><canvas id="chartCorrelacion"></canvas></div></div></div>
                        <div id="utpGeneral" class="utp-tab" style="display:none;">
                            <div class="table-wrapper"><table class="sge-table"><thead><tr><th>CURSO</th><th>MATR√çCULA ACTIVA</th><th>PROM. CURSO</th><th>APROBADOS</th><th>REPROBADOS</th><th>% APROB</th></tr></thead><tbody id="bodyUTPCursos"></tbody></table></div>
                            <div style="margin-top:20px; display:grid; grid-template-columns: 2fr 1fr; gap:20px; height:300px;">
                                <div><canvas id="chartUTPCursos"></canvas></div>
                                <div><canvas id="chartUTPPie"></canvas></div>
                            </div>
                        </div>
                        
                        <div id="utpMantenedor" class="utp-tab" style="display:none;">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                                <div class="card">
                                    <h3>1. Gesti√≥n de A√±o y Cursos</h3>
                                    <div class="form-section">Nuevo A√±o Acad√©mico</div>
                                    <p style="font-size:11px; color:#666;">Agregue un a√±o al selector (ej: 2027) para empezar a crear cursos en √©l.</p>
                                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                                        <input type="number" id="inNewYear" class="form-control" placeholder="Ej: 2027">
                                        <button class="btn btn-blue" onclick="addYearOption()">Agregar al Selector</button>
                                    </div>
                                    
                                    <div class="form-section">Crear Nuevo Curso</div>
                                    <div style="margin-bottom:10px;">
                                        <label>Nombre del Curso (Incluir a√±o):</label>
                                        <input type="text" id="inNewCursoNombre" class="form-control" placeholder="Ej: Primero Medio A 2027">
                                    </div>
                                    <div style="margin-bottom:10px;">
                                        <label>Profesor Jefe (Opcional):</label>
                                        <input type="text" id="inNewCursoProfe" class="form-control" placeholder="Nombre Profesor">
                                    </div>
                                    <button class="btn btn-success" onclick="createNewCurso()">+ Crear Curso</button>
                                </div>
                                
                                <div class="card">
                                    <h3>2. Agregar Asignaturas Faltantes</h3>
                                    <p style="font-size:11px; color:#666;">Seleccione el curso y agregue la asignatura que falt√≥ en la carga inicial.</p>
                                    <div style="margin-bottom:10px;">
                                        <label>Seleccionar Curso:</label>
                                        <select id="selMantCursoAsig" class="form-control"></select>
                                    </div>
                                    <div style="margin-bottom:10px;">
                                        <label>ID Asignatura (√önico, ej: 105):</label>
                                        <input type="text" id="inNewAsigID" class="form-control" placeholder="Ej: MAT2027">
                                    </div>
                                    <div style="margin-bottom:10px;">
                                        <label>Nombre Asignatura:</label>
                                        <input type="text" id="inNewAsigNombre" class="form-control" placeholder="Ej: MATEMATICA">
                                    </div>
                                    <button class="btn btn-blue" onclick="addNewSubject()">+ Agregar Asignatura</button>
                                </div>
                                
                                <div class="card span-2">
                                    <h3>3. Carga Masiva de Alumnos (N√≥mina)</h3>
                                    <p style="font-size:11px; color:#666;">Pegue la lista desde Excel. Formato: <b>RUT;NOMBRE COMPLETO</b> (Una l√≠nea por alumno).</p>
                                    <div style="margin-bottom:10px;">
                                        <label>Seleccionar Curso:</label>
                                        <select id="selMantCursoNomina" class="form-control"></select>
                                    </div>
                                    <textarea id="txtNominaMasiva" class="form-control" rows="10" placeholder="12345678-9;JUAN PEREZ&#10;98765432-1;MARIA GONZALEZ"></textarea>
                                    <br>
                                    <button class="btn btn-warning" onclick="batchStudents()">üì§ Cargar N√≥mina</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div id="vCurso" class="vista">
            <div class="card" style="padding:10px;"><h2 id="lblCurso"></h2></div>
            
            <div class="tabs-container">
                <button id="btn-notas" class="tab-btn active" onclick="ver('notas')">Notas</button>
                <button id="btn-asistencia" class="tab-btn" onclick="ver('asistencia')">Asistencia</button>
                <button id="btn-personalidad" class="tab-btn" onclick="ver('personalidad')">Personalidad</button>
                <button id="btn-informes" class="tab-btn" onclick="ver('informes')">Informes</button>
                <button id="btn-matricula" class="tab-btn" onclick="ver('matricula')" style="color:#004a99;">üìã Matr√≠cula</button>
            </div>
            
            <div id="divNotas" class="vista-tab">
                <div class="card" style="display:flex; flex-direction:column; gap:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <label>Asignatura:</label>
                            <select id="selAsig" onchange="renderNotas()" class="form-control"></select>
                            <button class="btn btn-default btn-sm" onclick="openAsigManager()" title="Gestionar Asignaturas" style="padding: 5px 10px;">‚öôÔ∏è</button>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-success" onclick="exportToExcel()">üì• Descargar Excel</button>
                            <button class="btn btn-blue" onclick="printPlanillaNotas()">üñ®Ô∏è Reporte de Notas</button>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; background:#f0f0f0; padding:10px; border-radius:4px;">
                        <label style="font-weight:bold;">Profesor(a) Asignatura:</label>
                        <input type="text" id="inProfesorAsig" class="form-control" style="max-width:300px;" placeholder="Nombre del Profesor..." onchange="saveProfesorAsig()">
                        <span style="font-size:11px; color:#666;">(Se guarda autom√°ticamente)</span>
                    </div>
                </div>
                <div id="wrapNotas" class="table-wrapper"></div>
            </div>
            
            <div id="divAsistencia" class="vista-tab" style="display:none;"><div class="card" style="display:flex; justify-content:space-between;"><select id="selMes" onchange="renderAsis()" class="form-control"><option value="mar">Marzo</option><option value="abr">Abril</option><option value="may">Mayo</option><option value="jun">Junio</option><option value="jul">Julio</option><option value="ago">Agosto</option><option value="sep">Septiembre</option><option value="oct">Octubre</option><option value="nov">Noviembre</option><option value="dic">Diciembre</option></select><button class="btn btn-blue" onclick="printPlanillaAsistencia()">üñ®Ô∏è Imprimir Planilla</button></div><div id="wrapAsistencia" class="table-wrapper"></div></div>
            <div id="divPersonalidad" class="vista-tab" style="display:none;"><div class="card"><button id="btnS1" class="btn btn-blue" onclick="switchSemestre('S1')">S1</button><button id="btnS2" class="btn btn-default" onclick="switchSemestre('S2')">S2</button></div><div id="wrapPers" class="table-wrapper"></div></div>
            <div id="divInformes" class="vista-tab" style="display:none;"><div class="card" style="text-align:right;"><button class="btn btn-blue" onclick="printAllInformes()">üñ®Ô∏è IMPRIMIR CURSO COMPLETO</button></div><div id="listaAlumnos" class="grid-cursos"></div></div>
            
            <div id="divMatricula" class="vista-tab" style="display:none;">
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="flex:1; max-width:400px; display:flex; gap:10px; align-items:center;">
                        <label>Profesor Jefe:</label>
                        <input type="text" id="inProfesorJefe" class="form-control" placeholder="Nombre del Profesor Jefe">
                        <button class="btn btn-success" onclick="saveCursoConfig()">Guardar</button>
                    </div>
                    <button class="btn btn-blue" onclick="openStudentModal()">+ Agregar Alumno</button>
                </div>
                <div id="wrapMatricula" class="table-wrapper"></div>
            </div>
        </div>
    </div>

    <div class="footer-credits">
        <img src="profeale.jpg" alt="ProfeAle" onerror="this.style.display='none'">
        <span>Desarrollado por ProfeAle</span>
        <span>No transferible Derechos Reservados</span>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCbZNKv2Dnk4pmrxcyUAdrYxiAW2Yo9rTE", authDomain: "libroclases-sscc.firebaseapp.com", projectId: "libroclases-sscc", storageBucket: "libroclases-sscc.firebasestorage.app", appId: "1:556632878686:web:528ae162b5be19f21a0ecf" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let CURSO = { id: null, data: null, alumnos: [], asignaturas: [] };
        let UTP_DATA = [];
        let currentSemPers = "S1";
        let activeEvalCol = null;
        let chartUTPInstance = null;
        let chartUTPPieInstance = null;
        let chartBestAsisInstance = null;
        let chartCorrelacionInstance = null;

        const MESES_MAP = {'mar':2,'abr':3,'may':4,'jun':5,'jul':6,'ago':7,'sep':8,'oct':9,'nov':10,'dic':11};
        const INDICADORES_PERS = [{id:'A1',cat:'A. √ÅMBITO PERSONAL',text:'Se esfuerza por progresar en su aprendizaje y demuestra inter√©s.'},{id:'A2',cat:'A. √ÅMBITO PERSONAL',text:'Demuestra confianza en s√≠ mismo y en sus capacidades.'},{id:'A3',cat:'A. √ÅMBITO PERSONAL',text:'Cuida su presentaci√≥n personal y √∫tiles escolares.'},{id:'A4',cat:'A. √ÅMBITO PERSONAL',text:'Se integra con facilidad y respeto al grupo de pares.'},{id:'B1',cat:'B. √ÅMBITO SOCIAL',text:'Utiliza el di√°logo como medio principal de soluci√≥n de conflictos.'},{id:'B2',cat:'B. √ÅMBITO SOCIAL',text:'Reconoce y respeta los derechos y deberes de los dem√°s.'},{id:'B3',cat:'B. √ÅMBITO SOCIAL',text:'Expresa sus opiniones con respeto y claridad.'},{id:'B4',cat:'B. √ÅMBITO SOCIAL',text:'Es solidario, emp√°tico y colaborativo con sus compa√±eros.'},{id:'C1',cat:'C. √ÅMBITO ACAD√âMICO/√âTICO',text:'Participa activamente en clases y actividades escolares.'},{id:'C2',cat:'C. √ÅMBITO ACAD√âMICO/√âTICO',text:'Respeta creencias, ideas y diferencias de los dem√°s.'},{id:'C3',cat:'C. √ÅMBITO ACAD√âMICO/√âTICO',text:'Respeta las normas de seguridad y convivencia del establecimiento.'}];
        const CONCEPTOS = ["RELIGION", "ORIENTACION", "FORMACION"];

        function cleanStr(s){return s?s.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""):""}
        function numToConcept(v){ let n=parseFloat(v); if(isNaN(n))return ""; if(n>=6.0)return "MB"; if(n>=5.0)return "B"; if(n>=4.0)return "S"; return "I"; }
        function isConcepto(nom) { return CONCEPTOS.some(c => cleanStr(nom).includes(c)); }
        function getPrintHeader(title){ return `<div class="inf-header-grid"><img src="logo.jpg" class="inf-logo"><div class="inf-center"><div class="inf-school">ESCUELA AGR√çCOLA SAGRADOS CORAZONES</div><div class="inf-city">VILLA ALEGRE</div><div class="inf-rbd">RBD: 3478-9 | DECRETO COOPERADOR: 17576</div><div class="inf-doc-title">${title}</div></div><div></div></div>`; }

        async function init() { const loader = document.getElementById("loader"); const grid = document.getElementById("gridCursos"); const year = document.getElementById("selAno").value; loader.style.display = "flex"; document.getElementById("loaderText").innerText = "Cargando Cursos..."; grid.innerHTML = ""; try { const s = await db.collection("cursos").get(); let h = ""; let count = 0; s.forEach(d => { if(d.data().nombre && d.data().nombre.includes(year)) { h += `<div class="curso-item" onclick="load('${d.id}')"><h3 style="font-size:30px;color:#004a99">üìö</h3><h3>${d.data().nombre}</h3></div>`; count++; } }); grid.innerHTML = count > 0 ? h : `<div style="grid-column:1/-1;text-align:center;">No hay cursos para el a√±o ${year}.</div>`; } catch (error) { console.error(error); alert(error.message); } finally { loader.style.display = "none"; } }
        async function load(id){ document.getElementById("loader").style.display="flex"; try{ const [c,a,s]=await Promise.all([db.collection("cursos").doc(id).get(),db.collection("cursos").doc(id).collection("alumnos").orderBy("numero_lista").get(),db.collection("cursos").doc(id).collection("asignaturas").orderBy("id").get()]); CURSO={id,data:c.data(),alumnos:a.docs.map(d=>d.data()),asignaturas:s.docs.map(d=>({id:d.id,...d.data()}))}; document.getElementById("lblCurso").innerText=CURSO.data.nombre; document.getElementById("inProfesorJefe").value = CURSO.data.profesor_jefe || ""; document.getElementById("vMenu").classList.remove("activa"); setTimeout(() => document.getElementById("vMenu").style.display="none", 300); document.getElementById("vCurso").style.display="block"; setTimeout(() => document.getElementById("vCurso").classList.add("activa"), 50); document.getElementById("btnHeaderBack").style.display="block"; let sel=document.getElementById("selAsig"); sel.innerHTML=""; CURSO.asignaturas.forEach(x=>sel.innerHTML+=`<option value="${x.id}">${x.nombre}</option>`); window.history.pushState({page: 'curso', id: id}, "Curso", "#curso"); ver('notas'); }catch(e){ alert("Error: " + e.message); }finally{ document.getElementById("loader").style.display="none" } }
        
        function ver(t){
            document.querySelectorAll(".vista-tab").forEach(x=>x.style.display="none"); 
            document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active")); 
            document.getElementById("div"+t.charAt(0).toUpperCase()+t.slice(1)).style.display="block"; 
            document.getElementById("btn-"+t).classList.add("active"); 
            
            if(t==='notas') renderNotas(); 
            else if(t==='asistencia') renderAsis(); 
            else if(t==='personalidad') renderPers(); 
            else if(t==='informes') renderListaInformes();
            else if(t==='matricula') renderMatricula();
        }

        function closeCurso(){ document.getElementById("loader").style.display = "none"; document.getElementById("printArea").innerHTML = ""; document.getElementById("vCurso").classList.remove("activa"); setTimeout(()=>{document.getElementById("vCurso").style.display="none"; document.getElementById("vMenu").style.display="block"; setTimeout(()=>document.getElementById("vMenu").classList.add("activa"),50); document.getElementById("btnHeaderBack").style.display="none"; },300) }
        window.onpopstate = function(event) { if(!event.state) { closeCurso(); } };
        function toggleMainView(view) { 
            if(view === 'utp') {
                let pass = prompt("üîê INGRESE CLAVE DE ACCESO UTP:");
                if(pass !== "290615") return alert("‚õî Clave Incorrecta.");
            }
            document.getElementById("sectionLibros").style.display = view === 'libros' ? 'block' : 'none'; 
            document.getElementById("sectionAsistenciaGral").style.display = view === 'asistencia_gral' ? 'block' : 'none'; 
            document.getElementById("sectionUTP").style.display = view === 'utp' ? 'block' : 'none'; 
            if(view === 'asistencia_gral') renderAsistenciaGral(); 
        }
        
        function getNota11Value(alu, asigNombre, cursoNombre, periodoSuffix = '', subjectsList = null) { 
            let s = cleanStr(asigNombre); let c = cleanStr(cursoNombre); let sourceKey = null; 
            if(s.includes("LENGUA")) sourceKey = "HABILIDADES"; if(s.includes("MATEMATICA")) sourceKey = "RELIGION"; if(s.includes("HISTORIA")) sourceKey = "INDUCCION"; if(s.includes("BIOLOGIA")) sourceKey = "HABITOS"; 
            
            // Detecci√≥n de niveles
            let esPrimeroSegundo = c.includes("1") || c.includes("2") || c.includes("PRIMERO") || c.includes("SEGUNDO"); 
            let esTerceroCuarto = c.includes("3") || c.includes("4") || c.includes("TERCERO") || c.includes("CUARTO");
            
            // L√≥gica de traspaso espec√≠fica por nivel
            if(s.includes("TECNOLOGIA") && esPrimeroSegundo) sourceKey = "ORIENTACION"; 
            if(s.includes("INGLES") && esTerceroCuarto) sourceKey = "ORIENTACION"; 
            
            if(!sourceKey) return null; 
            let list = subjectsList || (typeof CURSO !== 'undefined' && CURSO && CURSO.asignaturas ? CURSO.asignaturas : []); 
            if(!list || list.length === 0) return null;
            let sourceAsig = list.find(a => cleanStr(a.nombre).includes(sourceKey)); 
            if(!sourceAsig) return null; 
            return obtenerPromedioAsignatura(alu.notas, sourceAsig.id, periodoSuffix); 
        }

        function obtenerPromedioAsignatura(a,i,p){if(!a)return null;let n=a[i];if(!n){const k=Object.keys(a).find(k=>k==i);if(k)n=a[k]}if(!n)return null;let s=0,c=0;for(let j=1;j<=10;j++){let v=parseFloat((n[p+'n'+j]||"").replace(',','.'));if(!isNaN(v)){s+=v;c++}}return c>0?(s/c).toFixed(1):null}
        
        function renderNotas(){ 
            let asigID=document.getElementById("selAsig").value; 
            if(!CURSO.asignaturas || CURSO.asignaturas.length === 0) return; 
            let asigObj=CURSO.asignaturas.find(a=>a.id==asigID); if(!asigObj)return; 
            
            document.getElementById("inProfesorAsig").value = asigObj.profesor || "";

            let statsP1 = {'1.0-2.0':0, '2.1-3.0':0, '3.1-4.0':0, '4.1-5.0':0, '5.1-6.0':0, '6.1-6.9':0, '7.0':0}; 
            let countP1 = 0; 
            let h=`<table class="sge-table"><thead><tr><th class="col-alumno" rowspan="2">N√ìMINA</th><th class="header-blue" colspan="11">S1</th><th class="header-blue" rowspan="2">P1</th><th class="header-blue" colspan="11">S2</th><th class="header-blue" rowspan="2">P2</th><th class="header-final" rowspan="2">FINAL</th><th rowspan="2">IMP</th></tr><tr>`; 
            const rTh = (key, label) => { let evalData = asigObj.evaluaciones ? asigObj.evaluaciones[key] : null; let tooltip = evalData ? `${label}: ${evalData.concepto} (${evalData.fecha})` : `Clic para configurar ${label}`; let styleClass = evalData ? "th-configured" : ""; return `<th class="th-eval ${styleClass}" title="${tooltip}" onclick="openEvalModal('${key}', '${label}')">${label}</th>`; }; 
            for(let i=1;i<=10;i++) h+=rTh('n'+i,'N'+i); h+=`<th class="header-proc" style="background:#e0f7fa;">N11</th>`; 
            for(let i=1;i<=10;i++) h+=rTh('s2_n'+i,'N'+i); h+=`<th class="header-proc" style="background:#e0f7fa;">N11</th></tr></thead><tbody>`; 
            CURSO.alumnos.forEach((alu,x)=>{ 
                let isRetirado = !!alu.fecha_retiro;
                let trClass = isRetirado ? 'tr-retiro' : '';
                let n=alu.notas?(alu.notas[asigID]||alu.notas[Number(asigID)]||{}):{}; 
                let n11_s1=getNota11Value(alu,asigObj.nombre,CURSO.data.nombre,''); let n1 = n11_s1 || n.n11; 
                let n11_s2=getNota11Value(alu,asigObj.nombre,CURSO.data.nombre,'s2_'); let n2 = n11_s2 || n.s2_n11; 
                let s1=0,c1=0; for(let i=1;i<=10;i++){if(n['n'+i]){s1+=parseFloat(n['n'+i]);c1++}} if(n1){s1+=parseFloat(n1);c1++} let p1=c1>0?(s1/c1).toFixed(1):""; 
                let s2=0,c2=0; for(let i=1;i<=10;i++){let k='s2_n'+i;if(n[k]){s2+=parseFloat(n[k]);c2++}} if(n2){s2+=parseFloat(n2);c2++} let p2=c2>0?(s2/c2).toFixed(1):""; 
                let pf = (p1 && p2) ? ((parseFloat(p1)+parseFloat(p2))/2).toFixed(1) : ""; 
                // Only count stats if NOT retired
                if(!isRetirado && p1 && parseFloat(p1)>0) { countP1++; let v = parseFloat(p1); if(v <= 2.0) statsP1['1.0-2.0']++; else if(v <= 3.0) statsP1['2.1-3.0']++; else if(v <= 4.0) statsP1['3.1-4.0']++; else if(v <= 5.0) statsP1['4.1-5.0']++; else if(v <= 6.0) statsP1['5.1-6.0']++; else if(v < 7.0) statsP1['6.1-6.9']++; else statsP1['7.0']++; } 
                
                h+=`<tr class="${trClass}"><td class="col-alumno">${x+1}. ${alu.nombre_completo} ${isRetirado?'(RET)':''}</td>`; 
                for(let i=1;i<=10;i++){let v=n['n'+i]||''; h+=`<td><input class="nota-in" value="${v}" onchange="saveNota('${alu.rut}','${asigID}','n${i}',this.value)"></td>`} 
                let ro1 = n11_s1 ? "readonly title='Auto'" : `onchange="saveNota('${alu.rut}','${asigID}','n11',this.value)"`; 
                h+=`<td class="${n11_s1?'cell-auto':'cell-proc'}"><input class="nota-in" value="${n1||''}" ${ro1}></td><td class="cell-prom">${p1||''}</td>`; 
                for(let i=1;i<=10;i++){let v=n['s2_n'+i]||''; h+=`<td><input class="nota-in" value="${v}" onchange="saveNota('${alu.rut}','${asigID}','s2_n${i}',this.value)"></td>`} 
                let ro2 = n11_s2 ? "readonly title='Auto'" : `onchange="saveNota('${alu.rut}','${asigID}','s2_n11',this.value)"`; 
                h+=`<td class="${n11_s2?'cell-auto':'cell-proc'}"><input class="nota-in" value="${n2||''}" ${ro2}></td><td class="cell-prom">${p2||''}</td><td class="cell-final">${pf}</td>`; 
                h+=`<td><button class="btn btn-blue btn-sm" onclick="printFullReport('${alu.rut}')">üñ®Ô∏è</button></td></tr>`; 
            }); 
            let statsHtml = `<div class="stats-container"><div class="stats-box"><div class="stats-header">Resumen P1 (Activos)</div><table class="stats-table"><tr><td>Rango</td><td>N¬∞</td><td>%</td></tr>`; Object.keys(statsP1).forEach(k => { let val = statsP1[k]; let pct = countP1 > 0 ? Math.round((val/countP1)*100) : 0; statsHtml += `<tr><td>${k}</td><td>${val}</td><td>${pct}%</td></tr>`; }); statsHtml += `<tr><td>Total</td><td>${countP1}</td><td>100%</td></tr></table></div></div>`; document.getElementById("wrapNotas").innerHTML= statsHtml + h + "</tbody></table>"; 
        }

        async function saveNota(r,a,c,v){v=v.replace(',','.');await db.collection("cursos").doc(CURSO.id).collection("alumnos").doc(r).update({[`notas.${a}.${c}`]:v})}
        async function saveEvalData(){let f=document.getElementById("inEvalFecha").value,c=document.getElementById("inEvalConcepto").value,id=document.getElementById("selAsig").value;if(!f||!c)return alert("Datos incompletos");try{await db.collection("cursos").doc(CURSO.id).collection("asignaturas").doc(id).update({[`evaluaciones.${activeEvalCol}`]:{fecha:f,concepto:c}});document.getElementById("modalEval").style.display="none";renderNotas()}catch(e){console.error(e)}}
        function openEvalModal(k,l){activeEvalCol=k;let a=CURSO.asignaturas.find(x=>x.id==document.getElementById("selAsig").value),m=a.evaluaciones?.[k];document.getElementById("inEvalFecha").value=m?m.fecha:"";document.getElementById("inEvalConcepto").value=m?m.concepto:"";document.getElementById("modalEval").style.display="flex"}
        async function saveProfesorAsig() {
            let asigID = document.getElementById("selAsig").value;
            let nombreProfesor = document.getElementById("inProfesorAsig").value;
            try { await db.collection("cursos").doc(CURSO.id).collection("asignaturas").doc(asigID).update({ profesor: nombreProfesor }); let a = CURSO.asignaturas.find(x => x.id == asigID); if(a) a.profesor = nombreProfesor; } catch(e) { console.error("Error guardando profesor", e); }
        }

        function exportToExcel() {
            const asigID = document.getElementById("selAsig").value;
            const asigName = document.getElementById("selAsig").options[document.getElementById("selAsig").selectedIndex].text;
            const cursoName = CURSO.data.nombre;
            let data = []; let headers = ["N¬∞", "RUT", "ALUMNO", "ESTADO"];
            for(let i=1; i<=10; i++) headers.push(`S1_N${i}`); headers.push("S1_N11", "P1");
            for(let i=1; i<=10; i++) headers.push(`S2_N${i}`); headers.push("S2_N11", "P2", "FINAL");
            data.push(headers);
            CURSO.alumnos.forEach((alu, i) => {
                let row = []; row.push(i + 1); row.push(alu.rut); row.push(alu.nombre_completo);
                row.push(alu.fecha_retiro ? "RETIRADO" : "ACTIVO");
                let n = alu.notas ? (alu.notas[asigID] || alu.notas[Number(asigID)] || {}) : {};
                let n11_s1 = getNota11Value(alu, asigName, cursoName, ''); let s1_sum=0, s1_count=0;
                for(let k=1; k<=10; k++) { let val = n['n'+k] || ""; row.push(val); if(val) { s1_sum+=parseFloat(val); s1_count++; } }
                let val_n11 = n11_s1 || n.n11 || ""; row.push(val_n11); if(val_n11) { s1_sum+=parseFloat(val_n11); s1_count++; }
                let p1 = s1_count>0 ? (s1_sum/s1_count).toFixed(1) : ""; row.push(p1);
                let n11_s2 = getNota11Value(alu, asigName, cursoName, 's2_'); let s2_sum=0, s2_count=0;
                for(let k=1; k<=10; k++) { let val = n['s2_n'+k] || ""; row.push(val); if(val) { s2_sum+=parseFloat(val); s2_count++; } }
                let val_n11_s2 = n11_s2 || n.s2_n11 || ""; row.push(val_n11_s2); if(val_n11_s2) { s2_sum+=parseFloat(val_n11_s2); s2_count++; }
                let p2 = s2_count>0 ? (s2_sum/s2_count).toFixed(1) : ""; row.push(p2);
                let pf = ""; if(p1 && p2) pf = ((parseFloat(p1)+parseFloat(p2))/2).toFixed(1); else if(p1) pf = p1; row.push(pf);
                data.push(row);
            });
            let wb = XLSX.utils.book_new(); let ws = XLSX.utils.aoa_to_sheet(data); XLSX.utils.book_append_sheet(wb, ws, "Planilla"); XLSX.writeFile(wb, `${cursoName}_${asigName}.xlsx`);
        }

        function printPlanillaNotas() {
            const asigName = document.getElementById("selAsig").options[document.getElementById("selAsig").selectedIndex].text;
            const profName = document.getElementById("inProfesorAsig").value || "__________________________";
            let table = document.getElementById("wrapNotas").querySelector(".sge-table").cloneNode(true);
            table.querySelectorAll("input").forEach(input => { let span = document.createElement("span"); span.innerText = input.value; input.parentNode.replaceChild(span, input); });
            table.querySelectorAll("th").forEach(th => { th.style.cursor = "default"; th.style.background = "#f0f0f0"; th.style.color = "black"; th.title = ""; th.onclick = null; });
            table.querySelectorAll("button").forEach(btn => btn.remove());
            
            // CAMBIO: Usamos print-flow-container para permitir m√∫ltiples p√°ginas
            let html = `<div class="print-flow-container">${getPrintHeader("PLANILLA DE CALIFICACIONES PARCIALES")}<div class="inf-data-grid" style="margin-bottom:10px; grid-template-columns: 1fr 1fr 1fr;"><div><b>CURSO:</b> ${CURSO.data.nombre}</div><div><b>ASIGNATURA:</b> ${asigName}</div><div><b>PROFESOR(A):</b> ${profName}</div></div><div class="table-wrapper" style="border:none; box-shadow:none;">${table.outerHTML}</div><div class="inf-footer" style="margin-top:30px;"><div class="inf-firma">Firma Profesor(a)</div></div></div>`;
            
            document.getElementById("printArea").innerHTML = html; window.print();
        }

        function renderAsis() { const mesKey=document.getElementById("selMes").value,mesIdx=MESES_MAP[mesKey],year=parseInt(document.getElementById("selAno").value)||2026,daysInMonth=new Date(year,mesIdx+1,0).getDate(); let h=`<table class="sge-table"><thead><tr><th class="col-alumno">ALUMNO</th>`; for(let i=1;i<=daysInMonth;i++){let d=new Date(year,mesIdx,i),isWeekend=(d.getDay()===0||d.getDay()===6);h+=`<th class="${isWeekend?'weekend-header':''}" style="width:24px;">${i}</th>`} h+=`</tr></thead><tbody>`; CURSO.alumnos.forEach((alu,idx)=>{ let isRet = !!alu.fecha_retiro; let asis=alu.asistencia_diaria?(alu.asistencia_diaria[mesKey]||{}):{}; h+=`<tr class="${isRet?'tr-retiro':''}"><td class="col-alumno"><b>${idx+1}.</b> ${alu.nombre_completo} ${isRet?'(RET)':''}</td>`; for(let i=1;i<=daysInMonth;i++){let d=new Date(year,mesIdx,i),isWeekend=(d.getDay()===0||d.getDay()===6); if(isWeekend)h+=`<td class="weekend"></td>`; else {let isPresent=asis[i]!==false;h+=`<td><input type="checkbox" ${isPresent?'checked':''} onchange="saveAsis('${alu.rut}','${mesKey}',${i},this.checked)"></td>`} } h+=`</tr>`}); document.getElementById("wrapAsistencia").innerHTML=h+"</tbody></table>"; }
        async function saveAsis(rut,mes,dia,val){let alu=CURSO.alumnos.find(a=>a.rut===rut);if(alu){if(!alu.asistencia_diaria)alu.asistencia_diaria={};if(!alu.asistencia_diaria[mes])alu.asistencia_diaria[mes]={};alu.asistencia_diaria[mes][dia]=val} await db.collection("cursos").doc(CURSO.id).collection("alumnos").doc(rut).update({[`asistencia_diaria.${mes}.${dia}`]:val}); }
        function printPlanillaAsistencia() { const mesKey=document.getElementById("selMes").value,mesIdx=MESES_MAP[mesKey],mesNombre=document.getElementById("selMes").options[document.getElementById("selMes").selectedIndex].text,year=parseInt(document.getElementById("selAno").value)||2026,daysInMonth=new Date(year,mesIdx+1,0).getDate(); let h=`<div class="informe-page" style="display:block;height:auto;">${getPrintHeader("PLANILLA DE ASISTENCIA MENSUAL")}<div class="inf-data-grid" style="grid-template-columns:1fr 1fr;margin-bottom:15px;"><div><b>CURSO:</b> ${CURSO.data.nombre}</div><div><b>MES:</b> ${mesNombre} ${year}</div></div><table class="print-table"><thead><tr><th style="width:200px;text-align:left;padding-left:5px;">ALUMNO</th>`; for(let i=1;i<=daysInMonth;i++){let d=new Date(year,mesIdx,i),isWeekend=(d.getDay()===0||d.getDay()===6);h+=`<th style="${isWeekend?'background:#ccc;':''}width:20px;">${i}</th>`} h+=`</tr></thead><tbody>`; let tPres=new Array(daysInMonth+1).fill(0),tAus=new Array(daysInMonth+1).fill(0),mat=0; CURSO.alumnos.forEach((alu,idx)=>{ if(alu.fecha_retiro) return; mat++; let asis=alu.asistencia_diaria?(alu.asistencia_diaria[mesKey]||{}):{}; h+=`<tr><td style="text-align:left;padding-left:5px;"><b>${idx+1}.</b> ${alu.nombre_completo}</td>`; for(let i=1;i<=daysInMonth;i++){let d=new Date(year,mesIdx,i),isWeekend=(d.getDay()===0||d.getDay()===6),isPresent=asis[i]!==false; if(!isWeekend){if(isPresent)tPres[i]++;else tAus[i]++;} h+=`<td style="${isWeekend?'background:#ccc;':''}" class="print-check">${isWeekend?'':(isPresent?'‚Ä¢':'A')}</td>`} h+=`</tr>`}); h+=`</tbody><tfoot><tr><td>MATR√çCULA ACTIVA</td>`; for(let i=1;i<=daysInMonth;i++){let d=new Date(year,mesIdx,i),isWeekend=(d.getDay()===0||d.getDay()===6);h+=isWeekend?`<td style="background:#ccc"></td>`:`<td>${mat}</td>`} h+=`</tr><tr><td>PRESENTES</td>`; let sumT=0; for(let i=1;i<=daysInMonth;i++){let d=new Date(year,mesIdx,i),isWeekend=(d.getDay()===0||d.getDay()===6);if(!isWeekend)sumT+=tPres[i];h+=isWeekend?`<td style="background:#ccc"></td>`:`<td>${tPres[i]}</td>`} h+=`</tr><tr><td>AUSENTES</td>`; for(let i=1;i<=daysInMonth;i++){let d=new Date(year,mesIdx,i),isWeekend=(d.getDay()===0||d.getDay()===6);h+=isWeekend?`<td style="background:#ccc"></td>`:`<td>${tAus[i]}</td>`} h+=`</tr><tr><td>% ASISTENCIA</td>`; for(let i=1;i<=daysInMonth;i++){let d=new Date(year,mesIdx,i),isWeekend=(d.getDay()===0||d.getDay()===6),p=mat>0?Math.round((tPres[i]/mat)*100):0;h+=isWeekend?`<td style="background:#ccc"></td>`:`<td>${p}%</td>`} h+=`</tr></tfoot></table><div style="margin-top:15px;border:1px solid #000;display:inline-block;padding:10px;font-size:12px;"><b>RESUMEN MENSUAL:</b><br>Porcentaje: <b>${mat>0?Math.round((sumT/(mat*(daysInMonth-8)))*100):0}%</b></div><div class="inf-footer" style="margin-top:30px;"><div class="inf-firma">Firma Inspector√≠a / Profesor Jefe</div></div></div>`; document.getElementById("printArea").innerHTML=h; setTimeout(()=>window.print(),500); }

        function switchSemestre(s) { currentSemPers = s; document.getElementById("btnS1").className = s === 'S1' ? 'btn btn-blue' : 'btn btn-default'; document.getElementById("btnS2").className = s === 'S2' ? 'btn btn-blue' : 'btn btn-default'; renderPers(); }
        function renderPers() { let h = `<table class="sge-table"><thead><tr><th class="col-alumno">ALUMNO</th>`; INDICADORES_PERS.forEach(ind => { h += `<th title="${ind.text}">${ind.id}</th>`; }); h += `<th style="width:200px">OBSERVACI√ìN</th></tr></thead><tbody>`; CURSO.alumnos.forEach((alu, idx) => { let p = alu.personalidad || {}; h += `<tr class="${alu.fecha_retiro?'tr-retiro':''}"><td class="col-alumno">${idx + 1}. ${alu.nombre_completo}</td>`; INDICADORES_PERS.forEach(ind => { let key = `${ind.id}_${currentSemPers}`; let val = p[key] || ""; h += `<td><select class="nota-in" onchange="savePers('${alu.rut}', '${key}', this.value)"><option value="" ${val==""?"selected":""}>-</option><option value="DE" ${val=="DE"?"selected":""}>DE</option><option value="DA" ${val=="DA"?"selected":""}>DA</option><option value="PS" ${val=="PS"?"selected":""}>PS</option><option value="NR" ${val=="NR"?"selected":""}>NR</option></select></td>`; }); let obsKey = `obs_${currentSemPers.toLowerCase()}`; let obsVal = p[obsKey] || ""; h += `<td><input type="text" class="nota-in" style="text-align:left; padding:0 5px;" value="${obsVal}" onchange="savePers('${alu.rut}', '${obsKey}', this.value)" placeholder="Observaci√≥n..."></td></tr>`; }); document.getElementById("wrapPers").innerHTML = h + "</tbody></table>"; }
        async function savePers(rut, field, val) { await db.collection("cursos").doc(CURSO.id).collection("alumnos").doc(rut).update({[`personalidad.${field}`]: val}); }
        
        async function renderAsistenciaGral(){ const s=await db.collection("cursos").get(); let h=`<table class="sge-table" style="width:100%"><thead><tr><th style="width:150px">CURSO</th><th style="width:100px">MAT (Act)</th><th style="width:100px">PRES</th><th style="width:100px">AUS</th><th style="width:80px">%</th></tr></thead><tbody>`; for(const d of s.docs){ if(!d.data().nombre.includes("2026"))continue; h+=`<tr class="tr-click" onclick="showAsistenciaDetalle('${d.id}','${d.data().nombre}')"><td>${d.data().nombre}</td><td colspan="4" style="color:#004a99; font-weight:bold;">Ver detalle completo >></td></tr>` } document.getElementById("wrapAsistenciaGral").innerHTML=h+`</tbody></table>`; }
        async function showAsistenciaDetalle(cid, nom){ document.getElementById("loader").style.display="flex"; try { let aRef=await db.collection("cursos").doc(cid).collection("alumnos").get(); let alus=aRef.docs.map(d=>d.data()); 
        // FILTER RETIRED STUDENTS FROM STATS
        alus = alus.filter(a => !a.fecha_retiro);
        let ranking=[]; alus.forEach(alu=>{ let total=0, faltas=0; if(alu.asistencia_diaria){ Object.values(alu.asistencia_diaria).forEach(m=>{ Object.values(m).forEach(v=>{ if(v!==null){total++; if(v===false)faltas++} }) }) }; let p=total>0?Math.round(((total-faltas)/total)*100):0; ranking.push({nombre:alu.nombre_completo, faltas:faltas, pct:p}) }); let riskList = [...ranking].sort((a,b)=>b.faltas-a.faltas).filter(x=>x.faltas>0); let hRisk=""; if(riskList.length===0) hRisk="<tr><td colspan='3'>Asistencia Perfecta.</td></tr>"; else riskList.forEach(r=>{ hRisk+=`<tr><td style="text-align:left;">${r.nombre}</td><td style="color:red;font-weight:bold;">${r.faltas}</td><td>${r.pct}%</td></tr>`; }); document.getElementById("bodyRankingRisk").innerHTML=hRisk; let rewardList = [...ranking].sort((a,b)=>b.pct-a.pct).slice(0, 10); let labels = rewardList.map(r=>r.nombre.split(" ")[0] + " " + (r.nombre.split(" ")[2]||"")); let data = rewardList.map(r=>r.pct); const ctx = document.getElementById('chartBestAsis'); if(chartBestAsisInstance) chartBestAsisInstance.destroy(); chartBestAsisInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: '% Asistencia', data: data, backgroundColor: '#388e3c', borderColor: '#1b5e20', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100 } } } }); document.getElementById("modalAsisStats").style.display='flex'; } catch(e) { alert("Error cargando detalle: " + e.message); } finally { document.getElementById("loader").style.display="none"; } }

        async function loadUTPData() { const loader = document.getElementById("loader"); loader.style.display = "flex"; document.getElementById("loaderText").innerText = "Procesando Datos UTP..."; const year = document.getElementById("selAno").value; UTP_DATA = []; try { const cursosSnap = await db.collection("cursos").get(); const promises = []; cursosSnap.forEach(doc => { const c = doc.data(); if(c.nombre && c.nombre.includes(year)) { promises.push(Promise.all([db.collection("cursos").doc(doc.id).collection("alumnos").orderBy("numero_lista").get(),db.collection("cursos").doc(doc.id).collection("asignaturas").orderBy("id").get()]).then(([alusSnap, asigsSnap]) => { return { id: doc.id, nombre: c.nombre, alumnos: alusSnap.docs.map(a => a.data()), asignaturas: asigsSnap.docs.map(s => ({id:s.id, ...s.data()})) }; })); } }); const rawData = await Promise.all(promises); processUTPData(rawData); renderUTPGeneral(); 
            // UPDATED SELECTORS including Mantenedor
            let sel = document.getElementById("selUtpCursoSabana"); let selDet = document.getElementById("selUtpCursoDetalle"); 
            let selMantAsig = document.getElementById("selMantCursoAsig"); let selMantNomina = document.getElementById("selMantCursoNomina");
            
            let htmlOp = "<option value=''>Seleccione Curso</option>";
            sel.innerHTML = htmlOp; selDet.innerHTML = htmlOp; selMantAsig.innerHTML = htmlOp; selMantNomina.innerHTML = htmlOp;
            
            UTP_DATA.forEach((c, idx) => { let op = `<option value="${idx}">${c.nombre}</option>`; sel.innerHTML += op; selDet.innerHTML += op; selMantAsig.innerHTML += op; selMantNomina.innerHTML += op; }); } catch (e) { console.error(e); alert("Error cargando UTP"); } finally { loader.style.display = "none"; } }
        
        function processUTPData(courses) { 
            UTP_DATA = courses.map(c => { 
                let sumProm = 0, countProm = 0, reprobados = 0, rojosList = [], matriculaActiva = 0; 
                const IGNORAR = ["HABILIDADES", "HABITOS", "INDUCCION", "CONSEJO"]; 
                const CIENCIAS_NOMBRES = ["BIOLOGIA", "FISICA", "QUIMICA"]; 
                let cienciasIds = c.asignaturas.filter(a => CIENCIAS_NOMBRES.some(ci => cleanStr(a.nombre).includes(ci))).map(a => a.id); 
                
                c.alumnos.forEach(alu => { 
                    // CRITICAL: Skip withdrawn students for stats
                    if(alu.fecha_retiro) return;

                    matriculaActiva++;
                    let sumFinal = 0, cFinal = 0; let sumCiencias = 0, countCiencias = 0; let asigsRojas = 0; 
                    c.asignaturas.forEach(asig => { 
                        if(IGNORAR.some(ig => cleanStr(asig.nombre).includes(ig))) return; 
                        let p1 = obtenerPromedioAsignatura(alu.notas, asig.id, ''); 
                        let n11_s1 = getNota11Value(alu, asig.nombre, c.nombre, '', c.asignaturas); 
                        if(n11_s1){ let n=alu.notas?(alu.notas[asig.id]||{}):{}; let s=0,cnt=0; for(let x=1;x<=10;x++)if(n['n'+x]){s+=parseFloat(n['n'+x]);cnt++} s+=parseFloat(n11_s1); cnt++; p1=(s/cnt).toFixed(1); } 
                        let p2 = obtenerPromedioAsignatura(alu.notas, asig.id, 's2_'); 
                        let n11_s2 = getNota11Value(alu, asig.nombre, c.nombre, 's2_', c.asignaturas); 
                        if(n11_s2){ let n=alu.notas?(alu.notas[asig.id]||{}):{}; let s=0,cnt=0; for(let x=1;x<=10;x++)if(n['s2_n'+x]){s+=parseFloat(n['s2_n'+x]);cnt++} s+=parseFloat(n11_s2); cnt++; p2=(s/cnt).toFixed(1); } 
                        let pf = ""; if(p1 && p2) pf = ((parseFloat(p1)+parseFloat(p2))/2).toFixed(1); else if(p1) pf = p1; 
                        if(!isConcepto(asig.nombre) && pf) { 
                            if(cienciasIds.includes(asig.id)) { sumCiencias += parseFloat(pf); countCiencias++; } 
                            else { sumFinal += parseFloat(pf); cFinal++; if(parseFloat(pf) < 4.0) asigsRojas++; } 
                        } 
                    }); 
                    if(countCiencias > 0) { let promCiencias = parseFloat((sumCiencias/countCiencias).toFixed(1)); sumFinal += promCiencias; cFinal++; if(promCiencias < 4.0) asigsRojas++; } 
                    let promAlu = cFinal > 0 ? (sumFinal/cFinal).toFixed(1) : null; 
                    if(promAlu) { 
                        sumProm += parseFloat(promAlu); countProm++; 
                        let estado = "PROMOVIDO"; let esRiesgo = false; 
                        if(asigsRojas > 0) { 
                            if(asigsRojas > 2) { estado = "REPITENCIA"; esRiesgo = true; } 
                            else if(asigsRojas === 1 && parseFloat(promAlu) < 4.5) { estado = "REPITENCIA"; esRiesgo = true; } 
                            else if(asigsRojas === 2 && parseFloat(promAlu) < 5.0) { estado = "REPITENCIA"; esRiesgo = true; } 
                        } 
                        if(esRiesgo) reprobados++; 
                        alu.promedioGeneral = promAlu; alu.asigsRojas = asigsRojas; alu.estado = estado; 
                        if(esRiesgo) rojosList.push(alu); 
                    } 
                }); 
                return { ...c, matricula: matriculaActiva, promedioCurso: countProm > 0 ? (sumProm/countProm).toFixed(1) : 0, reprobados: reprobados, aprobados: matriculaActiva - reprobados, alertas: rojosList }; 
            }); 
        }
        
        function renderUTPGeneral() { 
            let totalMat=0, sumGlobal=0, countGlobal=0, totalRep=0, totalApro=0, html="", labels=[], dataProms=[]; 
            UTP_DATA.forEach(c=>{
                totalMat+=c.matricula; 
                if(c.promedioCurso>0){sumGlobal+=parseFloat(c.promedioCurso); countGlobal++;} 
                totalRep+=c.reprobados; 
                totalApro+=c.aprobados;
                let pct=c.matricula>0?Math.round((c.aprobados/(c.aprobados+c.reprobados))*100):0; 
                html+=`<tr><td style="text-align:left">${c.nombre}</td><td>${c.matricula}</td><td><b>${c.promedioCurso}</b></td><td style="color:green">${c.aprobados}</td><td style="color:red">${c.reprobados}</td><td>${pct}%</td></tr>`; 
                labels.push(c.nombre); 
                dataProms.push(c.promedioCurso);
            }); 
            
            document.getElementById("utpTotalMat").innerText=totalMat; 
            document.getElementById("utpPromGral").innerText=countGlobal>0?(sumGlobal/countGlobal).toFixed(1):"-"; 
            document.getElementById("utpRiesgo").innerText=totalRep; 
            document.getElementById("utpAprob").innerText=totalMat>0?Math.round(((totalMat-totalRep)/totalMat)*100)+"%":"0%"; 
            document.getElementById("bodyUTPCursos").innerHTML=html; 
            
            const ctx=document.getElementById('chartUTPCursos'); 
            if(chartUTPInstance)chartUTPInstance.destroy(); 
            chartUTPInstance=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Promedio',data:dataProms,backgroundColor:'#004a99'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:false,min:3.0,max:7.0}}}});
            
            const ctxPie=document.getElementById('chartUTPPie');
            if(chartUTPPieInstance)chartUTPPieInstance.destroy();
            chartUTPPieInstance=new Chart(ctxPie, {type: 'pie', data: {labels: ['Aprobados', 'Reprobados'], datasets: [{data: [totalApro, totalRep], backgroundColor: ['#388e3c', '#d32f2f']}]}, options: { responsive: true, maintainAspectRatio: false, plugins: { title: {display:true, text: 'Estado Global (Activos)'} } }});
        }
        
        function verUTP(tab) { document.querySelectorAll('.utp-tab').forEach(x => x.style.display = 'none'); document.getElementById('utp' + tab.charAt(0).toUpperCase() + tab.slice(1)).style.display = 'block'; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); if(tab==='alertas')renderUTPAlertas(); if(tab==='ranking')renderUTPRanking(); if(tab==='correlacion')renderUTPCorrelacion(); }
        function renderUTPAlertas(){let h="";UTP_DATA.forEach(c=>{c.alertas.forEach(alu=>{h+=`<tr><td style="text-align:left;">${alu.nombre_completo}</td><td>${c.nombre}</td><td><b>${alu.promedioGeneral}</b></td><td style="color:red; font-weight:bold;">${alu.estado} (${alu.asigsRojas} rojos)</td></tr>`})});document.getElementById("bodyUTPAlertas").innerHTML=h||"<tr><td colspan='4'>Sin alumnos en riesgo de repitencia.</td></tr>"}
        function renderUTPRanking(){let all=[];UTP_DATA.forEach(c=>{c.alumnos.forEach(a=>{if(a.promedioGeneral && !a.fecha_retiro)all.push({...a,curso:c.nombre})})});all.sort((a,b)=>parseFloat(b.promedioGeneral)-parseFloat(a.promedioGeneral));let h="";all.slice(0,10).forEach((a,i)=>{h+=`<tr><td><span class="ranking-badge">${i+1}</span></td><td style="text-align:left">${a.nombre_completo}</td><td>${a.curso}</td><td><b>${a.promedioGeneral}</b></td></tr>`});document.getElementById("bodyUTPRanking").innerHTML=h}
        function renderUTPPlanillaSabana() { const idx = document.getElementById("selUtpCursoSabana").value; if(idx === "") return; const curso = UTP_DATA[idx]; const IGNORAR = ["HABILIDADES", "HABITOS", "INDUCCION", "CONSEJO"]; const CIENCIAS_NOMBRES = ["BIOLOGIA", "FISICA", "QUIMICA"]; let cienciasIds = curso.asignaturas.filter(a => CIENCIAS_NOMBRES.some(ci => cleanStr(a.nombre).includes(ci))).map(a => a.id); let html = `<table class="sge-table sabana-table"><thead><tr><th class="col-alumno" rowspan="2">ALUMNO</th>`; curso.asignaturas.forEach(asig => { if(IGNORAR.some(ig => cleanStr(asig.nombre).includes(ig))) return; html += `<th colspan="3" class="sabana-header-asig" title="${asig.nombre}">${asig.nombre.substring(0, 10)}</th>`; }); if(cienciasIds.length > 0) html += `<th rowspan="2" class="sabana-header-asig" style="background:#e0f2f1 !important;">PROM CIEN</th>`; html += `<th rowspan="2" class="sabana-header-asig">P. S1</th><th rowspan="2" class="sabana-header-asig">P. S2</th><th rowspan="2" class="sabana-header-asig">P. GRAL</th><th rowspan="2" class="sabana-alert">ROJOS</th><th rowspan="2" class="sabana-header-asig">OBSERVACI√ìN</th></tr><tr>`; curso.asignaturas.forEach(asig => { if(IGNORAR.some(ig => cleanStr(asig.nombre).includes(ig))) return; html += `<th>S1</th><th>S2</th><th>FIN</th>`; }); html += `</tr></thead><tbody>`; curso.alumnos.forEach((alu, i) => { let rojosCount=0, sumFinal=0, cFinal=0, sumCiencias=0, countCiencias=0, sumS1=0, cS1=0, sumS2=0, cS2=0; html += `<tr class="${alu.fecha_retiro?'tr-retiro':''}"><td class="col-alumno">${i+1}. ${alu.nombre_completo} ${alu.fecha_retiro?'(RET)':''}</td>`; curso.asignaturas.forEach(asig => { if(IGNORAR.some(ig => cleanStr(asig.nombre).includes(ig))) return; let n11_s1=getNota11Value(alu,asig.nombre,curso.nombre,'', curso.asignaturas); let p1=obtenerPromedioAsignatura(alu.notas,asig.id,''); if(n11_s1){let n=alu.notas?(alu.notas[asig.id]||{}):{};let s=0,c=0;for(let x=1;x<=10;x++)if(n['n'+x]){s+=parseFloat(n['n'+x]);c++}s+=parseFloat(n11_s1);c++;p1=(s/c).toFixed(1);} let n11_s2=getNota11Value(alu,asig.nombre,curso.nombre,'s2_', curso.asignaturas); let p2=obtenerPromedioAsignatura(alu.notas,asig.id,'s2_'); if(n11_s2){let n=alu.notas?(alu.notas[asig.id]||{}):{};let s=0,c=0;for(let x=1;x<=10;x++)if(n['s2_n'+x]){s+=parseFloat(n['s2_n'+x]);c++}s+=parseFloat(n11_s2);c++;p2=(s/c).toFixed(1);} let pf=""; if(p1&&p2)pf=((parseFloat(p1)+parseFloat(p2))/2).toFixed(1); else if(p1)pf=p1; let esCon = isConcepto(asig.nombre); if(!esCon && pf){ if(cienciasIds.includes(asig.id)){ sumCiencias+=parseFloat(pf); countCiencias++; } else { sumFinal+=parseFloat(pf); cFinal++; if(parseFloat(pf)<4.0)rojosCount++; } if(p1){sumS1+=parseFloat(p1);cS1++} if(p2){sumS2+=parseFloat(p2);cS2++} } const st=(v)=>v&&parseFloat(v)<4.0&&!esCon?"nota-roja":"nota-azul"; html+=`<td class="sabana-s1 ${st(p1)}">${esCon?numToConcept(p1):p1||""}</td><td class="sabana-s2 ${st(p2)}">${esCon?numToConcept(p2):p2||""}</td><td class="sabana-final ${st(pf)}">${esCon?numToConcept(pf):pf||""}</td>`; }); if(cienciasIds.length>0){ let pc=countCiencias>0?(sumCiencias/countCiencias).toFixed(1):""; html+=`<td style="background:#e0f2f1;font-weight:bold;color:${parseFloat(pc)<4.0?'red':'#00695c'}">${pc}</td>`; if(pc){sumFinal+=parseFloat(pc);cFinal++;if(parseFloat(pc)<4.0)rojosCount++;} } let finalAnual=cFinal>0?(sumFinal/cFinal).toFixed(1):"-"; let obs="PROMOVIDO", style="color:green;font-weight:bold;"; if(finalAnual!=="-"){ let fa=parseFloat(finalAnual); if(rojosCount>2 || (rojosCount==1 && fa<4.5) || (rojosCount==2 && fa<5.0)){ obs="REPITENCIA"; style="color:red;font-weight:bold;"; } } else { obs="PENDIENTE"; style="color:#999;"; } if(alu.fecha_retiro) {obs="RETIRADO"; style="color:#666; font-style:italic;"} html+=`<td>${cS1>0?(sumS1/cS1).toFixed(1):"-"}</td><td>${cS2>0?(sumS2/cS2).toFixed(1):"-"}</td><td style="font-weight:bold;background:#fff3e0;">${finalAnual}</td><td class="sabana-alert">${rojosCount>0?rojosCount:""}</td><td style="${style}">${obs}</td></tr>`; }); document.getElementById("wrapUtpSabana").innerHTML = html + "</tbody></table>"; }
        function printSabana() { let content = document.getElementById("wrapUtpSabana").innerHTML; let cursoNombre = document.getElementById("selUtpCursoSabana").options[document.getElementById("selUtpCursoSabana").selectedIndex].text; document.getElementById("printArea").innerHTML = `<div class="informe-page sabana-print-container" style="width:auto; height:auto;"><h3>PLANILLA DE NOTAS - ${cursoNombre}</h3>${content}</div>`; window.print(); }
        function loadStudentsForDetail() { const idx = document.getElementById("selUtpCursoDetalle").value; let selAlu = document.getElementById("selUtpAlumnoDetalle"); selAlu.innerHTML = "<option value=''>-- Seleccione Alumno --</option>"; if(idx === "") return; UTP_DATA[idx].alumnos.forEach((alu, i) => selAlu.innerHTML += `<option value="${i}">${alu.nombre_completo}</option>`); }
        function renderUTPDetalle() { const idxCurso = document.getElementById("selUtpCursoDetalle").value; const idxAlu = document.getElementById("selUtpAlumnoDetalle").value; if(idxCurso === "" || idxAlu === "") return; const curso = UTP_DATA[idxCurso]; const alumno = curso.alumnos[idxAlu]; const IGNORAR = ["HABILIDADES", "HABITOS", "INDUCCION", "CONSEJO"]; let html = `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">`; html += `<div><div class="header-main-blue">VISTA ALUMNO: ${alumno.nombre_completo}</div><table class="utp-complex-table"><thead><tr><th rowspan="2">Subsector</th><th colspan="2" class="header-sub-blue">1¬∞ Sem</th><th colspan="2" class="header-sub-blue">2¬∞ Sem</th><th colspan="2" class="header-sub-blue">Final</th></tr><tr><th>Curso</th><th>Alu</th><th>Curso</th><th>Alu</th><th>Curso</th><th>Alu</th></tr></thead><tbody>`; curso.asignaturas.forEach(asig => { if(IGNORAR.some(ig => cleanStr(asig.nombre).includes(ig))) return; let sumC1=0, cntC1=0, sumC2=0, cntC2=0, sumCF=0, cntCF=0; curso.alumnos.forEach(a=>{ if(a.fecha_retiro)return; let n=a.notas?(a.notas[asig.id]||{}):{}; let s1=0,c1=0; for(let i=1;i<=10;i++)if(n['n'+i]){s1+=parseFloat(n['n'+i]);c1++} if(c1>0){sumC1+=s1/c1;cntC1++} let s2=0,c2=0; for(let i=1;i<=10;i++)if(n['s2_n'+i]){s2+=parseFloat(n['s2_n'+i]);c2++} if(c2>0){sumC2+=s2/c2;cntC2++} if(c1>0||c2>0){let p1=c1>0?s1/c1:null,p2=c2>0?s2/c2:null;let pf=(p1&&p2)?(p1+p2)/2:(p1||p2);if(pf){sumCF+=pf;cntCF++}} }); let pC1=cntC1>0?(sumC1/cntC1).toFixed(1):"", pC2=cntC2>0?(sumC2/cntC2).toFixed(1):"", pCF=cntCF>0?(sumCF/cntCF).toFixed(1):""; let p1=obtenerPromedioAsignatura(alumno.notas,asig.id,''), p2=obtenerPromedioAsignatura(alumno.notas,asig.id,'s2_'); let pf=""; if(p1&&p2)pf=((parseFloat(p1)+parseFloat(p2))/2).toFixed(1); else if(p1)pf=p1; const st=(v)=>v&&parseFloat(v)<4.0?"color:red;font-weight:bold;":"color:blue;font-weight:bold;"; html += `<tr><td style="text-align:left;">${asig.nombre}</td><td>${pC1}</td><td class="cell-yellow" style="${st(p1)}">${p1||""}</td><td>${pC2}</td><td class="cell-yellow" style="${st(p2)}">${p2||""}</td><td>${pCF}</td><td class="cell-yellow" style="${st(pf)}">${pf||""}</td></tr>`; }); html += `</tbody></table></div>`; html += `<div><div class="header-main-blue">ESTADO CURSO: ${curso.nombre}</div><table class="utp-complex-table"><thead><tr><th rowspan="2">Subsector</th><th colspan="2" class="header-sub-blue">1¬∞ Sem</th><th colspan="2" class="header-sub-blue">2¬∞ Sem</th><th colspan="2" class="header-sub-blue">Final</th></tr><tr><th>Apr</th><th>Rep</th><th>Apr</th><th>Rep</th><th>Apr</th><th>Rep</th></tr></thead><tbody>`; curso.asignaturas.forEach(asig => { if(IGNORAR.some(ig => cleanStr(asig.nombre).includes(ig))) return; let ap1=0,rp1=0,ap2=0,rp2=0,apF=0,rpF=0; curso.alumnos.forEach(a=>{ if(a.fecha_retiro) return; let p1=obtenerPromedioAsignatura(a.notas,asig.id,''); if(p1){parseFloat(p1)>=4.0?ap1++:rp1++} let p2=obtenerPromedioAsignatura(a.notas,asig.id,'s2_'); if(p2){parseFloat(p2)>=4.0?ap2++:rp2++} let pf=""; if(p1&&p2)pf=((parseFloat(p1)+parseFloat(p2))/2).toFixed(1); else if(p1)pf=p1; if(pf){parseFloat(pf)>=4.0?apF++:rpF++} }); html += `<tr><td style="text-align:left;">${asig.nombre}</td><td>${ap1}</td><td style="color:red;">${rp1}</td><td>${ap2}</td><td style="color:red;">${rp2}</td><td>${apF}</td><td style="color:red;">${rpF}</td></tr>`; }); html += `</tbody></table></div></div>`; document.getElementById("wrapUtpDetalle").innerHTML = html; }

        function renderUTPCorrelacion() {
            let dataPoints = [];
            UTP_DATA.forEach(c => {
                c.alumnos.forEach(alu => {
                    if(alu.promedioGeneral && alu.asistencia_diaria && !alu.fecha_retiro) {
                        let total=0, faltas=0;
                        Object.values(alu.asistencia_diaria).forEach(m=>{ Object.values(m).forEach(v=>{ if(v!==null){total++; if(v===false)faltas++} }) });
                        let pct = total > 0 ? Math.round(((total-faltas)/total)*100) : 100;
                        dataPoints.push({ x: pct, y: parseFloat(alu.promedioGeneral) });
                    }
                });
            });

            const ctx = document.getElementById('chartCorrelacion');
            if(chartCorrelacionInstance) chartCorrelacionInstance.destroy();
            chartCorrelacionInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Asistencia vs Promedio',
                        data: dataPoints,
                        backgroundColor: 'rgba(0, 74, 153, 0.5)',
                        borderColor: '#004a99',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: {display:true, text: '% Asistencia'}, min: 50, max: 100 },
                        y: { title: {display:true, text: 'Promedio General'}, min: 2.0, max: 7.0 }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Asis: ${context.parsed.x}% | Nota: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- SISTEMA DE RESPALDO (BACKUP) ---
        async function downloadBackup() {
            if(!confirm("¬øDesea generar una copia de seguridad de todos los cursos y alumnos del a√±o actual?")) return;
            document.getElementById("loader").style.display = "flex";
            document.getElementById("loaderText").innerText = "Generando Copia de Seguridad...";
            try {
                if(UTP_DATA.length === 0) await loadUTPData(); 
                const backupData = {
                    fecha: new Date().toISOString(),
                    cursos: UTP_DATA.map(c => ({
                        id: c.id,
                        nombre: c.nombre,
                        profesor_jefe: c.profesor_jefe,
                        alumnos: c.alumnos,
                        asignaturas: c.asignaturas
                    }))
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "RESPALDO_SGE_" + new Date().toISOString().slice(0,10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            } catch(e) {
                alert("Error al crear respaldo: " + e.message);
            } finally {
                document.getElementById("loader").style.display = "none";
            }
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if(!file) return;
            if(!confirm("‚ö†Ô∏è PELIGRO: Esto sobrescribir√° los datos actuales de la base de datos con los del archivo. ¬øEst√° 100% seguro?")) { input.value = ""; return; }
            const reader = new FileReader();
            reader.onload = async function(e) {
                const content = e.target.result;
                try {
                    const data = JSON.parse(content);
                    if(!data.cursos) throw new Error("Formato de archivo inv√°lido");
                    document.getElementById("loader").style.display = "flex";
                    document.getElementById("loaderText").innerText = "Restaurando... NO CIERRE LA P√ÅGINA";
                    for (const curso of data.cursos) {
                        await db.collection("cursos").doc(curso.id).set({ nombre: curso.nombre, profesor_jefe: curso.profesor_jefe || "" }, {merge:true});
                        for(const alu of curso.alumnos) { await db.collection("cursos").doc(curso.id).collection("alumnos").doc(alu.rut).set(alu); }
                        for(const asig of curso.asignaturas) { await db.collection("cursos").doc(curso.id).collection("asignaturas").doc(asig.id).set(asig); }
                    }
                    alert("Restauraci√≥n completada con √©xito.");
                    window.location.reload();
                } catch(err) {
                    alert("Error procesando archivo: " + err.message);
                } finally {
                    document.getElementById("loader").style.display = "none";
                    input.value = "";
                }
            };
            reader.readAsText(file);
        }

        function generateNotasHTML(alu) {
            let p=alu.personalidad||{}, totalDias=0, faltas=0; if(alu.asistencia_diaria) Object.values(alu.asistencia_diaria).forEach(m=>{Object.values(m).forEach(d=>{if(d!==undefined&&d!==null){totalDias++;if(d===false)faltas++}})}); let porcAsis=totalDias>0?Math.round(((totalDias-faltas)/totalDias)*100):100;
            const CONCEPTOS=["RELIGION","ORIENTACION","FORMACION"], CIENCIAS=["BIOLOGIA","FISICA","QUIMICA"], TALLERES_NOTA_11=["INDUCCION","HABILIDADES","HABITOS"], NO_PROM_GENERAL=["RELIGION","ORIENTACION","CONSEJO","HABILIDADES","HABITOS","INDUCCION"];
            
            // --- DETECCION DE NIVEL ---
            const cursoNombre = CURSO.data.nombre.toUpperCase();
            // Nivel 3ro o 4to Medio: Buscamos "3" o "4" o "TERCERO" o "CUARTO"
            const esTerceroCuarto = cursoNombre.includes("3") || cursoNombre.includes("4") || cursoNombre.includes("TERCERO") || cursoNombre.includes("CUARTO");
            
            let asignaturas=CURSO.asignaturas.filter(a=>!cleanStr(a.nombre).includes("CONSEJO")), sumPromAnual=0, countPromAnual=0, sumGenP1=0, countGenP1=0, sumGenP2=0, countGenP2=0;
            let scienceFinals=[], dataRows=asignaturas.map(asig=>{let n=alu.notas?(alu.notas[asig.id]||alu.notas[Number(asig.id)]||{}):{}, nomUpper=cleanStr(asig.nombre), esConcepto=CONCEPTOS.some(c=>nomUpper.includes(c)), esCiencia=CIENCIAS.some(c=>nomUpper.includes(c)), esTaller=TALLERES_NOTA_11.some(t=>nomUpper.includes(t)), sePromedia=!NO_PROM_GENERAL.some(c=>nomUpper.includes(c));
            
            // Si es 3ro o 4to medio, desactivamos la l√≥gica de fusi√≥n para que renderice fila normal
            if (esTerceroCuarto && esCiencia) { esCiencia = false; }

            let n11_s1=getNota11Value(alu,asig.nombre,CURSO.data.nombre,''); let s1=0,c1=0; for(let i=1;i<=10;i++){if(n['n'+i]){s1+=parseFloat(n['n'+i]);c1++}} if(n11_s1){s1+=parseFloat(n11_s1);c1++} else if(n.n11){s1+=parseFloat(n.n11);c1++} let p1=c1>0?(s1/c1).toFixed(1):"";
            let n11_s2=getNota11Value(alu,asig.nombre,CURSO.data.nombre,'s2_'); let s2=0,c2=0; for(let i=1;i<=10;i++){let k='s2_n'+i;if(n[k]){s2+=parseFloat(n[k]);c2++}} if(n11_s2){s2+=parseFloat(n11_s2);c2++} else if(n.s2_n11){s2+=parseFloat(n.s2_n11);c2++} let p2=c2>0?(s2/c2).toFixed(1):"";
            let pFinalNum=null; if(p1&&p2)pFinalNum=(parseFloat(p1)+parseFloat(p2))/2; else if(p1)pFinalNum=parseFloat(p1); else if(p2)pFinalNum=parseFloat(p2); let pFinal=pFinalNum?pFinalNum.toFixed(1):"";
            if(esCiencia&&pFinal)scienceFinals.push(pFinalNum); if(sePromedia&&!esConcepto){if(p1){sumGenP1+=parseFloat(p1);countGenP1++} if(p2){sumGenP2+=parseFloat(p2);countGenP2++} if(pFinal){sumPromAnual+=pFinalNum;countPromAnual++}} return{asig,n,p1,p2,pFinal,esConcepto,esCiencia,sePromedia,nomUpper,esTaller,n11_s1,n11_s2}});
            let promCienciasFusionado=0; if(scienceFinals.length>0){let sC=scienceFinals.reduce((a,b)=>a+b,0);promCienciasFusionado=sC/scienceFinals.length}
            let genP1=countGenP1>0?(sumGenP1/countGenP1).toFixed(1):"", genP2=countGenP2>0?(sumGenP2/countGenP2).toFixed(1):"", promedioGeneral=countPromAnual>0?(sumPromAnual/countPromAnual).toFixed(1):"", puntajeNEM=promedioGeneral?Math.round(parseFloat(promedioGeneral)*100):"", htmlRows="", cienciaRendered=false;
            dataRows.forEach(row=>{let p1Str=row.esTaller?`<span style="color:#aaa;">${row.p1}</span>`:(row.esConcepto?numToConcept(row.p1):row.p1), p2Str=row.esTaller?`<span style="color:#aaa;">${row.p2}</span>`:(row.esConcepto?numToConcept(row.p2):row.p2), n11_s1_str=row.esConcepto?numToConcept(row.n11_s1||row.n.n11):(row.n11_s1||row.n.n11||''), n11_s2_str=row.esConcepto?numToConcept(row.n11_s2||row.n.s2_n11):(row.n11_s2||row.n.s2_n11||''), finalStr=row.esTaller?"":(row.esConcepto?numToConcept(row.pFinal):row.pFinal), trStyle=row.esTaller?"color:#555;font-style:italic;":"";
            if(row.esCiencia){if(!cienciaRendered){htmlRows+=`<tr style="${trStyle}"><td class="print-col-nombre">${row.asig.nombre}</td>`;for(let i=1;i<=10;i++)htmlRows+=`<td class="print-col-nota">${row.esConcepto?numToConcept(row.n['n'+i]):(row.n['n'+i]||'')}</td>`;htmlRows+=`<td class="print-col-nota" style="background:#e8f0fe"><b>${n11_s1_str}</b></td><td class="print-col-prom">${p1Str}</td>`;for(let i=1;i<=10;i++)htmlRows+=`<td class="print-col-nota">${row.esConcepto?numToConcept(row.n['s2_n'+i]):(row.n['s2_n'+i]||'')}</td>`;htmlRows+=`<td class="print-col-nota" style="background:#e8f0fe"><b>${n11_s2_str}</b></td><td class="print-col-prom">${p2Str}</td><td class="print-col-final" rowspan="3" style="vertical-align:middle;background:#ddd;">${promCienciasFusionado?promCienciasFusionado.toFixed(1):"-"}</td></tr>`;cienciaRendered=true}else{htmlRows+=`<tr style="${trStyle}"><td class="print-col-nombre">${row.asig.nombre}</td>`;for(let i=1;i<=10;i++)htmlRows+=`<td class="print-col-nota">${row.esConcepto?numToConcept(row.n['n'+i]):(row.n['n'+i]||'')}</td>`;htmlRows+=`<td class="print-col-nota" style="background:#e8f0fe"><b>${n11_s1_str}</b></td><td class="print-col-prom">${p1Str}</td>`;for(let i=1;i<=10;i++)htmlRows+=`<td class="print-col-nota">${row.esConcepto?numToConcept(row.n['s2_n'+i]):(row.n['s2_n'+i]||'')}</td>`;htmlRows+=`<td class="print-col-nota" style="background:#e8f0fe"><b>${n11_s2_str}</b></td><td class="print-col-prom">${p2Str}</td></tr>`;}} else {htmlRows+=`<tr style="${trStyle}"><td class="print-col-nombre">${row.asig.nombre}</td>`;for(let i=1;i<=10;i++)htmlRows+=`<td class="print-col-nota">${row.esConcepto?numToConcept(row.n['n'+i]):(row.n['n'+i]||'')}</td>`;htmlRows+=`<td class="print-col-nota" style="background:#e8f0fe"><b>${n11_s1_str}</b></td><td class="print-col-prom">${p1Str}</td>`;for(let i=1;i<=10;i++)htmlRows+=`<td class="print-col-nota">${row.esConcepto?numToConcept(row.n['s2_n'+i]):(row.n['s2_n'+i]||'')}</td>`;htmlRows+=`<td class="print-col-nota" style="background:#e8f0fe"><b>${n11_s2_str}</b></td><td class="print-col-prom">${p2Str}</td><td class="print-col-final">${finalStr}</td></tr>`;}});
            return { html: `<div class="informe-page">${getPrintHeader("INFORME DE NOTAS Y DESARROLLO PERSONAL")}<div class="inf-data-grid"><div><b>ALUMNO:</b> ${alu.nombre_completo}</div><div><b>RUT:</b> ${alu.rut}</div><div><b>CURSO:</b> ${CURSO.data.nombre}</div><div style="background:#e8f0fe; border:1px solid #004a99; font-weight:bold; text-align:center;">NEM ESTIMADO: ${puntajeNEM||"-"}</div></div><div class="inf-layout"><div class="inf-col-left"><table class="inf-table"><thead><tr><th class="print-col-nombre" rowspan="2">ASIGNATURA</th><th colspan="11">PRIMER SEMESTRE</th><th class="print-col-prom" rowspan="2">P1</th><th colspan="11">SEGUNDO SEMESTRE</th><th class="print-col-prom" rowspan="2">P2</th><th class="print-col-final" rowspan="2">FINAL</th></tr><tr class="subheader-nums"><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>N11</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>N11</th></tr></thead><tbody>${htmlRows}</tbody><tfoot><tr><td colspan="12" style="text-align:right;padding-right:5px;font-weight:bold;">PROMEDIO GENERAL:</td><td style="font-weight:bold;background:#ccc;">${genP1}</td><td colspan="11"></td><td style="font-weight:bold;background:#ccc;">${genP2}</td><td class="final-closed">${promedioGeneral}</td></tr></tfoot></table></div><div class="inf-col-right"><div class="box-title">ASISTENCIA</div><div class="box-content"><div>% Asistencia: <b>${porcAsis}%</b></div><div>Inasistencias: <b>${faltas}</b></div></div><div class="box-title">RENDIMIENTO</div><div class="chart-box"><canvas id="chartPrint_${alu.rut}"></canvas></div><div class="box-title">PERSONALIDAD</div><div class="box-content" style="height:350px;font-style:italic;overflow:hidden;font-size:9px;"><b>S1:</b> ${p.obs_s1||"-"}<br><b>S2:</b> ${p.obs_s2||"-"}</div></div></div><div class="inf-footer-dual"><div class="inf-firma-box"><div class="inf-firma-line">Firma Profesor(a) Jefe</div></div><div class="inf-firma-box"><div class="inf-firma-line">Alejandra Morales G.<br><span class="inf-firma-sub">Unidad T√©cnico Pedag√≥gica</span></div></div></div></div>`, chartData: { id: `chartPrint_${alu.rut}`, data: [parseFloat(promedioGeneral)||0, 6.0] } };
        }
        function generatePersonalidadHTML(alu) { let p=alu.personalidad||{}, groups={}, trs=""; INDICADORES_PERS.forEach(i=>{if(!groups[i.cat])groups[i.cat]=[];groups[i.cat].push(i)}); for(const[cat,inds]of Object.entries(groups)){trs+=`<tr><td colspan="3" class="pers-cat-row">${cat}</td></tr>`;inds.forEach(ind=>{let v1=p[`${ind.id}_S1`]||"-",v2=p[`${ind.id}_S2`]||"-";trs+=`<tr><td style="text-align:left;padding-left:15px;">${ind.text}</td><td class="pers-val-col">${v1}</td><td class="pers-val-col">${v2}</td></tr>`})} 
        return `<div class="informe-page">${getPrintHeader("INFORME DE DESARROLLO PERSONAL Y SOCIAL")}<div class="inf-data-grid" style="grid-template-columns:2fr 1fr 1fr;"><div><b>ALUMNO:</b> ${alu.nombre_completo}</div><div><b>RUT:</b> ${alu.rut}</div><div><b>CURSO:</b> ${CURSO.data.nombre}</div></div><table class="pers-table"><thead><tr><th>INDICADORES DE EVALUACI√ìN</th><th>1¬∫ SEM</th><th>2¬∫ SEM</th></tr></thead><tbody>${trs}</tbody></table><div style="font-size:10px;margin-top:5px;font-style:italic;">Conceptos: DE: Desarrollo Excelente | DA: Desarrollo Adecuado | PS: Puede Superarse | NR: No Registra</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;"><div><div class="box-title">OBSERVACIONES 1¬∫ SEMESTRE</div><div class="box-content" style="height:60px;font-style:italic;">${p['obs_s1']||"Sin observaciones."}</div></div><div><div class="box-title">OBSERVACIONES 2¬∫ SEMESTRE</div><div class="box-content" style="height:60px;font-style:italic;">${p['obs_s2']||"Sin observaciones."}</div></div></div><div class="inf-footer-dual"><div class="inf-firma-box"><div class="inf-firma-line">Firma Profesor(a) Jefe</div></div><div class="inf-firma-box"><div class="inf-firma-line">Alejandra Morales G.<br><span class="inf-firma-sub">Unidad T√©cnico Pedag√≥gica</span></div></div></div></div>`; }
        function printInformes(mode, rut=null) { let targets=mode==='all'?CURSO.alumnos:[CURSO.alumnos.find(a=>a.rut===rut)], fullHTML="", charts=[]; targets.forEach(alu=>{if(!alu)return; let d=generateNotasHTML(alu); fullHTML+=d.html; charts.push(d.chartData); fullHTML+=generatePersonalidadHTML(alu); }); document.getElementById("printArea").innerHTML=fullHTML; charts.forEach(c=>{let ctx=document.getElementById(c.id); if(ctx){new Chart(ctx,{type:'bar',data:{labels:['Alumno','Curso'],datasets:[{label:'Promedio',data:c.data,backgroundColor:['#004a99','#ccc']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{min:2,max:7}},animation:false}})}}); setTimeout(()=>window.print(),800); }
        
        function printFullReport(rut){printInformes('one',rut)}
        function printAllInformes(){printInformes('all')} 
        function printOnlyPersonalidad(rut){let alu=CURSO.alumnos.find(a=>a.rut===rut); document.getElementById("printArea").innerHTML=generatePersonalidadHTML(alu); setTimeout(()=>window.print(),500)}

        function renderListaInformes(){
            if(!CURSO.alumnos) return;
            let h="";
            CURSO.alumnos.forEach(alu => {
                h += `<div class="curso-item" style="text-align:left; display:flex; justify-content:space-between; align-items:center; padding:10px;"><span>${alu.nombre_completo}</span><button class="btn btn-blue" onclick="printFullReport('${alu.rut}')">üñ®Ô∏è Imprimir</button></div>`;
            });
            document.getElementById("listaAlumnos").innerHTML=h;
        }

        // --- GESTI√ìN MATR√çCULA Y DATOS ---

        function renderMatricula() {
            let h = `<table class="sge-table"><thead><tr><th>Foto</th><th>N¬∞</th><th>RUT</th><th>Nombre Completo</th><th>F. Matr√≠cula</th><th>F. Retiro</th><th>Tel. Apo</th><th>Tel. Alu</th><th>Acciones</th></tr></thead><tbody>`;
            CURSO.alumnos.forEach((alu, idx) => {
                let fotoHtml = alu.foto_url ? `<img src="${alu.foto_url}" class="alu-thumb" onclick="window.open('${alu.foto_url}')" style="cursor:pointer">` : `<div class="alu-thumb" style="background:#eee;"></div>`;
                let isRet = !!alu.fecha_retiro;
                let rowClass = isRet ? 'tr-retiro' : '';
                
                h += `<tr class="${rowClass}">
                    <td>${fotoHtml}</td>
                    <td>${alu.numero_lista || (idx + 1)}</td>
                    <td>${alu.rut}</td>
                    <td style="text-align:left;">
                        ${alu.nombre_completo}
                        ${isRet ? '<span style="color:red;font-weight:bold;font-size:10px;margin-left:5px;">(RETIRADO)</span>' : ''}
                    </td>
                    <td>${alu.fecha_matricula || '-'}</td>
                    <td>${alu.fecha_retiro || '-'}</td>
                    <td>${alu.telefono_apoderado || '-'}</td>
                    <td>${alu.telefono_alumno || '-'}</td>
                    <td>
                        <button class="btn-icon" onclick="openStudentModal('${alu.rut}')">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteStudent('${alu.rut}')" style="color:red;">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            document.getElementById("wrapMatricula").innerHTML = h + "</tbody></table>";
        }

        function openStudentModal(rut = null) {
            const modal = document.getElementById("modalAlumno");
            const title = document.getElementById("modalAluTitle");
            document.getElementById("inAluId").value = "";
            document.getElementById("inAluRut").value = "";
            document.getElementById("inAluRut").disabled = false;
            document.getElementById("inAluNum").value = CURSO.alumnos.length + 1;
            document.getElementById("inAluSexo").value = "";
            document.getElementById("inAluNombreLegal").value = "";
            document.getElementById("inAluNombreSocial").value = "";
            document.getElementById("inAluFoto").value = "";
            document.getElementById("inAluFechaMat").value = "";
            document.getElementById("inAluFechaRet").value = "";
            document.getElementById("inAluDir").value = "";
            document.getElementById("inAluApo").value = "";
            document.getElementById("inAluTelApo").value = "";
            document.getElementById("inAluTelAlu").value = "";
            document.getElementById("inAluNEE").value = "";
            document.getElementById("inAluSalud").value = "";
            document.getElementById("inAluJudicial").value = "";

            if (rut) {
                const alu = CURSO.alumnos.find(a => a.rut === rut);
                if (alu) {
                    title.innerText = "Editar Alumno";
                    document.getElementById("inAluId").value = rut; 
                    document.getElementById("inAluRut").value = alu.rut;
                    document.getElementById("inAluRut").disabled = true; 
                    document.getElementById("inAluNum").value = alu.numero_lista || "";
                    document.getElementById("inAluSexo").value = alu.sexo_registral || "";
                    document.getElementById("inAluNombreLegal").value = alu.nombre_legal || alu.nombre_completo || "";
                    document.getElementById("inAluNombreSocial").value = alu.nombre_social || "";
                    document.getElementById("inAluFoto").value = alu.foto_url || "";
                    document.getElementById("inAluFechaMat").value = alu.fecha_matricula || "";
                    document.getElementById("inAluFechaRet").value = alu.fecha_retiro || "";
                    document.getElementById("inAluDir").value = alu.direccion || "";
                    document.getElementById("inAluApo").value = alu.nombre_apoderado || "";
                    document.getElementById("inAluTelApo").value = alu.telefono_apoderado || "";
                    document.getElementById("inAluTelAlu").value = alu.telefono_alumno || "";
                    document.getElementById("inAluNEE").value = alu.nee || "";
                    document.getElementById("inAluSalud").value = alu.salud || "";
                    document.getElementById("inAluJudicial").value = alu.judicial || "";
                }
            } else { title.innerText = "Nuevo Alumno"; }
            modal.style.display = "flex";
        }

        async function saveStudent() {
            const rut = document.getElementById("inAluRut").value.trim();
            const legal = document.getElementById("inAluNombreLegal").value.trim();
            const social = document.getElementById("inAluNombreSocial").value.trim();
            const nombreDisplay = social ? social : legal;
            if (!rut || !legal) return alert("RUT y Nombre Legal son obligatorios");
            const loader = document.getElementById("loader");
            loader.style.display = "flex"; document.getElementById("loaderText").innerText = "Guardando Ficha...";
            try {
                const data = { rut: rut, nombre_completo: nombreDisplay, nombre_legal: legal, nombre_social: social, sexo_registral: document.getElementById("inAluSexo").value, numero_lista: parseInt(document.getElementById("inAluNum").value), foto_url: document.getElementById("inAluFoto").value.trim(), fecha_matricula: document.getElementById("inAluFechaMat").value, fecha_retiro: document.getElementById("inAluFechaRet").value, direccion: document.getElementById("inAluDir").value.trim(), nombre_apoderado: document.getElementById("inAluApo").value.trim(), telefono_apoderado: document.getElementById("inAluTelApo").value.trim(), telefono_alumno: document.getElementById("inAluTelAlu").value.trim(), nee: document.getElementById("inAluNEE").value.trim(), salud: document.getElementById("inAluSalud").value.trim(), judicial: document.getElementById("inAluJudicial").value.trim() };
                await db.collection("cursos").doc(CURSO.id).collection("alumnos").doc(rut).set(data, { merge: true });
                document.getElementById("modalAlumno").style.display = "none";
                await load(CURSO.id); ver('matricula'); 
            } catch (e) { alert("Error al guardar: " + e.message); } finally { loader.style.display = "none"; }
        }

        async function deleteStudent(rut) {
            if (!confirm("¬øEST√Å SEGURO? Eliminar al alumno borrar√° permanentemente sus notas y asistencia. Esta acci√≥n no se puede deshacer.")) return;
            const loader = document.getElementById("loader"); loader.style.display = "flex"; document.getElementById("loaderText").innerText = "Eliminando...";
            try { await db.collection("cursos").doc(CURSO.id).collection("alumnos").doc(rut).delete(); await load(CURSO.id); ver('matricula'); } catch (e) { alert("Error al eliminar: " + e.message); } finally { loader.style.display = "none"; }
        }

        async function saveCursoConfig() { const profe = document.getElementById("inProfesorJefe").value.trim(); try { await db.collection("cursos").doc(CURSO.id).update({ profesor_jefe: profe }); CURSO.data.profesor_jefe = profe; alert("Configuraci√≥n del curso guardada."); } catch (e) { alert("Error: " + e.message); } }
        function openAsigManager() { if (!CURSO || !CURSO.asignaturas) return alert("Primero carga un curso."); let html = ""; CURSO.asignaturas.forEach(asig => { html += `<tr><td style="font-size:10px; color:#666;">${asig.id}</td><td style="font-weight:bold;">${asig.nombre}</td><td><button class="btn btn-red btn-sm" onclick="deleteAsignatura('${asig.id}')">üóëÔ∏è Eliminar</button></td></tr>`; }); document.getElementById("bodyAsigManager").innerHTML = html; document.getElementById("modalAsigManager").style.display = "flex"; }
        async function deleteAsignatura(id) { if(!confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nVas a eliminar la asignatura con ID: " + id + ".\nEsta acci√≥n es irreversible.")) return; const loader = document.getElementById("loader"); loader.style.display = "flex"; document.getElementById("loaderText").innerText = "Eliminando Asignatura..."; try { await db.collection("cursos").doc(CURSO.id).collection("asignaturas").doc(id).delete(); alert("Asignatura eliminada correctamente."); document.getElementById("modalAsigManager").style.display = "none"; await load(CURSO.id); } catch (e) { console.error(e); alert("Error al eliminar: " + e.message); } finally { loader.style.display = "none"; } }

        /* --- NUEVAS FUNCIONALIDADES: MANTENEDOR UTP --- */
        
        function addYearOption() {
            const y = document.getElementById("inNewYear").value;
            if(!y || y.length !== 4) return alert("Ingrese un a√±o v√°lido de 4 d√≠gitos");
            const sel = document.getElementById("selAno");
            // Check if exists
            for(let i=0; i<sel.options.length; i++) { if(sel.options[i].value == y) return alert("El a√±o ya existe en la lista."); }
            const opt = document.createElement("option");
            opt.value = y; opt.text = y;
            sel.add(opt, 0); // Add to top
            sel.value = y;
            alert("A√±o " + y + " agregado temporalmente. Cree un curso con este a√±o para guardarlo.");
            init(); // Refresh to show empty grid for new year
        }

        async function createNewCurso() {
            const nom = document.getElementById("inNewCursoNombre").value.trim();
            const profe = document.getElementById("inNewCursoProfe").value.trim();
            if(!nom) return alert("El nombre del curso es obligatorio.");
            if(!confirm("Crear curso: " + nom + "?")) return;
            
            document.getElementById("loader").style.display = "flex";
            try {
                // Crear documento de curso
                await db.collection("cursos").add({
                    nombre: nom,
                    profesor_jefe: profe
                });
                alert("Curso creado exitosamente. Actualizando UTP...");
                document.getElementById("inNewCursoNombre").value = "";
                loadUTPData(); // Recargar selectores y datos
            } catch(e) {
                alert("Error creando curso: " + e.message);
            } finally {
                document.getElementById("loader").style.display = "none";
            }
        }

        async function addNewSubject() {
            const idx = document.getElementById("selMantCursoAsig").value;
            const id = document.getElementById("inNewAsigID").value.trim();
            const nom = document.getElementById("inNewAsigNombre").value.trim();
            
            if(idx === "" || !id || !nom) return alert("Complete todos los campos.");
            const cursoId = UTP_DATA[idx].id;

            document.getElementById("loader").style.display = "flex";
            try {
                // Check dupes manually in UTP_DATA first to save a read
                if(UTP_DATA[idx].asignaturas.some(a => a.id === id)) throw new Error("ID de asignatura ya existe en este curso.");
                
                // --- CORRECCI√ìN CLAVE: Agregamos el campo 'id' dentro del documento ---
                await db.collection("cursos").doc(cursoId).collection("asignaturas").doc(id).set({
                    id: id,
                    nombre: nom.toUpperCase(),
                    profesor: ""
                });
                // ----------------------------------------------------------------------

                alert("Asignatura agregada correctamente.");
                document.getElementById("inNewAsigID").value = "";
                document.getElementById("inNewAsigNombre").value = "";
                loadUTPData();
            } catch(e) {
                alert("Error: " + e.message);
            } finally {
                document.getElementById("loader").style.display = "none";
            }
        }

        async function batchStudents() {
            const idx = document.getElementById("selMantCursoNomina").value;
            const text = document.getElementById("txtNominaMasiva").value.trim();
            
            if(idx === "" || !text) return alert("Seleccione curso y pegue la n√≥mina.");
            const cursoId = UTP_DATA[idx].id;
            
            const lines = text.split(/\r?\n/);
            if(lines.length === 0) return;

            if(!confirm(`Se cargar√°n ${lines.length} alumnos al curso ${UTP_DATA[idx].nombre}. ¬øContinuar?`)) return;

            document.getElementById("loader").style.display = "flex";
            document.getElementById("loaderText").innerText = "Procesando N√≥mina...";

            const batch = db.batch();
            let count = 0;
            // Get current max num lista approximately
            let currentMax = UTP_DATA[idx].alumnos.length;

            try {
                lines.forEach((line) => {
                    const parts = line.split(";");
                    if(parts.length >= 2) {
                        const rut = parts[0].trim();
                        const nombre = parts[1].trim();
                        if(rut && nombre) {
                            currentMax++;
                            const docRef = db.collection("cursos").doc(cursoId).collection("alumnos").doc(rut);
                            batch.set(docRef, {
                                rut: rut,
                                nombre_completo: nombre,
                                numero_lista: currentMax
                            }, { merge: true }); // Merge prevents overwriting existing detailed data if re-uploaded
                            count++;
                        }
                    }
                });

                await batch.commit();
                alert(`Proceso finalizado. ${count} alumnos procesados.`);
                document.getElementById("txtNominaMasiva").value = "";
                loadUTPData();
            } catch(e) {
                alert("Error en carga masiva: " + e.message);
            } finally {
                document.getElementById("loader").style.display = "none";
            }
        }

        init();
    </script>
</body>
</html>