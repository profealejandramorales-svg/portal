<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Horario 2026 - Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Inputs */
        .time-input {
            border: 1px solid #cbd5e1; border-radius: 6px; padding: 4px; 
            font-size: 0.9rem; text-align: center; width: 100%; transition: all 0.2s;
        }
        .time-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        /* Input deshabilitado (Viernes) */
        .time-input:disabled { 
            background-color: #f1f5f9; 
            color: transparent; 
            border-color: #e2e8f0;
            cursor: default;
        }

        .schedule-table th { text-align: center; font-size: 0.75rem; text-transform: uppercase; color: #64748b; padding-bottom: 8px; }
        .schedule-table td { padding: 4px; vertical-align: middle; }
        
        .teacher-item { cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
        .teacher-item:hover { background-color: #f1f5f9; }
        .teacher-item.active { background-color: #eff6ff; border-left-color: #2563eb; }

        /* IMPRESIÓN */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                position: absolute; left: 0; top: 0; width: 100%; height: 100%;
                background: white; padding: 40px; display: block !important; 
            }
            .no-print { display: none !important; }
            @page { size: letter; margin: 1.5cm; }

            .doc-container { font-family: Arial, sans-serif; line-height: 1.4; color: black; }
            .doc-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid black; padding-bottom: 15px; margin-bottom: 30px; }
            .doc-title { font-size: 16pt; font-weight: bold; text-transform: uppercase; text-align: center; margin-bottom: 5px; }
            .doc-subtitle { text-align: center; font-size: 11pt; margin-bottom: 25px; }
            
            .doc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9; -webkit-print-color-adjust: exact; }
            
            .doc-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .doc-table th { background-color: #eee !important; border: 1px solid black; padding: 8px; font-size: 10pt; -webkit-print-color-adjust: exact; }
            .doc-table td { border: 1px solid black; padding: 8px; text-align: center; font-size: 11pt; }
            
            .signatures { display: flex; justify-content: space-between; margin-top: 80px; }
            .sign-box { width: 40%; border-top: 1px solid black; text-align: center; padding-top: 5px; font-weight: bold; }
            
            .colacion-msg { font-size: 9pt; font-style: italic; margin-top: 5px; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 text-white shadow-md z-10 shrink-0">
        <div class="px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="logo.jpg" class="h-8 bg-white rounded p-0.5">
                <div>
                    <h1 class="font-bold text-lg">Horario Administrativo</h1>
                    <p class="text-[10px] text-gray-400">Desarrollado por ProfeAle</p>
                </div>
            </div>
            <div id="connection-status" class="text-xs bg-yellow-500 text-black px-2 py-1 rounded font-bold">Conectando...</div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-1/4 bg-white border-r border-gray-200 flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <h2 class="text-xs font-bold text-gray-500 uppercase">Seleccionar Docente</h2>
                <input type="text" id="search-input" onkeyup="filterTeachers()" placeholder="Buscar..." class="mt-2 w-full text-sm p-2 border rounded">
            </div>
            <div id="teacher-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <div class="text-center text-gray-400 text-xs py-4">Cargando...</div>
            </div>
        </div>

        <div class="flex-1 bg-slate-50 p-8 overflow-y-auto flex flex-col items-center">
            
            <div id="editor-panel" class="w-full max-w-4xl bg-white rounded-xl shadow-lg border border-gray-200 hidden">
                
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white rounded-t-xl">
                    <div>
                        <h2 id="lbl-nombre" class="text-xl font-bold text-slate-800">DOCENTE</h2>
                        <p id="lbl-rut" class="text-sm text-slate-500">---</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-gray-400 uppercase">Contrato</div>
                        <div id="lbl-contrato" class="text-2xl font-bold text-blue-600">0</div>
                    </div>
                </div>

                <div id="legal-notice" class="bg-blue-50 px-6 py-2 text-xs text-blue-800 border-b border-blue-100 flex items-center gap-2">
                    <i class="fas fa-info-circle"></i>
                    <span id="legal-text">Calculando normativa...</span>
                </div>

                <div class="p-6">
                    <table class="w-full schedule-table">
                        <thead>
                            <tr>
                                <th class="w-24">Día</th>
                                <th>Entrada</th>
                                <th class="text-orange-500">Inicio Colación</th>
                                <th class="text-orange-500">Fin Colación</th>
                                <th>Salida</th>
                                <th class="w-24">Total Día</th>
                                <th class="w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body"></tbody>
                    </table>
                </div>

                <div class="px-6 py-4 bg-slate-50 border-t border-gray-200 rounded-b-xl flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="text-xs font-bold text-gray-500 uppercase">Total Semanal</div>
                            <div id="lbl-total-prog" class="text-xl font-bold text-gray-800">00:00</div>
                        </div>
                        <div id="balance-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-200 text-gray-500">Pendiente</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveSchedule()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow transition"><i class="fas fa-save mr-2"></i> Guardar</button>
                        <button onclick="printSchedule()" class="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-lg font-bold shadow transition"><i class="fas fa-print mr-2"></i> Imprimir</button>
                    </div>
                </div>
            </div>

            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400">
                <i class="fas fa-user-clock text-6xl mb-4 text-gray-200"></i>
                <p>Seleccione un docente.</p>
            </div>

        </div>
    </div>

    <div id="print-area" class="hidden">
        <div class="doc-container">
            <div class="doc-header">
                <img src="logo.jpg" style="height:70px;">
                <div style="text-align:right;">
                    <h1 style="margin:0; font-size:12pt; font-weight:bold;">ESCUELA AGRÍCOLA SAGRADOS CORAZONES</h1>
                    <p style="margin:0; font-size:10pt;">Administración</p>
                </div>
            </div>

            <div class="doc-title">DECLARACIÓN DE HORARIO DE TRABAJO</div>
            <div class="doc-subtitle">AÑO ESCOLAR 2026</div>

            <div class="doc-grid">
                <div><strong>NOMBRE:</strong> <span id="p-nombre"></span></div>
                <div><strong>RUT:</strong> <span id="p-rut"></span></div>
                <div><strong>FUNCIÓN:</strong> <span id="p-cargo"></span></div>
                <div><strong>HORAS CONTRATO:</strong> <span id="p-contrato"></span> Horas Cronológicas</div>
            </div>

            <p style="text-align:justify; margin-bottom:20px; font-size:10pt;">
                Las partes acuerdan que la jornada de trabajo semanal será distribuida de la siguiente manera:
            </p>

            <table class="doc-table">
                <thead>
                    <tr>
                        <th>DÍA</th>
                        <th>ENTRADA</th>
                        <th>INICIO COLACIÓN</th>
                        <th>FIN COLACIÓN</th>
                        <th>SALIDA</th>
                        <th>TOTAL HRS</th>
                    </tr>
                </thead>
                <tbody id="p-table-body"></tbody>
                <tfoot>
                    <tr style="background-color:#f0f0f0;">
                        <td colspan="5" style="text-align:right; font-weight:bold;">TOTAL SEMANAL:</td>
                        <td style="font-weight:bold;"><span id="p-total"></span></td>
                    </tr>
                </tfoot>
            </table>

            <div id="p-legal-note" class="colacion-msg" style="margin-top:20px;"></div>

            <div class="signatures">
                <div class="sign-box">Firma Trabajador</div>
                <div class="sign-box">Firma Empleador</div>
            </div>
            
            <div style="text-align:center; font-size:8pt; margin-top:30px; color:#aaa;">
                Generado el <span id="p-fecha"></span> • Desarrollado por ProfeAle
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBnSMVCH0yyYUWk5z54kTIPTrWkyoeWs-I", authDomain: "suspenciones-40d0c.firebaseapp.com", projectId: "suspenciones-40d0c", storageBucket: "suspenciones-40d0c.firebasestorage.app", messagingSenderId: "853418739042", appId: "1:853418739042:web:d051befb99cd2acdd4583b", measurementId: "G-L00J7XN6Y1" };

        let db, TEACHERS = [], CURRENT_TEACHER = null;
        const DAYS = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];

        window.onload = function() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                document.getElementById('connection-status').innerText = "Conectado ✅";
                document.getElementById('connection-status').className = "text-xs bg-green-500 text-white px-2 py-1 rounded font-bold";
                loadTeachers();
            } catch (e) { console.error(e); }
        };

        async function loadTeachers() {
            TEACHERS = [];
            const snap = await db.collection("dotacion_2026").get();
            snap.forEach(doc => TEACHERS.push({ id: doc.id, ...doc.data() }));
            TEACHERS.sort((a,b) => a.nombre.localeCompare(b.nombre));
            renderList();
        }

        function renderList(filter = "") {
            const list = document.getElementById('teacher-list');
            list.innerHTML = "";
            TEACHERS.filter(t => t.nombre.includes(filter.toUpperCase())).forEach(t => {
                const div = document.createElement('div');
                div.className = "teacher-item p-3 border-b border-gray-100";
                div.onclick = () => selectTeacher(t);
                div.innerHTML = `<div class="font-bold text-xs text-slate-700">${t.nombre}</div><div class="flex justify-between mt-1"><span class="text-[10px] text-gray-400">${t.rut||'S/RUT'}</span><span class="text-[10px] font-bold text-blue-600">${t.contrato} hrs</span></div>`;
                list.appendChild(div);
            });
        }

        function filterTeachers() { renderList(document.getElementById('search-input').value); }

        function selectTeacher(t) {
            CURRENT_TEACHER = t;
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('editor-panel').classList.remove('hidden');
            
            document.getElementById('lbl-nombre').innerText = t.nombre;
            document.getElementById('lbl-rut').innerText = t.rut || '';
            document.getElementById('lbl-contrato').innerText = t.contrato;

            // Determinar Regla 42 Horas
            const contrato = parseFloat(t.contrato);
            const is42Plus = contrato >= 42;
            const legalText = document.getElementById('legal-text');
            
            if(is42Plus) {
                legalText.innerHTML = "<strong>Normativa 42+ Horas:</strong> Colación (30 min) imputada. <br>Cálculo = (Salida - Entrada) Directo.";
                document.getElementById('legal-notice').className = "bg-green-50 px-6 py-2 text-xs text-green-800 border-b border-green-100 flex items-center gap-2";
            } else {
                legalText.innerHTML = "<strong>Normativa Estándar:</strong> Colación descontada. <br>Cálculo = (Salida - Entrada) - Colación.";
                document.getElementById('legal-notice').className = "bg-orange-50 px-6 py-2 text-xs text-orange-800 border-b border-orange-100 flex items-center gap-2";
            }

            let schedule = t.horario || {};
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = "";

            DAYS.forEach(day => {
                const dayData = schedule[day] || { in: '', l_in: '', l_out: '', out: '' };
                const isFriday = day === 'Viernes';
                const lunchDisabled = isFriday ? 'disabled' : '';
                
                const row = document.createElement('tr');
                row.className = "border-b border-gray-100";
                row.innerHTML = `
                    <td class="font-bold text-slate-600">${day}</td>
                    <td><input type="time" class="time-input inp-in" data-day="${day}" value="${dayData.in}" onchange="calc()"></td>
                    <td><input type="time" class="time-input inp-lin" data-day="${day}" value="${isFriday ? '' : dayData.l_in}" onchange="calc()" ${lunchDisabled}></td>
                    <td><input type="time" class="time-input inp-lout" data-day="${day}" value="${isFriday ? '' : dayData.l_out}" onchange="calc()" ${lunchDisabled}></td>
                    <td><input type="time" class="time-input inp-out" data-day="${day}" value="${dayData.out}" onchange="calc()"></td>
                    <td class="text-center font-bold text-slate-700 total-day" id="total-${day}">00:00</td>
                    <td class="text-center"><button onclick="clearRow(this)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(row);
            });
            calc();
        }

        function calc() {
            let totalWeeklyMinutes = 0;
            const contrato = parseFloat(CURRENT_TEACHER.contrato);
            const is42Plus = contrato >= 42;

            DAYS.forEach(day => {
                const isFriday = day === 'Viernes';
                const row = document.querySelector(`input[data-day="${day}"]`).closest('tr');
                const tIn = row.querySelector('.inp-in').value;
                const tOut = row.querySelector('.inp-out').value;
                
                // Lógica de Colación
                const tLIn = isFriday ? null : row.querySelector('.inp-lin').value;
                const tLOut = isFriday ? null : row.querySelector('.inp-lout').value;

                let dayMinutes = 0;

                if (tIn && tOut) {
                    let mIn = timeToMin(tIn);
                    let mOut = timeToMin(tOut);
                    let jornadaBruta = mOut - mIn;

                    if (isFriday) {
                        // VIERNES: Siempre es Salida - Entrada
                        dayMinutes = jornadaBruta;
                    } else {
                        // LUNES A JUEVES
                        if (is42Plus) {
                            // 42+ Horas: Colación incluida en pago -> No se descuenta
                            dayMinutes = jornadaBruta;
                        } else {
                            // Menos 42 Horas: Colación se descuenta
                            if (tLIn && tLOut) {
                                let mLIn = timeToMin(tLIn);
                                let mLOut = timeToMin(tLOut);
                                let lunch = mLOut - mLIn;
                                dayMinutes = jornadaBruta - lunch;
                            } else {
                                // Si no marcan colación, asumimos jornada completa
                                dayMinutes = jornadaBruta;
                            }
                        }
                    }
                    dayMinutes = Math.max(0, dayMinutes);
                }

                document.getElementById(`total-${day}`).innerText = minToTime(dayMinutes);
                totalWeeklyMinutes += dayMinutes;
            });

            const totalHours = totalWeeklyMinutes / 60;
            const diff = totalHours - contrato;

            document.getElementById('lbl-total-prog').innerText = totalHours.toFixed(2) + " hrs";
            
            const badge = document.getElementById('balance-badge');
            if (Math.abs(diff) < 0.05) {
                badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200";
                badge.innerText = "CUADRA EXACTO ✅";
            } else if (diff < 0) {
                badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 border border-red-200";
                badge.innerText = `FALTAN ${Math.abs(diff).toFixed(2)} HRS`;
            } else {
                badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 border border-orange-200";
                badge.innerText = `SOBRAN ${diff.toFixed(2)} HRS`;
            }
        }

        async function saveSchedule() {
            if(!CURRENT_TEACHER) return;
            const scheduleData = {};
            DAYS.forEach(day => {
                const row = document.querySelector(`input[data-day="${day}"]`).closest('tr');
                scheduleData[day] = {
                    in: row.querySelector('.inp-in').value,
                    l_in: row.querySelector('.inp-lin').value,
                    l_out: row.querySelector('.inp-lout').value,
                    out: row.querySelector('.inp-out').value
                };
            });
            try {
                await db.collection("dotacion_2026").doc(CURRENT_TEACHER.id).update({ horario: scheduleData });
                CURRENT_TEACHER.horario = scheduleData; 
                Swal.fire('Guardado', '', 'success');
            } catch (e) { Swal.fire('Error', '', 'error'); }
        }

        function printSchedule() {
            if(!CURRENT_TEACHER) return;
            calc();

            const contrato = parseFloat(CURRENT_TEACHER.contrato);
            const is42Plus = contrato >= 42;

            document.getElementById('p-nombre').innerText = CURRENT_TEACHER.nombre;
            document.getElementById('p-rut').innerText = CURRENT_TEACHER.rut;
            document.getElementById('p-cargo').innerText = CURRENT_TEACHER.asignatura;
            document.getElementById('p-contrato').innerText = CURRENT_TEACHER.contrato;
            document.getElementById('p-fecha').innerText = new Date().toLocaleDateString();
            document.getElementById('p-total').innerText = document.getElementById('lbl-total-prog').innerText + " hrs";

            const legalNote = document.getElementById('p-legal-note');
            if(is42Plus) {
                legalNote.innerHTML = "* El docente cumple con una jornada de 42 horas o más, por lo que el tiempo de colación (30 min diarios) se considera dentro de la jornada laboral imputable.";
            } else {
                legalNote.innerHTML = "* El tiempo destinado a colación no se considera parte de la jornada laboral efectiva y ha sido descontado del total.";
            }

            const tbody = document.getElementById('p-table-body');
            tbody.innerHTML = "";

            DAYS.forEach(day => {
                const rowData = document.querySelector(`input[data-day="${day}"]`).closest('tr');
                const tIn = rowData.querySelector('.inp-in').value || '-';
                const tLIn = day === 'Viernes' ? '-' : (rowData.querySelector('.inp-lin').value || '-');
                const tLOut = day === 'Viernes' ? '-' : (rowData.querySelector('.inp-lout').value || '-');
                const tOut = rowData.querySelector('.inp-out').value || '-';
                const total = document.getElementById(`total-${day}`).innerText;

                if (tIn !== '-') {
                    tbody.innerHTML += `<tr><td><strong>${day}</strong></td><td>${tIn}</td><td>${tLIn}</td><td>${tLOut}</td><td>${tOut}</td><td><strong>${total}</strong></td></tr>`;
                }
            });
            window.print();
        }

        function clearRow(btn) {
            const row = btn.closest('tr');
            row.querySelectorAll('input').forEach(i => i.value = '');
            calc();
        }

        function timeToMin(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }
        function minToTime(min) { const h = Math.floor(min / 60); const m = min % 60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
    </script>
</body>
</html>