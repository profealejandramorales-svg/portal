<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Permiso de salida - Escuela Agrícola Sagrados Corazones</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7fafc;
    }
    @media print {
      body > * {
        visibility: hidden;
      }
      #voucher-container {
        visibility: visible;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      .no-print {
        display: none !important;
      }
    }
  </style>
</head>
<body class="p-6">

  <div id="app" class="max-w-3xl mx-auto bg-white rounded-2xl shadow-2xl p-8 border border-gray-200">
    <header class="text-center mb-6 border-b-2 border-[#166534] pb-3">
      <h1 class="text-3xl font-extrabold text-[#166534]">Permiso de Salida</h1>
      <p class="text-gray-600 text-lg">Escuela Agrícola Sagrados Corazones - Villa Alegre</p>
    </header>

    <section class="space-y-4">
      <label class="block text-gray-700 font-semibold">Nombre del estudiante:</label>
      <input id="student-name" type="text" placeholder="Ej: Juan Pérez"
        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-[#166534] focus:ring focus:ring-green-200 outline-none"/>

      <label class="block text-gray-700 font-semibold">Motivo del permiso:</label>
      <textarea id="reason" placeholder="Escribe el motivo del permiso..." rows="3"
        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-[#166534] focus:ring focus:ring-green-200 outline-none"></textarea>

      <label class="block text-gray-700 font-semibold">Hora de salida:</label>
      <input id="exit-time" type="time"
        class="w-1/2 p-3 border-2 border-gray-300 rounded-lg focus:border-[#166534] focus:ring focus:ring-green-200 outline-none"/>

      <div class="text-center mt-6">
        <button id="generate" class="bg-[#166534] text-white px-8 py-3 rounded-full font-bold hover:bg-green-800 transition">Generar Permiso</button>
      </div>
    </section>

    <div id="voucher-container" class="mt-10 hidden">
      <!-- Se genera dinámicamente -->
    </div>
  </div>

  <script>
    const greenColor = "#166534";

    // Recuperar o inicializar folio
    function getFolio() {
      const today = new Date();
      const storedData = JSON.parse(localStorage.getItem("folioData")) || {};
      const year = today.getFullYear();
      const month = today.getMonth();
      const day = today.getDate();

      // Reinicio automático el 31 de diciembre
      if (month === 11 && day === 31) {
        storedData.counter = 0;
        localStorage.setItem("folioData", JSON.stringify(storedData));
      }

      storedData.counter = (storedData.counter || 0) + 1;
      localStorage.setItem("folioData", JSON.stringify(storedData));
      return storedData.counter;
    }

    // Generar fecha y hora legible
    function formatDateTime() {
      const now = new Date();
      const options = { day: "numeric", month: "long", year: "numeric" };
      const fecha = now.toLocaleDateString("es-CL", options);
      const hora = now.toLocaleTimeString("es-CL", { hour: "2-digit", minute: "2-digit" });
      return `${fecha} a las ${hora}`;
    }

    // Generar el comprobante
    document.getElementById("generate").addEventListener("click", () => {
      const name = document.getElementById("student-name").value.trim();
      const reason = document.getElementById("reason").value.trim();
      const exitTime = document.getElementById("exit-time").value;
      const container = document.getElementById("voucher-container");

      if (!name || !reason || !exitTime) {
        alert("Por favor, completa todos los campos antes de generar el permiso.");
        return;
      }

      const folio = getFolio();
      const fecha = formatDateTime();

      const voucherHTML = `
        <div class="space-y-8">
          ${createVoucher(name, reason, exitTime, folio, fecha)}
          <hr class="border-t-4 border-dotted my-6 border-[${greenColor}]" />
          ${createVoucher(name, reason, exitTime, folio, fecha)}
          <p class="text-center mt-10 font-semibold text-[${greenColor}]">Desarrollado por ProfeAle</p>
        </div>
      `;

      container.innerHTML = voucherHTML;
      container.classList.remove("hidden");
      container.scrollIntoView({ behavior: "smooth" });
      window.print();
    });

    // Plantilla de comprobante
    function createVoucher(name, reason, exitTime, folio, fecha) {
      return `
        <div class="border-2 border-gray-300 rounded-xl p-6">
          <div class="flex justify-between mb-2">
            <span class="text-sm text-gray-600">Escuela Agrícola Sagrados Corazones</span>
            <span class="font-bold text-[${greenColor}]">Folio N° ${folio}</span>
          </div>
          <p class="text-sm text-gray-600 mb-4">Emitido el ${fecha}</p>
          <p><strong>Estudiante:</strong> ${name}</p>
          <p><strong>Motivo:</strong> ${reason}</p>
          <p><strong>Hora de salida:</strong> ${exitTime}</p>
          <div class="flex justify-between mt-10">
            <div class="text-center">
              <div class="border-t border-gray-500 w-40 mx-auto"></div>
              <p class="text-sm mt-1">Firma Apoderado</p>
            </div>
            <div class="text-center">
              <div class="border-t border-gray-500 w-40 mx-auto"></div>
              <p class="text-sm mt-1">Firma Inspector</p>
            </div>
          </div>
        </div>
      `;
    }
  </script>
</body>
</html>
