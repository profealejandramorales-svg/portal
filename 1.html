<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema DotaciÃ³n v46 (CorrecciÃ³n Curso 3Â°C)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f1f5f9; }
        .input-block:focus { outline: none; border-color: #2563eb; background-color: #eff6ff; }
        .tab-btn { transition: all 0.2s; border-bottom: 3px solid transparent; }
        .tab-btn.active { border-color: #2563eb; color: #1e40af; background-color: #eff6ff; font-weight: bold; }
        
        .contract-input { background: transparent; border: none; border-bottom: 2px solid #cbd5e1; width: 110px; text-align: right; font-weight: 800; color: #1e40af; }
        .contract-input:focus { border-color: #2563eb; outline: none; }

        .toggle-checkbox:checked { right: 0; border-color: #9333ea; }
        .toggle-checkbox:checked + .toggle-label { background-color: #9333ea; }
        
        /* Estilos Tabla Referencia */
        .ref-table { width: 100%; font-size: 11px; border-collapse: collapse; text-align: center; }
        .ref-table th { background: #334155; color: white; padding: 4px; border: 1px solid #475569; }
        .ref-table td { padding: 3px; border: 1px solid #cbd5e1; }
        .ref-table tr:nth-child(even) { background-color: #f8fafc; }

        /* VOUCHER & PRINT */
        .voucher-box { background: white; padding: 3rem; border: 1px solid #e2e8f0; max-width: 850px; margin: 0 auto; }
        .voucher-header { display: flex; justify-content: space-between; border-bottom: 3px solid #1e293b; padding-bottom: 1rem; margin-bottom: 2rem; }
        .voucher-row { display: flex; justify-content: space-between; padding: 0.6rem 0; border-bottom: 1px dotted #cbd5e1; align-items: center; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            /* MODO IMPRESION VOUCHER */
            body.printing-voucher { overflow: hidden; }
            body.printing-voucher > *:not(#modal-viewer) { display: none !important; }
            body.printing-voucher #modal-viewer { 
                display: flex !important; 
                position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                background: white; z-index: 99999; 
                align-items: flex-start; justify-content: center;
            }
            body.printing-voucher #modal-content { box-shadow: none; border: none; width: 100%; padding: 0; margin: 0; }
            .voucher-box { border: none; padding: 0; width: 100%; margin: 0; }
            @page { size: letter; margin: 1cm; }
        }
    </style>
</head>
<body class="text-slate-800 flex flex-col min-h-screen relative">

    <header class="bg-slate-900 text-white p-4 shadow-lg no-print sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg"><i class="fa-solid fa-graduation-cap text-xl"></i></div>
                <div>
                    <h1 class="text-xl font-bold leading-tight">Sistema de DotaciÃ³n</h1>
                    <p class="text-xs text-indigo-200"><i class="fa-solid fa-code mr-1"></i>Desarrollado por ProfeAle</p>
                </div>
            </div>
            
            <nav class="flex bg-slate-800 rounded-lg p-1">
                <button onclick="switchTab('calculator')" id="tab-calculator" class="tab-btn active px-4 py-2 rounded text-sm text-slate-300 hover:text-white">
                    <i class="fa-solid fa-calculator mr-2"></i>Ficha
                </button>
                <button onclick="switchTab('pie')" id="tab-pie" class="tab-btn px-4 py-2 rounded text-sm text-slate-300 hover:text-white">
                    <i class="fa-solid fa-chart-pie mr-2"></i>Control PIE
                </button>
                <button onclick="switchTab('summary')" id="tab-summary" class="tab-btn px-4 py-2 rounded text-sm text-slate-300 hover:text-white">
                    <i class="fa-solid fa-table-list mr-2"></i>Resumen General
                </button>
            </nav>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-8 max-w-[98%] mx-auto w-full">

        <div id="edit-mode-banner" class="hidden mb-6 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded shadow-sm flex justify-between items-center no-print">
            <div class="flex items-center">
                <div class="bg-yellow-100 p-2 rounded-full mr-3 text-yellow-600"><i class="fa-solid fa-pen"></i></div>
                <div>
                    <p class="font-bold text-yellow-800 text-lg">Modo EdiciÃ³n</p>
                    <p class="text-sm text-yellow-700">Editando a: <span id="editing-name-display" class="font-bold uppercase underline">...</span></p>
                </div>
            </div>
            <button onclick="cancelEdit()" class="text-sm bg-white border border-yellow-300 text-yellow-800 px-4 py-2 rounded hover:bg-yellow-100 font-bold shadow-sm transition">
                <i class="fa-solid fa-xmark mr-1"></i> Cancelar
            </button>
        </div>

        <div id="view-calculator" class="space-y-6">
            <div class="bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden">
                <div class="p-6 border-b-2 border-slate-100 bg-slate-50">
                    <div class="flex flex-col md:flex-row justify-between items-start gap-6">
                        <div class="w-full md:w-1/3">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nombre del Docente</label>
                            <input type="text" id="teacher-name" placeholder="Ej: Renato Rojas" class="text-3xl font-bold text-slate-800 w-full bg-transparent border-b border-transparent hover:border-slate-300 focus:border-blue-500 outline-none transition placeholder-slate-300">
                        </div>
                        <div class="w-full md:w-1/3 flex flex-col items-center bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                            <span class="text-xs font-bold text-slate-400 uppercase mb-2">Rol Funcionario</span>
                            <div class="flex items-center gap-3">
                                <div class="text-right"><span class="block text-xs font-bold text-blue-700">AULA</span><span class="block text-[9px] text-slate-400">PIE = Lectivo</span></div>
                                <div class="relative inline-block w-14 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="role-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" onchange="calculate()">
                                    <label for="role-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                                </div>
                                <div><span class="block text-xs font-bold text-purple-700">PIE</span><span class="block text-[9px] text-slate-400">PIE = No Lec</span></div>
                            </div>
                        </div>
                        <div class="w-full md:w-1/3 text-right">
                            <label class="block text-xs font-bold text-blue-600 uppercase mb-1">Contrato Total</label>
                            <div class="flex justify-end items-baseline gap-2">
                                <input type="number" id="manual-contract" placeholder="Auto" oninput="calculate()" class="contract-input text-5xl" step="0.5">
                                <span class="text-xl text-slate-400 font-bold">hrs</span>
                            </div>
                            <p class="text-xs text-slate-400 mt-1" id="contract-mode-label">Calculadora AutomÃ¡tica</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12">
                    <div class="lg:col-span-8 p-6 border-r border-slate-100">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="font-bold text-slate-700 flex items-center gap-2"><i class="fa-solid fa-list-check text-blue-500"></i> Carga AcadÃ©mica</h2>
                            <div class="text-right flex gap-2">
                                <span class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">1 Blq = 0.75 hrs</span>
                            </div>
                        </div>
                        <div class="overflow-hidden rounded-lg border border-slate-200">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-800 text-white">
                                    <tr>
                                        <th class="p-3 text-left w-1/3">Curso</th>
                                        <th class="p-3 text-center w-1/4">Bloques</th>
                                        <th class="p-3 text-center w-1/4 bg-orange-900">Hrs PIE</th>
                                        <th class="p-3 text-right w-1/6 bg-slate-700">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100" id="course-table-body"></tbody>
                                <tfoot class="bg-blue-50 font-bold border-t-2 border-blue-100">
                                    <tr>
                                        <td class="p-3 text-blue-800">TOTALES</td>
                                        <td class="p-3 text-center text-blue-800 text-lg" id="sum-blocks">0</td>
                                        <td class="p-3 text-center text-orange-700 bg-orange-50" id="sum-pie">0.00</td>
                                        <td class="p-3 text-right text-lg text-blue-800" id="sum-crono">0.00 h</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="lg:col-span-4 bg-slate-50 p-6 flex flex-col justify-between">
                        <div class="mb-4">
                            <h2 class="font-bold text-slate-700 mb-3 text-sm uppercase border-b pb-1">Horas No Lectivas</h2>
                            <div class="space-y-2 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                <div class="flex justify-between items-center text-sm"><label class="font-medium text-slate-600">Jefatura</label><input type="text" id="fixed-jefatura" value="0" oninput="calculate()" class="w-16 text-right font-bold border-b focus:border-blue-500 outline-none bg-transparent"></div>
                                <div class="flex justify-between items-center text-sm"><label class="font-medium text-slate-600">Talleres</label><input type="text" id="fixed-talleres" value="0" oninput="calculate()" class="w-16 text-right font-bold border-b focus:border-blue-500 outline-none bg-transparent"></div>
                                <div class="flex justify-between items-center text-sm"><label class="font-medium text-slate-600">Otras</label><input type="text" id="fixed-otros" value="0" oninput="calculate()" class="w-16 text-right font-bold border-b focus:border-blue-500 outline-none bg-transparent"></div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl border border-slate-300 shadow-sm mb-4" id="breakdown-panel">
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-3 flex justify-between border-b pb-1">
                                <span id="role-status-text">...</span>
                                <span id="usage-percent">0%</span>
                            </h3>
                            <div class="space-y-1 text-sm">
                                <div class="bg-blue-50 p-2 rounded relative">
                                    <div class="flex justify-between font-bold text-blue-800 text-xs uppercase mb-1"><span>1. CARGA LECTIVA</span><span id="res-total-lectivo">0.00 h</span></div>
                                    <div class="pl-2 space-y-1 text-xs text-blue-600">
                                        <div class="flex justify-between"><span>â€¢ Aula (Crono)</span><span id="res-crono-aula">0.00</span></div>
                                        <div class="flex justify-between hidden" id="row-pie-lectivo"><span>â€¢ PIE (Lectivo)</span><span class="font-bold text-orange-600" id="res-pie-lec">0.00</span></div>
                                    </div>
                                    <div id="compliance-badge" class="absolute top-2 right-16 text-[9px] px-1 rounded font-bold">...</div>
                                </div>
                                <div class="flex justify-between items-center bg-gray-100 p-1 rounded text-xs text-gray-500 my-1"><span>(-) Recreos (4m/hr)</span><span class="font-bold" id="res-recreo">0.00 h</span></div>
                                <div class="bg-orange-50 p-2 rounded border border-orange-100">
                                    <div class="flex justify-between font-bold text-orange-800 text-xs uppercase mb-1"><span>2. CARGA NO LECTIVA</span><span id="res-total-nolec">0.00 h</span></div>
                                    <div class="pl-2 space-y-1 text-xs text-orange-700">
                                        <div class="flex justify-between"><span>â€¢ Fijas</span><span id="res-fijas-sum">0.00</span></div>
                                        <div class="flex justify-between hidden" id="row-pie-nolec"><span>â€¢ PIE (No Lectivo)</span><span class="font-bold text-purple-700" id="res-pie-nolec">0.00</span></div>
                                    </div>
                                </div>
                                <div class="flex justify-between bg-green-50 p-2 rounded mt-1 border border-green-100">
                                    <span class="font-bold text-green-800 text-xs">3. PERMANENCIA (SALDO)</span>
                                    <span class="font-extrabold text-green-800" id="res-saldo">0.00 h</span>
                                </div>
                                <div class="text-[10px] text-right text-gray-400 mt-1">Total: <span id="res-total-final" class="font-bold text-black">0.00</span> hrs</div>
                                <div id="alert-box" class="text-[10px] text-center font-bold hidden p-1 rounded"></div>
                            </div>
                        </div>

                        <button onclick="saveTeacher()" id="btn-save" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded shadow transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-floppy-disk"></i> Guardar Ficha
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-pie" class="hidden space-y-6">
            <div class="print-area bg-white rounded-xl shadow border border-purple-200 p-8">
                <div class="flex justify-between items-center border-b-2 border-purple-800 pb-4 mb-6">
                    <h2 class="text-2xl font-bold uppercase text-purple-900">Control de Metas PIE</h2>
                    <div class="no-print"><button onclick="window.print()" class="bg-purple-800 text-white px-4 py-2 rounded font-bold">Imprimir</button></div>
                </div>
                <table class="w-full text-sm text-left border-collapse"><tbody id="pie-table-body"></tbody></table>
            </div>
        </div>

        <div id="view-summary" class="hidden space-y-6">
            <div class="print-area bg-white rounded-xl shadow-xl border border-slate-200 p-8">
                <div class="flex justify-between items-center border-b-2 border-slate-800 pb-4 mb-6">
                    <h2 class="text-2xl font-bold uppercase text-slate-800">Resumen General</h2>
                    <div class="no-print"><button onclick="window.print()" class="bg-slate-800 text-white px-4 py-2 rounded font-bold">Imprimir</button></div>
                </div>
                <div class="overflow-x-auto mb-8">
                    <table class="w-full text-xs text-left border-collapse">
                        <thead class="bg-slate-100 text-slate-700 uppercase font-bold border-y-2 border-slate-300">
                            <tr>
                                <th class="p-2 border-r">Docente</th>
                                <th class="p-2 text-center border-r w-8">Rol</th>
                                <th class="p-2 text-center bg-blue-50 border-r w-16">Lectivas<br>(Crono)</th>
                                <th class="p-2 text-center bg-orange-100 border-r w-12 font-bold">PIE</th>
                                <th class="p-2 text-center text-gray-400 border-r w-12 text-[9px]">35%<br>Legal</th>
                                <th class="p-2 text-center bg-orange-50 border-r w-10">Jef</th>
                                <th class="p-2 text-center bg-orange-50 border-r w-10">Tall</th>
                                <th class="p-2 text-center bg-orange-50 border-r w-10">Otr</th>
                                <th class="p-2 text-center bg-green-50 text-green-900 border-r font-bold w-16">PERM.</th>
                                <th class="p-2 text-right bg-blue-900 text-white w-16">TOTAL</th>
                                <th class="p-2 text-center no-print w-24">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="summary-table-body" class="divide-y divide-slate-200"></tbody>
                        <tfoot class="bg-slate-100 font-bold text-slate-800 border-t-2 border-slate-300" id="summary-footer"></tfoot>
                    </table>
                </div>
                <div class="mt-8 border-t-2 border-dashed border-slate-300 pt-6">
                    <button onclick="document.getElementById('ref-table-container').classList.toggle('hidden')" class="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-slate-800 transition mb-4"><i class="fa-solid fa-chevron-down"></i> Ver Tabla Referencia 65/35 (2019)</button>
                    <div id="ref-table-container" class="hidden overflow-x-auto bg-slate-50 p-4 rounded border border-slate-200"><table class="ref-table" id="reference-legal-table"></table></div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-viewer" class="fixed top-0 left-0 w-full h-full z-[100] hidden bg-slate-900/50 flex items-center justify-center">
        <div class="bg-white w-11/12 md:max-w-2xl mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[95vh]" id="modal-content">
            <div id="modal-body"></div>
            <div class="p-4 bg-gray-50 flex justify-end gap-2 border-t no-print">
                <button onclick="printVoucher()" class="px-4 py-2 bg-slate-800 text-white hover:bg-slate-900 rounded font-bold">Imprimir Voucher</button>
                <button onclick="closeModal()" class="px-4 py-2 text-slate-500 hover:bg-slate-200 rounded">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBnSMVCH0yyYUWk5z54kTIPTrWkyoeWs-I", authDomain: "suspenciones-40d0c.firebaseapp.com", projectId: "suspenciones-40d0c", storageBucket: "suspenciones-40d0c.firebasestorage.app", messagingSenderId: "853418739042", appId: "1:853418739042:web:d051befb99cd2acdd4583b", measurementId: "G-L00J7XN6Y1" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const COLL_NAME = "dotacion_docente";
        let staffList = [];
        let editingId = null;
        // CORRECCIÃ“N AQUI: Se cambiÃ³ 3Â° Medio B por 3Â° Medio C
        const ALL_COURSES = ["1Â° Medio A","1Â° Medio B","2Â° Medio A","2Â° Medio B","3Â° Medio A","3Â° Medio C","4Â° Medio A","4Â° Medio C"];
        
        const TABLE_65_35 = { 44: 28.5, 43: 27.75, 42: 27.0, 41: 26.25, 40: 26.25, 39: 25.5, 38: 24.75, 37: 24.0, 36: 23.25, 35: 22.5, 34: 21.75, 33: 21.75, 32: 21.0, 31: 20.25, 30: 19.5, 29: 18.75, 28: 18.0, 27: 17.25, 26: 16.5, 25: 16.5, 24: 15.75, 23: 15.0, 22: 14.25, 21: 13.5, 20: 12.75, 19: 12.0, 18: 12.0, 17: 11.25, 16: 10.5, 15: 9.75, 14: 9.0, 13: 8.25, 12: 7.5, 11: 7.5, 10: 6.75, 9: 6.0, 8: 5.25, 7: 4.5, 6: 3.75, 5: 3.0, 4: 2.25, 3: 2.25, 2: 1.5, 1: 0.75 };

        function getMaxLective(c) { return TABLE_65_35[Math.floor(c)] || c*0.65; }
        function parseLocalFloat(val) { const v = parseFloat(val); return isNaN(v) ? 0 : v; }
        function safeSetText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }

        function init() {
            renderCourseTable(); renderReferenceTable(); calculate();
            db.collection(COLL_NAME).orderBy("createdAt", "desc").onSnapshot((snapshot) => {
                staffList = []; snapshot.forEach((doc) => staffList.push({ id: doc.id, ...doc.data() }));
                updateSummaryTable(); updatePieSummary();
            });
        }

        function renderReferenceTable() {
            const table = document.getElementById('reference-legal-table');
            let html = `<thead><tr><th>Contrato</th><th>MÃ¡x. Lectivas (65%)</th><th>Recreo (4m/hr)</th><th>MÃ­n. No Lectivas (35%)</th></tr></thead><tbody>`;
            for (let i = 44; i >= 1; i--) {
                const maxLec = TABLE_65_35[i];
                const numBlq = maxLec / 0.75;
                const rec = (numBlq * 4) / 60;
                const noLec = i - maxLec - rec;
                html += `<tr><td class="font-bold text-blue-900">${i} hrs</td><td class="font-bold">${maxLec.toFixed(2)}</td><td class="text-gray-500">${rec.toFixed(2)}</td><td class="text-green-700 font-bold">${noLec.toFixed(2)}</td></tr>`;
            }
            html += `</tbody>`;
            table.innerHTML = html;
        }

        function renderCourseTable() {
            const tbody = document.getElementById('course-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            ALL_COURSES.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="p-3 font-bold text-slate-700 border-b border-slate-100">${c}</td><td class="p-2 border-b border-slate-100 text-center"><input type="text" placeholder="0" oninput="calculate()" class="c-blocks w-16 text-center font-bold p-1 border rounded" data-name="${c}"></td><td class="p-2 border-b border-slate-100 text-center bg-orange-50"><input type="text" placeholder="0" oninput="calculate()" class="c-pie w-16 text-center font-bold p-1 border rounded border-orange-200 text-orange-700"></td><td class="p-3 border-b border-slate-100 text-right font-bold text-slate-400 c-subtotal">0.00</td>`;
                tbody.appendChild(tr);
            });
        }

        function calculate() {
            let sumBlocks=0, sumPie=0, sumCrono=0;
            document.querySelectorAll('#course-table-body tr').forEach(row => {
                const b = parseLocalFloat(row.querySelector('.c-blocks').value);
                const p = parseLocalFloat(row.querySelector('.c-pie').value);
                const sub = (b * 0.75) + p;
                row.querySelector('.c-subtotal').innerText = sub.toFixed(2);
                row.querySelector('.c-subtotal').className = sub > 0 ? "p-3 border-b border-slate-100 text-right font-bold text-blue-700 c-subtotal" : "p-3 border-b border-slate-100 text-right font-bold text-slate-400 c-subtotal";
                sumBlocks += b; sumPie += p; sumCrono += sub;
            });

            const jef = parseLocalFloat(document.getElementById('fixed-jefatura').value);
            const tall = parseLocalFloat(document.getElementById('fixed-talleres').value);
            const otr = parseLocalFloat(document.getElementById('fixed-otros').value);
            const totalFijas = jef + tall + otr;

            const isPieRole = document.getElementById('role-toggle').checked;
            document.getElementById('role-status-text').innerText = isPieRole ? "Modo: Educador PIE" : "Modo: Profe Aula";
            document.getElementById('role-status-text').className = isPieRole ? "font-bold text-purple-700" : "font-bold text-blue-700";

            let cargaLectiva = 0, cargaNoLectiva = 0;
            if (isPieRole) { 
                cargaLectiva = sumCrono - sumPie; 
                cargaNoLectiva = totalFijas + sumPie;
                document.getElementById('row-pie-lectivo').classList.add('hidden');
                document.getElementById('row-pie-nolec').classList.remove('hidden');
            } else { 
                cargaLectiva = sumCrono; 
                cargaNoLectiva = totalFijas;
                document.getElementById('row-pie-lectivo').classList.remove('hidden');
                document.getElementById('row-pie-nolec').classList.add('hidden');
            }

            const numBloques = cargaLectiva / 0.75;
            const recreo = (numBloques * 4) / 60;

            let minContract = cargaLectiva / 0.65;
            let suggested = Math.ceil(minContract * 2) / 2;
            if(suggested < (cargaLectiva + cargaNoLectiva + recreo)) suggested = Math.ceil((cargaLectiva + cargaNoLectiva + recreo)*2)/2;

            const manual = parseLocalFloat(document.getElementById('manual-contract').value);
            let finalContract = manual > 0 ? manual : suggested;
            const balance = finalContract - cargaLectiva - cargaNoLectiva - recreo;
            
            safeSetText('sum-blocks', sumBlocks);
            safeSetText('sum-pie', sumPie.toFixed(2));
            safeSetText('sum-crono', sumCrono.toFixed(2) + " h");
            safeSetText('res-crono-aula', (sumCrono-sumPie).toFixed(2));
            safeSetText('res-pie-lec', sumPie.toFixed(2));
            safeSetText('res-pie-nolec', sumPie.toFixed(2));
            safeSetText('res-fijas-sum', totalFijas.toFixed(2));
            safeSetText('res-total-lectivo', cargaLectiva.toFixed(2));
            safeSetText('res-total-nolec', cargaNoLectiva.toFixed(2));
            safeSetText('res-recreo', recreo.toFixed(2));
            safeSetText('res-saldo', balance.toFixed(2) + " h");
            safeSetText('res-total-final', finalContract.toFixed(2));
            
            document.getElementById('manual-contract').placeholder = suggested;
            if(manual > 0 && balance < -0.01) {
                document.getElementById('alert-box').innerText = `âš ï¸ FALTAN: ${Math.abs(balance).toFixed(2)} HRS`;
                document.getElementById('alert-box').classList.remove('hidden');
            } else { document.getElementById('alert-box').classList.add('hidden'); }

            const maxLec = getMaxLective(finalContract);
            const badge = document.getElementById('compliance-badge');
            if(cargaLectiva <= maxLec + 0.05) {
                badge.className = "absolute top-2 right-2 text-[9px] px-2 py-0.5 rounded bg-green-100 text-green-700 font-bold";
                badge.innerText = `NORMA OK (Max ${maxLec})`;
            } else {
                badge.className = "absolute top-2 right-2 text-[9px] px-2 py-0.5 rounded bg-red-100 text-red-700 font-bold";
                badge.innerText = `EXCEDE (Max ${maxLec})`;
            }
            updatePieSummary();
        }

        async function saveTeacher() {
            const name = document.getElementById('teacher-name').value;
            if(!name) return alert("Falta nombre");
            const btn = document.getElementById('btn-save');
            btn.innerHTML = 'Guardando...'; btn.disabled = true;

            try {
                let courseDetails = [];
                let activeCourseNames = [];
                document.querySelectorAll('#course-table-body tr').forEach(row => {
                    const b = parseLocalFloat(row.querySelector('.c-blocks').value);
                    const p = parseLocalFloat(row.querySelector('.c-pie').value);
                    const n = row.querySelector('.c-blocks').dataset.name;
                    if(b > 0 || p > 0) activeCourseNames.push(n);
                    courseDetails.push({ name: n, blocks: b, pie: p });
                });

                const sumB = courseDetails.reduce((a,c)=>a+c.blocks,0);
                const sumP = courseDetails.reduce((a,c)=>a+c.pie,0);
                const sumC = sumB * 0.75; 
                
                const jef = parseLocalFloat(document.getElementById('fixed-jefatura').value);
                const tall = parseLocalFloat(document.getElementById('fixed-talleres').value);
                const otr = parseLocalFloat(document.getElementById('fixed-otros').value);
                const manual = parseLocalFloat(document.getElementById('manual-contract').value);
                const isPieRole = document.getElementById('role-toggle').checked;

                let cargaLectiva = isPieRole ? sumC : (sumC + sumP);
                let cargaNoLectiva = isPieRole ? (jef + tall + otr + sumP) : (jef + tall + otr);
                const numBloques = cargaLectiva / 0.75;
                const recreo = (numBloques * 4) / 60;

                let contract = 0;
                if(manual > 0) contract = manual;
                else {
                    let min = cargaLectiva / 0.65;
                    contract = Math.ceil(min * 2) / 2;
                    if(contract < (cargaLectiva + cargaNoLectiva + recreo)) contract = Math.ceil((cargaLectiva + cargaNoLectiva + recreo)*2)/2;
                }
                const saldo = contract - cargaLectiva - cargaNoLectiva - recreo;

                const data = {
                    name, 
                    courses: activeCourseNames.join(", "), 
                    courseDetails, 
                    breakdown: { jef, tall, otr },
                    totalBlocks: sumB, clasesCrono: sumC, pie: sumP, fijas: (jef+tall+otr),
                    saldo, manualContract: manual, contract, isPieRole, recreo,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if(editingId) await db.collection(COLL_NAME).doc(editingId).update(data);
                else await db.collection(COLL_NAME).add(data);
                
                clearForm();
                alert("Guardado Correctamente");
            } catch(e) { alert(e.message); }
            btn.innerHTML = 'Guardar Ficha'; btn.disabled = false;
        }

        function clearForm() {
            editingId = null;
            document.getElementById('edit-mode-banner').classList.add('hidden');
            document.getElementById('teacher-name').value = '';
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.getElementById('role-toggle').checked = false;
            calculate();
        }
        function editTeacher(id) {
            const t = staffList.find(x => x.id === id);
            if(!t) return;
            editingId = id;
            document.getElementById('edit-mode-banner').classList.remove('hidden');
            document.getElementById('editing-name-display').innerText = t.name;
            document.getElementById('teacher-name').value = t.name;
            if(t.manualContract) document.getElementById('manual-contract').value = t.manualContract;
            document.getElementById('role-toggle').checked = t.isPieRole || false;
            if(t.breakdown) {
                document.getElementById('fixed-jefatura').value = t.breakdown.jef;
                document.getElementById('fixed-talleres').value = t.breakdown.tall;
                document.getElementById('fixed-otros').value = t.breakdown.otr;
            }
            document.querySelectorAll('#course-table-body tr').forEach(row => {
                const inpB = row.querySelector('.c-blocks');
                const det = t.courseDetails.find(d => d.name === inpB.dataset.name);
                if(det) { inpB.value = det.blocks||''; row.querySelector('.c-pie').value = det.pie||''; }
                else { inpB.value=''; row.querySelector('.c-pie').value=''; }
            });
            calculate();
            switchTab('calculator');
        }
        function deleteTeacher(id) { if(confirm("Â¿Borrar?")) db.collection(COLL_NAME).doc(id).delete(); }
        
        function updateSummaryTable() {
            const tbody = document.getElementById('summary-table-body');
            tbody.innerHTML = '';
            staffList.forEach(t => {
                const cls = t.clasesCrono||0; const pie = t.pie||0; const con = t.contract||0;
                const isPie = t.isPieRole;
                let lec = isPie ? cls : (cls+pie);
                let nolec = isPie ? (t.fijas+pie) : t.fijas;
                const rec = t.recreo || ((lec/0.75)*4)/60; 
                const sal = con - lec - nolec - rec;
                const roleBadge = isPie ? '<span class="text-[10px] bg-purple-100 text-purple-700 px-1 rounded font-bold">PIE</span>' : '<span class="text-[10px] bg-blue-100 text-blue-700 px-1 rounded font-bold">AULA</span>';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 border-r font-bold">${t.name}</td>
                    <td class="p-2 border-r text-center">${roleBadge}</td>
                    <td class="p-2 border-r font-bold text-blue-700 bg-blue-50 text-center">${lec.toFixed(2)}</td>
                    <td class="p-2 border-r font-bold text-orange-700 bg-orange-100 text-center">${pie.toFixed(2)}</td>
                    <td class="p-2 border-r text-gray-400 text-center text-[10px]">${getMaxLective(con)}</td>
                    <td class="p-2 border-r bg-orange-50 text-center">${t.breakdown.jef}</td>
                    <td class="p-2 border-r bg-orange-50 text-center">${t.breakdown.tall}</td>
                    <td class="p-2 border-r bg-orange-50 text-center">${t.breakdown.otr}</td>
                    <td class="p-2 border-r font-bold text-green-700 bg-green-50 text-center">${sal.toFixed(2)}</td>
                    <td class="p-2 border-r font-extrabold text-blue-900 text-center">${con.toFixed(2)}</td>
                    <td class="p-2 text-center flex justify-center gap-1">
                        <button onclick="openModal('${t.id}')" class="text-teal-600 mr-2"><i class="fa-solid fa-eye"></i></button>
                        <button onclick="editTeacher('${t.id}')" class="text-blue-600 mr-2"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteTeacher('${t.id}')" class="text-red-600"><i class="fa-solid fa-trash"></i></button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        function updatePieSummary() {
            const tbody = document.getElementById('pie-table-body');
            tbody.innerHTML = '';
            const stats = {};
            ALL_COURSES.forEach(c => stats[c] = { total: 0, teachers: [] });

            // DB Data
            staffList.forEach(t => {
                if(t.id === editingId) return; // Skip currently edited teacher from DB
                if(t.courseDetails) t.courseDetails.forEach(d => {
                    const p = parseFloat(d.pie)||0;
                    if(p>0 && stats[d.name]) {
                        stats[d.name].total += p;
                        stats[d.name].teachers.push(`${t.name} (${p}h)`);
                    }
                });
            });

            // Live Data
            const curName = document.getElementById('teacher-name').value || "Actual";
            document.querySelectorAll('#course-table-body tr').forEach(row => {
                const inpP = row.querySelector('.c-pie');
                const p = parseFloat(inpP.value)||0;
                const cName = row.querySelector('.c-blocks').dataset.name;
                if(p>0 && stats[cName]) {
                    stats[cName].total += p;
                    stats[cName].teachers.push(`${curName} (${p}h)`);
                }
            });

            Object.keys(stats).forEach(c => {
                const d = stats[c];
                const diff = d.total - 3.0;
                let statusHtml = '';
                if(Math.abs(diff) < 0.05) statusHtml = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">âœ… Cumple</span>';
                else if(diff < 0) statusHtml = `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">ðŸ”´ Faltan ${Math.abs(diff).toFixed(2)}h</span>`;
                else statusHtml = `<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold">ðŸŸ£ Excede ${diff.toFixed(2)}h</span>`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 border-b text-slate-700 font-bold">${c}</td>
                    <td class="p-3 border-b text-center font-bold text-lg text-purple-900">${d.total.toFixed(2)}</td>
                    <td class="p-3 border-b text-center text-slate-400">3.00</td>
                    <td class="p-3 border-b text-center">${statusHtml}</td>
                    <td class="p-3 border-b text-xs text-slate-500">${d.teachers.join(', ')}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openModal(id) {
             const t = staffList.find(x => x.id === id); if(!t) return;
             const isPie = t.isPieRole;
             const lec = isPie ? t.clasesCrono : (t.clasesCrono + t.pie);
             const rec = t.recreo || 0;
             const sal = t.contract - lec - (isPie?(t.fijas+t.pie):t.fijas) - rec;
             
             let coursesRows = '';
             if(t.courseDetails) {
                 t.courseDetails.forEach(c => {
                     if(c.blocks > 0 || c.pie > 0) {
                         coursesRows += `<tr class="border-b border-gray-100 text-xs">
                            <td class="py-2 pl-2">${c.name}</td>
                            <td class="text-center">${c.blocks}</td>
                            <td class="text-center font-bold text-orange-600">${c.pie}</td>
                         </tr>`;
                     }
                 });
             }

             const html = `
                <div class="voucher-box">
                    <div class="voucher-header">
                        <div><h2 class="text-2xl font-bold uppercase">${t.name}</h2><p class="text-sm text-slate-500">${isPie?'Educador PIE':'Docente Aula'}</p></div>
                        <div class="text-right"><p class="text-xs font-bold text-slate-400">TOTAL</p><p class="text-4xl font-extrabold text-blue-900">${t.contract.toFixed(2)}</p></div>
                    </div>
                    
                    <div class="mb-6 bg-slate-50 p-4 rounded border border-slate-200">
                        <div class="voucher-section-title">Detalle de Cursos</div>
                        <table class="voucher-table">
                            <thead><tr><th>Curso</th><th class="text-center">Bloques</th><th class="text-center">PIE</th></tr></thead>
                            <tbody>${coursesRows}</tbody>
                        </table>
                    </div>

                    <div class="mb-6">
                        <div class="voucher-section-title">Resumen de Horas</div>
                        <div class="voucher-row"><span>1. Horas Lectivas Totales</span><strong>${lec.toFixed(2)} h</strong></div>
                        <div class="voucher-row text-xs pl-4 text-slate-500"><span>- Aula (Crono)</span><span>${t.clasesCrono.toFixed(2)} h</span></div>
                        <div class="voucher-row text-xs pl-4 text-slate-500"><span>- PIE (Lectivo)</span><span>${!isPie?t.pie.toFixed(2):'0.00'} h</span></div>
                        
                        <div class="voucher-row mt-2"><span>2. Horas No Lectivas</span><strong>${(isPie?(t.fijas+t.pie):t.fijas).toFixed(2)} h</strong></div>
                        <div class="voucher-row text-xs pl-4 text-slate-500"><span>- Fijas (Jef/Tall/Otr)</span><span>${t.fijas.toFixed(2)} h</span></div>
                        <div class="voucher-row text-xs pl-4 text-slate-500"><span>- PIE (No Lectivo)</span><span>${isPie?t.pie.toFixed(2):'0.00'} h</span></div>

                        <div class="voucher-row mt-2 bg-gray-50"><span>3. Recreos (Calculado)</span><strong>${rec.toFixed(2)} h</strong></div>
                        <div class="voucher-row bg-green-50 mt-1"><span class="font-bold text-green-900">4. Permanencia Real</span><strong class="text-green-700 text-lg">${sal.toFixed(2)} h</strong></div>
                    </div>
                </div>`;
             document.getElementById('modal-body').innerHTML = html;
             document.getElementById('modal-viewer').classList.remove('hidden');
             document.getElementById('modal-viewer').classList.add('flex');
        }
        function printVoucher() { 
            document.body.classList.add('printing-voucher');
            window.print(); 
            setTimeout(() => document.body.classList.remove('printing-voucher'), 1000);
        }
        window.closeModal = function() { 
            document.getElementById('modal-viewer').classList.add('hidden');
            document.getElementById('modal-viewer').classList.remove('flex');
        }
        function switchTab(id) { ['calculator','summary','pie'].forEach(v=>document.getElementById('view-'+v).classList.add('hidden')); document.getElementById('view-'+id).classList.remove('hidden'); }
        window.onload = init;
    </script>
</body>
</html>