<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control de Planificaciones — Gestión UTP v22 (Memo Formal)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@300;400;700&display=swap');
    body { font-family: 'Inter', sans-serif; background:#f3f4f6; min-height: 100vh; }
    
    /* UI Element Styles */
    .container-card { background:#fff; padding:1.25rem; border-radius:1rem; box-shadow:0 4px 6px rgba(0,0,0,0.08); }
    .button-primary { background:#4f46e5; color:#fff; padding:0.5rem 1rem; border-radius:0.5rem; font-weight:600; transition: 0.2s; cursor: pointer; }
    .button-primary:hover { background:#4338ca; }
    .button-secondary { background:#3b82f6; color:#fff; padding:0.5rem 1rem; border-radius:0.5rem; font-weight:600; transition: 0.2s; cursor: pointer; }
    .button-secondary:hover { background:#2563eb; }
    .button-success { background:#059669; color:#fff; padding:0.5rem 1rem; border-radius:0.5rem; font-weight:600; transition: 0.2s; cursor: pointer; }
    .button-success:hover { background:#047857; }
    .button-danger { background:#fee2e2; color:#ef4444; padding:0.25rem 0.5rem; border-radius:0.375rem; transition: 0.2s; cursor: pointer; }
    .button-danger:hover { background:#fecaca; color:#dc2626; }
    
    .badge { padding:0.25rem 0.5rem; border-radius:9999px; font-size:0.7rem; font-weight:700; text-transform: uppercase; display: inline-block; }
    .badge-ok { background:#d1fae5; color:#065f46; }
    .badge-warn { background:#fef3c7; color:#92400e; }
    .badge-err { background:#fee2e2; color:#991b1b; }

    /* --- SISTEMA DE IMPRESIÓN --- */
    @media print {
      /* MÁRGENES FORMALES DE 2.5cm */
      @page { margin: 2.5cm; size: letter; }
      
      body { background: white; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      body > * { display: none !important; }

      /* MODOS DE IMPRESIÓN */
      body:not(.voucher-print-mode):not(.feedback-print-mode):not(.memo-print-mode) .printable { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
      body:not(.voucher-print-mode):not(.feedback-print-mode):not(.memo-print-mode) .printable * { visibility: visible !important; display: block; }
      
      body.voucher-print-mode #voucher-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; z-index: 9999; }
      body.voucher-print-mode #voucher-container * { visibility: visible !important; }

      body.feedback-print-mode #feedback-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; z-index: 9999; }
      body.feedback-print-mode #feedback-container * { visibility: visible !important; }
      body.feedback-print-mode #feedback-container .grid { display: grid !important; }
      body.feedback-print-mode #feedback-container .flex { display: flex !important; }
      body.feedback-print-mode #feedback-container table { display: table !important; width: 100%; }

      /* MODO MEMO */
      body.memo-print-mode #memo-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; z-index: 9999; margin: 0; padding: 0; }
      body.memo-print-mode #memo-container * { visibility: visible !important; }

      .no-print, header, button, input, select, textarea, .list-manage-controls { display: none !important; }
      .grid { display: grid !important; } .flex { display: flex !important; }
      .chart-container { height: 280px !important; width: 100% !important; page-break-inside: avoid; }
      #reportHeader { display: flex !important; margin-bottom: 20px; border-bottom: 2px solid #4f46e5; padding-bottom: 15px; width: 100%; }
    }

    #reportHeader { display: none; }
    .hidden { display: none; }
    
    .custom-scroll { max-height: 150px; overflow-y: auto; }
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
  </style>
</head>
<body class="p-6 md:p-10">
  
  <div class="max-w-7xl mx-auto mb-6 no-print">
    <header class="flex items-center justify-between flex-wrap gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center gap-3">
        <img src="logo.jpg" class="h-12 w-auto object-contain rounded-full shadow-sm bg-white p-1">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 leading-tight">Control de Planificaciones</h1>
            <p class="text-xs text-gray-500 font-mono">Desarrollado por ProfeAle</p>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-300">
            <span class="text-xs font-bold text-gray-500 px-2 uppercase">Ciclo Escolar:</span>
            <select id="yearSelector" class="bg-white border-0 rounded-md text-sm font-bold text-indigo-700 focus:ring-0 cursor-pointer py-1 pl-2 pr-8">
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
            </select>
        </div>
        <button id="printListBtn" class="button-primary bg-gray-800 hover:bg-gray-900 shadow-md text-sm">
            <i class="fa-solid fa-print mr-2"></i>Imprimir Pantalla
        </button>
      </div>
    </header>
  </div>

  <div class="max-w-7xl mx-auto space-y-8 mb-8 no-print">
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      
      <div class="container-card border-t-4 border-indigo-500">
        <h2 class="text-lg font-bold text-gray-800 mb-2 flex justify-between items-center">
            <span><i class="fa-solid fa-chalkboard-user mr-2 text-indigo-500"></i>Profesores</span>
            <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500" id="countProf">0</span>
        </h2>
        <div class="flex gap-2 mb-3">
          <input id="profesorInput" class="flex-grow rounded-md border border-gray-300 p-2 text-sm" placeholder="Nuevo Profesor..."/>
          <button id="addProfesorBtn" class="button-primary bg-indigo-600 px-3">+</button>
        </div>
        <ul id="profesorList" class="space-y-1 text-sm custom-scroll"></ul>
      </div>

      <div class="container-card border-t-4 border-teal-500">
        <h2 class="text-lg font-bold text-gray-800 mb-2 flex justify-between items-center">
            <span><i class="fa-solid fa-users mr-2 text-teal-500"></i>Cursos</span>
            <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500" id="countCur">0</span>
        </h2>
        <div class="flex gap-2 mb-3">
          <input id="cursoInput" class="flex-grow rounded-md border border-gray-300 p-2 text-sm" placeholder="Nuevo Curso..."/>
          <button id="addCursoBtn" class="button-primary bg-teal-600 px-3">+</button>
        </div>
        <ul id="cursoList" class="space-y-1 text-sm custom-scroll"></ul>
      </div>

      <div class="container-card border-t-4 border-purple-500">
        <h2 class="text-lg font-bold text-gray-800 mb-2 flex justify-between items-center">
            <span><i class="fa-solid fa-book mr-2 text-purple-500"></i>Asignaturas</span>
            <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500" id="countAsig">0</span>
        </h2>
        <div class="flex gap-2 mb-3">
          <input id="asignaturaInput" class="flex-grow rounded-md border border-gray-300 p-2 text-sm" placeholder="Nueva Asignatura..."/>
          <button id="addAsignaturaBtn" class="button-primary bg-purple-600 px-3">+</button>
        </div>
        <ul id="asignaturaList" class="space-y-1 text-sm custom-scroll"></ul>
      </div>
    </div>

    <div class="container-card bg-gray-50 border border-gray-200">
        <h2 class="text-lg font-bold text-gray-800 mb-3"><i class="fa-solid fa-plus-circle mr-2 text-gray-600"></i>Ingreso de Planificación</h2>
        <form id="planificacionForm" class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-4 items-end">
            <div class="md:col-span-1 lg:col-span-1">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Título Unidad</label>
                <input id="titulo" class="w-full rounded border p-2 text-sm" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Profesor</label>
                <select id="profesor" class="w-full rounded border p-2 text-sm" required></select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Curso</label>
                <select id="curso" class="w-full rounded border p-2 text-sm" required></select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Asignatura</label>
                <select id="asignaturaForm" class="w-full rounded border p-2 text-sm" required></select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Plazo Entrega</label>
                <input type="date" id="fechaEntrega" class="w-full rounded border p-2 text-sm" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Recepción Real</label>
                <input type="date" id="fechaReal" class="w-full rounded border p-2 text-sm">
            </div>
            <div class="md:col-span-2 lg:col-span-2">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Estado Revisión</label>
                <select id="estadoRevision" class="w-full rounded border-2 border-indigo-100 p-2 text-sm font-bold text-indigo-700">
                    <option value="pendiente">⏳ Pendiente Revisión</option>
                    <option value="revisado">✅ Revisado OK</option>
                    <option value="observado">⚠️ Con Observaciones</option>
                </select>
            </div>
            <div class="md:col-span-1 lg:col-span-1">
                <button type="submit" class="button-primary w-full h-10 shadow-sm">Guardar</button>
            </div>
        </form>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="container-card bg-white border-l-4 border-gray-400">
            <h2 class="text-lg font-bold text-gray-800 mb-3">Filtros de Visualización</h2>
            <div class="grid grid-cols-2 gap-3">
                <select id="filterProfesor" class="rounded border p-2 text-sm w-full"></select>
                <select id="filterCurso" class="rounded border p-2 text-sm w-full"></select>
                <input type="date" id="dateStart" class="rounded border p-2 text-sm w-full" title="Desde">
                <input type="date" id="dateEnd" class="rounded border p-2 text-sm w-full" title="Hasta">
            </div>
            <div class="mt-3 flex gap-2 justify-end flex-wrap">
                <button id="sendEmailBtn" class="button-secondary text-sm"><i class="fa-solid fa-envelope mr-1"></i> Email</button>
                <button id="generateVoucherBtn" class="button-primary bg-green-600 hover:bg-green-700 text-sm"><i class="fa-solid fa-file-pdf mr-1"></i> Voucher</button>
                <button id="generateMatrixBtn" class="button-primary bg-emerald-600 hover:bg-emerald-700 text-sm"><i class="fa-solid fa-table mr-1"></i> Matriz Excel</button>
            </div>
        </div>

        <div class="container-card bg-amber-50 border-l-4 border-amber-500">
            <h2 class="text-lg font-bold text-gray-800 mb-2"><i class="fa-solid fa-comment-dots mr-2 text-amber-600"></i>Retroalimentación</h2>
            <div class="space-y-3">
                <div class="bg-white rounded border overflow-hidden">
                    <table class="w-full text-xs" id="tablaCoberturas">
                        <thead class="bg-amber-100"><tr><th class="p-1">Curso/Asig</th><th class="p-1 text-center">% Cob.</th><th class="p-1"></th></tr></thead>
                        <tbody id="bodyCoberturas">
                            <tr class="border-b"><td class="p-1"><input class="w-full border rounded input-desc" placeholder="Ej: 1°A Mat"></td><td class="p-1"><input type="number" class="w-12 border rounded text-center input-pct" placeholder="%"></td><td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-red-400"><i class="fa-solid fa-times"></i></button></td></tr>
                        </tbody>
                    </table>
                    <button onclick="agregarFilaCobertura()" class="w-full text-center text-xs text-amber-600 font-bold p-1 hover:bg-amber-50">+ Agregar Asignatura</button>
                </div>
                
                <div class="flex gap-2">
                    <select id="frasesRapidas" class="w-1/3 text-xs border rounded"><option value="">+ Frase</option><option value="Avance curricular adecuado.">Avance OK</option><option value="Se requiere priorizar OA basales.">Priorizar</option><option value="Felicitaciones por la puntualidad.">Puntualidad</option></select>
                    <textarea id="inputObservaciones" rows="1" class="w-2/3 text-xs border rounded p-1" placeholder="Observaciones..."></textarea>
                </div>
                <button id="btnFeedbackReport" class="button-success w-full text-sm shadow-sm">Generar Informe Gestión</button>
            </div>
        </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto space-y-6 printable">
    <div id="reportHeader" class="items-center">
      <div class="mr-6"><img src="logo.jpg" style="height: 80px; width: auto;" class="object-contain"></div>
      <div class="flex-grow flex justify-between items-end">
        <div><h1 class="text-2xl font-bold text-gray-900 uppercase">Reporte de Estado Curricular</h1><p class="text-sm text-gray-500 mt-1">Escuela Agrícola Sagrados Corazones - UTP</p></div>
        <div class="text-right"><p class="text-lg font-bold text-indigo-700" id="printDocenteName">VISTA GENERAL</p><p class="text-xs text-gray-400" id="printDate">Fecha: --/--/----</p></div>
      </div>
    </div>

    <div class="space-y-6">
        <div class="container-card mb-6 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                Resumen de Gestión <span id="yearDisplayBadge" class="ml-2 text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded">2025</span>
            </h2>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-100"><p class="text-sm text-blue-600 font-bold">Total Visualizado</p><p id="totalCount" class="text-3xl font-bold text-gray-900">0</p></div>
                <div class="bg-red-50 rounded-lg p-4 border border-red-100"><p class="text-sm text-red-600 font-bold">Atrasadas</p><p id="delayedCount" class="text-3xl font-bold text-red-600">0</p></div>
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200"><p class="text-sm text-gray-600 font-bold">Suma Días Atraso</p><p id="totalDaysDelayed" class="text-3xl font-bold text-gray-800">0</p></div>
                <div class="bg-amber-50 rounded-lg p-4 border border-amber-200"><p class="text-sm text-amber-700 font-bold">Acumulado Docente</p><p id="cumulativeByTeacherUpToDate" class="text-3xl font-bold text-amber-800">—</p></div>
            </div>
        </div>

        <div class="mb-8 p-4 border rounded-lg bg-gray-50 container-card">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-2 rounded shadow-sm border chart-container"><canvas id="chartStatus"></canvas></div>
                <div class="bg-white p-2 rounded shadow-sm border chart-container"><canvas id="chartDelays"></canvas></div>
            </div>
        </div>

        <div class="container-card">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Detalle de Registros</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left border rounded-lg overflow-hidden">
                <thead class="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                    <tr><th class="p-3 border-b">Actividad</th><th class="p-3 border-b">Profesor</th><th class="p-3 border-b">Curso/Asig</th><th class="p-3 border-b">Plazo vs Real</th><th class="p-3 border-b text-center">Entrega</th><th class="p-3 border-b text-center">Rev. UTP</th><th class="p-3 border-b text-center no-print">Acciones</th></tr>
                </thead>
                <tbody id="planificacionesList" class="divide-y divide-gray-200 bg-white"></tbody>
                </table>
            </div>
        </div>
    </div>
  </div>

  <div id="voucher-container" class="hidden"></div>
  <div id="feedback-container" class="hidden bg-white p-10 max-w-4xl mx-auto"></div>
  
  <div id="memo-container" class="hidden bg-white max-w-4xl mx-auto relative font-serif text-gray-900"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const cfg = {apiKey:"AIzaSyDJnJlpsqR76z_lBnTNEULYcGoQGIi23VU",authDomain:"planificaciones-18b94.firebaseapp.com",projectId:"planificaciones-18b94",storageBucket:"planificaciones-18b94.appspot.com",messagingSenderId:"268119843295",appId:"1:268119843295:web:bb2bdbcb0affe4ecf3646a"};
    
    const ARTIFACTS_PATH = "artifacts/planificaciones-18b94/users/planificaciones-18b94";
    const app=initializeApp(cfg); 
    const db=getFirestore(app);

    let planificacionesData=[];
    let listsData = { profesores: [], cursos: [], asignaturas: [] };
    let chartStatus=null, chartDelays=null;

    function toDate(v) { if(!v) return null; if(v instanceof Date) return v; if(v.seconds) return new Date(v.seconds*1000); if(typeof v==='string'){const d=new Date(v); if(v.includes('-')){const p=v.split('-'); return new Date(p[0],p[1]-1,p[2]);} return isNaN(d)?null:d;} return null; }
    function daysDelay(e,a){ const E=toDate(e),A=toDate(a); if(!E||!A)return 0; E.setHours(0,0,0,0); A.setHours(0,0,0,0); const d=Math.ceil((A-E)/86400000); return d>0?d:0; }
    function status(e,a){ if(!a) return 'pending'; return daysDelay(e,a)>0?'delayed':'completed'; }
    function fmt(d){ const x=toDate(d); return x?x.toLocaleDateString('es-CL'):'-'; }
    function ym(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

    function loadPlans() {
        let d1=[], d2=[], l1=false, l2=false;
        const mg=()=>{if(l1&&l2) {
            planificacionesData = [...d1,...d2].sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
            renderDashboard();
        }};
        onSnapshot(collection(db,'planificaciones'),s=>{d1=[];s.forEach(d=>d1.push({id:d.id,...d.data()}));l1=true;mg();});
        onSnapshot(collection(db,`${ARTIFACTS_PATH}/planificaciones`),s=>{d2=[];s.forEach(d=>d2.push({id:d.id,...d.data()}));l2=true;mg();});
    }

    function loadListCollection(colName, key) {
        let d1=[], d2=[], l1=false, l2=false;
        const updateUI=()=>{
            if(l1&&l2) {
                const all = [...d1, ...d2];
                all.sort((a,b) => a.nombre.localeCompare(b.nombre));
                listsData[key] = all;
                renderListUI(key);
                updateSelectors();
            }
        };
        onSnapshot(collection(db, colName), s=>{
            d1=[]; s.forEach(d=>d1.push({id:d.id, ...d.data(), origin:'root'}));
            l1=true; updateUI();
        });
        onSnapshot(collection(db, `${ARTIFACTS_PATH}/${colName}`), s=>{
            d2=[]; s.forEach(d=>d2.push({id:d.id, ...d.data(), origin:'artifact'}));
            l2=true; updateUI();
        });
    }

    loadPlans();
    loadListCollection('profesores', 'profesores');
    loadListCollection('cursos', 'cursos');
    loadListCollection('asignaturas', 'asignaturas');

    function renderListUI(key) {
        const ul = $(key === 'profesores' ? 'profesorList' : key === 'cursos' ? 'cursoList' : 'asignaturaList');
        const counter = $(key === 'profesores' ? 'countProf' : key === 'cursos' ? 'countCur' : 'countAsig');
        ul.innerHTML = '';
        const data = listsData[key];
        counter.innerText = data.length;

        data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-2 bg-white border rounded hover:bg-gray-50';
            li.innerHTML = `
                <span class="font-medium text-gray-700">${item.nombre}</span>
                <button class="button-danger text-xs" onclick="window.deleteListItem('${key}', '${item.id}', '${item.origin}')">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;
            ul.appendChild(li);
        });
    }

    function updateSelectors() {
        const fill=(id, list)=>{
            const el=$(id), curr=el.value; 
            el.innerHTML='<option value="">Seleccionar...</option>'; 
            const uniqueNames = [...new Set(list.map(i => i.nombre))];
            uniqueNames.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;el.appendChild(o);}); 
            if(curr)el.value=curr;
        };
        fill('profesor', listsData.profesores);
        fill('filterProfesor', listsData.profesores);
        fill('curso', listsData.cursos);
        fill('filterCurso', listsData.cursos);
        fill('asignaturaForm', listsData.asignaturas);
    }

    const saveEntity = async (col, val) => {
        if(!val) return;
        try { await addDoc(collection(db, `${ARTIFACTS_PATH}/${col}`), { nombre: val, createdAt: serverTimestamp() }); } 
        catch(e) { alert("Error: " + e.message); }
    };
    
    $('addProfesorBtn').onclick = () => { saveEntity('profesores', $('profesorInput').value); $('profesorInput').value=''; };
    $('addCursoBtn').onclick = () => { saveEntity('cursos', $('cursoInput').value); $('cursoInput').value=''; };
    $('addAsignaturaBtn').onclick = () => { saveEntity('asignaturas', $('asignaturaInput').value); $('asignaturaInput').value=''; };

    window.deleteListItem = async (key, id, origin) => {
        if(!confirm("¿Eliminar elemento?")) return;
        const colName = key; 
        try {
            const path = origin === 'artifact' ? `${ARTIFACTS_PATH}/${colName}` : colName;
            await deleteDoc(doc(db, path, id));
        } catch(e) { alert("Error al eliminar: " + e.message); }
    };

    $('planificacionForm').addEventListener('submit',async e=>{
        e.preventDefault();
        await addDoc(collection(db,`${ARTIFACTS_PATH}/planificaciones`),{
            titulo:$('titulo').value.trim(), profesor:$('profesor').value, curso:$('curso').value, asignatura:$('asignaturaForm').value,
            fechaEntrega:$('fechaEntrega').value||null, fechaReal:$('fechaReal').value||null, estadoRevision:$('estadoRevision').value, createdAt:serverTimestamp()
        });
        alert("✅ Guardado"); $('planificacionForm').reset();
    });

    $('yearSelector').addEventListener('change', renderDashboard);

    function renderDashboard(){
        const fP=$('filterProfesor').value, fC=$('filterCurso').value, dS=$('dateStart').value, dE=$('dateEnd').value;
        const selectedYear = $('yearSelector').value;
        
        $('printDocenteName').innerText=fP?fP.toUpperCase():"VISTA GENERAL"; 
        $('printDate').innerText="Fecha: "+new Date().toLocaleDateString('es-CL');
        $('yearDisplayBadge').innerText = selectedYear;

        const filtered=planificacionesData.filter(p=>{
            let ok=true; const d=toDate(p.fechaEntrega);
            if(d && d.getFullYear().toString() !== selectedYear) ok=false;
            if(!d && selectedYear !== new Date().getFullYear().toString()) ok=false;
            if(fP&&p.profesor!==fP)ok=false; if(fC&&p.curso!==fC)ok=false;
            if(d&&dS&&d<new Date(dS))ok=false; if(d&&dE&&d>new Date(dE))ok=false;
            return ok;
        });

        const tb=$('planificacionesList'); tb.innerHTML='';
        let tot=0, comp=0, del=0, sumDel=0;

        filtered.forEach(p=>{
            const st=status(p.fechaEntrega,p.fechaReal), dd=daysDelay(p.fechaEntrega,p.fechaReal);
            tot++; if(st==='completed')comp++; if(st==='delayed'){del++; sumDel+=dd;}
            let revBadge='<span class="badge badge-warn">Pendiente</span>';
            if(p.estadoRevision==='revisado')revBadge='<span class="badge badge-ok">Revisado OK</span>';
            if(p.estadoRevision==='observado')revBadge='<span class="badge badge-err">Observado</span>';
            
            // --- BOTONES ---
            let alertBtn = '';
            if(st==='delayed' || st==='pending') {
                alertBtn += `<button onclick="window.sendAlert('${p.profesor}','${p.titulo}','${fmt(p.fechaEntrega)}')" class="text-blue-600 hover:text-blue-800 ml-1" title="Enviar Email"><i class="fa-solid fa-envelope"></i></button>`;
            }
            // Botón Memo (>= 10 días atraso)
            if(parseInt(dd) >= 10) {
                alertBtn += `<button onclick="window.generateMemo('${p.profesor}', '${p.titulo}', '${fmt(p.fechaEntrega)}', '${fmt(p.fechaReal)}', ${dd})" class="text-red-600 hover:text-red-800 ml-3" title="Generar Memorándum"><i class="fa-solid fa-file-pdf text-lg"></i></button>`;
            }

            tb.innerHTML+=`<tr class="border-b hover:bg-gray-50">
                <td class="p-3"><div class="font-bold text-gray-800">${p.titulo||'-'}</div></td><td class="p-3 text-xs">${p.profesor||'-'}</td>
                <td class="p-3 text-xs"><div>${p.curso||'-'}</div><div class="text-gray-500">${p.asignatura||'-'}</div></td>
                <td class="p-3 text-xs text-center"><div>Plazo: ${fmt(p.fechaEntrega)}</div><div>Real: ${fmt(p.fechaReal)}</div></td>
                <td class="p-3 text-center"><span class="badge ${st==='completed'?'badge-ok':(st==='delayed'?'badge-err':'badge-warn')}">${st==='completed'?'A Tiempo':(st==='delayed'?'Atraso '+dd+'d':'Pendiente')}</span></td>
                <td class="p-3 text-center">${revBadge}</td><td class="p-3 text-center no-print flex justify-center items-center">${alertBtn}</td></tr>`;
        });

        $('totalCount').innerText=tot; $('delayedCount').innerText=del; $('totalDaysDelayed').innerText=sumDel;
        if(fP){
            const cut=dE?new Date(dE):new Date(), h=planificacionesData.filter(p=>p.profesor===fP&&toDate(p.fechaEntrega)&&toDate(p.fechaEntrega)<=cut);
            const mm={}; h.forEach(p=>{const d=daysDelay(p.fechaEntrega,p.fechaReal);if(d>0)mm[ym(toDate(p.fechaEntrega))]=Math.max(mm[ym(toDate(p.fechaEntrega))]||0,d);});
            $('cumulativeByTeacherUpToDate').innerText=Object.values(mm).reduce((a,b)=>a+b,0);
        }else $('cumulativeByTeacherUpToDate').innerText="—";
        renderCharts(filtered, selectedYear);
    }

    function renderCharts(d, year){
        if(chartStatus)chartStatus.destroy(); if(chartDelays)chartDelays.destroy();
        const m=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'], s=m.map(()=>({ok:0,late:0,days:0}));
        d.forEach(p=>{const f=toDate(p.fechaEntrega); if(f&&f.getFullYear().toString()===year){const i=f.getMonth(); if(status(p.fechaEntrega,p.fechaReal)==='completed')s[i].ok++; else if(status(p.fechaEntrega,p.fechaReal)==='delayed'){s[i].late++;s[i].days+=daysDelay(p.fechaEntrega,p.fechaReal);}}});
        chartStatus=new Chart($('chartStatus'),{type:'bar',data:{labels:m,datasets:[{label:'OK',data:s.map(x=>x.ok),backgroundColor:'#34d399'},{label:'Late',data:s.map(x=>x.late),backgroundColor:'#f87171'}]},options:{animation:false,responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true}}}});
        chartDelays=new Chart($('chartDelays'),{type:'line',data:{labels:m,datasets:[{label:'Días Atraso',data:s.map(x=>x.days),borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.2)',fill:true,tension:0.3}]},options:{animation:false,responsive:true,maintainAspectRatio:false}});
    }

    $('frasesRapidas').addEventListener('change', function() {
        const val = this.value;
        if(val) {
            const currentText = $('inputObservaciones').value;
            $('inputObservaciones').value = currentText + (currentText.length > 0 ? " " : "") + val;
            this.value = ""; 
        }
    });

    window.agregarFilaCobertura = () => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `<td class="p-1"><input type="text" class="w-full border rounded input-desc" placeholder="Desc. Asig"></td><td class="p-1"><input type="number" class="w-full border rounded text-center input-pct" placeholder="%"></td><td class="p-1 text-center"><button onclick="this.closest('tr').remove()" class="text-red-400"><i class="fa-solid fa-trash"></i></button></td>`;
        $('bodyCoberturas').appendChild(tr);
    }

    $('generateMatrixBtn').onclick = () => {
        const year = $('yearSelector').value;
        const matriz = {}; 

        const data = planificacionesData.filter(p => {
            const d = toDate(p.fechaEntrega);
            return d && d.getFullYear().toString() === year;
        });

        if (data.length === 0) return alert("No hay datos para el año " + year);

        data.forEach(p => {
            const key = `${p.profesor}||${p.curso}||${p.asignatura}`;
            if (!matriz[key]) {
                matriz[key] = {
                    profesor: p.profesor, curso: p.curso, asignatura: p.asignatura,
                    meses: Array(12).fill(0), totalEntregas: 0, entregasOK: 0, totalDiasAtraso: 0
                };
            }
            const mesIndex = toDate(p.fechaEntrega).getMonth();
            const diasAtraso = daysDelay(p.fechaEntrega, p.fechaReal);
            
            if (diasAtraso > 0) {
                matriz[key].meses[mesIndex] += diasAtraso;
                matriz[key].totalDiasAtraso += diasAtraso;
            } else {
                matriz[key].entregasOK++;
            }
            matriz[key].totalEntregas++;
        });

        const filas = Object.values(matriz).sort((a, b) => a.curso.localeCompare(b.curso) || a.profesor.localeCompare(b.profesor));

        let tbody = "";
        filas.forEach(row => {
            const porcentaje = row.totalEntregas > 0 ? Math.round((row.entregasOK / row.totalEntregas) * 100) : 0;
            let celdasMeses = "";
            for (let i = 2; i <= 11; i++) { 
                const val = row.meses[i];
                const style = val > 0 ? "font-weight:bold; color:#dc2626;" : "color:#d1d5db;";
                celdasMeses += `<td class="border p-1 text-center" style="${style}">${val}</td>`;
            }

            tbody += `
                <tr class="text-xs hover:bg-gray-50">
                    <td class="border p-1 font-bold text-gray-700">${row.curso}</td>
                    <td class="border p-1">${row.profesor}</td>
                    <td class="border p-1 text-gray-600">${row.asignatura}</td>
                    ${celdasMeses}
                    <td class="border p-1 text-center font-bold bg-gray-100">${row.totalDiasAtraso}</td>
                    <td class="border p-1 text-center font-bold ${porcentaje < 80 ? 'text-red-600' : 'text-blue-600'}">${porcentaje}%</td>
                </tr>
            `;
        });

        const container = $('feedback-container');
        container.innerHTML = `
            <div class="font-sans text-gray-800 p-4 min-h-screen bg-white">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h1 class="text-xl font-bold text-gray-800 uppercase">Matriz de Cumplimiento - ${year}</h1>
                    <div class="text-right text-xs text-gray-500"><p>Generado: ${new Date().toLocaleDateString()}</p></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-400 text-xs">
                        <thead class="bg-gray-300 text-gray-800 font-bold uppercase text-center">
                            <tr>
                                <th class="border border-gray-400 p-2 text-left w-16">Curso</th>
                                <th class="border border-gray-400 p-2 text-left">Profesor</th>
                                <th class="border border-gray-400 p-2 text-left">Asignatura</th>
                                <th class="border border-gray-400 p-1 w-8">Mar</th>
                                <th class="border border-gray-400 p-1 w-8">Abr</th>
                                <th class="border border-gray-400 p-1 w-8">May</th>
                                <th class="border border-gray-400 p-1 w-8">Jun</th>
                                <th class="border border-gray-400 p-1 w-8">Jul</th>
                                <th class="border border-gray-400 p-1 w-8">Ago</th>
                                <th class="border border-gray-400 p-1 w-8">Sep</th>
                                <th class="border border-gray-400 p-1 w-8">Oct</th>
                                <th class="border border-gray-400 p-1 w-8">Nov</th>
                                <th class="border border-gray-400 p-1 w-8">Dic</th>
                                <th class="border border-gray-400 p-1 w-12 bg-gray-200">Total<br>Días</th>
                                <th class="border border-gray-400 p-1 w-12 bg-gray-200">%<br>Cump.</th>
                            </tr>
                        </thead>
                        <tbody>${tbody}</tbody>
                    </table>
                </div>
            </div>
        `;

        container.classList.remove('hidden');
        document.body.classList.add('feedback-print-mode');
        const style = document.createElement('style');
        style.innerHTML = `@page { size: landscape; margin: 0.5cm; }`;
        document.head.appendChild(style);

        setTimeout(() => {
            window.print();
            setTimeout(() => {
                document.body.classList.remove('feedback-print-mode');
                container.classList.add('hidden');
                document.head.removeChild(style);
            }, 500);
        }, 500);
    };

    $('btnFeedbackReport').onclick = () => {
        const prof = $('filterProfesor').value;
        const cursoSeleccionado = $('filterCurso').value; 
        const dS = $('dateStart').value;
        const dE = $('dateEnd').value;
        const observacion = $('inputObservaciones').value || "Sin observaciones registradas.";

        if(!prof || !dE) { alert("⚠️ Para generar este informe DEBE seleccionar un Profesor y una Fecha de Corte (Hasta)."); return; }

        let tablaCoberturasHtml = '<table class="w-full border-collapse border border-gray-300 text-sm mb-4"><thead class="bg-gray-100"><tr><th class="border p-2">Asignatura/Curso</th><th class="border p-2">% Cobertura</th></tr></thead><tbody>';
        let rows = document.querySelectorAll('#bodyCoberturas tr');
        let hasRows = false;
        rows.forEach(r => {
            const d = r.querySelector('.input-desc').value;
            const p = r.querySelector('.input-pct').value;
            if(d || p) {
                hasRows = true;
                const pctVal = parseInt(p)||0;
                const color = pctVal >= 80 ? 'text-green-600 font-bold' : (pctVal >= 50 ? 'text-yellow-600 font-bold' : 'text-red-600 font-bold');
                tablaCoberturasHtml += `<tr><td class="border p-2">${d}</td><td class="border p-2 text-center ${color}">${p}%</td></tr>`;
            }
        });
        tablaCoberturasHtml += '</tbody></table>';
        if(!hasRows) tablaCoberturasHtml = '<p class="italic text-gray-500 mb-4">No se ingresó detalle de cobertura por asignatura.</p>';

        const pData = planificacionesData.filter(p => 
            p.profesor === prof && 
            (!cursoSeleccionado || p.curso === cursoSeleccionado) && 
            toDate(p.fechaEntrega) >= (dS?new Date(dS):new Date('2000-01-01')) && 
            toDate(p.fechaEntrega) <= new Date(dE)
        );

        const total = pData.length;
        const entregadas = pData.filter(p => p.fechaReal).length;
        const cumplimientoPlan = total > 0 ? Math.round((entregadas/total)*100) : 0;
        const atrasos = pData.filter(p => status(p.fechaEntrega, p.fechaReal) === 'delayed').length;

        const statsCursos = {};
        pData.forEach(p => {
            if(!statsCursos[p.curso]) statsCursos[p.curso] = {total:0, ok:0, late:0};
            statsCursos[p.curso].total++;
            const st = status(p.fechaEntrega, p.fechaReal);
            if(st === 'completed') statsCursos[p.curso].ok++;
            if(st === 'delayed') statsCursos[p.curso].late++;
        });
        
        let desgloseCursosHtml = '';
        if(Object.keys(statsCursos).length > 0){
            desgloseCursosHtml = '<div class="mb-4 mt-2"><p class="text-xs font-bold text-gray-500 uppercase mb-1">Desglose por Curso</p><table class="w-full text-xs border text-center"><thead class="bg-gray-200"><tr><th>Curso</th><th>Total</th><th>OK</th><th>Atrasos</th><th>% Cump.</th></tr></thead><tbody>';
            for (const [c, s] of Object.entries(statsCursos)) {
                const pct = s.total > 0 ? Math.round(((s.total - s.late)/s.total)*100) : 0;
                desgloseCursosHtml += `<tr><td class="border p-1 font-bold">${c}</td><td class="border p-1">${s.total}</td><td class="border p-1 text-green-600">${s.ok}</td><td class="border p-1 text-red-600">${s.late}</td><td class="border p-1 font-bold ${pct<80?'text-red-600':'text-blue-600'}">${pct}%</td></tr>`;
            }
            desgloseCursosHtml += '</tbody></table></div>';
        }

        $('feedback-container').innerHTML = `
            <div class="font-sans text-gray-800 border-4 border-double border-gray-300 p-8 h-full relative">
                <div class="flex items-center justify-between border-b-2 border-indigo-700 pb-4 mb-6">
                    <img src="logo.jpg" style="height: 70px;">
                    <div class="text-right">
                        <h1 class="text-xl font-bold uppercase text-indigo-900">Informe de Gestión Curricular</h1>
                        <p class="text-sm text-gray-500">Unidad Técnico Pedagógica</p>
                        <p class="text-xs text-gray-400">Emisión: ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
                <div class="bg-gray-100 p-4 rounded mb-6 flex justify-between">
                    <div>
                        <span class="font-bold text-gray-600 block text-xs">DOCENTE</span><span class="text-lg font-bold">${prof}</span>
                        ${cursoSeleccionado ? `<span class="block text-xs text-indigo-600 font-bold mt-1">FILTRO: CURSO ${cursoSeleccionado}</span>` : ''}
                    </div>
                    <div class="text-right"><span class="font-bold text-gray-600 block text-xs">PERIODO EVALUADO</span><span>${dS?fmt(dS):'Inicio'} al ${fmt(dE)}</span></div>
                </div>
                <h3 class="font-bold text-indigo-800 uppercase text-sm mb-2 border-b">I. Cumplimiento de Planificaciones</h3>
                
                <div class="grid grid-cols-2 gap-4 mb-2 text-center">
                    <div class="border p-3 rounded bg-white shadow-sm">
                        <div class="text-3xl font-bold ${cumplimientoPlan>=80?'text-green-600':'text-red-600'}">${cumplimientoPlan}%</div>
                        <div class="text-xs text-gray-500 uppercase font-bold mt-1">Planificaciones Entregadas</div>
                    </div>
                    <div class="border p-3 rounded bg-white shadow-sm">
                        <div class="text-3xl font-bold text-gray-700">${atrasos}</div>
                        <div class="text-xs text-gray-500 uppercase font-bold mt-1">Entregas con Atraso</div>
                    </div>
                </div>
                
                ${desgloseCursosHtml}

                <h3 class="font-bold text-indigo-800 uppercase text-sm mb-2 border-b mt-6">II. Avance de Cobertura Curricular</h3>
                ${tablaCoberturasHtml}
                <h3 class="font-bold text-indigo-800 uppercase text-sm mb-2 border-b">III. Retroalimentación y Compromisos</h3>
                <div class="border rounded p-4 bg-white min-h-[120px] text-sm leading-relaxed text-justify mb-8">
                    ${observacion.replace(/\n/g, '<br>')}
                </div>
                <div class="flex justify-between mt-16 px-10">
                    <div class="text-center w-1/3 border-t border-black pt-2">
                        <p class="font-bold text-sm">${prof}</p>
                        <p class="text-xs text-gray-500">Docente</p>
                    </div>
                    <div class="text-center w-1/3 border-t border-black pt-2">
                        <p class="font-bold text-sm">ALEJANDRA MORALES G.</p>
                        <p class="text-xs text-gray-500">Jefa UTP</p>
                    </div>
                </div>
            </div>
        `;

        $('feedback-container').classList.remove('hidden');
        document.body.classList.add('feedback-print-mode');
        setTimeout(() => { window.print(); setTimeout(() => { document.body.classList.remove('feedback-print-mode'); $('feedback-container').classList.add('hidden'); }, 500); }, 500);
    };

    window.sendAlert=(p,t,d)=>{const m=prompt(`Correo para ${p}:`,"profe@colegio.cl");if(m)window.location.href=`mailto:${m}?subject=Alerta Atraso&body=Pendiente: ${t} (Vence: ${d})`;};
    $('sendEmailBtn').onclick=()=>{const p=$('filterProfesor').value; if(!p)return alert("Seleccione Profesor"); const m=prompt(`Correo para ${p}:`); if(m)window.location.href=`mailto:${m}?subject=Resumen Gestión&body=Adjunto resumen mensual.`;};

    $('generateVoucherBtn').onclick=()=>{
        const prof=$('filterProfesor').value, dS=$('dateStart').value, dE=$('dateEnd').value;
        if(!prof||!dE)return alert("Seleccione Profesor y Fecha Hasta");
        const pData=planificacionesData.filter(p=>p.profesor===prof&&toDate(p.fechaEntrega)>=(dS?new Date(dS):new Date('2000-01-01'))&&toDate(p.fechaEntrega)<=new Date(dE)).sort((a,b)=>toDate(a.fechaEntrega)-toDate(b.fechaEntrega));
        let sumD=0, maxD=0;
        const dictStatus = { 'completed': 'A TIEMPO', 'delayed': 'ATRASADO', 'pending': 'PENDIENTE' };
        
        const rows=pData.map(p=>{ 
            const d=daysDelay(p.fechaEntrega,p.fechaReal), s=status(p.fechaEntrega,p.fechaReal); 
            const sEs = dictStatus[s] || s; 
            if(d>0){sumD+=d;maxD=Math.max(maxD,d);} 
            return `<tr class="border-b text-xs"><td class="p-2">${p.titulo}</td><td class="p-2">${p.curso}</td><td class="p-2">${fmt(p.fechaEntrega)}</td><td class="p-2">${fmt(p.fechaReal)}</td><td class="p-2 font-bold ${d>0?'text-red-600':''}">${d>0?d:'-'}</td><td class="p-2"><span class="badge ${s==='completed'?'badge-ok':(s==='delayed'?'badge-err':'badge-warn')}">${sEs}</span></td></tr>`;
        }).join('');
        
        $('voucher-container').innerHTML=`<div class="space-y-6 text-sm font-sans text-gray-800"><div class="border-b pb-4 flex justify-between"><img src="logo.jpg" style="height:60px"><div><h1 class="text-xl font-bold">COMPROBANTE DE ENTREGAS</h1><p class="text-right text-gray-500">${new Date().toLocaleDateString()}</p></div></div><div class="bg-gray-100 p-2 font-bold flex justify-between"><span>${prof}</span><span>${pData.length} Regs.</span></div><table class=\"w-full text-left mt-4\"><thead class=\"bg-gray-200 text-xs uppercase\"><tr><th class=\"p-2\">Actividad</th><th class=\"p-2\">Curso</th><th class=\"p-2\">Plazo</th><th class=\"p-2\">Entrega</th><th class=\"p-2\">Días</th><th class=\"p-2\">Est</th></tr></thead><tbody>${rows}</tbody></table><div class=\"mt-8 pt-4 border-t text-center text-xs text-gray-400\">Generado por ProfeAle System</div></div>`;
        $('voucher-container').classList.remove('hidden'); document.body.classList.add('voucher-print-mode');
        setTimeout(()=>{window.print();setTimeout(()=>{document.body.classList.remove('voucher-print-mode');$('voucher-container').classList.add('hidden');},500);},500);
    };

    // --- FUNCIÓN MEMORANDUM FORMAL (UNA SOLA PLANA) ---
    window.generateMemo = (profesor, titulo, fechaPlazo, fechaReal, diasAtraso) => {
        const container = $('memo-container');
        const fechaHoy = new Date().toLocaleDateString('es-CL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        // Plantilla Formal con espaciado ajustado para carta/letter
        container.innerHTML = `
            <div class="h-full flex flex-col relative font-serif text-gray-900 leading-snug">
                <div class="flex items-end justify-between mb-6 border-b-2 border-black pb-2">
                    <img src="logo.jpg" style="height: 60px;" alt="Logo Escuela">
                    <div class="text-right">
                        <h2 class="text-xl font-bold uppercase tracking-wide text-black">Memorándum</h2>
                        <p class="text-xs font-bold text-gray-600">UNIDAD TÉCNICO PEDAGÓGICA</p>
                    </div>
                </div>

                <div class="grid grid-cols-[80px_1fr] gap-2 mb-8 text-base">
                    <div class="font-bold uppercase">De:</div>
                    <div>JEFA UNIDAD TÉCNICO PEDAGÓGICA</div>
                    
                    <div class="font-bold uppercase">Para:</div>
                    <div class="uppercase font-semibold">${profesor}</div>

                    <div class="font-bold uppercase">Fecha:</div>
                    <div class="capitalize">${fechaHoy}</div>

                    <div class="font-bold uppercase">Mat:</div>
                    <div class="uppercase font-bold underline">INCUMPLIMIENTO DE PLAZOS DE ENTREGA</div>
                </div>

                <div class="text-justify text-base space-y-4">
                    <p>Estimado(a) docente:</p>
                    
                    <p>
                        Junto con saludar, me dirijo a usted para informar y dejar constancia del incumplimiento 
                        en los plazos establecidos para la entrega de la documentación pedagógica correspondiente.
                    </p>

                    <p>
                        En específico, se detalla la siguiente situación respecto a la planificación de la unidad:
                    </p>

                    <div class="bg-gray-50 p-4 border-l-4 border-red-600 my-4 text-sm shadow-sm">
                        <ul class="list-disc pl-5 space-y-1">
                            <li><strong>Actividad / Unidad:</strong> ${titulo}</li>
                            <li><strong>Fecha de Plazo Estipulada:</strong> ${fechaPlazo}</li>
                            <li><strong>Fecha Real de Recepción:</strong> ${fechaReal}</li>
                            <li class="mt-2"><strong>Días Totales de Atraso:</strong> <span class="text-red-700 font-bold text-lg border-b border-red-300">${diasAtraso} días</span></li>
                        </ul>
                    </div>

                    <p>
                        Esta situación afecta el normal funcionamiento de los procesos de revisión y seguimiento curricular 
                        de nuestro establecimiento. Se solicita regularizar sus entregas futuras para evitar medidas administrativas mayores, 
                        conforme a lo estipulado en nuestro Reglamento Interno y contrato de trabajo respecto al cumplimiento de deberes profesionales.
                    </p>

                    <p>Sin otro particular, saluda atentamente,</p>
                </div>

                <div class="flex justify-between mt-16 px-4">
                    <div class="text-center w-5/12 pt-2 border-t border-black">
                        <p class="font-bold text-xs uppercase">${profesor}</p>
                        <p class="text-[10px] text-gray-500 uppercase">Recibí Conforme</p>
                    </div>
                    <div class="text-center w-5/12 pt-2 border-t border-black">
                        <p class="font-bold text-xs uppercase">ALEJANDRA MORALES G.</p>
                        <p class="text-[10px] text-gray-500 uppercase">Jefa Unidad Técnico Pedagógica</p>
                    </div>
                </div>
                
                <div class="text-[10px] text-center text-gray-400 mt-8">
                    Escuela Agrícola Sagrados Corazones - Documento generado el ${new Date().toLocaleDateString()}
                </div>
            </div>
        `;

        // Activar modo impresión Memo
        container.classList.remove('hidden');
        document.body.classList.add('memo-print-mode');

        setTimeout(() => {
            window.print();
            setTimeout(() => {
                document.body.classList.remove('memo-print-mode');
                container.classList.add('hidden');
            }, 500);
        }, 500);
    };

    ['filterProfesor','filterCurso','dateStart','dateEnd'].forEach(i=>$(i).addEventListener('change',renderDashboard));
    $('printListBtn').onclick=()=>window.print();
  </script>
</body>
</html>